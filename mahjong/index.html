<!DOCTYPE html
	PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>

<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
	<title>麻将牌谱生成</title>
	<script src="javascripts/jquery.js" type="text/javascript"></script>
	<script src="javascripts/raphael.js" type="text/javascript"></script>
	<script src="javascripts/html2canvas.js"></script>
	<style>
		#maj_img {
			line-height: 200px;
			height: 200px;
			width: 1300px;
		}

		#maj_img img {
			margin-left: -2px;
			margin-right: -2px;
			text-align: auto;
			vertical-align: middle;
			position: relative;
		}

		#maj_img img:first-of-type {
			margin-left: 10px;
		}

		#dora {
			margin-left: 30px;
		}
	</style>

</head>

<body>
	<div id="content">
		<div id="majtab">
			<p>输入要生成的牌谱:<a href="#" id="maj_example">(Examples:5z1-11m2-22p-333s44-4z:7z):</a></p>
			<p><input id="user_input" size="40"></p>
			<p>样式: <select id="icontype">
					<option value="cn">中</option>
					<option value="jp" selected="true">日</option>
				</select></p>
			<br />
			<p id="newaddress"></p>
			<p><a href="https://github.com/wangandi520/mahjongImgGenerate">项目地址:
					https://github.com/wangandi520/mahjongImgGenerate</a></p>
			<input id="maj_gen" type="button" value="生成">
			<input id="maj_clearButton" type="button" value="清空">
			<input id="maj_downloadButton" type="button" value="下载">
			<input id="maj_toaddress" type="button" value="生成网址">
			<br />
			<br />
			<div id="maj_img"></div>
			<br />
			<div id="maj_download"></div>
		</div>
		<br />


		<hr />

		<div id="majjp">
			<p>日</p>
			<img src="majjp/0m.png" />
			<img src="majjp/1m.png" />
			<img src="majjp/2m.png" />
			<img src="majjp/3m.png" />
			<img src="majjp/4m.png" />
			<img src="majjp/5m.png" />
			<img src="majjp/6m.png" />
			<img src="majjp/7m.png" />
			<img src="majjp/8m.png" />
			<img src="majjp/9m.png" />
			<br />
			<img src="majjp/0p.png" />
			<img src="majjp/1p.png" />
			<img src="majjp/2p.png" />
			<img src="majjp/3p.png" />
			<img src="majjp/4p.png" />
			<img src="majjp/5p.png" />
			<img src="majjp/6p.png" />
			<img src="majjp/7p.png" />
			<img src="majjp/8p.png" />
			<img src="majjp/9p.png" />
			<br />
			<img src="majjp/0s.png" />
			<img src="majjp/1s.png" />
			<img src="majjp/2s.png" />
			<img src="majjp/3s.png" />
			<img src="majjp/4s.png" />
			<img src="majjp/5s.png" />
			<img src="majjp/6s.png" />
			<img src="majjp/7s.png" />
			<img src="majjp/8s.png" />
			<img src="majjp/9s.png" />
			<br />
			<img src="majjp/1z.png" />
			<img src="majjp/2z.png" />
			<img src="majjp/3z.png" />
			<img src="majjp/4z.png" />
			<img src="majjp/5z.png" />
			<img src="majjp/6z.png" />
			<img src="majjp/7z.png" />
			<img src="majjp/0b.png" />
			<img src="majjp/1b.png" />
		</div>

		<hr />

		<div id="majcn">
			<p>中</p>
			<img src="majcn/1m.png" />
			<img src="majcn/2m.png" />
			<img src="majcn/3m.png" />
			<img src="majcn/4m.png" />
			<img src="majcn/5m.png" />
			<img src="majcn/6m.png" />
			<img src="majcn/7m.png" />
			<img src="majcn/8m.png" />
			<img src="majcn/9m.png" />
			<br />
			<img src="majcn/1p.png" />
			<img src="majcn/2p.png" />
			<img src="majcn/3p.png" />
			<img src="majcn/4p.png" />
			<img src="majcn/5p.png" />
			<img src="majcn/6p.png" />
			<img src="majcn/7p.png" />
			<img src="majcn/8p.png" />
			<img src="majcn/9p.png" />
			<br />
			<img src="majcn/1s.png" />
			<img src="majcn/2s.png" />
			<img src="majcn/3s.png" />
			<img src="majcn/4s.png" />
			<img src="majcn/5s.png" />
			<img src="majcn/6s.png" />
			<img src="majcn/7s.png" />
			<img src="majcn/8s.png" />
			<img src="majcn/9s.png" />
			<br />
			<img src="majcn/1z.png" />
			<img src="majcn/2z.png" />
			<img src="majcn/3z.png" />
			<img src="majcn/4z.png" />
			<img src="majcn/5z.png" />
			<img src="majcn/6z.png" />
			<img src="majcn/7z.png" />
			<img src="majcn/0b.png" />
			<img src="majcn/1b.png" />
			<br />
			<img src="majcn/1x.png" />
			<img src="majcn/2x.png" />
			<img src="majcn/3x.png" />
			<img src="majcn/4x.png" />
			<img src="majcn/5x.png" />
			<img src="majcn/6x.png" />
			<img src="majcn/7x.png" />
			<img src="majcn/8x.png" />
		</div>
		<script type='text/javascript'>
			var saveFile = function (data, filename) {
				var save_link = document.createElementNS('http://www.w3.org/1999/xhtml', 'a');
				save_link.href = data;
				save_link.download = filename;

				var event = document.createEvent('MouseEvents');
				event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
				save_link.dispatchEvent(event);
			};

			$('#maj_example').click(function () {
				$('#user_input').val('5z1-11m2-22p-333s44-4z:7z');
				$('#maj_gen').click();
			})

			$('#maj_gen').click(function () {
				var icontype = $('#icontype').val();
				var rawValue = $('#user_input').val();
				var each = '';
				var checkNumber = /^(\-|\+)?\d{1}$/;
				var checkAlphabet = /^[A-Za-z]*$/;
				var outputValue = new Array();
				var tempNumArray = new Array();
				var dora = '';
				var symbol = '';
				var lasteach = ''
				//牌背数量
				var backCount = 0;
				//图片偏移
				var allOffset = 0;

				//分割宝牌
				if (rawValue.match(':')) {
					todoValue = rawValue.split(':')[0];
					dora = rawValue.split(':')[1];
				}
				else {
					todoValue = rawValue;
				}

				//输入处理
				for (each of todoValue) {
					if (checkNumber.test(symbol + each)) {
						tempNumArray.push(symbol + each)
						symbol = '';
					}
					else if (checkAlphabet.test(each)) {
						var tempEach = new Array();
						for (tempEach of tempNumArray) {
							outputValue.push(tempEach + each)
						}
						tempNumArray = []
					}
					else if (each == '-') {
						symbol = '-';
					}
				}
				each = ''
				$('#maj_img').html('');
				for (each of outputValue) {
					if (each[0] == '-') {
						if (each == lasteach) {
							//暗杠
							$('#maj_img').append('<img class="' + each + '" src="maj' + icontype + '/' + each.substr(1, 2) + '.png" style="transform-origin:left bottom;transform:translateX(-1px) translateY(-72px) rotate(270deg)"/>')
							//$('.rotate2').css('transform-origin','left bottom');
							//$('.rotate2').css('transform','translateX(30px) translateY(-75px) rotate(270deg)');
						}
						else {
							//吃碰
							$('#maj_img').append('<img class="' + each + '" src="maj' + icontype + '/' + each.substr(1, 2) + '.png" style="transform-origin:left bottom;transform:translateX(100px) rotate(270deg);margin-right:33px;"/>')
							//$('.rotate1').css('transform-origin','left bottom');
							//$('.rotate1').css('transform','rotate(270deg)');
						}
					}
					else if ((each == '0b') || (each == '1b')) {
						//牌背，暂不完善
						backCount = backCount + 1;
						if (backCount % 2 == 0) {
							$('#maj_img').append('<img class="' + each + '"  src="maj' + icontype + '/' + each + '.png" style="margin-right:5px;transform:translateX(2px)"/>')
							//$('.rotate3').css('transform','translateX(-35px)');
						}
						else {
							$('#maj_img').append('<img class="' + each + '"  src="maj' + icontype + '/' + each + '.png"  style="margin-right:5px;transform:translateX(2px);"/>');
						}
					}
					else {
						$('#maj_img').append('<img class="' + each + '"  src="maj' + icontype + '/' + each + '.png" style="margin-left:-1px;margin-right:-1px;"/> ');
					}
					lasteach = each;
				}

				//宝牌
				if (dora) {
					$('#maj_img').append('<span id="dora">ドラ</span>');
					$('#maj_img').append('<img class="dora' + dora + '"  src="maj' + icontype + '/' + dora + '.png" style="margin-left:5px"/>')
				}

				//二次整理css

				$('#maj_img img:gt(2)').each(function () {
					if (typeof($(this).prev().prev())  != "undefined"){
						//if (($(this).prev().attr('class')[0] == '-') && ($(this).prev().attr('class') == $(this).prev().prev().attr('class'))){
						if ($(this).prev().attr('class') == $(this).prev().prev().attr('class')){
							if (($(this).prev().attr('class')[0] == '-')){
								console.log($(this).attr('class'));
								$(this).css('transform','translateX(-66px)');
							}
						}
						if ($(this).prev().prev().attr('class') == $(this).prev().prev().prev().attr('class')){
							if (($(this).prev().prev().attr('class')[0] == '-') && ($(this).prev().attr('class') == $(this).attr('class'))){
								console.log($(this).attr('class'));
								$(this).css('transform','translateX(-66px)');
								$(this).prev().css('transform','translateX(-66px)');
								
							}
						}
					}
				});

				//点击图片删除
				$('#maj_img img').on('click', function () {
					$(this).remove();
					if ($(this).attr('class').substring(0, 4) == 'dora') {
						$('#dora').remove();
					}
					var allMaj = new Array();
					$('#maj_img img').each(function () {
						allMaj.push($(this).attr('class'));
					});
					//重新写入文本框

					var newval = ''
					for (each of allMaj) {
						if (each.substring(0, 4) != 'dora') {
							newval = newval + each;
						}
						if (each.substring(0, 4) == 'dora') {
							newval = newval + ':' + each.substring(4, 6);
						}
					}
					$('#user_input').val(newval);
				})
			})

			$('#maj_clearButton').click(function () {
				$('#user_input').val('');
				$('#maj_img').html('');
				$('#maj_download').html('');
			})

			$('#icontype').click(function () {
				$('#maj_gen').click();
			})

			//下载牌谱
			$('#maj_downloadButton').click(function () {
				html2canvas(document.querySelector("#maj_img")).then(canvas => {
					$('#maj_download').html(canvas);
					var pageData = canvas.toDataURL('image/png', 1.0);
					var filename = $('#user_input').val();
					saveFile(pageData.replace("image/png", "image/octet-stream"), filename + ".png");
				});
			})

			//生成网址
			$('#maj_toaddress').click(function () {
				var href = window.location.pathname + '?' + $('#user_input').val();
				$('#newaddress').html('<a href="' + href + '">' + href + '</a>');
			})


			//获取网址的参数并显示出牌谱
			$(document).ready(function () {
				var newhref = window.location.href;
				if (newhref.indexOf('?') > 0) {
					$('#user_input').val(newhref.split('?')[1].split('#')[0]);
					$('#maj_gen').click();
				}


				//点击图片添加
				$('#majjp img,#majcn img').on('click', function () {
					var oldsrc = $(this).attr('src');
					var oldval = $('#user_input').val();
					if (oldval.indexOf(':') > 0) {
						var others = '';
						others = oldval.split(':')[0];
						var dora = oldval.split(':')[1];
						var newval = oldsrc.substring(6, 8)
						$('#user_input').val(others + newval + ':' + dora);
						$('#maj_gen').click();
					}
					else {
						var newval = oldsrc.substring(6, 8)
						$('#user_input').val(oldval + newval);
						$('#maj_gen').click();
					}
				})

				$(document).keydown(function () {
					if (event.keyCode == 13) {//回车键的键值为13
						$('#maj_gen').click();
					}
				});
			});
		</script>
</body>

</html>