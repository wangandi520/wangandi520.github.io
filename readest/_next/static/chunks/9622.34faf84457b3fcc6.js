"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9622],{99622:(e,t,i)=>{i.r(t),i.d(t,{NotFoundError:()=>P,ResponseError:()=>I,UnsupportedTypeError:()=>M,View:()=>ea,makeBook:()=>A});var n=i(96261),r=i(89657),s=i(49033),a=i(80570),l=i(19780),o=i(25842),h=i(84648),c=i(47868);let d=e=>{let t=0,i=e=>{if(e.id=t++,e.subitems)for(let t of e.subitems)i(t)};for(let t of e)i(t);return e},u=e=>e.map(e=>{var t;return(null==(t=e.subitems)?void 0:t.length)?[e,u(e.subitems)].flat():e}).flat();class f{async init(e){let{toc:t,ids:i,splitHref:n,getFragment:r}=e;d(t);let s=u(t),a=new Map;for(let[e,t]of s.entries()){var l;let[i,r]=null!=(l=await n(null==t?void 0:t.href))?l:[],o={fragment:r,item:t};a.has(i)?a.get(i).items.push(o):a.set(i,{prev:s[e-1],items:[o]})}let o=new Map;for(let[e,t]of i.entries())a.has(t)?o.set(t,a.get(t)):o.set(t,o.get(i[e-1]));this.ids=i,this.map=o,this.getFragment=r}getProgress(e,t){if(!this.ids)return;let i=this.ids[e],n=this.map.get(i);if(!n)return null;let{prev:r,items:s}=n;if(!s)return r;if(!t||1===s.length&&!s[0].fragment)return s[0].item;let a=t.startContainer.getRootNode();for(let[e,{fragment:i}]of s.entries()){var l,o;let n=this.getFragment(a,i);if(n&&t.comparePoint(n,0)>0)return null!=(o=null==(l=s[e-1])?void 0:l.item)?o:r}return s[s.length-1].item}}var v=new WeakSet;class w{getProgress(e,t){var i;let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,{sizes:r,sizePerLoc:s,sizePerTimeUnit:a,sizeTotal:l}=this,o=null!=(i=r[e])?i:0,h=r.slice(0,e).reduce((e,t)=>e+t,0)+t*o,c=h+n*o;return{fraction:c/l,section:{current:e,total:r.length},location:{current:Math.floor(h/s),next:Math.floor(c/s),total:Math.ceil(l/s)},time:{section:(1-t)*o/a,total:(l-h)/a}}}getSection(e){if(e<=0)return[0,0];if(e>=1)return[this.sizes.length-1,1];e+=Number.EPSILON;let{sizeTotal:t}=this,i=this.sectionFractions.findIndex(t=>t>e)-1;if(i<0)return[0,0];for(;!this.sizes[i];)i++;let n=(e-this.sectionFractions[i])/(this.sizes[i]/t);return[i,n]}constructor(e,t,i){(0,o._)(this,v),this.sizes=e.map(e=>"no"!=e.linear&&e.size>0?e.size:0),this.sizePerLoc=t,this.sizePerTimeUnit=i,this.sizeTotal=this.sizes.reduce((e,t)=>e+t,0),this.sectionFractions=(0,l._)(this,v,g).call(this)}}function g(){let{sizeTotal:e}=this,t=[0],i=0;for(let n of this.sizes)t.push((i+=n)/e);return t}var p=i(35913);let _=(e,t)=>{let i=[];for(let n=t.currentNode;n;n=t.nextNode()){let t=e.comparePoint(n,0);if(0===t)i.push(n);else if(t>0)break}return i},m=(e,t)=>{let i=[];for(let e=t.nextNode();e;e=t.nextNode())i.push(e);return i},y=NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT|NodeFilter.SHOW_CDATA_SECTION,b=e=>{if(1===e.nodeType){let t=e.tagName.toLowerCase();return"script"===t||"style"===t?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_SKIP}return NodeFilter.FILTER_ACCEPT},k=function*(e,t,i){var n,r;let s=null!=(r=null!=(n=e.commonAncestorContainer)?n:e.body)?r:e,a=document.createTreeWalker(s,y,{acceptNode:i||b}),l=(e.commonAncestorContainer?_:m)(e,a);for(let e of t(l.map(e=>{var t;return null!=(t=e.nodeValue)?t:""}),(e,t,i,n)=>{let r=document.createRange();return r.setStart(l[e],t),r.setEnd(l[i],n),r}))yield e},E="foliate-search:",x=async e=>{let t=new Uint8Array(await e.slice(0,4).arrayBuffer());return 80===t[0]&&75===t[1]&&3===t[2]&&4===t[3]},T=async e=>{let t=new Uint8Array(await e.slice(0,5).arrayBuffer());return 37===t[0]&&80===t[1]&&68===t[2]&&70===t[3]&&45===t[4]},C=e=>{let{name:t,type:i}=e;return"application/vnd.comicbook+zip"===i||t.endsWith(".cbz")},S=e=>{let{name:t,type:i}=e;return"application/x-fictionbook+xml"===i||t.endsWith(".fb2")},F=e=>{let{name:t,type:i}=e;return"application/x-zip-compressed-fb2"===i||t.endsWith(".fb2.zip")||t.endsWith(".fbz")},L=async e=>{let{configure:t,ZipReader:n,BlobReader:r,TextWriter:s,BlobWriter:a}=await i.e(5136).then(i.bind(i,75136));t({useWebWorkers:!1});let l=new n(new r(e)),o=await l.getEntries(),h=new Map(o.map(e=>[e.filename,e])),c=e=>function(t){for(var i=arguments.length,n=Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];return h.has(t)?e(h.get(t),...n):null},d=c(e=>e.getData(new s));return{entries:o,loadText:d,loadBlob:c((e,t)=>e.getData(new a(t))),getSize:e=>{var t,i;return null!=(i=null==(t=h.get(e))?void 0:t.uncompressedSize)?i:0}}},W=async e=>e.isFile?e:(await Promise.all(Array.from(await new Promise((t,i)=>e.createReader().readEntries(e=>t(e),e=>i(e))),W))).flat(),N=async e=>{let t=await W(e),i=new Map((await Promise.all(t.map(e=>new Promise((t,i)=>e.file(i=>t([i,e.fullPath]),e=>i(e)))))).map(t=>{let[i,n]=t;return[n.replace(e.fullPath+"/",""),i]})),n=new TextDecoder,r=e=>e?n.decode(e):null,s=e=>{var t,n;return null!=(n=null==(t=i.get(e))?void 0:t.arrayBuffer())?n:null};return{loadText:async e=>r(await s(e)),loadBlob:e=>i.get(e),getSize:e=>{var t,n;return null!=(n=null==(t=i.get(e))?void 0:t.size)?n:0}}};class I extends Error{}class P extends Error{}class M extends Error{}let z=async e=>{let t=await fetch(e);if(!t.ok)throw new I("".concat(t.status," ").concat(t.statusText),{cause:t});return new File([await t.blob()],new URL(t.url).pathname)},A=async e=>{let t;if("string"==typeof e&&(e=await z(e)),e.isDirectory){let n=await N(e),{EPUB:r}=await i.e(4300).then(i.bind(i,44300));t=await new r(n).init()}else if(e.size)if(await x(e)){let n=await L(e);if(C(e)){let{makeComicBook:r}=await i.e(8531).then(i.bind(i,28531));t=r(n,e)}else if(F(e)){let{makeFB2:e}=await i.e(5796).then(i.bind(i,5796)),{entries:r}=n,s=r.find(e=>e.filename.endsWith(".fb2")),a=await n.loadBlob((null!=s?s:r[0]).filename);t=await e(a)}else{let{EPUB:e}=await i.e(4300).then(i.bind(i,44300));t=await new e(n).init()}}else if(await T(e)){let{makePDF:n}=await i.e(8189).then(i.bind(i,38189));t=await n(e)}else{let{isMOBI:n,MOBI:r}=await i.e(9867).then(i.bind(i,59867));if(await n(e)){let n=await i.e(9393).then(i.bind(i,19393));t=await new r({unzlib:n.unzlibSync}).open(e)}else if(S(e)){let{makeFB2:n}=await i.e(5796).then(i.bind(i,5796));t=await n(e)}}else throw new P("File not found");if(!t)throw new M("File type not supported");return t};var O=new WeakMap,R=new WeakMap,D=new WeakMap,B=new WeakMap;class H{cloneFor(e){return new H(e,(0,n._)(this,D),(0,n._)(this,B))}hide(){(0,n._)(this,R).style.cursor="none",(0,n._)(this,B).hidden=!0}show(){(0,n._)(this,R).style.removeProperty("cursor"),(0,n._)(this,B).hidden=!1}constructor(e,t,i={}){(0,r._)(this,O,{writable:!0,value:void 0}),(0,r._)(this,R,{writable:!0,value:void 0}),(0,r._)(this,D,{writable:!0,value:void 0}),(0,r._)(this,B,{writable:!0,value:void 0}),(0,s._)(this,R,e),(0,s._)(this,D,t),(0,s._)(this,B,i),(0,n._)(this,B).hidden&&this.hide(),(0,n._)(this,R).addEventListener("mousemove",e=>{let{screenX:i,screenY:r}=e;(i!==(0,n._)(this,B).x||r!==(0,n._)(this,B).y)&&((0,n._)(this,B).x=i,(0,n._)(this,B).y=r,this.show(),(0,n._)(this,O)&&clearTimeout((0,n._)(this,O)),t()&&(0,s._)(this,O,setTimeout(this.hide.bind(this),1e3)))},!1)}}var U=new WeakMap,V=new WeakMap;class j extends EventTarget{pushState(e){let t=(0,n._)(this,U)[(0,n._)(this,V)];t===e||null!=t&&t.fraction&&t.fraction===e.fraction||((0,n._)(this,U)[++(0,a._)(this,V).value]=e,(0,n._)(this,U).length=(0,n._)(this,V)+1,this.dispatchEvent(new Event("index-change")))}replaceState(e){let t=(0,n._)(this,V);(0,n._)(this,U)[t]=e}back(){let e=(0,n._)(this,V);if(e<=0)return;let t={state:(0,n._)(this,U)[e-1]};(0,s._)(this,V,e-1),this.dispatchEvent(new CustomEvent("popstate",{detail:t})),this.dispatchEvent(new Event("index-change"))}forward(){let e=(0,n._)(this,V);if(e>=(0,n._)(this,U).length-1)return;let t={state:(0,n._)(this,U)[e+1]};(0,s._)(this,V,e+1),this.dispatchEvent(new CustomEvent("popstate",{detail:t})),this.dispatchEvent(new Event("index-change"))}get canGoBack(){return(0,n._)(this,V)>0}get canGoForward(){return(0,n._)(this,V)<(0,n._)(this,U).length-1}clear(){(0,s._)(this,U,[]),(0,s._)(this,V,-1)}constructor(...e){super(...e),(0,r._)(this,U,{writable:!0,value:[]}),(0,r._)(this,V,{writable:!0,value:-1})}}let G=e=>{if(!e)return{};try{var t,i,n;let r=Intl.getCanonicalLocales(e)[0],s=new Intl.Locale(r),a=["zh","ja","kr"].includes(s.language),l=null==(t=null!=(n=null==(i=s.getTextInfo)?void 0:i.call(s))?n:s.textInfo)?void 0:t.direction;return{canonical:r,locale:s,isCJK:a,direction:l}}catch(e){return console.warn(e),{}}};var J=new WeakMap,K=new WeakMap,X=new WeakMap,q=new WeakMap,Q=new WeakMap,Y=new WeakMap,Z=new WeakSet,$=new WeakSet,ee=new WeakSet,et=new WeakSet,ei=new WeakSet,en=new WeakSet,er=new WeakSet,es=new WeakSet;class ea extends HTMLElement{async open(e){var t,r,a,o;if(("string"==typeof e||"function"==typeof e.arrayBuffer||e.isDirectory)&&(e=await A(e)),this.book=e,this.language=G(null==(t=e.metadata)?void 0:t.language),e.splitTOCHref&&e.getTOCFragment){let t=e.sections.map(e=>e.id);(0,s._)(this,K,new w(e.sections,1500,1600));let i=e.splitTOCHref.bind(e),r=e.getTOCFragment.bind(e);(0,s._)(this,X,new f),await (0,n._)(this,X).init({toc:null!=(a=e.toc)?a:[],ids:t,splitHref:i,getFragment:r}),(0,s._)(this,q,new f),await (0,n._)(this,q).init({toc:null!=(o=e.pageList)?o:[],ids:t,splitHref:i,getFragment:r})}if(this.isFixedLayout=(null==(r=this.book.rendition)?void 0:r.layout)==="pre-paginated",this.isFixedLayout?(await i.e(1457).then(i.bind(i,71457)),this.renderer=document.createElement("foliate-fxl")):(await i.e(141).then(i.bind(i,80141)),this.renderer=document.createElement("foliate-paginator")),this.renderer.setAttribute("exportparts","head,foot,filter,container"),this.renderer.addEventListener("load",e=>(0,l._)(this,ee,eh).call(this,e.detail)),this.renderer.addEventListener("relocate",e=>(0,l._)(this,$,eo).call(this,e.detail)),this.renderer.addEventListener("create-overlayer",e=>e.detail.attach((0,l._)(this,en,eu).call(this,e.detail))),this.renderer.open(e),(0,n._)(this,J).append(this.renderer),e.sections.some(e=>e.mediaOverlay)){let t,i=e.media.activeClass,n=e.media.playbackActiveClass;this.mediaOverlay=e.getMediaOverlay(),this.mediaOverlay.addEventListener("highlight",e=>{let r=this.resolveNavigation(e.detail.text);this.renderer.goTo(r).then(()=>{let{doc:e}=this.renderer.getContents().find(e=>e.index=r.index),s=r.anchor(e);s.classList.add(i),n&&s.ownerDocument.documentElement.classList.add(n),t=new WeakRef(s)})}),this.mediaOverlay.addEventListener("unhighlight",()=>{let e=null==t?void 0:t.deref();e&&(e.classList.remove(i),n&&e.ownerDocument.documentElement.classList.remove(n))})}}close(){var e,t;null==(e=this.renderer)||e.destroy(),null==(t=this.renderer)||t.remove(),(0,s._)(this,K,null),(0,s._)(this,X,null),(0,s._)(this,q,null),(0,s._)(this,Q,new Map),this.lastLocation=null,this.history.clear(),this.tts=null,this.mediaOverlay=null}goToTextStart(){var e,t,i;return this.goTo(null!=(i=null==(t=this.book.landmarks)||null==(e=t.find(e=>e.type.includes("bodymatter")||e.type.includes("text")))?void 0:e.href)?i:this.book.sections.findIndex(e=>"no"!==e.linear))}async init(e){let{lastLocation:t,showTextStart:i}=e,n=t?this.resolveNavigation(t):null;n?(await this.renderer.goTo(n),this.history.pushState(t)):i?await this.goToTextStart():(this.history.pushState(0),await this.next())}async addAnnotation(e,t){var i,r;let{value:s}=e;if(s.startsWith(E)){let e=s.replace(E,""),{index:i,anchor:n}=await this.resolveNavigation(e),r=(0,l._)(this,ei,ed).call(this,i);if(r){let{overlayer:e,doc:i}=r;if(t)return void e.remove(s);let a=i?n(i):n;e.add(s,a,p.u.outline)}return}let{index:a,anchor:o}=await this.resolveNavigation(s),h=(0,l._)(this,ei,ed).call(this,a);if(h){let{overlayer:i,doc:n}=h;if(i.remove(s),!t){let t=n?o(n):o;(0,l._)(this,Z,el).call(this,"draw-annotation",{draw:(e,n)=>i.add(s,t,e,n),annotation:e,doc:n,range:t})}}let c=null!=(r=null==(i=(0,n._)(this,X).getProgress(a))?void 0:i.label)?r:"";return{index:a,label:c}}deleteAnnotation(e){return this.addAnnotation(e,!0)}async showAnnotation(e){let{value:t}=e,i=await this.goTo(t);if(i){let{index:e,anchor:n}=i,{doc:r}=(0,l._)(this,ei,ed).call(this,e),s=n(r);(0,l._)(this,Z,el).call(this,"show-annotation",{value:t,index:e,range:s})}}getCFI(e,t){var i;let n=null!=(i=this.book.sections[e].cfi)?i:c.fake.fromIndex(e);return t?c.joinIndir(n,c.fromRange(t)):n}resolveCFI(e){if(this.book.resolveCFI)return this.book.resolveCFI(e);{var t;let i=c.parse(e);return{index:c.fake.toIndex((null!=(t=i.parent)?t:i).shift()),anchor:e=>c.toRange(e,i)}}}resolveNavigation(e){try{if("number"==typeof e)return{index:e};if("number"==typeof e.fraction){let[t,i]=(0,n._)(this,K).getSection(e.fraction);return{index:t,anchor:i}}if(c.isCFI.test(e))return this.resolveCFI(e);return this.book.resolveHref(e)}catch(t){console.error(t),console.error("Could not resolve target ".concat(e))}}async goTo(e){let t=this.resolveNavigation(e);try{return await this.renderer.goTo(t),this.history.pushState(e),t}catch(t){console.error(t),console.error("Could not go to ".concat(e))}}async goToFraction(e){let[t,i]=(0,n._)(this,K).getSection(e);await this.renderer.goTo({index:t,anchor:i}),this.history.pushState({fraction:e})}async select(e){try{let t=await this.resolveNavigation(e);await this.renderer.goTo({...t,select:!0}),this.history.pushState(e)}catch(t){console.error(t),console.error("Could not go to ".concat(e))}}deselect(){for(let{doc:e}of this.renderer.getContents())e.defaultView.getSelection().removeAllRanges()}getSectionFractions(){var e,t;return(null!=(t=null==(e=(0,n._)(this,K))?void 0:e.sectionFractions)?t:[]).map(e=>e+Number.EPSILON)}getProgressOf(e,t){var i,r;return{tocItem:null==(i=(0,n._)(this,X))?void 0:i.getProgress(e,t),pageItem:null==(r=(0,n._)(this,q))?void 0:r.getProgress(e,t)}}async getTOCItemOf(e){try{let{index:t,anchor:i}=await this.resolveNavigation(e),r=await this.book.sections[t].createDocument(),s=i(r),a=s instanceof Range,l=a?s:r.createRange();return a||l.selectNodeContents(s),(0,n._)(this,X).getProgress(t,l)}catch(t){console.error(t),console.error("Could not get ".concat(e))}}async prev(e){await this.renderer.prev(e)}async next(e){await this.renderer.next(e)}goLeft(){return"rtl"===this.book.dir?this.next():this.prev()}goRight(){return"rtl"===this.book.dir?this.prev():this.next()}async *search(e){this.clearSearch();let{searchMatcher:t}=await i.e(9646).then(i.bind(i,49646)),{query:r,index:s}=e,a=t(k,{defaultLocale:this.language,...e}),o=null!=s?(0,l._)(this,er,ef).call(this,a,r,s):(0,l._)(this,es,ev).call(this,a,r),h=[];for await(let e of((0,n._)(this,Q).set(s,h),o))if(e.subitems){var c,d;let t=e.subitems.map(e=>{let{cfi:t}=e;return{value:E+t}});for(let i of((0,n._)(this,Q).set(e.index,t),t))this.addAnnotation(i);yield{label:null!=(d=null==(c=(0,n._)(this,X).getProgress(e.index))?void 0:c.label)?d:"",subitems:e.subitems}}else{if(e.cfi){let t={value:E+e.cfi};h.push(t),this.addAnnotation(t)}yield e}yield"done"}clearSearch(){for(let e of(0,n._)(this,Q).values())for(let t of e)this.deleteAnnotation(t);(0,n._)(this,Q).clear()}async initTTS(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"word",t=this.renderer.getContents()[0].doc;if(this.tts&&this.tts.doc===t)return;let{TTS:n}=await i.e(9543).then(i.bind(i,19543));this.tts=new n(t,k,e=>this.renderer.scrollToAnchor(e,!0),e)}startMediaOverlay(){let{index:e}=this.renderer.getContents()[0];return this.mediaOverlay.start(e)}constructor(){super(),(0,o._)(this,Z),(0,o._)(this,$),(0,o._)(this,ee),(0,o._)(this,et),(0,o._)(this,ei),(0,o._)(this,en),(0,o._)(this,er),(0,o._)(this,es),(0,r._)(this,J,{writable:!0,value:this.attachShadow({mode:"open"})}),(0,r._)(this,K,{writable:!0,value:void 0}),(0,r._)(this,X,{writable:!0,value:void 0}),(0,r._)(this,q,{writable:!0,value:void 0}),(0,r._)(this,Q,{writable:!0,value:new Map}),(0,r._)(this,Y,{writable:!0,value:new H(this,()=>this.hasAttribute("autohide-cursor"))}),(0,h._)(this,"isFixedLayout",!1),(0,h._)(this,"lastLocation",void 0),(0,h._)(this,"history",new j),this.history.addEventListener("popstate",e=>{let{detail:t}=e,i=this.resolveNavigation(t.state);this.renderer.goTo(i)})}}function el(e,t,i){return this.dispatchEvent(new CustomEvent(e,{detail:t,cancelable:i}))}function eo(e){var t,i,r,s;let{reason:a,range:o,index:h,fraction:c,size:d}=e,u=null!=(s=null==(t=(0,n._)(this,K))?void 0:t.getProgress(h,c,d))?s:{},f=null==(i=(0,n._)(this,X))?void 0:i.getProgress(h,o),v=null==(r=(0,n._)(this,q))?void 0:r.getProgress(h,o),w=this.getCFI(h,o);this.lastLocation={...u,tocItem:f,pageItem:v,cfi:w,range:o},("snap"===a||"page"===a||"scroll"===a)&&this.history.replaceState(w),(0,l._)(this,Z,el).call(this,"relocate",this.lastLocation)}function eh(e){var t,i,r,s;let{doc:a,index:o}=e;(t=a.documentElement).lang||(t.lang=null!=(r=this.language.canonical)?r:""),!this.language.isCJK&&((i=a.documentElement).dir||(i.dir=null!=(s=this.language.direction)?s:"")),(0,l._)(this,et,ec).call(this,a,o),(0,n._)(this,Y).cloneFor(a.documentElement),(0,l._)(this,Z,el).call(this,"load",{doc:a,index:o})}function ec(e,t){let{book:i}=this,n=i.sections[t];e.addEventListener("click",e=>{var t,r,s;let a=e.target.closest("a[href]");if(!a)return;e.preventDefault();let o=a.getAttribute("href"),h=null!=(s=null==n||null==(t=n.resolveHref)?void 0:t.call(n,o))?s:o;(null==i||null==(r=i.isExternal)?void 0:r.call(i,h))?Promise.resolve((0,l._)(this,Z,el).call(this,"external-link",{a,href:h},!0)).then(e=>e?globalThis.open(h,"_blank"):null).catch(e=>console.error(e)):Promise.resolve((0,l._)(this,Z,el).call(this,"link",{a,href:h},!0)).then(e=>e?this.goTo(h):null).catch(e=>console.error(e))})}function ed(e){return this.renderer.getContents().find(t=>t.index===e&&t.overlayer)}function eu(e){let{doc:t,index:i}=e,r=new p.u(t);t.addEventListener("click",e=>{let[t,n]=r.hitTest(e);t&&!t.startsWith(E)&&(0,l._)(this,Z,el).call(this,"show-annotation",{value:t,index:i,range:n})},!1);let s=(0,n._)(this,Q).get(i);if(s)for(let e of s)this.addAnnotation(e);return(0,l._)(this,Z,el).call(this,"create-overlay",{index:i}),r}async function*ef(e,t,i){for(let{range:n,excerpt:r}of e(await this.book.sections[i].createDocument(),t))yield{cfi:this.getCFI(i,n),excerpt:r}}async function*ev(e,t){let{sections:i}=this.book;for(let[n,{createDocument:r}]of i.entries()){if(!r)continue;let s=Array.from(e(await r(),t),e=>{let{range:t,excerpt:i}=e;return{cfi:this.getCFI(n,t),excerpt:i}}),a=(n+1)/i.length;yield{progress:a},s.length&&(yield{index:n,subitems:s})}}customElements.define("foliate-view",ea)}}]);