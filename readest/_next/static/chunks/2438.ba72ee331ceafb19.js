"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2438],{1487:(t,e,a)=>{a.d(e,{T:()=>P,g:()=>S});var i=a(96261),n=a(89657),o=a(49033),s=a(19780),r=a(25842),l=a(84648),h=a(72897),c=a(50981),d=new WeakMap,u=new WeakMap;class w extends Blob{async arrayBuffer(){return await (0,i._)(this,d)}async text(){let t=await (0,i._)(this,d);return new TextDecoder().decode(t)}stream(){return new ReadableStream({start:async t=>{let e=await (0,i._)(this,d),a=new ReadableStream({start(t){t.enqueue(new Uint8Array(e)),t.close()}}).getReader(),n=()=>a.read().then(e=>{let{done:a,value:i}=e;return a?(t.close(),Promise.resolve()):(t.enqueue(i),n())});return n()}})}get type(){return(0,i._)(this,u)}constructor(t,e){super(),(0,n._)(this,d,{writable:!0,value:void 0}),(0,n._)(this,u,{writable:!0,value:void 0}),(0,o._)(this,d,t),(0,o._)(this,u,e)}}var f=new WeakMap,p=new WeakMap,g=new WeakMap,_=new WeakMap,m=new WeakMap,y=new WeakMap,k=new WeakMap,v=new WeakMap,x=new WeakMap,b=new WeakSet,B=new WeakSet;class S extends File{async open(){(0,o._)(this,f,await (0,h.ho)((0,i._)(this,p),(0,i._)(this,_)?{baseDir:(0,i._)(this,_)}:void 0));let t=await (0,i._)(this,f).stat();return(0,o._)(this,y,t.size),(0,o._)(this,m,t.mtime?t.mtime.getTime():Date.now()),this}async close(){(0,i._)(this,f)&&(await (0,i._)(this,f).close(),(0,o._)(this,f,null)),(0,i._)(this,v).clear(),(0,o._)(this,x,[])}get name(){return(0,i._)(this,g)}get type(){return(0,i._)(this,k)}get size(){return(0,i._)(this,y)}get lastModified(){return(0,i._)(this,m)}async stat(){var t;return null==(t=(0,i._)(this,f))?void 0:t.stat()}async seek(t,e){if(!(0,i._)(this,f))throw Error("File handle is not open");return(0,i._)(this,f).seek(t,e)}async readData(t,e){if(!(0,i._)(this,f))throw Error("File handle is not open");let a=(e=Math.max(t=Math.max(0,t),Math.min(this.size,e)))-t;if(a>S.MAX_CACHE_CHUNK_SIZE){await (0,i._)(this,f).seek(t,h.mf.Start);let e=new Uint8Array(a);return await (0,i._)(this,f).read(e),e.buffer}let n=Array.from((0,i._)(this,v).keys()).find(a=>{let n=(0,i._)(this,v).get(a);return t>=a&&e<=a+n.byteLength});if(void 0!==n){(0,s._)(this,b,A).call(this,n);let e=(0,i._)(this,v).get(n),o=t-n;return e.slice(o,o+a)}let o=Math.max(0,t-1024),r=Math.min(this.size,o+S.MAX_CACHE_CHUNK_SIZE)-o;await (0,i._)(this,f).seek(o,h.mf.Start);let l=new Uint8Array(r);await (0,i._)(this,f).read(l),(0,i._)(this,v).set(o,l.buffer),(0,s._)(this,b,A).call(this,o),(0,s._)(this,B,C).call(this);let c=t-o;return l.buffer.slice(c,c+a)}slice(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.size,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.type;return new w(this.readData(t,e),a)}stream(){let t=0;return new ReadableStream({pull:async e=>{if(!(0,i._)(this,f))return void e.error(Error("File handle is not open"));if(t>=this.size)return void e.close();let a=new Uint8Array(Math.min(t+1048576,this.size)-t);await (0,i._)(this,f).seek(t,h.mf.Start);let n=await (0,i._)(this,f).read(a);if(null===n||0===n)return void e.close();e.enqueue(a.subarray(0,n)),t+=n},cancel:async()=>{var t;await (null==(t=(0,i._)(this,f))?void 0:t.close())}})}async text(){return this.slice(0,this.size).text()}async arrayBuffer(){return this.slice(0,this.size).arrayBuffer()}constructor(t,e,a=null,i=""){super([],e||t,{type:i}),(0,r._)(this,b),(0,r._)(this,B),(0,n._)(this,f,{writable:!0,value:null}),(0,n._)(this,p,{writable:!0,value:void 0}),(0,n._)(this,g,{writable:!0,value:void 0}),(0,n._)(this,_,{writable:!0,value:void 0}),(0,n._)(this,m,{writable:!0,value:0}),(0,n._)(this,y,{writable:!0,value:-1}),(0,n._)(this,k,{writable:!0,value:""}),(0,n._)(this,v,{writable:!0,value:new Map}),(0,n._)(this,x,{writable:!0,value:[]}),(0,o._)(this,p,t),(0,o._)(this,_,a),(0,o._)(this,g,e||t)}}function A(t){let e=(0,i._)(this,x).indexOf(t);e>-1&&(0,i._)(this,x).splice(e,1),(0,i._)(this,x).unshift(t)}function C(){for(;(0,i._)(this,v).size>S.MAX_CACHE_ITEMS_SIZE;){let t=(0,i._)(this,x).pop();void 0!==t&&(0,i._)(this,v).delete(t)}}(0,l._)(S,"MAX_CACHE_CHUNK_SIZE",1048576),(0,l._)(S,"MAX_CACHE_ITEMS_SIZE",20);var E=new WeakMap,D=new WeakMap,M=new WeakMap,F=new WeakMap,I=new WeakMap,U=new WeakMap,T=new WeakSet,N=new WeakSet,z=new WeakSet;class P extends File{get name(){return(0,i._)(this,E)}get type(){return(0,i._)(this,F)}get size(){return(0,i._)(this,M)}get lastModified(){return(0,i._)(this,D)}async _open_with_head(){let t=await fetch(this.url,{method:"HEAD"});if(!t.ok)throw Error("Failed to fetch file size: ".concat(t.status));return(0,o._)(this,M,Number(t.headers.get("content-length"))),(0,o._)(this,F,t.headers.get("content-type")||""),this}async _open_with_range(){var t;let e=await fetch(this.url,{headers:{Range:"bytes=".concat(0,"-",1023)}});if(!e.ok)throw Error("Failed to fetch file size: ".concat(e.status));return(0,o._)(this,M,Number(null==(t=e.headers.get("content-range"))?void 0:t.split("/")[1])),(0,o._)(this,F,e.headers.get("content-type")||""),this}async open(){return"android"===(0,c.Ox)()?this._open_with_range():this._open_with_head()}async close(){(0,i._)(this,I).clear(),(0,o._)(this,U,[])}async fetchRangePart(t,e){t=Math.max(0,t),e=Math.min(this.size-1,e);let a=await fetch(this.url,{headers:{Range:"bytes=".concat(t,"-").concat(e)}});if(!a.ok)throw Error("Failed to fetch range: ".concat(a.status));return a.arrayBuffer()}async fetchRange(t,e){let a=e-t+1;if(a>1024e3){let a=[];for(let i=t;i<=e;i+=1024e3){let t=Math.min(i+1024e3-1,e);a.push(await this.fetchRangePart(i,t))}let i=new Uint8Array(a.reduce((t,e)=>t+e.byteLength,0)),n=0;for(let t of a)i.set(new Uint8Array(t),n),n+=t.byteLength;return i.buffer}{if(a>P.MAX_CACHE_CHUNK_SIZE)return this.fetchRangePart(t,e);let n=Array.from((0,i._)(this,I).keys()).find(a=>{let n=(0,i._)(this,I).get(a).byteLength;return t>=a&&e<=a+n});if(void 0!==n){(0,s._)(this,N,L).call(this,n);let e=(0,i._)(this,I).get(n),o=t-n;return e.slice(o,o+a)}n=await (0,s._)(this,T,O).call(this,t,e);let o=(0,i._)(this,I).get(n),r=t-n;return o.slice(r,r+a)}}slice(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.size,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.type;return new w(this.fetchRange(t,e-1),a)}async text(){return this.slice(0,this.size).text()}async arrayBuffer(){return this.slice(0,this.size).arrayBuffer()}constructor(t,e,a="",i=Date.now()){let s=t.split("/").pop()||"remote-file";super([],e||s,{type:a,lastModified:i}),(0,r._)(this,T),(0,r._)(this,N),(0,r._)(this,z),(0,l._)(this,"url",void 0),(0,n._)(this,E,{writable:!0,value:void 0}),(0,n._)(this,D,{writable:!0,value:void 0}),(0,n._)(this,M,{writable:!0,value:-1}),(0,n._)(this,F,{writable:!0,value:""}),(0,n._)(this,I,{writable:!0,value:new Map}),(0,n._)(this,U,{writable:!0,value:[]}),this.url=t,(0,o._)(this,E,e||s),(0,o._)(this,F,a),(0,o._)(this,D,i)}}async function O(t,e){let a=Math.max(0,t-1024),n=Math.max(e,t+P.MAX_CACHE_CHUNK_SIZE-1024-1);return(0,i._)(this,I).set(a,await this.fetchRangePart(a,n)),(0,s._)(this,N,L).call(this,a),(0,s._)(this,z,W).call(this),a}function L(t){let e=(0,i._)(this,U).indexOf(t);e>-1&&(0,i._)(this,U).splice(e,1),(0,i._)(this,U).unshift(t)}function W(){for(;(0,i._)(this,I).size>P.MAX_CACHE_ITEMS_SIZE;){let t=(0,i._)(this,U).pop();void 0!==t&&(0,i._)(this,I).delete(t)}}(0,l._)(P,"MAX_CACHE_CHUNK_SIZE",131072),(0,l._)(P,"MAX_CACHE_ITEMS_SIZE",10)},2675:(t,e,a)=>{a.d(e,{ND:()=>r});var i=a(21029),n=a(79336);let o=n.env.NEXT_PUBLIC_SUPABASE_URL||"https://gxkhxxxeapexynpouyjz.supabase.co",s=n.env.NEXT_PUBLIC_SUPABASE_ANON_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4a2h4eHhlYXBleHlucG91eWp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ0MzAwNTksImV4cCI6MjA1MDAwNjA1OX0.jhinkQsimQoidsg_U59YD5ROw4PmMJQNKuyXbr4TiQA",r=(0,i.UU)(o,s)},8783:(t,e,a)=>{a.d(e,{v:()=>n});var i=a(28039);let n=async(t,e)=>{let a=await (0,i.iD)();if(!a)throw Error("Not authenticated");let n={...e.headers,Authorization:"Bearer ".concat(a)},o=await fetch(t,{...e,headers:n});if(!o.ok){let t=await o.json();throw console.error("Error:",t.error||o.statusText),Error(t.error||"Request failed")}return o}},21013:(t,e,a)=>{a.d(e,{Q:()=>n,z:()=>o});let i="translationDailyUsage",n=(t,e)=>{{let a=e||new Date().toISOString().split("T")[0];localStorage.setItem(i,JSON.stringify({[a]:t}))}},o=t=>{{let e=t||new Date().toISOString().split("T")[0],a=localStorage.getItem(i);if(a){let t=JSON.parse(a);if(t[e])return t[e]}}return null}},28039:(t,e,a)=>{a.d(e,{Bg:()=>d,Fk:()=>w,iD:()=>u,l3:()=>h,r2:()=>c});var i=a(88744),n=a(2675),o=a(40965),s=a(69921),r=a(21013),l=a(79336);let h=t=>((0,i.s)(t)||{}).plan||"free",c=t=>{let e=(0,i.s)(t)||{},a=e.plan||"free",n=e.storage_usage_bytes||0,s=parseInt(l.env.NEXT_PUBLIC_STORAGE_FIXED_QUOTA||"0")||o.zW[a]||o.zW.free;return{plan:a,usage:n,quota:s}},d=t=>{let e=((0,i.s)(t)||{}).plan||"free",a=(0,r.z)()||0,n=o.Vz[e];return{plan:e,usage:a,quota:n}},u=async()=>{var t,e,a;if((0,s.hx)())return null!=(e=localStorage.getItem("token"))?e:null;let{data:i}=await n.ND.auth.getSession();return null!=(a=null==i||null==(t=i.session)?void 0:t.access_token)?a:null},w=async()=>{var t,e,a,i,o;if((0,s.hx)())return null!=(i=JSON.parse(null!=(a=localStorage.getItem("user"))?a:"{}").id)?i:null;let{data:r}=await n.ND.auth.getSession();return null!=(o=null==r||null==(e=r.session)||null==(t=e.user)?void 0:t.id)?o:null}},72997:(t,e,a)=>{a.d(e,{Lg:()=>i,ub:()=>n});let i=(t,e,a)=>{let i=(t=JSON.parse(JSON.stringify(t))).viewSettings,n=t.searchConfig;return t.viewSettings=Object.entries(i).reduce((t,a)=>{let[i,n]=a;return e[i]!==n&&(t[i]=n),t},{}),t.searchConfig=Object.entries(n).reduce((t,e)=>{let[i,n]=e;return a[i]!==n&&(t[i]=n),t},{}),JSON.stringify(t)},n=(t,e,a)=>{var i;let n=JSON.parse(t),{viewSettings:o,searchConfig:s}=n;return n.viewSettings={...e,...o},n.searchConfig={...a,...s},null!=n.updatedAt||(n.updatedAt=Date.now()),n}},81622:(t,e,a)=>{a.d(e,{E:()=>C});var i=a(84648),n=a(58529),o=a(45375),s=a(3189),r=a(40965),l=a(50981),h=a(72997),c=a(69921),d=a(28039),u=a(8783),w=a(83090);let f={upload:(0,c.L1)()+"/storage/upload",download:(0,c.L1)()+"/storage/download",delete:(0,c.L1)()+"/storage/delete"},p=(t,e,a)=>i=>{let n=i.progress/i.total,o=(e.count+n)/t*100;a&&a({progress:o,total:100,transferSpeed:i.transferSpeed})},g=async(t,e,a,i)=>{try{let n=await (0,u.v)(f.upload,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileName:t.name,fileSize:t.size,bookHash:i})}),{uploadUrl:o}=await n.json();(0,c.hx)()?await (0,w.WC)(t,o,a):await (0,w.Bq)(o,e,"PUT",a)}catch(t){if(console.error("File upload failed:",t),t instanceof Error)throw t;throw Error("File upload failed")}},_=async(t,e,a)=>{try{let i=await (0,d.Fk)();if(!i)throw Error("Not authenticated");let n="".concat(i,"/").concat(t),o=await (0,u.v)("".concat(f.download,"?fileKey=").concat(encodeURIComponent(n)),{method:"GET"}),{downloadUrl:s}=await o.json();if((0,c.hx)())return await (0,w.B6)(s,a);return void await (0,w.e2)(s,e,a)}catch(e){throw console.error("File '".concat(t,"' download failed:"),e),Error("File download failed")}},m=async t=>{try{let e=await (0,d.Fk)();if(!e)throw Error("Not authenticated");let a="".concat(e,"/").concat(t);await (0,u.v)("".concat(f.delete,"?fileKey=").concat(encodeURIComponent(a)),{method:"DELETE"})}catch(t){throw console.error("File deletion failed:",t),Error("File deletion failed")}};var y=a(88642);function k(){let t=(0,y._)(["(?:^|\n|s)"],["(?:^|\\n|\\s)"]);return k=function(){return t},t}function v(){let t=(0,y._)(["第[零〇一二三四五六七八九十0-9][零〇一二三四五六七八九十百千万0-9]*(?:[章卷节回讲篇封])(?:[：:、 　()0-9]*[^\n-]{0,24})(?!S)"],["第[零〇一二三四五六七八九十0-9][零〇一二三四五六七八九十百千万0-9]*(?:[章卷节回讲篇封])(?:[：:、 　\\(\\)0-9]*[^\\n-]{0,24})(?!\\S)"]);return v=function(){return t},t}function x(){let t=(0,y._)(["(?:^|\n|s|《[^》]+》)[一二三四五六七八九十][零〇一二三四五六七八九十百千万]*(?:[：: 　][^\n-]{0,24})(?!S)"],["(?:^|\\n|\\s|《[^》]+》)[一二三四五六七八九十][零〇一二三四五六七八九十百千万]*(?:[：: 　][^\\n-]{0,24})(?!\\S)"]);return x=function(){return t},t}function b(){let t=(0,y._)(["(?:楔子|前言|引言|序言|序章|总论|概论)(?:[：: 　][^\n-]{0,24})?(?!S)"],["(?:楔子|前言|引言|序言|序章|总论|概论)(?:[：: 　][^\\n-]{0,24})?(?!\\S)"]);return b=function(){return t},t}let B={lastAccessDate:new Date(0),lastModDate:new Date(0)},S=t=>t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;"):"";class A{async convert(t){let{file:e,author:a,language:i}=t,s=await e.arrayBuffer(),r=new TextDecoder(this.detectEncoding(s)||"utf-8").decode(s).trim(),l=this.extractBookTitle((0,n.t7)(e.name)),h="".concat(l,".epub"),c=r.slice(0,1024),d=c.match(/[【\[]?作者[】\]]?[:：\s]\s*(.+)\r?\n/)||c.match(/[【\[]?\s*(.+)\s+著\s*[】\]]?\r?\n/),u=d?d[1].trim():a||"",w=i||this.detectLanguage(c),f={bookTitle:l,author:u,language:w,identifier:await (0,o.Yw)(e)},p=[];for(let t=4;t>=3;t--){if(0===(p=this.extractChapters(r,f,{linesBetweenSegments:t})).length)throw Error("No chapters detected.");if(p.length>1)break}return 1===p.length&&(p=this.extractChapters(r,f,{linesBetweenSegments:4,paragraphsPerChapter:100})),{file:new File([await this.createEpub(p,f)],h),bookTitle:l,chapterCount:p.length,language:w}}extractChapters(t,e,a){let i,{language:n}=e,{linesBetweenSegments:o,paragraphsPerChapter:s}=a,r=new RegExp("(?:\\r?\\n){".concat(o,",}|-{8,}\r?\n"));i="zh"===n?RegExp(String.raw(k())+"("+[String.raw(v()),String.raw(x()),String.raw(b())].join("|")+")","gu"):/(?:^|\n|\s)(?:(Chapter|Part)\s+(\d+|[IVXLCDM]+)(?:[:.\-–—]?\s+[^\n]*)?|(?:Prologue|Epilogue|Introduction|Foreword)(?:[:.\-–—]?\s+[^\n]*)?)(?=\s|$)/gi;let l=t=>(t=S(t)).replace(/-{8,}|_{8,}/g,"\n").split(/\n+/).map(t=>t.trim()).filter(t=>t).join("</p><p>"),h=t=>t.reduce((t,e,a,i)=>(void 0===e&&a>0&&a<i.length-1&&void 0!==i[a-1]&&void 0!==i[a+1]?t[t.length-1]+=i[a+1]:void 0!==e&&(0===a||void 0!==i[a-1])&&t.push(e),t),[]),c=[];for(let e of t.split(r)){let t=e.replace(/<!--.*?-->/g,"").trim();if(!t)continue;if(s&&s>0){let e=t.split(/\n+/),a=e.length;for(let t=0;t<a;t+=s){let a=l(e.slice(t,t+s).join("\n")),i="".concat(c.length+1),n="<h2>".concat(i,"</h2><p>").concat(a,"</p>");c.push({title:i,content:n})}continue}let a=[],o=h(t.split(i));for(let t=1;t<o.length;t+=2){var d,u;let e=(null==(d=o[t])?void 0:d.trim())||"",i=(null==(u=o[t+1])?void 0:u.trim())||"",s=!1,r=("zh"===n?/第[零〇一二三四五六七八九十百千万0-9]+卷/.test(e):/\b(Part|Volume|Book)\b/i.test(e))?"<h1>".concat(e,"</h1>"):"<h2>".concat(e,"</h2>"),h=l(i);a.push({title:S(e),content:"".concat(r,"<p>").concat(h,"</p>")})}if(o[0]&&o[0].trim()){let t=o[0].trim(),e=t.split("\n")[0].trim(),i=(e.length>16?t.split(RegExp("[\\n\\s\\p{P}]","u"))[0].trim():e)||t.slice(0,16),n=l(t);a.unshift({title:S(i),content:"<h3></h3><p>".concat(n,"</p>")})}c.push(...a)}return c}async createEpub(t,e){let{BlobWriter:i,TextReader:n,ZipWriter:o}=await a.e(2363).then(a.bind(a,92363)),{bookTitle:s,author:r,language:l,identifier:h}=e,c=new o(new i("application/epub+zip"),{extendedTimestamp:!1});await c.add("mimetype",new n("application/epub+zip"),B),await c.add("META-INF/container.xml",new n('<?xml version="1.0" encoding="UTF-8"?>\n    <container xmlns="urn:oasis:names:tc:opendocument:xmlns:container" version="1.0">\n      <rootfiles>\n        <rootfile full-path="content.opf" media-type="application/oebps-package+xml"/>\n      </rootfiles>\n    </container>'.trim()),B);let d=t.map((t,e)=>{let a="chapter".concat(e+1);return'\n        <navPoint id="navPoint-'.concat(a,'" playOrder="').concat(e+1,'">\n          <navLabel>\n            <text>').concat(t.title,'</text>\n          </navLabel>\n          <content src="./OEBPS/').concat(a,'.xhtml" />\n        </navPoint>\n      ').trim()}).join("\n"),u='<?xml version="1.0" encoding="UTF-8"?>\n    <ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">\n      <head>\n        <meta name="dtb:uid" content="book-id" />\n        <meta name="dtb:depth" content="1" />\n        <meta name="dtb:totalPageCount" content="0" />\n        <meta name="dtb:maxPageNumber" content="0" />\n      </head>\n      <docTitle>\n        <text>'.concat(S(s),"</text>\n      </docTitle>\n      <docAuthor>\n        <text>").concat(S(r),"</text>\n      </docAuthor>\n      <navMap>\n        ").concat(d,"\n      </navMap>\n    </ncx>").trim();await c.add("toc.ncx",new n(u),B);let w=t.map((t,e)=>'\n      <item id="chap'.concat(e+1,'" href="OEBPS/chapter').concat(e+1,'.xhtml" media-type="application/xhtml+xml"/>\n    ')).join("\n").trim(),f=t.map((t,e)=>'\n      <itemref idref="chap'.concat(e+1,'"/>')).join("\n").trim();await c.add("style.css",new n("\n      body { line-height: 1.6; font-size: 1em; font-family: 'Arial', sans-serif; text-align: justify; }\n      p { text-indent: 2em; margin: 0; }\n    "),B);for(let e=0;e<t.length;e++){let a=t[e],i='<?xml version="1.0" encoding="UTF-8"?>\n        <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">\n        <html xmlns="http://www.w3.org/1999/xhtml" lang="zh">\n          <head>\n            <title>'.concat(a.title,'</title>\n            <link rel="stylesheet" type="text/css" href="../style.css"/>\n          </head>\n          <body>').concat(a.content,"</body>\n        </html>").trim();await c.add("OEBPS/chapter".concat(e+1,".xhtml"),new n(i),B)}let p='<?xml version="1.0" encoding="UTF-8"?>\n      <package xmlns="http://www.idpf.org/2007/opf" unique-identifier="book-id" version="2.0">\n        <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">\n          <dc:title>'.concat(S(s),"</dc:title>\n          <dc:language>").concat(l,"</dc:language>\n          <dc:creator>").concat(S(r),'</dc:creator>\n          <dc:identifier id="book-id">').concat(h,"</dc:identifier>\n        </metadata>\n        <manifest>\n          ").concat(w,"\n          ").concat('<item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>','\n        </manifest>\n        <spine toc="ncx">\n          ').concat(f,"\n        </spine>\n      </package>").trim();return await c.add("content.opf",new n(p),B),await c.close()}detectEncoding(t){try{return new TextDecoder("utf-8",{fatal:!0}).decode(t),"utf-8"}catch(t){}let e=new Uint8Array(t.slice(0,4));if(255===e[0]&&254===e[1])return"utf-16le";if(254===e[0]&&255===e[1])return"utf-16be";if(239===e[0]&&187===e[1]&&191===e[2])return"utf-8";let a=new Uint8Array(t.slice(0,Math.min(1024,t.byteLength))),i=0;for(let t=0;t<a.length;t++)a[t]>=128&&i++;let n=i/a.length;if(n>.3)return"gbk";if(n>.1){let t=!1;for(let e=0;e<a.length-1;e++){let i=a[e],n=a[e+1];if((i>=129&&i<=159||i>=224&&i<=252)&&(n>=64&&n<=126||n>=128&&n<=252)){t=!0;break}}return t?"shift-jis":"gb18030"}return"utf-8"}detectLanguage(t){let e=0;for(let a=0;a<t.length;a++){let i=t.charCodeAt(a);(i>=19968&&i<=40959||i>=13312&&i<=19903||i>=131072&&i<=173791)&&e++}return e/t.length>.05?"zh":"en"}extractBookTitle(t){let e=t.match(/《([^》]+)》/);return e?e[1]:t.split(".")[0]}}class C{async loadSettings(){let t,{fp:e,base:a}=this.resolvePath("settings.json","Settings");try{var i;await this.fs.exists(e,a);let n=await this.fs.readFile(e,a,"text"),o=null!=(i=(t=JSON.parse(n)).version)?i:0;(this.isAppDataSandbox||o<r.B5)&&(t.localBooksDir=await this.getInitBooksDir(),t.version=r.B5),(t={...r.u7,...t}).globalReadSettings={...r.u$,...t.globalReadSettings},t.globalViewSettings={...r.hU,...r.Ow,...r.Y6,...this.isMobile?r.Pf:{},...(0,l.ii)()?r.lt:{},...r.ZK,...r.Ff,...r.e5,...{...r.W_,translateTargetLang:(0,l.mj)()},...t.globalViewSettings}}catch(i){t={...r.u7,version:r.B5,localBooksDir:await this.getInitBooksDir(),globalReadSettings:{...r.u$,...this.isMobile?r.NR:{}},globalViewSettings:{...r.hU,...r.Ow,...r.Y6,...this.isMobile?r.Pf:{},...(0,l.ii)()?r.lt:{},...r.ZK,...r.Ff,...r.e5,...{...r.W_,translateTargetLang:(0,l.mj)()}}},await this.fs.createDir("","Books",!0),await this.fs.createDir("",a,!0),await this.fs.writeFile(e,a,JSON.stringify(t))}this.localBooksDir=t.localBooksDir;let n=await this.getCacheDir();return this.fs.getPrefix=t=>"Books"===t?this.localBooksDir:"Cache"===t?n:null,t}async saveSettings(t){let{fp:e,base:a}=this.resolvePath("settings.json","Settings");await this.fs.createDir("",a,!0),await this.fs.writeFile(e,a,JSON.stringify(t))}async importBook(t,e){let a=!(arguments.length>2)||void 0===arguments[2]||arguments[2],i=!(arguments.length>3)||void 0===arguments[3]||arguments[3],r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],h=arguments.length>5&&void 0!==arguments[5]&&arguments[5];try{let d,u,w,f;if(h&&"string"!=typeof t)throw Error("Transient import is only supported for file paths");try{if("string"==typeof t?w=(f=await this.fs.openFile(t,"None")).name||(0,n.e7)(t):(f=t,w=t.name),w.endsWith(".txt")){let t=new A;({file:f}=await t.convert({file:f}))}({book:d,format:u}=await new s.xb(f).open()),d.metadata.title||(d.metadata.title=(0,n.t7)(w))}catch(t){throw console.error(t),Error("Failed to open the book: ".concat(t.message||t))}let p=await (0,o.Yw)(f),g=e.filter(t=>t.hash===p)[0];g&&(h||(g.deletedAt=null),g.createdAt=Date.now(),g.updatedAt=Date.now());let _={hash:p,format:u,title:(0,n.Ef)(d.metadata.title),author:(0,n.kY)(d.metadata.author,d.metadata.language),primaryLanguage:(0,n.hM)(d.metadata.language),createdAt:g?g.createdAt:Date.now(),uploadedAt:g?g.uploadedAt:null,deletedAt:h?Date.now():null,downloadedAt:Date.now(),updatedAt:Date.now()};if(g){var c;g.title=_.title,g.author=_.author,g.primaryLanguage=null!=(c=g.primaryLanguage)?c:_.primaryLanguage}if(await this.fs.exists((0,n._T)(_),"Books")||await this.fs.createDir((0,n._T)(_),"Books"),a&&!h&&(!await this.fs.exists((0,n.ow)(_),"Books")||r)&&(w.endsWith(".txt")?await this.fs.writeFile((0,n.ow)(_),"Books",f):"string"==typeof t&&(0,l.em)(t)?await this.fs.copyFile(t,(0,n.ow)(_),"Books"):"string"!=typeof t||(0,l.Gz)(t)?await this.fs.writeFile((0,n.ow)(_),"Books",f):await this.fs.copyFile(t,(0,n.ow)(_),"Books")),i&&(!await this.fs.exists((0,n.df)(_),"Books")||r)){let t=await d.getCover();t&&await this.fs.writeFile((0,n.df)(_),"Books",await t.arrayBuffer())}return g||(await this.saveBookConfig(_,n.iY),e.splice(0,0,_)),"string"==typeof t&&((0,l.Gz)(t)&&(_.url=t,g&&(g.url=t)),h&&(_.filePath=t,g&&(g.filePath=t))),_.coverImageUrl=await this.generateCoverImageUrl(_),t&&t.close&&await t.close(),_}catch(t){throw t}}async deleteBook(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=[(0,n.z1)(t),(0,n.df)(t)];for(let e of[(0,n.ow)(t),(0,n.df)(t)])await this.fs.exists(e,"Books")&&await this.fs.removeFile(e,"Books");for(let t of a)if(e){console.log("Deleting uploaded file:",t);let e="".concat(r.pU,"/").concat(t);try{m(e)}catch(t){console.log("Failed to delete uploaded file:",t)}}t.deletedAt=Date.now(),t.downloadedAt=null,e&&(t.uploadedAt=null)}async uploadFileToCloud(t,e,a,i){console.log("Uploading file:",t,"to",e);let n=await this.fs.openFile(t,"Books",e),o="".concat(this.localBooksDir,"/").concat(t);await g(n,o,a,i),n&&n.close&&await n.close()}async uploadBook(t,e){let a=!1,i={count:0},o=0,s=await this.fs.exists((0,n.df)(t),"Books"),l=await this.fs.exists((0,n.ow)(t),"Books");if(s&&o++,l&&o++,!l&&t.url){let e=await this.fs.openFile(t.url,"None");await this.fs.writeFile((0,n.ow)(t),"Books",await e.arrayBuffer()),l=!0}let h=p(o,i,e);if(s){let e=(0,n.df)(t),o="".concat(r.pU,"/").concat((0,n.df)(t));await this.uploadFileToCloud(e,o,h,t.hash),a=!0,i.count++}if(l){let e=(0,n.ow)(t),o="".concat(r.pU,"/").concat((0,n.z1)(t));await this.uploadFileToCloud(e,o,h,t.hash),a=!0,i.count++}if(a)t.deletedAt=null,t.updatedAt=Date.now(),t.uploadedAt=Date.now(),t.downloadedAt=Date.now();else throw Error("Book file not uploaded")}async downloadCloudFile(t,e,a){console.log("Downloading file:",e,"to",t);let i="".concat(this.localBooksDir,"/").concat(t),n=await _(e,i,a);try{"web"===this.appPlatform&&await this.fs.writeFile(t,"Books",await n.arrayBuffer())}catch(t){throw console.log("Failed to download file:",e),Error("Failed to download file")}}async downloadBook(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=arguments.length>2?arguments[2]:void 0,i=!1,o={count:0},s=0,l=!await this.fs.exists((0,n.df)(t),"Books"),h=!e&&!await this.fs.exists((0,n.ow)(t),"Books");l&&s++,h&&s++;let c=p(s,o,a);await this.fs.exists((0,n._T)(t),"Books")||await this.fs.createDir((0,n._T)(t),"Books");try{if(l){let e=(0,n.df)(t),a="".concat(r.pU,"/").concat(e);await this.downloadCloudFile(e,a,c),o.count++}}catch(e){console.log("Failed to download cover file for book: '".concat(t.title,"'"),e)}if(h){let e=(0,n.ow)(t),a="".concat(r.pU,"/").concat((0,n.z1)(t));await this.downloadCloudFile(e,a,c);let s="".concat(this.localBooksDir,"/").concat(e);i=await this.fs.exists(s,"Books"),o.count++}!i&&(e||h)||(t.downloadedAt=Date.now())}async isBookAvailable(t){let e=(0,n.ow)(t);return!!await this.fs.exists(e,"Books")||(t.filePath?await this.fs.exists(t.filePath,"None"):!!t.url&&(0,l.Gz)(t.url))}async getBookFileSize(t){let e=(0,n.ow)(t);if(await this.fs.exists(e,"Books")){let t=await this.fs.openFile(e,"Books"),a=t.size;return t&&t.close&&await t.close(),a}return null}async loadBookContent(t,e){let a,i=(0,n.ow)(t);if(await this.fs.exists(i,"Books"))a=await this.fs.openFile(i,"Books");else if(t.filePath)a=await this.fs.openFile(t.filePath,"None");else if(t.url)a=await this.fs.openFile(t.url,"None");else throw Error("Book file not found");return{book:t,file:a,config:await this.loadBookConfig(t,e)}}async loadBookConfig(t,e){let{globalViewSettings:a}=e;try{let e="{}";return await this.fs.exists((0,n.An)(t),"Books")&&(e=await this.fs.readFile((0,n.An)(t),"Books","text")),(0,h.ub)(e,a,r.e3)}catch(t){return(0,h.ub)("{}",a,r.e3)}}async fetchBookDetails(t,e){let a=(0,n.ow)(t);!await this.fs.exists(a,"Books")&&t.uploadedAt&&await this.downloadBook(t);let{file:i}=await this.loadBookContent(t,e),o=(await new s.xb(i).open()).book;return i&&i.close&&await i.close(),o.metadata}async saveBookConfig(t,e,a){let i;if(a){let{globalViewSettings:t}=a;i=(0,h.Lg)(e,t,r.e3)}else i=JSON.stringify(e);await this.fs.writeFile((0,n.An)(t),"Books",i)}async generateCoverImageUrl(t){return"web"===this.appPlatform?await this.getCoverImageBlobUrl(t):this.getCoverImageUrl(t)}async loadLibraryBooks(){console.log("Loading library books...");let t=[],e=(0,n.pX)();try{let a=await this.fs.readFile(e,"Books","text");t=JSON.parse(a)}catch(t){await this.fs.createDir("","Books",!0),await this.fs.writeFile(e,"Books","[]")}return await Promise.all(t.map(async t=>{var e;return t.coverImageUrl=await this.generateCoverImageUrl(t),null!=t.updatedAt||(t.updatedAt=t.lastUpdated||Date.now()),t})),t}async saveLibraryBooks(t){let e=t.map(t=>{let{coverImageUrl:e,...a}=t;return a});await this.fs.writeFile((0,n.pX)(),"Books",JSON.stringify(e))}constructor(){(0,i._)(this,"osPlatform",(0,l.Ox)()),(0,i._)(this,"appPlatform","tauri"),(0,i._)(this,"localBooksDir",""),(0,i._)(this,"isMobile",!1),(0,i._)(this,"isMacOSApp",!1),(0,i._)(this,"isLinuxApp",!1),(0,i._)(this,"isAppDataSandbox",!1),(0,i._)(this,"isAndroidApp",!1),(0,i._)(this,"isIOSApp",!1),(0,i._)(this,"isMobileApp",!1),(0,i._)(this,"hasTrafficLight",!1),(0,i._)(this,"hasWindow",!1),(0,i._)(this,"hasWindowBar",!1),(0,i._)(this,"hasContextMenu",!1),(0,i._)(this,"hasRoundedWindow",!1),(0,i._)(this,"hasSafeAreaInset",!1),(0,i._)(this,"hasHaptics",!1),(0,i._)(this,"hasUpdater",!1)}}},83090:(t,e,a)=>{a.d(e,{B6:()=>o,Bq:()=>s,WC:()=>n,e2:()=>r});var i=a(7269);let n=(t,e,a)=>new Promise((i,n)=>{let o=Date.now(),s=new XMLHttpRequest;s.open("PUT",e,!0),s.upload.onprogress=t=>{a&&t.lengthComputable&&a({progress:t.loaded,total:t.total,transferSpeed:t.loaded/((Date.now()-o)/1e3)})},s.onload=()=>{s.status>=200&&s.status<300?i():n(Error("Upload failed with status ".concat(s.status)))},s.onerror=()=>n(Error("Upload failed")),s.send(t)}),o=async(t,e)=>{let a=await fetch(t);if(!a.ok)throw Error("File download failed");let i=a.headers.get("Content-Length");if(!i)throw Error("Cannot track progress: Content-Length missing");let n=parseInt(i,10),o=0,s=a.body.getReader(),r=[],l=Date.now();for(;;){let{done:t,value:a}=await s.read();if(t)break;r.push(a),o+=a.length,e&&e({progress:o,total:n,transferSpeed:o/((Date.now()-l)/1e3)})}return new Blob(r)},s=async(t,e,a,n,o)=>{let s=new Uint32Array(1);window.crypto.getRandomValues(s);let r=s[0],l=new i.c3;return n&&(l.onmessage=n),await (0,i.lA)("upload_file",{id:r,url:t,filePath:e,method:a,headers:null!=o?o:{},onProgress:l})},r=async(t,e,a,n,o)=>{let s=new Uint32Array(1);window.crypto.getRandomValues(s);let r=s[0],l=new i.c3;a&&(l.onmessage=a),await (0,i.lA)("download_file",{id:r,url:t,filePath:e,headers:null!=n?n:{},onProgress:l,body:o})}},91225:(t,e,a)=>{a.d(e,{A:()=>o,i:()=>n});var i=a(50981);let n=t=>{if(!t)return"auto";let e=new Set(["ar","he","fa","ur","dv","ps","sd","yi"]),a=t.split("-")[0].toLowerCase();return e.has(a)?"rtl":"auto"},o=()=>n((0,i.gl)())}}]);