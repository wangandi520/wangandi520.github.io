"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4300],{44300:(e,t,i)=>{i.d(t,{EPUB:()=>eL});var l=i(96261),r=i(89657),a=i(49033),n=i(80570),s=i(19780),o=i(25842),u=i(84648),h=i(47868);let c={CONTAINER:"urn:oasis:names:tc:opendocument:xmlns:container",XHTML:"http://www.w3.org/1999/xhtml",OPF:"http://www.idpf.org/2007/opf",EPUB:"http://www.idpf.org/2007/ops",DC:"http://purl.org/dc/elements/1.1/",ENC:"http://www.w3.org/2001/04/xmlenc#",NCX:"http://www.daisy.org/z3986/2005/ncx/",XLINK:"http://www.w3.org/1999/xlink",SMIL:"http://www.w3.org/ns/SMIL"},d={XML:"application/xml",NCX:"application/x-dtbncx+xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml",JS:/\/(x-)?(javascript|ecmascript)/},p={a11y:"http://www.idpf.org/epub/vocab/package/a11y/#",dcterms:"http://purl.org/dc/terms/",marc:"http://id.loc.gov/vocabulary/",media:"http://www.idpf.org/epub/vocab/overlays/#",onix:"http://www.editeur.org/ONIX/book/codelists/current.html#",rendition:"http://www.idpf.org/vocab/rendition/#",schema:"http://schema.org/",xsd:"http://www.w3.org/2001/XMLSchema#",msv:"http://www.idpf.org/epub/vocab/structure/magazine/#",prism:"http://www.prismstandard.org/specifications/3.0/PRISM_CV_Spec_3.0.htm#"},f={art:"artist",aut:"author",clr:"colorist",edt:"editor",ill:"illustrator",nrt:"narrator",trl:"translator",pbl:"publisher"},m={"02":"isbn","06":"doi",15:"isbn",26:"doi",34:"issn"},g=e=>e.toLowerCase().replace(/[-:](.)/g,(e,t)=>t.toUpperCase()),v=e=>e?e.replace(/[\t\n\f\r ]+/g," ").replace(/^[\t\n\f\r ]+/,"").replace(/[\t\n\f\r ]+$/,""):"",w=(e,t,i)=>i?i=>{var l,r;return null==(r=i.getAttribute(e))||null==(l=r.split(/\s/))?void 0:l.includes(t)}:"function"==typeof t?i=>t(i.getAttribute(e)):i=>i.getAttribute(e)===t,y=function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return e=>e?Object.fromEntries(t.map(t=>[g(t),e.getAttribute(t)])):null},_=e=>v(null==e?void 0:e.textContent),b=(e,t)=>{let i=e.lookupNamespaceURI(null)===t||e.lookupPrefix(t),l=i?(e,i)=>e=>e.namespaceURI===t&&e.localName===i:(e,t)=>e=>e.localName===t;return{$:(e,t)=>[...e.children].find(l(e,t)),$$:(e,t)=>[...e.children].filter(l(e,t)),$$$:i?(e,i)=>[...e.getElementsByTagNameNS(t,i)]:(e,t)=>[...e.getElementsByTagName(t)]}},S=(e,t)=>{try{if(e=e.replace(/%2c/gi,",").replace(/%3a/gi,":"),t.includes(":")&&!t.startsWith("OEBPS"))return new URL(e,t);let i="https://invalid.invalid/",l=new URL(e,i+t);return l.search="",decodeURI(l.href.replace(i,""))}catch(t){return console.warn(t),e}},E=e=>/^(?!blob)\w+:/i.test(e),A=(e,t)=>{if(!e)return t;let i=e.replace(/\/$/,"").split("/"),l=t.replace(/\/$/,"").split("/"),r=(i.length>l.length?i:l).findIndex((e,t)=>i[t]!==l[t]);return r<0?"":Array(i.length-r).fill("..").concat(l.slice(r)).join("/")},I=e=>e.slice(0,e.lastIndexOf("/")+1),M=async(e,t,i)=>{let l=[];e.replace(t,function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return l.push(t),null});let r=[];for(let e of l)r.push(await i(...e));return e.replace(t,()=>r.shift())},T=e=>e.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),k=e=>{for(let[t,i]of Object.entries(e))null==i?delete e[t]:Array.isArray(i)?(e[t]=i.filter(e=>e).map(e=>"object"!=typeof e||Array.isArray(e)?e:k(e)),e[t].length?1===e[t].length&&(e[t]=e[t][0]):delete e[t]):"object"==typeof i&&(e[t]=k(i),Object.keys(i).length||delete e[t]);let t=Object.keys(e);return 1===t.length&&"name"===t[0]?e[t[0]]:e},L=e=>{let t=new Map(Object.entries(p)),i=e.documentElement.getAttributeNS(c.EPUB,"prefix")||e.documentElement.getAttribute("prefix");if(i)for(let[,e,l]of i.matchAll(/(.+): +(.+)[ \t\r\n]*/g))t.set(e,l);return t},x=(e,t)=>{if(!e)return null;let[i,l]=e.split(":"),r=l||i,a=t.get(l?i:null);return a?a+r:null},N=e=>{var t,i,l,r,a,n,s,o,u,h,d,v,w,y,S,E,A,I,M,T,N,C,B,U,O,W,P,j,H,X,F,D,q,$,z,V,G;let{$:J}=b(e,c.OPF),K=J(e.documentElement,"metadata"),Q=Object.groupBy(K.children,e=>e.namespaceURI===c.DC?"dc":e.namespaceURI===c.OPF&&"meta"===e.localName?e.hasAttribute("name")?"legacyMeta":"meta":""),Y=null!=(O=null!=(U=K.getAttribute("xml:lang"))?U:e.documentElement.getAttribute("xml:lang"))?O:"und",Z=L(e),ee=e=>{var t,i;let l=e.getAttribute("property"),r=e.getAttribute("scheme");return{property:null!=(t=x(l,Z))?t:l,scheme:null!=(i=x(r,Z))?i:r,lang:e.getAttribute("xml:lang"),value:_(e),props:ei(e),attrs:Object.fromEntries(Array.from(e.attributes).filter(e=>e.namespaceURI===c.OPF).map(e=>[e.localName,e.value]))}},et=Map.groupBy(null!=(W=Q.meta)?W:[],e=>e.getAttribute("refines")),ei=e=>{let t=et.get(e?"#"+e.getAttribute("id"):null);return t?Object.groupBy(t.map(ee),e=>e.property):null},el=Object.fromEntries(Object.entries(Object.groupBy(Q.dc||[],e=>e.localName)).map(e=>{let[t,i]=e;return[t,i.map(ee)]})),er=null!=(P=ei())?P:{},ea=Object.fromEntries(null!=(j=null==(t=Q.legacyMeta)?void 0:t.map(e=>[e.getAttribute("name"),e.getAttribute("content")]))?j:[]),en=e=>{var t;return null==e||null==(t=e[0])?void 0:t.value},es=(e,t)=>{var i;return en(null==e||null==(i=e.props)?void 0:i[t])},eo=e=>{var t,i,l,r,a;if(!e)return null;let n=null!=(l=null==(t=e.props)?void 0:t["alternate-script"])?l:[],s=e.attrs["alt-rep"];if(!n.length&&(!e.lang||e.lang===Y)&&!s)return e.value;let o={[null!=(r=e.lang)?r:Y]:e.value};for(let t of(s&&(o[e.attrs["alt-rep-lang"]]=s),n))null!=o[i=t.lang]||(o[i]=t.value);return o},eh=e=>{var t,i,l,r,a,n,s,o,u;return e?{name:eo(e),sortAs:null!=(n=eo(null==(i=e.props)||null==(t=i["file-as"])?void 0:t[0]))?n:e.attrs["file-as"],role:null!=(s=null==(a=e.props)||null==(r=a.role)||null==(l=r.filter(e=>e.scheme===p.marc+"relators"))?void 0:l.map(e=>e.value))?s:[e.attrs.role],code:null!=(o=es(e,"term"))?o:e.attrs.term,scheme:null!=(u=es(e,"authority"))?u:e.attrs.authority}:null},ec=e=>{var t;return{name:eo(e),position:en(null==(t=e.props)?void 0:t["group-position"])}},ed=e=>{var t;let{value:i}=e;if(/^urn:/i.test(i))return i;if(/^doi:/i.test(i))return"urn:".concat(i);let l=null==(t=e.props)?void 0:t["identifier-type"];if(!l){let t=e.attrs.scheme;return t?/^(doi|isbn|uuid)$/i.test(t)?"urn:".concat(t,":").concat(i):{scheme:t,value:i}:i}if(l.scheme===p.onix+"codelist5"){let e=m[l.value];if(e)return"urn:".concat(e,":").concat(i)}return i},ep=Object.groupBy(null!=(H=er["belongs-to-collection"])?H:[],e=>"series"===es(e,"collection-type")?"series":"collection"),ef=null!=(X=null==(i=el.title)?void 0:i.find(e=>"main"===es(e,"title-type")))?X:null==(l=el.title)?void 0:l[0],em={identifier:eu(e),title:eo(ef),sortAs:null!=(D=null!=(F=eo(null==ef||null==(a=ef.props)||null==(r=a["file-as"])?void 0:r[0]))?F:null==ef||null==(n=ef.attrs)?void 0:n["file-as"])?D:null==ea?void 0:ea["calibre:title_sort"],subtitle:null==(o=el.title)||null==(s=o.find(e=>"subtitle"===es(e,"title-type")))?void 0:s.value,language:null==(u=el.language)?void 0:u.map(e=>e.value),description:en(el.description),publisher:eh(null==(h=el.publisher)?void 0:h[0]),published:null!=(q=null==(v=el.date)||null==(d=v.find(e=>"publication"===e.attrs.event))?void 0:d.value)?q:en(el.date),modified:null!=($=en(er[p.dcterms+"modified"]))?$:null==(y=el.date)||null==(w=y.find(e=>"modification"===e.attrs.event))?void 0:w.value,subject:null==(S=el.subject)?void 0:S.map(eh),belongsTo:{collection:null==(E=ep.collection)?void 0:E.map(ec),series:(null!=(z=null==(A=ep.series)?void 0:A.map(ec))?z:null==ea?void 0:ea["calibre:series"])?{name:null==ea?void 0:ea["calibre:series"],position:parseFloat(null==ea?void 0:ea["calibre:series_index"])}:null},altIdentifier:null==(I=el.identifier)?void 0:I.map(ed),source:null==(M=el.source)?void 0:M.map(ed),rights:en(el.rights)},eg=e=>t=>{var i;let l=new Set(null==(i=t.role)?void 0:i.map(t=>{var i;return null!=(i=f[t])?i:e}));return[l.size?l:[e],t]};for(let[e,t]of[].concat(null!=(V=null==(N=el.creator)||null==(T=N.map(eh))?void 0:T.map(eg("author")))?V:[],null!=(G=null==(B=el.contributor)||null==(C=B.map(eh))?void 0:C.map(eg("contributor")))?G:[]))for(let i of e)em[i]?em[i].push(t):em[i]=[t];k(em),em.altIdentifier===em.identifier&&delete em.altIdentifier;let ev={},ew={};for(let[e,t]of Object.entries(er))e.startsWith(p.rendition)?ev[g(e.replace(p.rendition,""))]=en(t):e.startsWith(p.media)&&(ew[g(e.replace(p.media,""))]=en(t));return ew.duration&&(ew.duration=R(ew.duration)),{metadata:em,rendition:ev,media:ew}},C=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e=>e,{$:i,$$:l,$$$:r}=b(e,c.XHTML),a=e=>e?decodeURI(t(e)):null,n=e=>t=>{var l,r;let n=null!=(r=i(t,"a"))?r:i(t,"span"),o=i(t,"ol"),u=a(null==n?void 0:n.getAttribute("href")),h={label:_(n)||(null==n?void 0:n.getAttribute("title")),href:u,subitems:s(o)};return e&&(h.type=null==n||null==(l=n.getAttributeNS(c.EPUB,"type"))?void 0:l.split(/\s/)),h},s=(e,t)=>e?l(e,"li").map(n(t)):null,o=(e,t)=>s(i(e,"ol"),t),u=r(e,"nav"),h=null,d=null,p=null,f=[];for(let e of u){var m,g;let t=null!=(g=null==(m=e.getAttributeNS(c.EPUB,"type"))?void 0:m.split(/\s/))?g:[];t.includes("toc")?null!=h||(h=o(e)):t.includes("page-list")?null!=d||(d=o(e)):t.includes("landmarks")?null!=p||(p=o(e,!0)):f.push({label:_(e.firstElementChild),type:t,list:o(e)})}return{toc:h,pageList:d,landmarks:p,others:f}},B=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e=>e,{$:i,$$:l}=b(e,c.NCX),r=e=>e?decodeURI(t(e)):null,a=e=>{let t=i(e,"navLabel"),n=i(e,"content"),s=_(t),o=r(n.getAttribute("src"));if("navPoint"===e.localName){let t=l(e,"navPoint");return{label:s,href:o,subitems:t.length?t.map(a):null}}return{label:s,href:o}},n=(e,t)=>l(e,t).map(a),s=(t,l)=>{let r=i(e.documentElement,t);return r?n(r,l):null};return{toc:s("navMap","navPoint"),pageList:s("pageList","pageTarget"),others:l(e.documentElement,"navList").map(e=>({label:_(i(e,"navLabel")),list:n(e,"navTarget")}))}},R=e=>{if(!e)return;let t=e.split(":").map(e=>parseFloat(e));if(3===t.length){let[e,i,l]=t;return 60*e*60+60*i+l}if(2===t.length){let[e,i]=t;return 60*e+i}let[i,l]=e.split(/(?=[^\d.])/);return parseFloat(i)*("h"===l?3600:"min"===l?60:"ms"===l?.001:1)};var U=new WeakMap,O=new WeakMap,W=new WeakMap,P=new WeakMap,j=new WeakMap,H=new WeakMap,X=new WeakMap,F=new WeakMap,D=new WeakMap,q=new WeakSet,$=new WeakMap,z=new WeakMap,V=new WeakSet,G=new WeakSet,J=new WeakSet,K=new WeakSet,Q=new WeakSet;class Y extends EventTarget{async start(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:()=>!0;null==(t=(0,l._)(this,H))||t.pause();let r=this.book.sections[e],n=null==r?void 0:r.id;if(!n)return;let{mediaOverlay:o}=r;if(!o)return this.start(e+1);(0,a._)(this,W,e),await (0,s._)(this,q,Z).call(this,o);for(let e=0;e<(0,l._)(this,U).length;e++){let{items:t}=(0,l._)(this,U)[e];for(let l=0;l<t.length;l++)if(t[l].text.split("#")[0]===n&&i(t[l],l,t))return(0,s._)(this,K,ea).call(this,e,l).catch(e=>(0,s._)(this,V,ei).call(this,e))}}pause(){var e;(0,a._)(this,D,"paused"),null==(e=(0,l._)(this,H))||e.pause()}resume(){var e;(0,a._)(this,D,"playing"),null==(e=(0,l._)(this,H))||e.play().catch(e=>(0,s._)(this,V,ei).call(this,e))}stop(){(0,a._)(this,D,"stopped"),(0,s._)(this,Q,en).call(this)}prev(){(0,l._)(this,j)>0?(0,s._)(this,K,ea).call(this,(0,l._)(this,P),(0,l._)(this,j)-1):(0,l._)(this,P)>0?(0,s._)(this,K,ea).call(this,(0,l._)(this,P)-1,(0,l._)(this,U)[(0,l._)(this,P)-1].items.length-1):(0,l._)(this,W)>0&&this.start((0,l._)(this,W)-1,(e,t,i)=>t===i.length-1)}next(){(0,s._)(this,K,ea).call(this,(0,l._)(this,P),(0,l._)(this,j)+1)}setVolume(e){(0,a._)(this,X,e),(0,l._)(this,H)&&((0,l._)(this,H).volume=e)}setRate(e){(0,a._)(this,F,e),(0,l._)(this,H)&&((0,l._)(this,H).playbackRate=e)}constructor(e,t){super(),(0,o._)(this,q),(0,r._)(this,$,{get:ee,set:void 0}),(0,r._)(this,z,{get:et,set:void 0}),(0,o._)(this,V),(0,o._)(this,G),(0,o._)(this,J),(0,o._)(this,K),(0,o._)(this,Q),(0,r._)(this,U,{writable:!0,value:void 0}),(0,r._)(this,O,{writable:!0,value:void 0}),(0,r._)(this,W,{writable:!0,value:void 0}),(0,r._)(this,P,{writable:!0,value:void 0}),(0,r._)(this,j,{writable:!0,value:void 0}),(0,r._)(this,H,{writable:!0,value:void 0}),(0,r._)(this,X,{writable:!0,value:1}),(0,r._)(this,F,{writable:!0,value:1}),(0,r._)(this,D,{writable:!0,value:void 0}),this.book=e,this.loadXML=t}}async function Z(e){if((0,l._)(this,O)===e)return;let t=await this.loadXML(e.href),i=t=>t?S(t,e.href):null,{$:r,$$$:n}=b(t,c.SMIL);(0,a._)(this,P,-1),(0,a._)(this,j,-1),(0,a._)(this,U,n(t,"par").reduce((e,t)=>{var l;let a=i(null==(l=r(t,"text"))?void 0:l.getAttribute("src")),n=r(t,"audio");if(!a||!n)return e;let s=i(n.getAttribute("src")),o=R(n.getAttribute("clipBegin")),u=R(n.getAttribute("clipEnd")),h=e.at(-1);return(null==h?void 0:h.src)===s?h.items.push({text:a,begin:o,end:u}):e.push({src:s,items:[{text:a,begin:o,end:u}]}),e},[])),(0,a._)(this,O,e)}function ee(){return(0,l._)(this,U)[(0,l._)(this,P)]}function et(){var e,t;return null==(t=(0,l._)(this,$))||null==(e=t.items)?void 0:e[(0,l._)(this,j)]}function ei(e){console.error(e),this.dispatchEvent(new CustomEvent("error",{detail:e}))}function el(){this.dispatchEvent(new CustomEvent("highlight",{detail:(0,l._)(this,z)}))}function er(){this.dispatchEvent(new CustomEvent("unhighlight",{detail:(0,l._)(this,z)}))}async function ea(e,t){var i,r;(0,s._)(this,Q,en).call(this),(0,a._)(this,P,e),(0,a._)(this,j,t);let o=null==(i=(0,l._)(this,$))?void 0:i.src;if(!o||!(0,l._)(this,z))return this.start((0,l._)(this,W)+1);let u=URL.createObjectURL(await this.book.loadBlob(o)),h=new Audio(u);(0,a._)(this,H,h),h.volume=(0,l._)(this,X),h.playbackRate=(0,l._)(this,F),h.addEventListener("timeupdate",()=>{var e,t;if(h.paused)return;let i=h.currentTime,{items:r}=(0,l._)(this,$);if(i>(null==(e=(0,l._)(this,z))?void 0:e.end)&&((0,s._)(this,J,er).call(this),(0,l._)(this,j)===r.length-1))return void(0,s._)(this,K,ea).call(this,(0,l._)(this,P)+1,0).catch(e=>(0,s._)(this,V,ei).call(this,e));let a=(0,l._)(this,j);for(;(null==(t=r[(0,l._)(this,j)+1])?void 0:t.begin)<=i;)(0,n._)(this,j).value++;(0,l._)(this,j)!==a&&(0,s._)(this,G,el).call(this)}),h.addEventListener("error",()=>(0,s._)(this,V,ei).call(this,Error("Failed to load ".concat(o)))),h.addEventListener("playing",()=>(0,s._)(this,G,el).call(this)),h.addEventListener("ended",()=>{(0,s._)(this,J,er).call(this),URL.revokeObjectURL(u),(0,a._)(this,H,null),(0,s._)(this,K,ea).call(this,e+1,0).catch(e=>(0,s._)(this,V,ei).call(this,e))}),"paused"===(0,l._)(this,D)?((0,s._)(this,G,el).call(this),h.currentTime=null!=(r=(0,l._)(this,z).begin)?r:0):h.addEventListener("canplaythrough",()=>{var e;h.currentTime=null!=(e=(0,l._)(this,z).begin)?e:0,(0,a._)(this,D,"playing"),h.play().catch(e=>(0,s._)(this,V,ei).call(this,e))},{once:!0})}function en(){(0,l._)(this,H)&&((0,l._)(this,H).pause(),URL.revokeObjectURL((0,l._)(this,H).src),(0,a._)(this,H,null),(0,s._)(this,J,er).call(this))}let es=/([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/,eo=e=>{for(let t of e.getElementsByTagNameNS(c.DC,"identifier")){let[e]=_(t).split(":").slice(-1);if(es.test(e))return e}return""},eu=e=>{var t;return _(null!=(t=e.getElementById(e.documentElement.getAttribute("unique-identifier")))?t:e.getElementsByTagNameNS(c.DC,"identifier")[0])},eh=async(e,t,i)=>{let l=new Uint8Array(await i.slice(0,t).arrayBuffer());t=Math.min(t,l.length);for(var r=0;r<t;r++)l[r]=l[r]^e[r%e.length];return new Blob([l,i.slice(t)],{type:i.type})},ec=async e=>{let t=new TextEncoder().encode(e);return new Uint8Array(await globalThis.crypto.subtle.digest("SHA-1",t))},ed=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ec;return{"http://www.idpf.org/2008/embedding":{key:t=>e(eu(t).replaceAll(/[\u0020\u0009\u000d\u000a]/g,"")),decode:(e,t)=>eh(e,1040,t)},"http://ns.adobe.com/pdf/enc#RC":{key:e=>{let t=eo(e).replaceAll("-","");return Uint8Array.from({length:16},(e,i)=>parseInt(t.slice(2*i,2*i+2),16))},decode:(e,t)=>eh(e,1024,t)}}};var ep=new WeakMap,ef=new WeakMap,em=new WeakMap;class eg{async init(e,t){if(e)for(let{algorithm:i,uri:r}of Array.from(e.getElementsByTagNameNS(c.ENC,"EncryptedData"),e=>{var t,i;return{algorithm:null==(t=e.getElementsByTagNameNS(c.ENC,"EncryptionMethod")[0])?void 0:t.getAttribute("Algorithm"),uri:null==(i=e.getElementsByTagNameNS(c.ENC,"CipherReference")[0])?void 0:i.getAttribute("URI")}})){if(!(0,l._)(this,ef).has(i)){let e=(0,l._)(this,em)[i];if(!e){console.warn("Unknown encryption algorithm");continue}let r=await e.key(t);(0,l._)(this,ef).set(i,t=>e.decode(r,t))}(0,l._)(this,ep).set(r,i)}}getDecoder(e){var t;return null!=(t=(0,l._)(this,ef).get((0,l._)(this,ep).get(e)))?t:e=>e}constructor(e){(0,r._)(this,ep,{writable:!0,value:new Map}),(0,r._)(this,ef,{writable:!0,value:new Map}),(0,r._)(this,em,{writable:!0,value:void 0}),(0,a._)(this,em,e)}}class ev{getItemByID(e){return this.manifestById||(this.manifestById=new Map(this.manifest.map(e=>[e.id,e]))),this.manifestById.get(e)}getItemByHref(e){return this.manifest.find(t=>t.href===e)}getItemByProperty(e){return this.manifest.find(t=>{var i;return null==(i=t.properties)?void 0:i.includes(e)})}resolveCFI(e){var t;let i=h.parse(e),l=(null!=(t=i.parent)?t:i).shift(),r=h.toElement(this.opf,l);r&&"idref"!==r.nodeName&&(l.at(-1).id=null,r=h.toElement(this.opf,l));let a=null==r?void 0:r.getAttribute("idref");return{index:this.spine.findIndex(e=>e.idref===a),anchor:e=>h.toRange(e,i)}}constructor({opf:e,resolveHref:t}){var i,l,r,a,n,s,o,u,p,f;this.opf=e;let{$:m,$$:g,$$$:v}=b(e,c.OPF),_=m(e.documentElement,"manifest"),S=m(e.documentElement,"spine"),E=g(S,"itemref");this.manifest=g(_,"item").map(y("href","id","media-type","properties","media-overlay")).map(e=>{var i;return e.href=t(e.href),e.properties=null==(i=e.properties)?void 0:i.split(/\s/),e}),this.spine=E.map(y("idref","id","linear","properties")).map(e=>{var t;return e.properties=null==(t=e.properties)?void 0:t.split(/\s/),e}),this.pageProgressionDirection=S.getAttribute("page-progression-direction"),this.navPath=null==(i=this.getItemByProperty("nav"))?void 0:i.href,this.ncxPath=null==(l=null!=(s=this.getItemByID(S.getAttribute("toc")))?s:this.manifest.find(e=>e.mediaType===d.NCX))?void 0:l.href;let A=m(e.documentElement,"guide");A&&(this.guide=g(A,"reference").map(y("type","title","href")).map(e=>{let{type:i,title:l,href:r}=e;return{label:l,type:i.split(/\s/),href:t(r)}})),this.cover=null!=(f=null!=(p=null!=(u=null!=(o=this.getItemByProperty("cover-image"))?o:this.getItemByID(null==(r=v(e,"meta").find(w("name","cover")))?void 0:r.getAttribute("content")))?u:this.manifest.find(e=>e.href.includes("cover")&&e.mediaType.startsWith("image")))?p:this.getItemByHref(null==(n=this.guide)||null==(a=n.find(e=>e.type.includes("cover")))?void 0:a.href))?f:this.manifest.find(e=>e.mediaType.startsWith("image")),this.cfis=h.fromElements(E)}}var ew=new WeakMap,ey=new WeakMap,e_=new WeakMap,eb=new WeakMap;class eS{async createURL(e,t,i,r){if(!t)return"";let a={data:t,type:i};Object.defineProperty(a,"name",{value:e});let n=new CustomEvent("data",{detail:a});this.eventTarget.dispatchEvent(n);let s=await n.detail.data,o=await n.detail.type,u=URL.createObjectURL(new Blob([s],{type:o}));if((0,l._)(this,ew).set(e,u),(0,l._)(this,eb).set(e,1),o===d.XHTML&&(0,l._)(this,ey).set(u,{href:e,type:o,data:s}),r){let t=(0,l._)(this,e_).get(r);t?t.push(e):(0,l._)(this,e_).set(r,[e])}return u}ref(e,t){let i=(0,l._)(this,e_).get(t);return(null==i?void 0:i.includes(e))||((0,l._)(this,eb).set(e,(0,l._)(this,eb).get(e)+1),i?i.push(e):(0,l._)(this,e_).set(t,[e])),(0,l._)(this,ew).get(e)}unref(e){if(!(0,l._)(this,eb).has(e))return;let t=(0,l._)(this,eb).get(e)-1;if(t<1){let t=(0,l._)(this,ew).get(e);URL.revokeObjectURL(t),(0,l._)(this,ew).delete(e),(0,l._)(this,ey).delete(t),(0,l._)(this,eb).delete(e);let i=(0,l._)(this,e_).get(e);if(i)for(;i.length;)this.unref(i.pop());(0,l._)(this,e_).delete(e)}else(0,l._)(this,eb).set(e,t)}async loadItem(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(!e)return null;let{href:i,mediaType:r}=e,a=d.JS.test(e.mediaType);if(a&&!this.allowScript)return null;let n=t.at(-1);if((0,l._)(this,ew).has(i))return this.ref(i,n);if((a||[d.XHTML,d.HTML,d.CSS,d.SVG].includes(r))&&t.every(e=>e!==i))return this.loadReplaced(e,t);let s=Promise.resolve().then(()=>this.loadBlob(i));return this.createURL(i,s,r,n)}async loadItemXHTMLContent(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=await this.loadItem(e,i);if(r)return null==(t=(0,l._)(this,ey).get(r))?void 0:t.data}async loadHref(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(E(e))return e;let l=S(e,t),r=this.manifest.find(e=>e.href===l);return r?this.loadItem(r,i.concat(t)):e}async loadReplaced(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],{href:i,mediaType:l}=e,r=t.at(-1),a="";try{a=await this.loadText(i)}catch(e){return this.createURL(i,Promise.reject(e),l,r)}if(!a)return null;if([d.XHTML,d.HTML,d.SVG].includes(l)){var n,s,o;let u=new DOMParser().parseFromString(a,l);if(l===d.XHTML&&(u.querySelector("parsererror")||!(null==(n=u.documentElement)?void 0:n.namespaceURI))&&(console.warn(null!=(o=null==(s=u.querySelector("parsererror"))?void 0:s.innerText)?o:"Invalid XHTML"),e.mediaType=d.HTML,u=new DOMParser().parseFromString(a,e.mediaType)),[d.XHTML,d.SVG].includes(e.mediaType)){let e=u.firstChild;for(;e instanceof ProcessingInstruction;){if(e.data){let l=await M(e.data,/(?:^|\s*)(href\s*=\s*['"])([^'"]*)(['"])/i,(e,l,r,a)=>this.loadHref(r,i,t).then(e=>"".concat(l).concat(e).concat(a)));e.replaceWith(u.createProcessingInstruction(e.target,l))}e=e.nextSibling}}let h=async(e,l)=>e.setAttribute(l,await this.loadHref(e.getAttribute(l),i,t));for(let e of u.querySelectorAll("link[href]"))await h(e,"href");for(let e of u.querySelectorAll("[src]"))await h(e,"src");for(let e of u.querySelectorAll("[poster]"))await h(e,"poster");for(let e of u.querySelectorAll("object[data]"))await h(e,"data");for(let e of u.querySelectorAll("[*|href]:not([href])"))e.setAttributeNS(c.XLINK,"href",await this.loadHref(e.getAttributeNS(c.XLINK,"href"),i,t));for(let e of u.querySelectorAll("style"))e.textContent&&(e.textContent=await this.replaceCSS(e.textContent,i,t));for(let e of u.querySelectorAll("[style]"))e.setAttribute("style",await this.replaceCSS(e.getAttribute("style"),i,t));let p=new XMLSerializer().serializeToString(u);return this.createURL(i,p,e.mediaType,r)}let u=l===d.CSS?await this.replaceCSS(a,i,t):await this.replaceString(a,i,t);return this.createURL(i,u,l,r)}async replaceCSS(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],l=await M(e,/url\(\s*["']?([^'"\n]*?)\s*["']?\s*\)/gi,(e,l)=>this.loadHref(l,t,i).then(e=>'url("'.concat(e,'")')));return M(l,/@import\s*["']([^"'\n]*?)["']/gi,(e,l)=>this.loadHref(l,t,i).then(e=>'@import "'.concat(e,'"')))}replaceString(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],l=new Map,r=this.assets.map(e=>{if(e.href===t)return;let i=A(I(t),e.href),r=encodeURI(i),a="/"+e.href,n=encodeURI(a),s=new Set([i,r,a,n]);for(let t of s)l.set(t,e);return Array.from(s)}).flat().filter(e=>e);return r.length?M(e,RegExp(r.map(T).join("|"),"g"),async e=>this.loadItem(l.get(e.replace(/^\//,"")),i.concat(t))):e}unloadItem(e){this.unref(null==e?void 0:e.href)}destroy(){for(let e of(0,l._)(this,ew).values())URL.revokeObjectURL(e)}constructor({loadText:e,loadBlob:t,resources:i}){(0,r._)(this,ew,{writable:!0,value:new Map}),(0,r._)(this,ey,{writable:!0,value:new Map}),(0,r._)(this,e_,{writable:!0,value:new Map}),(0,r._)(this,eb,{writable:!0,value:new Map}),(0,u._)(this,"allowScript",!1),(0,u._)(this,"eventTarget",new EventTarget),this.loadText=e,this.loadBlob=t,this.manifest=i.manifest,this.assets=i.manifest}}let eE=(e,t)=>{var i;return null!=(i=e.getElementById(t))?i:e.querySelector('[name="'.concat(CSS.escape(t),'"]'))},eA=e=>{for(let t of e){if("page-spread-left"===t||"rendition:page-spread-left"===t)return"left";if("page-spread-right"===t||"rendition:page-spread-right"===t)return"right";if("rendition:page-spread-center"===t)return"center"}},eI=e=>e?{fixedLayout:_(e.querySelector('option[name="fixed-layout"]')),openToSpread:_(e.querySelector('option[name="open-to-spread"]'))}:null;var eM=new WeakMap,eT=new WeakMap,ek=new WeakSet;class eL{async init(){var e,t,i,r,n,o;let{allowScript:u=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},h=await (0,s._)(this,ek,ex).call(this,"META-INF/container.xml");if(!h)throw Error("Failed to load container file");let d=Array.from(h.getElementsByTagNameNS(c.CONTAINER,"rootfile"),y("full-path","media-type")).filter(e=>"application/oebps-package+xml"===e.mediaType);if(!d.length)throw Error("No package document defined in container");let p=d[0].fullPath,f=await (0,s._)(this,ek,ex).call(this,p);if(!f)throw Error("Failed to load package document");let m=await (0,s._)(this,ek,ex).call(this,"META-INF/encryption.xml");await (0,l._)(this,eT).init(m,f),this.resources=new ev({opf:f,resolveHref:e=>S(e,p)}),(0,a._)(this,eM,new eS({loadText:this.loadText,loadBlob:e=>Promise.resolve(this.loadBlob(e)).then((0,l._)(this,eT).getDecoder(e)),resources:this.resources})),(0,l._)(this,eM).allowScript=u,this.transformTarget=(0,l._)(this,eM).eventTarget,this.sections=this.resources.spine.map((e,t)=>{let{idref:i,linear:r,properties:a=[]}=e,n=this.resources.getItemByID(i);return n?{id:n.href,load:()=>(0,l._)(this,eM).loadItem(n),unload:()=>(0,l._)(this,eM).unloadItem(n),loadContent:()=>(0,l._)(this,eM).loadItemXHTMLContent(n),createDocument:()=>this.loadDocument(n),size:this.getSize(n.href),cfi:this.resources.cfis[t],linear:r,pageSpread:eA(a),resolveHref:e=>S(e,n.href),mediaOverlay:n.mediaOverlay?this.resources.getItemByID(n.mediaOverlay):null}:(console.warn('Could not find item with ID "'.concat(i,'" in manifest')),null)}).filter(e=>e);let{navPath:g,ncxPath:v}=this.resources;if(g)try{let e=C(await (0,s._)(this,ek,ex).call(this,g),e=>S(e,g));this.toc=e.toc,this.pageList=e.pageList,this.landmarks=e.landmarks}catch(e){console.warn(e)}if(!this.toc&&v)try{let e=B(await (0,s._)(this,ek,ex).call(this,v),e=>S(e,v));this.toc=e.toc,this.pageList=e.pageList}catch(e){console.warn(e)}null!=this.landmarks||(this.landmarks=this.resources.guide);let{metadata:w,rendition:_,media:b}=N(f);this.metadata=w,this.rendition=_,this.media=b,this.dir=this.resources.pageProgressionDirection;let E=eI(null!=(t=await (0,s._)(this,ek,ex).call(this,"META-INF/com.apple.ibooks.display-options.xml"))?t:await (0,s._)(this,ek,ex).call(this,"META-INF/com.kobobooks.display-options.xml"));return E&&("true"===E.fixedLayout&&(null!=(i=this.rendition).layout||(i.layout="pre-paginated")),"false"===E.openToSpread&&(null!=(r=this.sections.find(e=>"no"!==e.linear)).pageSpread||(r.pageSpread="rtl"===this.dir?"left":"right"))),this}async loadDocument(e){let t=await this.loadText(e.href);return this.parser.parseFromString(t,e.mediaType)}getMediaOverlay(){return new Y(this,(0,s._)(this,ek,ex).bind(this))}resolveCFI(e){return this.resources.resolveCFI(e)}resolveHref(e){let[t,i]=e.split("#"),l=this.resources.getItemByHref(decodeURI(t));return l?{index:this.resources.spine.findIndex(e=>{let{idref:t}=e;return t===l.id}),anchor:i?e=>eE(e,i):()=>0}:null}splitTOCHref(e){var t;return null!=(t=null==e?void 0:e.split("#"))?t:[]}getTOCFragment(e,t){var i;return null!=(i=e.getElementById(t))?i:e.querySelector('[name="'.concat(CSS.escape(t),'"]'))}isExternal(e){return E(e)}async getCover(){var e;let t=null==(e=this.resources)?void 0:e.cover;return(null==t?void 0:t.href)?new Blob([await this.loadBlob(t.href)],{type:t.mediaType}):null}async getCalibreBookmarks(){let e=await this.loadText("META-INF/calibre_bookmarks.txt"),t="encoding=json+base64:";if(null==e?void 0:e.startsWith(t))return JSON.parse(atob(e.slice(t.length)))}destroy(){var e;null==(e=(0,l._)(this,eM))||e.destroy()}constructor({loadText:e,loadBlob:t,getSize:i,sha1:l}){(0,o._)(this,ek),(0,u._)(this,"parser",new DOMParser),(0,r._)(this,eM,{writable:!0,value:void 0}),(0,r._)(this,eT,{writable:!0,value:void 0}),this.loadText=e,this.loadBlob=t,this.getSize=i,(0,a._)(this,eT,new eg(ed(l)))}}async function ex(e){let t=await this.loadText(e);if(!t)return null;let i=this.parser.parseFromString(t,d.XML);if(i.querySelector("parsererror"))throw Error("XML parsing error: ".concat(e,"\n").concat(i.querySelector("parsererror").innerText));return i}}}]);