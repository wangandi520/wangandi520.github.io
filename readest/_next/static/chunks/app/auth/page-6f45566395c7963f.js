(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8365],{7716:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>M});var n=i(62574),a=i(3073),s=i(84574),r=i(38012),l=i(97749),o=i(79186),c=i(5959),u=i(17669),d=i(90863),h=i(46450),p=i(2675),g=i(57597),w=i(15574),f=i(98335),m=i(20517),b=i(78549),v=i(18631),_=i(69921),y=i(5375),x=i(52270),L=i(90734),S=i(50843),k=i(7269),A=i(19806),E=i(54599);async function C(e){let t=(0,E.NW)();if("ios"===t)return await (0,k.lA)("plugin:sign-in-with-apple|get_apple_id_credential",{payload:e});if("macos"===t)return new Promise(async(t,i)=>{let n=await (0,A.KT)("apple-sign-in-complete",e=>{let{payload:i}=e;s(),t(i)}),a=await (0,A.KT)("apple-sign-in-error",e=>{let{payload:t}=e;s(),i("string"==typeof t?Error(t):Error("Apple sign‑in failed"))});function s(){n(),a()}try{await (0,k.lA)("start_apple_sign_in",{payload:e})}catch(e){s(),i(e)}});throw Error("Unsupported platform")}async function N(e){let t=(0,E.NW)();if("ios"===t)return await (0,k.lA)("plugin:native-bridge|auth_with_safari",{payload:e});if("macos"===t)return new Promise(async(t,i)=>{let n=await (0,A.KT)("safari-auth-complete",e=>{let{payload:i}=e;n(),t(i)});try{await (0,k.lA)("auth_with_safari",{payload:e})}catch(e){n(),i(e)}});throw Error("Unsupported OS type")}async function j(e){return await (0,k.lA)("plugin:native-bridge|auth_with_custom_tab",{payload:e})}var T=i(40965),O=i(77553),D=i(79336);let P="".concat(T._u,"/auth/callback"),z="readest://auth-callback",I="true"===D.env.NEXT_PUBLIC_USE_APPLE_SIGN_IN,W=e=>{let{provider:t,handleSignIn:i,Icon:s,label:r}=e;return(0,n.jsxs)("button",{onClick:()=>i(t),className:(0,a.A)("mb-2 flex w-64 items-center justify-center rounded border p-2.5","bg-base-100 border-base-300 hover:bg-base-200 shadow-sm transition"),children:[(0,n.jsx)(s,{}),(0,n.jsx)("span",{className:"text-base-content/75 px-2 text-sm",children:r})]})};function M(){let e=(0,b.B)(),t=(0,r.useRouter)(),{login:k}=(0,h.A)(),{envConfig:A,appService:E}=(0,g.D)(),{isDarkMode:T}=(0,f.C)(),{isTrafficLightVisible:D}=(0,v.w)(),{settings:M,setSettings:F,saveSettings:R}=(0,m.C)(),[U,Y]=(0,s.useState)(null),B=(0,s.useRef)(!1),[V,G]=(0,s.useState)(!1),H=(0,s.useRef)(null);(0,w.D)({systemUIVisible:!1});let Z=e=>(null==E?void 0:E.isMobileApp)?e?z:P:z,K=async()=>{if(!p.ND)throw Error("No backend connected");if(p.ND.auth.signOut(),(null==E?void 0:E.isIOSApp)||I){let e=await C({scope:["fullName","email"]});if(e.identityToken){let{error:t}=await p.ND.auth.signInWithIdToken({provider:"apple",token:e.identityToken});t&&console.error("Authentication error:",t)}}else console.log("Sign in with Apple on this platform is not supported yet")},Q=async e=>{if(!p.ND)throw Error("No backend connected");p.ND.auth.signOut();let{data:t,error:i}=await p.ND.auth.signInWithOAuth({provider:e,options:{skipBrowserRedirect:!0,redirectTo:Z(!0)}});if(i)return void console.error("Authentication error:",i);if((null==E?void 0:E.isIOSApp)||(null==E?void 0:E.isMacOSApp)){let e=await N({authUrl:t.url});e&&q(e.redirectUrl)}else if(null==E?void 0:E.isAndroidApp){let e=await j({authUrl:t.url});e&&q(e.redirectUrl)}else await (0,L.CZ)(t.url)},q=async e=>{console.log("Handle OAuth URL:",e);let i=e.match(/#(.*)/);if(i){var n;let e=new URLSearchParams(i[1]),a=e.get("access_token"),s=e.get("refresh_token"),r=e.get("type"),l=null!=(n=e.get("next"))?n:"/";a&&(0,S.m)({accessToken:a,refreshToken:s,type:r,next:l,login:k,navigate:t.push})}},J=async()=>{try{{let{getCurrentWindow:e}=await Promise.resolve().then(i.bind(i,88330));e().listen("single-instance",e=>{let{event:t,payload:i}=e;console.log("Received deep link:",t,i);let{args:n}=i;(null==n?void 0:n[1])&&q(n[1])}),await (0,y.bx)(e=>{e.forEach(e=>{q(e)})})}}catch(e){console.error("Error starting OAuth server:",e)}},X=async()=>{try{U&&(await (0,x.ZT)(U),console.log("OAuth server stopped"))}catch(e){console.error("Error stopping OAuth server:",e)}},$=()=>{M.keepLogin=!1,F(M),R(A,M),t.back()},ee=()=>({variables:{sign_in:{email_label:e("Email address"),password_label:e("Your Password"),email_input_placeholder:e("Your email address"),password_input_placeholder:e("Your password"),button_label:e("Sign in"),loading_button_label:e("Signing in..."),social_provider_text:e("Sign in with {{provider}}"),link_text:e("Already have an account? Sign in")},sign_up:{email_label:e("Email address"),password_label:e("Create a Password"),email_input_placeholder:e("Your email address"),password_input_placeholder:e("Your password"),button_label:e("Sign up"),loading_button_label:e("Signing up..."),social_provider_text:e("Sign in with {{provider}}"),link_text:e("Don’t have an account? Sign up"),confirmation_text:e("Check your email for the confirmation link")},magic_link:{email_input_label:e("Email address"),email_input_placeholder:e("Your email address"),button_label:e("Sign in"),loading_button_label:e("Signing in ..."),link_text:e("Send a magic link email"),confirmation_text:e("Check your email for the magic link")},forgotten_password:{email_label:e("Email address"),password_label:e("Your Password"),email_input_placeholder:e("Your email address"),button_label:e("Send reset password instructions"),loading_button_label:e("Sending reset instructions ..."),link_text:e("Forgot your password?"),confirmation_text:e("Check your email for the password reset link")},verify_otp:{email_input_label:e("Email address"),email_input_placeholder:e("Your email address"),phone_input_label:e("Phone number"),phone_input_placeholder:e("Your phone number"),token_input_label:e("Token"),token_input_placeholder:e("Your OTP token"),button_label:e("Verify token"),loading_button_label:e("Signing in ...")}}});return((0,s.useEffect)(()=>{if((0,_.uO)()&&!B.current)return B.current=!0,J(),()=>{B.current=!1,X()}},[]),(0,s.useEffect)(()=>{let{data:e}=p.ND.auth.onAuthStateChange((e,i)=>{if((null==i?void 0:i.access_token)&&i.user){k(i.access_token,i.user);let e=new URLSearchParams(window.location.search).get("redirect");t.push(null!=e?e:"/library")}});return()=>{null==e||e.subscription.unsubscribe()}},[t]),(0,s.useEffect)(()=>{G(!0)},[]),V)?(0,_.uO)()?(0,n.jsxs)("div",{className:(0,a.A)("fixed inset-0 z-0 flex select-none flex-col items-center overflow-y-auto","bg-base-100 border-base-200 border",(null==E?void 0:E.hasSafeAreaInset)&&"pt-[env(safe-area-inset-top)]"),children:[(0,n.jsxs)("div",{ref:H,className:(0,a.A)("fixed z-10 flex w-full items-center justify-between py-2 pe-6 ps-4",(null==E?void 0:E.hasTrafficLight)&&"pt-11"),children:[(0,n.jsx)("button",{onClick:$,className:(0,a.A)("btn btn-ghost h-8 min-h-8 w-8 p-0"),children:(0,n.jsx)(d.NEn,{className:"text-base-content"})}),(null==E?void 0:E.hasWindowBar)&&(0,n.jsx)(O.A,{headerRef:H,showMinimize:!D,showMaximize:!D,showClose:!D,onClose:$})]}),(0,n.jsxs)("div",{className:(0,a.A)("z-20 pb-8",(null==E?void 0:E.hasTrafficLight)?"mt-24":"mt-12"),style:{maxWidth:"420px"},children:[(0,n.jsx)(W,{provider:"google",handleSignIn:Q,Icon:c.F4b,label:e("Sign in with Google")}),(0,n.jsx)(W,{provider:"apple",handleSignIn:(null==E?void 0:E.isIOSApp)||I?K:Q,Icon:u.eMv,label:e("Sign in with Apple")}),(0,n.jsx)(W,{provider:"github",handleSignIn:Q,Icon:u.hL4,label:e("Sign in with GitHub")}),(0,n.jsx)("hr",{className:"border-base-300 my-3 mt-6 w-64 border-t"}),(0,n.jsx)(l.Nj,{supabaseClient:p.ND,appearance:{theme:o.Hv},theme:T?"dark":"light",magicLink:!0,providers:[],redirectTo:Z(!1),localization:ee()})]})]}):(0,n.jsxs)("div",{style:{maxWidth:"420px",margin:"auto",padding:"2rem",paddingTop:"4rem"},children:[(0,n.jsx)("button",{onClick:$,className:"btn btn-ghost fixed left-6 top-6 h-8 min-h-8 w-8 p-0",children:(0,n.jsx)(d.NEn,{className:"text-base-content"})}),(0,n.jsx)(l.Nj,{supabaseClient:p.ND,appearance:{theme:o.Hv},theme:T?"dark":"light",magicLink:!0,providers:["google","apple","github"],redirectTo:P,localization:ee()})]}):null}},15574:(e,t,i)=>{"use strict";i.d(t,{D:()=>c});var n=i(84574),a=i(57597),s=i(98335),r=i(20517),l=i(71997),o=i(58068);let c=function(){let{systemUIVisible:e=!0,appThemeColor:t="base-100"}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{appService:i}=(0,a.D)(),{settings:c}=(0,r.C)(),{themeColor:u,isDarkMode:d,showSystemUI:h,dismissSystemUI:p,updateAppTheme:g,setStatusBarHeight:w}=(0,s.C)();(0,n.useEffect)(()=>{g(t),(null==i?void 0:i.isMobileApp)&&(e?h():p(),(0,o.Mp)({visible:e,darkMode:d})),(null==i?void 0:i.isAndroidApp)&&(0,o.ZA)().then(e=>{e.height&&e.height>0&&w(e.height/window.devicePixelRatio)})},[i,d]),(0,n.useEffect)(()=>{var e,t;let i=null!=(t=null==(e=c.globalReadSettings)?void 0:e.customThemes)?t:[];i.forEach(e=>{(0,l.PL)(e)}),localStorage.setItem("customThemes",JSON.stringify(i))},[c]),(0,n.useEffect)(()=>{let e=d?"dark":"light";document.documentElement.setAttribute("data-theme","".concat(u,"-").concat(e)),document.documentElement.style.setProperty("color-scheme",e)},[u,d])}},18631:(e,t,i)=>{"use strict";i.d(t,{w:()=>s});var n=i(75972),a=i(7269);let s=(0,n.v)((e,t)=>({appService:void 0,isTrafficLightVisible:!1,shouldShowTrafficLight:!1,initializeTrafficLightStore:t=>{e({appService:t,isTrafficLightVisible:t.hasTrafficLight,shouldShowTrafficLight:t.hasTrafficLight})},setTrafficLightVisibility:async t=>{let{getCurrentWindow:n}=await Promise.resolve().then(i.bind(i,88330)),s=n();e({isTrafficLightVisible:!await s.isFullscreen()&&t,shouldShowTrafficLight:t}),(0,a.lA)("set_traffic_lights",{visible:t,x:10,y:22})},initializeTrafficLightListeners:async()=>{let{getCurrentWindow:n}=await Promise.resolve().then(i.bind(i,88330)),a=n(),s=await a.listen("will-enter-fullscreen",()=>{e({isTrafficLightVisible:!1})}),r=await a.listen("will-exit-fullscreen",()=>{let{shouldShowTrafficLight:i}=t();e({isTrafficLightVisible:i})});e({unlistenEnterFullScreen:s,unlistenExitFullScreen:r})},cleanupTrafficLightListeners:()=>{let{unlistenEnterFullScreen:i,unlistenExitFullScreen:n}=t();i&&i(),n&&n(),e({unlistenEnterFullScreen:void 0,unlistenExitFullScreen:void 0})}}))},20517:(e,t,i)=>{"use strict";i.d(t,{C:()=>n});let n=(0,i(75972).v)(e=>({settings:{},isFontLayoutSettingsDialogOpen:!1,isFontLayoutSettingsGlobal:!0,setSettings:t=>e({settings:t}),saveSettings:async(e,t)=>{let i=await e.getAppService();await i.saveSettings(t)},setFontLayoutSettingsDialogOpen:t=>e({isFontLayoutSettingsDialogOpen:t}),setFontLayoutSettingsGlobal:t=>e({isFontLayoutSettingsGlobal:t})}))},29353:(e,t,i)=>{"use strict";i.d(t,{Lj:()=>p,YF:()=>c,_Y:()=>l,c_:()=>g,tP:()=>h,tQ:()=>d,u5:()=>o,wm:()=>u});var n=i(88330),a=i(19806),s=i(70627),r=i(66763);let l=async()=>{let e=(0,n.getCurrentWindow)(),t=await e.scaleFactor(),i=await e.outerPosition();return{x:i.x/t,y:i.y/t}},o=async()=>{(0,n.getCurrentWindow)().minimize()},c=async()=>{let e=(0,n.getCurrentWindow)();await e.isFullscreen()?(await e.setFullscreen(!1),await e.unmaximize()):(0,n.getCurrentWindow)().toggleMaximize()},u=async()=>{(0,n.getCurrentWindow)().close()},d=async e=>(0,n.getCurrentWindow)().listen(a.es.WINDOW_CLOSE_REQUESTED,async()=>{await e(),console.log("exit app"),await (0,s.N)(0)}),h=async()=>{let e=(0,n.getCurrentWindow)(),t=await e.isFullscreen();await e.isMaximized()?await e.unmaximize():await e.setFullscreen(!t)},p=async e=>{let t=(0,n.getCurrentWindow)();await t.setAlwaysOnTop(e)},g=async()=>{await r.I.dispatch("quit-app"),await (0,s.N)(0)}},50843:(e,t,i)=>{"use strict";i.d(t,{m:()=>a});var n=i(2675);function a(e){let{accessToken:t,refreshToken:i,login:a,navigate:s,type:r,next:l="/",error:o}=e;!async function(){if(o)return s("/auth/error");if(!t||!i)return s("/library");let{error:e}=await n.ND.auth.setSession({access_token:t,refresh_token:i});if(e){console.error("Error setting session:",e),s("/auth/error");return}let{data:{user:c}}=await n.ND.auth.getUser();if(c){if(a(t,c),"recovery"===r)return s("/auth/recovery");s(l)}else console.error("Error fetching user data"),s("/auth/error")}()}},57597:(e,t,i)=>{"use strict";i.d(t,{D:()=>o,L:()=>l});var n=i(62574),a=i(84574),s=i(69921);let r=(0,a.createContext)(void 0),l=e=>{let{children:t}=e,[i]=(0,a.useState)(s.Ay),[l,o]=(0,a.useState)(null);return a.useEffect(()=>{i.getAppService().then(e=>o(e)),window.addEventListener("error",e=>"ResizeObserver loop limit exceeded"===e.message&&(e.stopImmediatePropagation(),e.preventDefault(),!0))},[i]),(0,n.jsx)(r.Provider,{value:{envConfig:i,appService:l},children:t})},o=()=>{let e=(0,a.useContext)(r);if(!e)throw Error("useEnv must be used within EnvProvider");return e}},58068:(e,t,i)=>{"use strict";i.d(t,{Ed:()=>r,LB:()=>d,Mp:()=>l,S$:()=>u,ZA:()=>o,i1:()=>s,ot:()=>h,ov:()=>a});var n=i(7269);async function a(e){return await (0,n.lA)("plugin:native-bridge|copy_uri_to_path",{payload:e})}async function s(e){await (0,n.lA)("plugin:native-bridge|use_background_audio",{payload:e})}async function r(e){return await (0,n.lA)("plugin:native-bridge|install_package",{payload:e})}async function l(e){return await (0,n.lA)("plugin:native-bridge|set_system_ui_visibility",{payload:e})}async function o(){return await (0,n.lA)("plugin:native-bridge|get_status_bar_height")}let c=null;async function u(){if(c)return c;let e=await (0,n.lA)("plugin:native-bridge|get_sys_fonts_list");return c=e,e}async function d(e){await (0,n.lA)("plugin:native-bridge|intercept_keys",{payload:e})}async function h(e){await (0,n.lA)("plugin:native-bridge|lock_screen_orientation",{payload:e})}},66763:(e,t,i)=>{"use strict";i.d(t,{I:()=>s});var n=i(84648);class a{on(e,t){this.asyncListeners.has(e)||this.asyncListeners.set(e,new Set),this.asyncListeners.get(e).add(t)}off(e,t){var i;null==(i=this.asyncListeners.get(e))||i.delete(t)}async dispatch(e,t){let i=this.asyncListeners.get(e);if(i){let n=new CustomEvent(e,{detail:t});for(let e of i)await e(n)}}onSync(e,t){this.syncListeners.has(e)||this.syncListeners.set(e,[]),this.syncListeners.get(e).push(t)}offSync(e,t){let i=this.syncListeners.get(e);i&&this.syncListeners.set(e,i.filter(e=>e!==t))}dispatchSync(e,t){let i=this.syncListeners.get(e);if(i){let n=new CustomEvent(e,{detail:t});for(let e of[...i].reverse())if(e(n))return!0}return!1}constructor(){(0,n._)(this,"syncListeners",void 0),(0,n._)(this,"asyncListeners",void 0),this.syncListeners=new Map,this.asyncListeners=new Map}}let s=new a},74166:(e,t,i)=>{Promise.resolve().then(i.bind(i,7716))},77553:(e,t,i)=>{"use strict";i.d(t,{A:()=>u});var n=i(62574),a=i(3073),s=i(84574),r=i(57597),l=i(29353),o=i(69921);let c=e=>{let{onClick:t,ariaLabel:i,id:a,children:s}=e;return(0,n.jsx)("button",{id:a,onClick:t,className:"window-button text-base-content/85 hover:text-base-content","aria-label":i,children:s})},u=e=>{let{className:t,headerRef:u,showMinimize:d=!0,showMaximize:h=!0,showClose:p=!0,onMinimize:g,onToggleMaximize:w,onClose:f}=e,m=(0,s.useRef)(null),{appService:b}=(0,r.D)(),v=async e=>{let t=e.target;if(t.closest(".btn")||t.closest(".window-button")||t.closest(".dropdown-container")||t.closest(".exclude-title-bar-mousedown"))return;let{getCurrentWindow:n}=await Promise.resolve().then(i.bind(i,88330));1===e.buttons&&(2===e.detail?n().toggleMaximize():n().startDragging())};(0,s.useEffect)(()=>{if(!(0,o.uO)())return;let e=null==u?void 0:u.current;return null==e||e.addEventListener("mousedown",v),()=>{null==e||e.removeEventListener("mousedown",v)}},[]);let _=async()=>{g?g():(0,l.u5)()},y=async()=>{w?w():(0,l.YF)()},x=async()=>{f?f():(0,l.wm)()};return(0,n.jsxs)("div",{ref:m,className:(0,a.A)("window-buttons flex h-8 items-center justify-end space-x-2",p||h||d?"visible":"hidden",t),children:[d&&(null==b?void 0:b.hasWindowBar)&&(0,n.jsx)(c,{onClick:_,ariaLabel:"Minimize",id:"titlebar-minimize",children:(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{fill:"currentColor",d:"M20 14H4v-2h16"})})}),h&&(null==b?void 0:b.hasWindowBar)&&(0,n.jsx)(c,{onClick:y,ariaLabel:"Maximize/Restore",id:"titlebar-maximize",children:(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{fill:"currentColor",d:"M4 4h16v16H4zm2 4v10h12V8z"})})}),p&&((null==b?void 0:b.hasWindowBar)||f)&&(0,n.jsx)(c,{onClick:x,ariaLabel:"Close",id:"titlebar-close",children:(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{fill:"currentColor",d:"M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"})})})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[7412,951,8375,7456,1029,6261,743,8769,1503,7749,1192,1985,426,3125,7358],()=>t(74166)),_N_E=e.O()}]);