"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2200],{42200:(e,t,r)=>{r.r(t),r.d(t,{MOBI:()=>N,isMOBI:()=>D});let i=e=>{if(!e)return"";let t=document.createElement("textarea");return t.innerHTML=e,t.value},s={XML:"application/xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml"},a={name:[0,32,"string"],type:[60,4,"string"],creator:[64,4,"string"],numRecords:[76,2,"uint"]},n={compression:[0,2,"uint"],numTextRecords:[8,2,"uint"],recordSize:[10,2,"uint"],encryption:[12,2,"uint"]},l={magic:[16,4,"string"],length:[20,4,"uint"],type:[24,4,"uint"],encoding:[28,4,"uint"],uid:[32,4,"uint"],version:[36,4,"uint"],titleOffset:[84,4,"uint"],titleLength:[88,4,"uint"],localeRegion:[94,1,"uint"],localeLanguage:[95,1,"uint"],resourceStart:[108,4,"uint"],huffcdic:[112,4,"uint"],numHuffcdic:[116,4,"uint"],exthFlag:[128,4,"uint"],trailingFlags:[240,4,"uint"],indx:[244,4,"uint"]},o={resourceStart:[108,4,"uint"],fdst:[192,4,"uint"],numFdst:[196,4,"uint"],frag:[248,4,"uint"],skel:[252,4,"uint"],guide:[260,4,"uint"]},c={magic:[0,4,"string"],length:[4,4,"uint"],count:[8,4,"uint"]},h={magic:[0,4,"string"],length:[4,4,"uint"],type:[8,4,"uint"],idxt:[20,4,"uint"],numRecords:[24,4,"uint"],encoding:[28,4,"uint"],language:[32,4,"uint"],total:[36,4,"uint"],ordt:[40,4,"uint"],ligt:[44,4,"uint"],numLigt:[48,4,"uint"],numCncx:[52,4,"uint"]},u={magic:[0,4,"string"],length:[4,4,"uint"],numControlBytes:[8,4,"uint"]},f={magic:[0,4,"string"],offset1:[8,4,"uint"],offset2:[12,4,"uint"]},d={magic:[0,4,"string"],length:[4,4,"uint"],numEntries:[8,4,"uint"],codeLength:[12,4,"uint"]},g={magic:[0,4,"string"],numEntries:[8,4,"uint"]},m={flags:[8,4,"uint"],dataStart:[12,4,"uint"],keyLength:[16,4,"uint"],keyStart:[20,4,"uint"]},p={1252:"windows-1252",65001:"utf-8"},w={100:["creator","string",!0],101:["publisher"],103:["description"],104:["isbn"],105:["subject","string",!0],106:["date"],108:["contributor","string",!0],109:["rights"],110:["subjectCode","string",!0],112:["source","string",!0],113:["asin"],121:["boundary","uint"],122:["fixedLayout"],125:["numResources","uint"],126:["originalResolution"],127:["zeroGutter"],128:["zeroMargin"],129:["coverURI"],132:["regionMagnification"],201:["coverOffset","uint"],202:["thumbnailOffset","uint"],503:["title"],524:["language","string",!0],527:["pageProgressionDirection"]},b={1:["ar","ar-SA","ar-IQ","ar-EG","ar-LY","ar-DZ","ar-MA","ar-TN","ar-OM","ar-YE","ar-SY","ar-JO","ar-LB","ar-KW","ar-AE","ar-BH","ar-QA"],2:["bg"],3:["ca"],4:["zh","zh-TW","zh-CN","zh-HK","zh-SG"],5:["cs"],6:["da"],7:["de","de-DE","de-CH","de-AT","de-LU","de-LI"],8:["el"],9:["en","en-US","en-GB","en-AU","en-CA","en-NZ","en-IE","en-ZA","en-JM",null,"en-BZ","en-TT","en-ZW","en-PH"],10:["es","es-ES","es-MX",null,"es-GT","es-CR","es-PA","es-DO","es-VE","es-CO","es-PE","es-AR","es-EC","es-CL","es-UY","es-PY","es-BO","es-SV","es-HN","es-NI","es-PR"],11:["fi"],12:["fr","fr-FR","fr-BE","fr-CA","fr-CH","fr-LU","fr-MC"],13:["he"],14:["hu"],15:["is"],16:["it","it-IT","it-CH"],17:["ja"],18:["ko"],19:["nl","nl-NL","nl-BE"],20:["no","nb","nn"],21:["pl"],22:["pt","pt-BR","pt-PT"],23:["rm"],24:["ro"],25:["ru"],26:["hr",null,"sr"],27:["sk"],28:["sq"],29:["sv","sv-SE","sv-FI"],30:["th"],31:["tr"],32:["ur"],33:["id"],34:["uk"],35:["be"],36:["sl"],37:["et"],38:["lv"],39:["lt"],41:["fa"],42:["vi"],43:["hy"],44:["az"],45:["eu"],46:["hsb"],47:["mk"],48:["st"],49:["ts"],50:["tn"],52:["xh"],53:["zu"],54:["af"],55:["ka"],56:["fo"],57:["hi"],58:["mt"],59:["se"],62:["ms"],63:["kk"],65:["sw"],67:["uz",null,"uz-UZ"],68:["tt"],69:["bn"],70:["pa"],71:["gu"],72:["or"],73:["ta"],74:["te"],75:["kn"],76:["ml"],77:["as"],78:["mr"],79:["sa"],82:["cy","cy-GB"],83:["gl","gl-ES"],87:["kok"],97:["ne"],98:["fy"]},y=(e,t)=>{let r=new e.constructor(e.length+t.length);return r.set(e),r.set(t,e.length),r},R=(e,t,r)=>{let i=new e.constructor(e.length+t.length+r.length);return i.set(e),i.set(t,e.length),i.set(r,e.length+t.length),i},x=new TextDecoder,S=e=>x.decode(e),T=e=>{if(!e)return;let t=e.byteLength;return new DataView(e)[4===t?"getUint32":2===t?"getUint16":"getUint8"](0)},L=(e,t)=>Object.fromEntries(Array.from(Object.entries(e)).map(([e,[r,i,s]])=>[e,("string"===s?S:T)(t.slice(r,r+i))])),A=e=>new TextDecoder(p[e]),E=(e,t=0)=>{let r=0,i=0;for(let s of e.subarray(t,t+4))if(r=r<<7|(127&s)>>>0,i++,128&s)break;return{value:r,length:i}},C=e=>{let t=0;for(let r of e.subarray(-4))128&r&&(t=0),t=t<<7|127&r;return t},M=e=>{let t=0;for(;e>0;e>>=1)(1&e)==1&&t++;return t},I=e=>{let t=0;for(;(1&e)==0;)e>>=1,t++;return t},v=e=>{let t=[];for(let r=0;r<e.length;r++){let i=e[r];if(0===i)t.push(0);else if(i<=8)for(let s of e.subarray(r+1,(r+=i)+1))t.push(s);else if(i<=127)t.push(i);else if(i<=191){let s=i<<8|e[r+++1],a=(16383&s)>>>3,n=(7&s)+3;for(let e=0;e<n;e++)t.push(t[t.length-a])}else t.push(32,128^i)}return Uint8Array.from(t)},U=(e,t)=>{let r=t>>3,i=t+32,s=i>>3,a=0n;for(let t=r;t<=s;t++)a=a<<8n|BigInt(e[t]??0);return a>>8n-BigInt(7&i)&4294967295n},k=async(e,t)=>{let r=await t(e.huffcdic),{magic:i,offset1:s,offset2:a}=L(f,r);if("HUFF"!==i)throw Error("Invalid HUFF record");let n=Array.from({length:256},(e,t)=>s+4*t).map(e=>T(r.slice(e,e+4))).map(e=>[128&e,31&e,e>>>8]),l=[null].concat(Array.from({length:32},(e,t)=>a+8*t).map(e=>[T(r.slice(e,e+4)),T(r.slice(e+4,e+8))])),o=[];for(let r=1;r<e.numHuffcdic;r++){let i=await t(e.huffcdic+r),s=L(d,i);if("CDIC"!==s.magic)throw Error("Invalid CDIC record");let a=Math.min(1<<s.codeLength,s.numEntries-o.length),n=i.slice(s.length);for(let e=0;e<a;e++){let t=T(n.slice(2*e,2*e+2)),r=T(n.slice(t,t+2)),i=32767&r,s=32768&r,a=new Uint8Array(n.slice(t+2,t+2+i));o.push([a,s])}}let c=e=>{let t=new Uint8Array,r=8*e.byteLength;for(let i=0;i<r;){let s=Number(U(e,i)),[a,h,u]=n[s>>>24];if(!a){for(;s>>>32-h<l[h][0];)h+=1;u=l[h][1]}if((i+=h)>r)break;let f=u-(s>>>32-h),[d,g]=o[f];g||(d=c(d),o[f]=[d,!0]),t=y(t,d)}return t};return c},O=async(e,t)=>{let r=await t(e),i=L(h,r);if("INDX"!==i.magic)throw Error("Invalid INDX record");let s=A(i.encoding),a=r.slice(i.length),n=L(u,a);if("TAGX"!==n.magic)throw Error("Invalid TAGX section");let l=Array.from({length:(n.length-12)/4},(e,t)=>new Uint8Array(a.slice(12+4*t,12+4*t+4))),o={},c=0;for(let r=0;r<i.numCncx;r++){let a=await t(e+i.numRecords+r+1),n=new Uint8Array(a);for(let e=0;e<n.byteLength;){let t=e,{value:r,length:i}=E(n,e);e+=i;let l=a.slice(e,e+r);e+=r,o[c+t]=s.decode(l)}c+=65536}let f=[];for(let r=0;r<i.numRecords;r++){let i=await t(e+1+r),s=new Uint8Array(i),a=L(h,i);if("INDX"!==a.magic)throw Error("Invalid INDX record");for(let e=0;e<a.numRecords;e++){let t=a.idxt+4+2*e,r=T(i.slice(t,t+2)),o=T(i.slice(r,r+1)),c=S(i.slice(r+1,r+1+o)),h=[],u=r+1+o,d=0,g=u+n.numControlBytes;for(let[e,t,r,a]of l){if(1&a){d++;continue}let n=u+d,l=T(i.slice(n,n+1))&r;if(l===r)if(M(r)>1){let{value:r,length:i}=E(s,g);h.push([e,null,r,t]),g+=i}else h.push([e,1,null,t]);else h.push([e,l>>I(r),null,t])}let m={};for(let[e,t,r,i]of h){let a=[];if(null!=t)for(let e=0;e<t*i;e++){let{value:e,length:t}=E(s,g);a.push(e),g+=t}else{let e=0;for(;e<r;){let{value:t,length:r}=E(s,g);a.push(t),g+=r,e+=r}}m[e]=a}f.push({name:c,tagMap:m})}}return{table:f,cncx:o}},B=async(e,t)=>{let{table:r,cncx:i}=await O(e,t),s=r.map(({tagMap:e},t)=>({index:t,offset:e[1]?.[0],size:e[2]?.[0],label:i[e[3]]??"",headingLevel:e[4]?.[0],pos:e[6],parent:e[21]?.[0],firstChild:e[22]?.[0],lastChild:e[23]?.[0]})),a=e=>(null==e.firstChild||(e.children=s.filter(t=>t.parent===e.index).map(a)),e);return s.filter(e=>0===e.headingLevel).map(a)},H=(e,t)=>{let{magic:r,count:i}=L(c,e);if("EXTH"!==r)throw Error("Invalid EXTH header");let s=A(t),a={},n=12;for(let t=0;t<i;t++){let t=T(e.slice(n,n+4)),r=T(e.slice(n+4,n+8));if(t in w){let[i,l,o]=w[t],c=e.slice(n+8,n+r),h="uint"===l?T(c):s.decode(c);o?(a[i]??=[],a[i].push(h)):a[i]=h}n+=r}return a},F=async(e,t)=>{let{flags:r,dataStart:i,keyLength:s,keyStart:a}=L(m,e),n=new Uint8Array(e.slice(i));if(2&r){let t=new Uint8Array(e.slice(a,a+s)),r=Math.min(16===s?1024:1040,n.length);for(var l=0;l<r;l++)n[l]=n[l]^t[l%t.length]}if(1&r)try{return await t(n)}catch(e){console.warn(e),console.warn("Failed to decompress font")}return n},D=async e=>"BOOKMOBI"===S(await e.slice(60,68).arrayBuffer());class z{#e;#t;pdb;async open(e){this.#e=e;let t=L(a,await e.slice(0,78).arrayBuffer());this.pdb=t;let r=await e.slice(78,78+8*t.numRecords).arrayBuffer();this.#t=Array.from({length:t.numRecords},(e,t)=>T(r.slice(8*t,8*t+4))).map((e,t,r)=>[e,r[t+1]])}loadRecord(e){let t=this.#t[e];if(!t)throw RangeError("Record index out of bounds");return this.#e.slice(...t).arrayBuffer()}async loadMagic(e){let t=this.#t[e][0];return S(await this.#e.slice(t,t+4).arrayBuffer())}}class N extends z{#r=0;#i;#s;#a;#n;#l;constructor({unzlib:e}){super(),this.unzlib=e}async open(e){await super.open(e),this.headers=this.#o(await super.loadRecord(0)),this.#i=this.headers.mobi.resourceStart;let t=this.headers.mobi.version>=8;if(!t){let e=this.headers.exth?.boundary;if(e<0xffffffff)try{this.headers=this.#o(await super.loadRecord(e)),this.#r=e,t=!0}catch(e){console.warn(e),console.warn("Failed to open KF8; falling back to MOBI")}}return await this.#c(),t?new J(this).init():new $(this).init()}#o(e){let t=L(n,e),r=L(l,e);if("MOBI"!==r.magic)throw Error("Missing MOBI header");let{titleOffset:i,titleLength:s,localeLanguage:a,localeRegion:c}=r;r.title=e.slice(i,i+s);let h=b[a];r.language=h?.[c>>2]??h?.[0];let u=64&r.exthFlag?H(e.slice(r.length+16),r.encoding):null,f=r.version>=8?L(o,e):null;return{palmdoc:t,mobi:r,exth:u,kf8:f}}async #c(){let{palmdoc:e,mobi:t}=this.headers;this.#s=A(t.encoding),this.#a=new TextEncoder;let{compression:r}=e;if(this.#n=1===r?e=>e:2===r?v:17480===r?await k(t,this.loadRecord.bind(this)):null,!this.#n)throw Error("Unknown compression type");let{trailingFlags:i}=t,s=1&i,a=M(i>>>1);this.#l=e=>{for(let t=0;t<a;t++){let t=C(e);e=e.subarray(0,-t)}if(s){let t=(3&e[e.length-1])+1;e=e.subarray(0,-t)}return e}}decode(...e){return this.#s.decode(...e)}encode(...e){return this.#a.encode(...e)}loadRecord(e){return super.loadRecord(this.#r+e)}loadMagic(e){return super.loadMagic(this.#r+e)}loadText(e){return this.loadRecord(e+1).then(e=>new Uint8Array(e)).then(this.#l).then(this.#n)}async loadResource(e){let t=await super.loadRecord(this.#i+e),r=S(t.slice(0,4));return"FONT"===r?F(t,this.unzlib):"VIDE"===r||"AUDI"===r?t.slice(12):t}getNCX(){let e=this.headers.mobi.indx;if(e<0xffffffff)return B(e,this.loadRecord.bind(this))}getMetadata(){let{mobi:e,exth:t}=this.headers;return{identifier:e.uid.toString(),title:i(t?.title||this.decode(e.title)),author:t?.creator?.map(i),publisher:i(t?.publisher),language:t?.language??e.language,published:t?.date,description:i(t?.description),subject:t?.subject?.map(i),rights:i(t?.rights),contributor:t?.contributor}}async getCover(){let{exth:e}=this.headers,t=e?.coverOffset<0xffffffff?e?.coverOffset:e?.thumbnailOffset<0xffffffff?e?.thumbnailOffset:null;if(null!=t)return new Blob([await this.loadResource(t)])}}let X=/<\s*(?:mbp:)?pagebreak[^>]*>/gi,j=/<[^<>]+filepos=['"]{0,1}(\d+)[^<>]*>/gi,G=e=>{let t=0;for(;e;){let r=e.parentElement;if(r){let e=r.tagName.toLowerCase();"p"===e?t+=1.5:"blockquote"===e&&(t+=2)}e=r}return t};class ${parser=new DOMParser;serializer=new XMLSerializer;#h=new Map;#u=new Map;#f=new Map;#d;#g=[];#m=s.HTML;constructor(e){this.mobi=e}async init(){let e=new Uint8Array;for(let t=0;t<this.mobi.headers.palmdoc.numTextRecords;t++)e=y(e,await this.mobi.loadText(t));let t=Array.from(new Uint8Array(e),e=>String.fromCharCode(e)).join("");this.#d=[0].concat(Array.from(t.matchAll(X),e=>e.index)).map((e,r,i)=>t.slice(e,i[r+1])).map(e=>Uint8Array.from(e,e=>e.charCodeAt(0))).map(e=>({book:this,raw:e})).reduce((e,t)=>{let r=e[e.length-1];return t.start=r?.end??0,t.end=t.start+t.raw.byteLength,e.concat(t)},[]),this.sections=this.#d.map((e,t)=>({id:t,load:()=>this.loadSection(e),createDocument:()=>this.createDocument(e),size:e.end-e.start}));try{this.landmarks=await this.getGuide();let e=this.landmarks.find(({type:e})=>e?.includes("toc"))?.href;if(e){let t,{index:r}=this.resolveHref(e),i=await this.sections[r].createDocument(),s=0,a=0,n=new Map,l=new Map;this.toc=Array.from(i.querySelectorAll("a[filepos]")).reduce((e,r)=>{let i=G(r),o={label:r.innerText?.trim()??"",href:`filepos:${r.getAttribute("filepos")}`},c=i>a?s+1:i===a?s:n.get(i)??Math.max(0,s-1);if(c>s)t?(t.subitems??=[],t.subitems.push(o),l.set(c,t)):e.push(o);else{let t=l.get(c);t?t.subitems.push(o):e.push(o)}return t=o,s=c,a=i,n.set(i,c),e},[])}}catch(e){console.warn(e)}return this.#g=[...new Set(Array.from(t.matchAll(j),e=>e[1]))].map(e=>({filepos:e,number:Number(e)})).sort((e,t)=>e.number-t.number),this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getGuide(){return Array.from((await this.createDocument(this.#d[0])).getElementsByTagName("reference"),e=>({label:e.getAttribute("title"),type:e.getAttribute("type")?.split(/\s/),href:`filepos:${e.getAttribute("filepos")}`}))}async loadResource(e){if(this.#h.has(e))return this.#h.get(e);let t=await this.mobi.loadResource(e),r=URL.createObjectURL(new Blob([t]));return this.#h.set(e,r),r}async loadRecindex(e){return this.loadResource(Number(e)-1)}async replaceResources(e){for(let t of e.querySelectorAll("img[recindex]")){let e=t.getAttribute("recindex");try{t.src=await this.loadRecindex(e)}catch{console.warn(`Failed to load image ${e}`)}}for(let t of e.querySelectorAll("[mediarecindex]")){let e=t.getAttribute("mediarecindex"),r=t.getAttribute("recindex");try{t.src=await this.loadRecindex(e),r&&(t.poster=await this.loadRecindex(r))}catch{console.warn(`Failed to load media ${e}`)}}for(let t of e.querySelectorAll("[filepos]")){let e=t.getAttribute("filepos");t.href=`filepos:${e}`}}async loadText(e){if(this.#u.has(e))return this.#u.get(e);let{raw:t}=e,r=this.#g.filter(({number:t})=>t>=e.start&&t<e.end).map(t=>({...t,offset:t.number-e.start})),i=t;r.length&&(i=t.subarray(0,r[0].offset),r.forEach(({filepos:e,offset:s},a)=>{let n=r[a+1],l=this.mobi.encode(`<a id="filepos${e}"></a>`);i=R(i,l,t.subarray(s,n?.offset))}));let s=this.mobi.decode(i).replaceAll(X,"");return this.#u.set(e,s),s}async createDocument(e){let t=await this.loadText(e);return this.parser.parseFromString(t,this.#m)}async loadSection(e){if(this.#f.has(e))return this.#f.get(e);let t=await this.createDocument(e),r=t.createElement("style");t.head.append(r),r.append(t.createTextNode(`blockquote {
            margin-block-start: 0;
            margin-block-end: 0;
            margin-inline-start: 1em;
            margin-inline-end: 0;
        }`)),await this.replaceResources(t);let i=this.serializer.serializeToString(t),s=URL.createObjectURL(new Blob([i],{type:this.#m}));return this.#f.set(e,s),s}resolveHref(e){let t=e.match(/filepos:(.*)/)[1],r=Number(t);return{index:this.#d.findIndex(e=>e.end>r),anchor:e=>e.getElementById(`filepos${t}`)}}splitTOCHref(e){let t=e.match(/filepos:(.*)/)[1],r=Number(t);return[this.#d.findIndex(e=>e.end>r),`filepos${t}`]}getTOCFragment(e,t){return e.getElementById(t)}isExternal(e){return/^(?!blob|filepos)\w+:/i.test(e)}destroy(){for(let e of this.#h.values())URL.revokeObjectURL(e);for(let e of this.#f.values())URL.revokeObjectURL(e)}}let q=/kindle:(flow|embed):(\w+)(?:\?mime=(\w+\/[-+.\w]+))?/,P=/kindle:pos:fid:(\w+):off:(\w+)/,V=e=>{let[t,r,i]=e.match(q).slice(1);return{resourceType:t,id:parseInt(r,32),type:i}},Z=e=>{let[t,r]=e.match(P).slice(1);return{fid:parseInt(t,32),off:parseInt(r,32)}},Y=(e=0,t=0)=>`kindle:pos:fid:${e.toString(32).toUpperCase().padStart(4,"0")}:off:${t.toString(32).toUpperCase().padStart(10,"0")}`,K=e=>{let t=e.match(/\s(id|name|aid)\s*=\s*['"]([^'"]*)['"]/i);if(!t)return;let[,r,i]=t;return`[${r}="${CSS.escape(i)}"]`},W=async(e,t,r)=>{let i=[];e.replace(t,(...e)=>(i.push(e),null));let s=[];for(let e of i)s.push(await r(...e));return e.replace(t,()=>s.shift())},_=e=>{for(let t of e){if("page-spread-left"===t||"rendition:page-spread-left"===t)return"left";if("page-spread-right"===t||"rendition:page-spread-right"===t)return"right";if("rendition:page-spread-center"===t)return"center"}};class J{parser=new DOMParser;serializer=new XMLSerializer;transformTarget=new EventTarget;#f=new Map;#p=new Map;#w=new Map;#b={};#d;#y;#R=new Uint8Array;#x=new Uint8Array;#S=-1;#T=-1;#m=s.XHTML;#L=new Map;constructor(e){this.mobi=e}async init(){let e=this.mobi.loadRecord.bind(this.mobi),{kf8:t}=this.mobi.headers;try{let r=await e(t.fdst),i=L(g,r);if("FDST"!==i.magic)throw Error("Missing FDST record");let s=Array.from({length:i.numEntries},(e,t)=>12+8*t).map(e=>[T(r.slice(e,e+4)),T(r.slice(e+4,e+8))]);this.#b.fdstTable=s,this.#y=s[s.length-1][1]}catch{}let r=(await O(t.skel,e)).table.map(({name:e,tagMap:t},r)=>({index:r,name:e,numFrag:t[1][0],offset:t[6][0],length:t[6][1]})),a=await O(t.frag,e),n=a.table.map(({name:e,tagMap:t})=>({insertOffset:parseInt(e),selector:a.cncx[t[2][0]],index:t[4][0],offset:t[6][0],length:t[6][1]}));this.#b.skelTable=r,this.#b.fragTable=n,this.#d=r.reduce((e,t)=>{let r=e[e.length-1],i=r?.fragEnd??0,s=i+t.numFrag,a=n.slice(i,s),l=t.length+a.map(e=>e.length).reduce((e,t)=>e+t),o=(r?.totalLength??0)+l;return e.concat({skel:t,frags:a,fragEnd:s,length:l,totalLength:o})},[]);let l=await this.getResourcesByMagic(["RESC","PAGE"]),o=new Map;if(l.RESC){let e=await this.mobi.loadRecord(l.RESC),t=this.mobi.decode(e.slice(16)).replace(/\0/g,""),r=t.search(/\?>/),i=`<package>${t.slice(r)}</package>`;for(let e of this.parser.parseFromString(i,s.XML).querySelectorAll("spine > itemref")){let t=parseInt(e.getAttribute("skelid"));o.set(t,_(e.getAttribute("properties")?.split(" ")??[]))}}this.sections=this.#d.map((e,t)=>e.frags.length?{id:t,load:()=>this.loadSection(e),createDocument:()=>this.createDocument(e),size:e.length,pageSpread:o.get(t)}:{linear:"no"});try{let e=await this.mobi.getNCX(),t=({label:e,pos:r,children:s})=>{let[a,n]=r,l=Y(a,n),o=this.#p.get(a);return o?o.push(n):this.#p.set(a,[n]),{label:i(e),href:l,subitems:s?.map(t)}};this.toc=e?.map(t),this.landmarks=await this.getGuide()}catch(e){console.warn(e)}let{exth:c}=this.mobi.headers;return this.dir=c.pageProgressionDirection,this.rendition={layout:"true"===c.fixedLayout?"pre-paginated":"reflowable",viewport:Object.fromEntries(c.originalResolution?.split("x")?.slice(0,2)?.map((e,t)=>[t?"height":"width",e])??[])},this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getResourcesByMagic(e){let t={},r=this.mobi.headers.kf8.resourceStart,i=this.mobi.pdb.numRecords;for(let s=r;s<i;s++)try{let r=await this.mobi.loadMagic(s),i=e.find(e=>e===r);i&&(t[i]=s)}catch{}return t}async getGuide(){let e=this.mobi.headers.kf8.guide;if(e<0xffffffff){let t=this.mobi.loadRecord.bind(this.mobi),{table:r,cncx:i}=await O(e,t);return r.map(({name:e,tagMap:t})=>({label:i[t[1][0]]??"",type:e?.split(/\s/),href:Y(t[6]?.[0]??t[3]?.[0])}))}}async loadResourceBlob(e){let{resourceType:t,id:r,type:i}=V(e),a="flow"===t?await this.loadFlow(r):await this.mobi.loadResource(r-1),n=new CustomEvent("data",{detail:{data:[s.XHTML,s.HTML,s.CSS,s.SVG].includes(i)?await this.replaceResources(this.mobi.decode(a)):a,type:i}});this.transformTarget.dispatchEvent(n);let l=await n.detail.data,o=await n.detail.type,c=o===s.SVG?this.parser.parseFromString(l,o):null;return[new Blob([l],{newType:o}),c?.getElementsByTagNameNS("http://www.w3.org/2000/svg","image")?.length?c.documentElement:null]}async loadResource(e){if(this.#f.has(e))return this.#f.get(e);let[t,r]=await this.loadResourceBlob(e),i=r?e:URL.createObjectURL(t);return r&&this.#L.set(i,r),this.#f.set(e,i),i}replaceResources(e){return W(e,RegExp(q,"g"),this.loadResource.bind(this))}async loadRaw(e,t){let r=t-this.#R.length,i=null==this.#y?1/0:this.#y-this.#x.length-e;if(r<0||r<i){for(;this.#R.length<t;){let e=++this.#S,t=await this.mobi.loadText(e);this.#R=y(this.#R,t)}return this.#R.slice(e,t)}for(;this.#y-this.#x.length>e;){let e=this.mobi.headers.palmdoc.numTextRecords-1-++this.#T,t=await this.mobi.loadText(e);this.#x=y(t,this.#x)}let s=this.#y-this.#x.length;return this.#x.slice(e-s,t-s)}loadFlow(e){if(e<0xffffffff)return this.loadRaw(...this.#b.fdstTable[e])}async loadText(e){let{skel:t,frags:r,length:i}=e,s=await this.loadRaw(t.offset,t.offset+i),a=s.slice(0,t.length);for(let e of r){let r=e.insertOffset-t.offset,i=t.length+e.offset,n=s.slice(i,i+e.length);a=R(a.slice(0,r),n,a.slice(r));let l=this.#p.get(e.index);if(l)for(let t of l){let r=K(this.mobi.decode(n).slice(t));this.#A(e.index,t,r)}}return this.mobi.decode(a)}async createDocument(e){let t=await this.loadText(e);return this.parser.parseFromString(t,this.#m)}async loadSection(e){if(this.#f.has(e))return this.#f.get(e);let t=await this.loadText(e),r=await this.replaceResources(t),i=this.parser.parseFromString(r,this.#m);for(let[e,t]of((i.querySelector("parsererror")||!i.documentElement?.namespaceURI)&&(this.#m=s.HTML,i=this.parser.parseFromString(r,this.#m)),this.#L))for(let r of i.querySelectorAll(`img[src="${e}"]`))r.replaceWith(t);let a=URL.createObjectURL(new Blob([this.serializer.serializeToString(i)],{type:this.#m}));return this.#f.set(e,a),a}getIndexByFID(e){return this.#d.findIndex(t=>t.frags.some(t=>t.index===e))}#A(e,t,r){let i=this.#w.get(e);if(i)i.set(t,r);else{let i=new Map;this.#w.set(e,i),i.set(t,r)}}async resolveHref(e){let{fid:t,off:r}=Z(e),i=this.getIndexByFID(t);if(i<0)return;let s=this.#w.get(t)?.get(r);if(s)return{index:i,anchor:e=>e.querySelector(s)};let{skel:a,frags:n}=this.#d[i],l=n.find(e=>e.index===t),o=a.offset+a.length+l.offset,c=await this.loadRaw(o,o+l.length),h=K(this.mobi.decode(c).slice(r));return this.#A(t,r,h),{index:i,anchor:e=>e.querySelector(h)}}splitTOCHref(e){let t=Z(e);return[this.getIndexByFID(t.fid),t]}getTOCFragment(e,{fid:t,off:r}){let i=this.#w.get(t)?.get(r);return e.querySelector(i)}isExternal(e){return/^(?!blob|kindle)\w+:/i.test(e)}destroy(){for(let e of this.#f.values())URL.revokeObjectURL(e)}}}}]);