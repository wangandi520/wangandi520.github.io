"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5935],{65935:(e,t,r)=>{r.d(t,{EPUB:()=>F});var i=r(28377);let a={CONTAINER:"urn:oasis:names:tc:opendocument:xmlns:container",XHTML:"http://www.w3.org/1999/xhtml",OPF:"http://www.idpf.org/2007/opf",EPUB:"http://www.idpf.org/2007/ops",DC:"http://purl.org/dc/elements/1.1/",ENC:"http://www.w3.org/2001/04/xmlenc#",NCX:"http://www.daisy.org/z3986/2005/ncx/",XLINK:"http://www.w3.org/1999/xlink",SMIL:"http://www.w3.org/ns/SMIL"},s={XML:"application/xml",NCX:"application/x-dtbncx+xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml",JS:/\/(x-)?(javascript|ecmascript)/},n={a11y:"http://www.idpf.org/epub/vocab/package/a11y/#",dcterms:"http://purl.org/dc/terms/",marc:"http://id.loc.gov/vocabulary/",media:"http://www.idpf.org/epub/vocab/overlays/#",onix:"http://www.editeur.org/ONIX/book/codelists/current.html#",rendition:"http://www.idpf.org/vocab/rendition/#",schema:"http://schema.org/",xsd:"http://www.w3.org/2001/XMLSchema#",msv:"http://www.idpf.org/epub/vocab/structure/magazine/#",prism:"http://www.prismstandard.org/specifications/3.0/PRISM_CV_Spec_3.0.htm#"},l={art:"artist",aut:"author",clr:"colorist",edt:"editor",ill:"illustrator",nrt:"narrator",trl:"translator",pbl:"publisher"},o={"02":"isbn","06":"doi",15:"isbn",26:"doi",34:"issn"},h=e=>e.toLowerCase().replace(/[-:](.)/g,(e,t)=>t.toUpperCase()),c=e=>e?e.replace(/[\t\n\f\r ]+/g," ").replace(/^[\t\n\f\r ]+/,"").replace(/[\t\n\f\r ]+$/,""):"",d=(e,t,r)=>r?r=>r.getAttribute(e)?.split(/\s/)?.includes(t):"function"==typeof t?r=>t(r.getAttribute(e)):r=>r.getAttribute(e)===t,u=(...e)=>t=>t?Object.fromEntries(e.map(e=>[h(e),t.getAttribute(e)])):null,p=e=>c(e?.textContent),m=(e,t)=>{let r=e.lookupNamespaceURI(null)===t||e.lookupPrefix(t),i=r?(e,r)=>e=>e.namespaceURI===t&&e.localName===r:(e,t)=>e=>e.localName===t;return{$:(e,t)=>[...e.children].find(i(e,t)),$$:(e,t)=>[...e.children].filter(i(e,t)),$$$:r?(e,r)=>[...e.getElementsByTagNameNS(t,r)]:(e,t)=>[...e.getElementsByTagName(t)]}},f=(e,t)=>{try{if(e=e.replace(/%2c/gi,",").replace(/%3a/gi,":"),t.includes(":")&&!t.startsWith("OEBPS"))return new URL(e,t);let r="https://invalid.invalid/",i=new URL(e,r+t);return i.search="",decodeURI(i.href.replace(r,""))}catch(t){return console.warn(t),e}},g=e=>/^(?!blob)\w+:/i.test(e),y=(e,t)=>{if(!e)return t;let r=e.replace(/\/$/,"").split("/"),i=t.replace(/\/$/,"").split("/"),a=(r.length>i.length?r:i).findIndex((e,t)=>r[t]!==i[t]);return a<0?"":Array(r.length-a).fill("..").concat(i.slice(a)).join("/")},b=e=>e.slice(0,e.lastIndexOf("/")+1),w=async(e,t,r)=>{let i=[];e.replace(t,(...e)=>(i.push(e),null));let a=[];for(let e of i)a.push(await r(...e));return e.replace(t,()=>a.shift())},I=e=>e.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),v=e=>{for(let[t,r]of Object.entries(e))null==r?delete e[t]:Array.isArray(r)?(e[t]=r.filter(e=>e).map(e=>"object"!=typeof e||Array.isArray(e)?e:v(e)),e[t].length?1===e[t].length&&(e[t]=e[t][0]):delete e[t]):"object"==typeof r&&(e[t]=v(r),Object.keys(r).length||delete e[t]);let t=Object.keys(e);return 1===t.length&&"name"===t[0]?e[t[0]]:e},x=e=>{let t=new Map(Object.entries(n)),r=e.documentElement.getAttributeNS(a.EPUB,"prefix")||e.documentElement.getAttribute("prefix");if(r)for(let[,e,i]of r.matchAll(/(.+): +(.+)[ \t\r\n]*/g))t.set(e,i);return t},S=(e,t)=>{if(!e)return null;let[r,i]=e.split(":"),a=i||r,s=t.get(i?r:null);return s?s+a:null},L=e=>{let{$:t}=m(e,a.OPF),r=t(e.documentElement,"metadata"),i=Object.groupBy(r.children,e=>e.namespaceURI===a.DC?"dc":e.namespaceURI===a.OPF&&"meta"===e.localName?e.hasAttribute("name")?"legacyMeta":"meta":""),s=r.getAttribute("xml:lang")??e.documentElement.getAttribute("xml:lang")??"und",c=x(e),d=e=>{let t=e.getAttribute("property"),r=e.getAttribute("scheme");return{property:S(t,c)??t,scheme:S(r,c)??r,lang:e.getAttribute("xml:lang"),value:p(e),props:f(e),attrs:Object.fromEntries(Array.from(e.attributes).filter(e=>e.namespaceURI===a.OPF).map(e=>[e.localName,e.value]))}},u=Map.groupBy(i.meta??[],e=>e.getAttribute("refines")),f=e=>{let t=u.get(e?"#"+e.getAttribute("id"):null);return t?Object.groupBy(t.map(d),e=>e.property):null},g=Object.fromEntries(Object.entries(Object.groupBy(i.dc||[],e=>e.localName)).map(([e,t])=>[e,t.map(d)])),y=f()??{},b=Object.fromEntries(i.legacyMeta?.map(e=>[e.getAttribute("name"),e.getAttribute("content")])??[]),w=e=>e?.[0]?.value,I=(e,t)=>w(e?.props?.[t]),L=e=>{if(!e)return null;let t=e.props?.["alternate-script"]??[],r=e.attrs["alt-rep"];if(!t.length&&(!e.lang||e.lang===s)&&!r)return e.value;let i={[e.lang??s]:e.value};for(let a of(r&&(i[e.attrs["alt-rep-lang"]]=r),t))i[a.lang]??=a.value;return i},A=e=>e?{name:L(e),sortAs:L(e.props?.["file-as"]?.[0])??e.attrs["file-as"],role:e.props?.role?.filter(e=>e.scheme===n.marc+"relators")?.map(e=>e.value)??[e.attrs.role],code:I(e,"term")??e.attrs.term,scheme:I(e,"authority")??e.attrs.authority}:null,E=e=>({name:L(e),position:w(e.props?.["group-position"])}),M=e=>{let{value:t}=e;if(/^urn:/i.test(t))return t;if(/^doi:/i.test(t))return`urn:${t}`;let r=e.props?.["identifier-type"];if(!r){let r=e.attrs.scheme;return r?/^(doi|isbn|uuid)$/i.test(r)?`urn:${r}:${t}`:{scheme:r,value:t}:t}if(r.scheme===n.onix+"codelist5"){let e=o[r.value];if(e)return`urn:${e}:${t}`}return t},C=Object.groupBy(y["belongs-to-collection"]??[],e=>"series"===I(e,"collection-type")?"series":"collection"),N=g.title?.find(e=>"main"===I(e,"title-type"))??g.title?.[0],O={identifier:B(e),title:L(N),sortAs:L(N?.props?.["file-as"]?.[0])??N?.attrs?.["file-as"]??b?.["calibre:title_sort"],subtitle:g.title?.find(e=>"subtitle"===I(e,"title-type"))?.value,language:g.language?.map(e=>e.value),description:w(g.description),publisher:A(g.publisher?.[0]),published:g.date?.find(e=>"publication"===e.attrs.event)?.value??w(g.date),modified:w(y[n.dcterms+"modified"])??g.date?.find(e=>"modification"===e.attrs.event)?.value,subject:g.subject?.map(A),belongsTo:{collection:C.collection?.map(E),series:C.series?.map(E)??b?.["calibre:series"]?{name:b?.["calibre:series"],position:parseFloat(b?.["calibre:series_index"])}:null},altIdentifier:g.identifier?.map(M),source:g.source?.map(M),rights:w(g.rights)},R=e=>t=>{let r=new Set(t.role?.map(t=>l[t]??e));return[r.size?r:[e],t]};for(let[e,t]of[].concat(g.creator?.map(A)?.map(R("author"))??[],g.contributor?.map(A)?.map(R("contributor"))??[]))for(let r of e)O[r]?O[r].push(t):O[r]=[t];v(O),O.altIdentifier===O.identifier&&delete O.altIdentifier;let U={},k={};for(let[e,t]of Object.entries(y))e.startsWith(n.rendition)?U[h(e.replace(n.rendition,""))]=w(t):e.startsWith(n.media)&&(k[h(e.replace(n.media,""))]=w(t));return k.duration&&(k.duration=T(k.duration)),{metadata:O,rendition:U,media:k}},A=(e,t=e=>e)=>{let{$:r,$$:i,$$$:s}=m(e,a.XHTML),n=e=>e?decodeURI(t(e)):null,l=e=>t=>{let i=r(t,"a")??r(t,"span"),s=r(t,"ol"),l=n(i?.getAttribute("href")),h={label:p(i)||i?.getAttribute("title"),href:l,subitems:o(s)};return e&&(h.type=i?.getAttributeNS(a.EPUB,"type")?.split(/\s/)),h},o=(e,t)=>e?i(e,"li").map(l(t)):null,h=(e,t)=>o(r(e,"ol"),t),c=s(e,"nav"),d=null,u=null,f=null,g=[];for(let e of c){let t=e.getAttributeNS(a.EPUB,"type")?.split(/\s/)??[];t.includes("toc")?d??=h(e):t.includes("page-list")?u??=h(e):t.includes("landmarks")?f??=h(e,!0):g.push({label:p(e.firstElementChild),type:t,list:h(e)})}return{toc:d,pageList:u,landmarks:f,others:g}},E=(e,t=e=>e)=>{let{$:r,$$:i}=m(e,a.NCX),s=e=>e?decodeURI(t(e)):null,n=e=>{let t=r(e,"navLabel"),a=r(e,"content"),l=p(t),o=s(a.getAttribute("src"));if("navPoint"===e.localName){let t=i(e,"navPoint");return{label:l,href:o,subitems:t.length?t.map(n):null}}return{label:l,href:o}},l=(e,t)=>i(e,t).map(n),o=(t,i)=>{let a=r(e.documentElement,t);return a?l(a,i):null};return{toc:o("navMap","navPoint"),pageList:o("pageList","pageTarget"),others:i(e.documentElement,"navList").map(e=>({label:p(r(e,"navLabel")),list:l(e,"navTarget")}))}},T=e=>{if(!e)return;let t=e.split(":").map(e=>parseFloat(e));if(3===t.length){let[e,r,i]=t;return 60*e*60+60*r+i}if(2===t.length){let[e,r]=t;return 60*e+r}let[r,i]=e.split(/(?=[^\d.])/);return parseFloat(r)*("h"===i?3600:"min"===i?60:"ms"===i?.001:1)};class M extends EventTarget{#e;#t;#r;#i;#a;#s;#n=1;#l=1;#o;constructor(e,t){super(),this.book=e,this.loadXML=t}async #h(e){if(this.#t===e)return;let t=await this.loadXML(e.href),r=t=>t?f(t,e.href):null,{$:i,$$$:s}=m(t,a.SMIL);this.#i=-1,this.#a=-1,this.#e=s(t,"par").reduce((e,t)=>{let a=r(i(t,"text")?.getAttribute("src")),s=i(t,"audio");if(!a||!s)return e;let n=r(s.getAttribute("src")),l=T(s.getAttribute("clipBegin")),o=T(s.getAttribute("clipEnd")),h=e.at(-1);return h?.src===n?h.items.push({text:a,begin:l,end:o}):e.push({src:n,items:[{text:a,begin:l,end:o}]}),e},[]),this.#t=e}get #c(){return this.#e[this.#i]}get #d(){return this.#c?.items?.[this.#a]}#u(e){console.error(e),this.dispatchEvent(new CustomEvent("error",{detail:e}))}#p(){this.dispatchEvent(new CustomEvent("highlight",{detail:this.#d}))}#m(){this.dispatchEvent(new CustomEvent("unhighlight",{detail:this.#d}))}async #f(e,t){this.#g(),this.#i=e,this.#a=t;let r=this.#c?.src;if(!r||!this.#d)return this.start(this.#r+1);let i=URL.createObjectURL(await this.book.loadBlob(r)),a=new Audio(i);this.#s=a,a.volume=this.#n,a.playbackRate=this.#l,a.addEventListener("timeupdate",()=>{if(a.paused)return;let e=a.currentTime,{items:t}=this.#c;if(e>this.#d?.end&&(this.#m(),this.#a===t.length-1))return void this.#f(this.#i+1,0).catch(e=>this.#u(e));let r=this.#a;for(;t[this.#a+1]?.begin<=e;)this.#a++;this.#a!==r&&this.#p()}),a.addEventListener("error",()=>this.#u(Error(`Failed to load ${r}`))),a.addEventListener("playing",()=>this.#p()),a.addEventListener("ended",()=>{this.#m(),URL.revokeObjectURL(i),this.#s=null,this.#f(e+1,0).catch(e=>this.#u(e))}),"paused"===this.#o?(this.#p(),a.currentTime=this.#d.begin??0):a.addEventListener("canplaythrough",()=>{a.currentTime=this.#d.begin??0,this.#o="playing",a.play().catch(e=>this.#u(e))},{once:!0})}async start(e,t=()=>!0){this.#s?.pause();let r=this.book.sections[e],i=r?.id;if(!i)return;let{mediaOverlay:a}=r;if(!a)return this.start(e+1);this.#r=e,await this.#h(a);for(let e=0;e<this.#e.length;e++){let{items:r}=this.#e[e];for(let a=0;a<r.length;a++)if(r[a].text.split("#")[0]===i&&t(r[a],a,r))return this.#f(e,a).catch(e=>this.#u(e))}}pause(){this.#o="paused",this.#s?.pause()}resume(){this.#o="playing",this.#s?.play().catch(e=>this.#u(e))}#g(){this.#s&&(this.#s.pause(),URL.revokeObjectURL(this.#s.src),this.#s=null,this.#m())}stop(){this.#o="stopped",this.#g()}prev(){this.#a>0?this.#f(this.#i,this.#a-1):this.#i>0?this.#f(this.#i-1,this.#e[this.#i-1].items.length-1):this.#r>0&&this.start(this.#r-1,(e,t,r)=>t===r.length-1)}next(){this.#f(this.#i,this.#a+1)}setVolume(e){this.#n=e,this.#s&&(this.#s.volume=e)}setRate(e){this.#l=e,this.#s&&(this.#s.playbackRate=e)}}let C=/([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/,N=e=>{for(let t of e.getElementsByTagNameNS(a.DC,"identifier")){let[e]=p(t).split(":").slice(-1);if(C.test(e))return e}return""},B=e=>p(e.getElementById(e.documentElement.getAttribute("unique-identifier"))??e.getElementsByTagNameNS(a.DC,"identifier")[0]),O=async(e,t,r)=>{let i=new Uint8Array(await r.slice(0,t).arrayBuffer());t=Math.min(t,i.length);for(var a=0;a<t;a++)i[a]=i[a]^e[a%e.length];return new Blob([i,r.slice(t)],{type:r.type})},R=async e=>{let t=new TextEncoder().encode(e);return new Uint8Array(await globalThis.crypto.subtle.digest("SHA-1",t))},U=(e=R)=>({"http://www.idpf.org/2008/embedding":{key:t=>e(B(t).replaceAll(/[\u0020\u0009\u000d\u000a]/g,"")),decode:(e,t)=>O(e,1040,t)},"http://ns.adobe.com/pdf/enc#RC":{key:e=>{let t=N(e).replaceAll("-","");return Uint8Array.from({length:16},(e,r)=>parseInt(t.slice(2*r,2*r+2),16))},decode:(e,t)=>O(e,1024,t)}});class k{#y=new Map;#b=new Map;#w;constructor(e){this.#w=e}async init(e,t){if(e)for(let{algorithm:r,uri:i}of Array.from(e.getElementsByTagNameNS(a.ENC,"EncryptedData"),e=>({algorithm:e.getElementsByTagNameNS(a.ENC,"EncryptionMethod")[0]?.getAttribute("Algorithm"),uri:e.getElementsByTagNameNS(a.ENC,"CipherReference")[0]?.getAttribute("URI")}))){if(!this.#b.has(r)){let e=this.#w[r];if(!e){console.warn("Unknown encryption algorithm");continue}let i=await e.key(t);this.#b.set(r,t=>e.decode(i,t))}this.#y.set(i,r)}}getDecoder(e){return this.#b.get(this.#y.get(e))??(e=>e)}}class X{constructor({opf:e,resolveHref:t}){this.opf=e;let{$:r,$$:n,$$$:l}=m(e,a.OPF),o=r(e.documentElement,"manifest"),h=r(e.documentElement,"spine"),c=n(h,"itemref");this.manifest=n(o,"item").map(u("href","id","media-type","properties","media-overlay")).map(e=>(e.href=t(e.href),e.properties=e.properties?.split(/\s/),e)),this.spine=c.map(u("idref","id","linear","properties")).map(e=>(e.properties=e.properties?.split(/\s/),e)),this.pageProgressionDirection=h.getAttribute("page-progression-direction"),this.navPath=this.getItemByProperty("nav")?.href,this.ncxPath=(this.getItemByID(h.getAttribute("toc"))??this.manifest.find(e=>e.mediaType===s.NCX))?.href;let p=r(e.documentElement,"guide");p&&(this.guide=n(p,"reference").map(u("type","title","href")).map(({type:e,title:r,href:i})=>({label:r,type:e.split(/\s/),href:t(i)}))),this.cover=this.getItemByProperty("cover-image")??this.getItemByID(l(e,"meta").find(d("name","cover"))?.getAttribute("content"))??this.manifest.find(e=>e.href.includes("cover")&&e.mediaType.startsWith("image"))??this.getItemByHref(this.guide?.find(e=>e.type.includes("cover"))?.href)??this.manifest.find(e=>e.mediaType.startsWith("image")),this.cfis=i.fromElements(c)}getItemByID(e){return this.manifestById||(this.manifestById=new Map(this.manifest.map(e=>[e.id,e]))),this.manifestById.get(e)}getItemByHref(e){return this.manifest.find(t=>t.href===e)}getItemByProperty(e){return this.manifest.find(t=>t.properties?.includes(e))}resolveCFI(e){let t=i.parse(e),r=(t.parent??t).shift(),a=i.toElement(this.opf,r);a&&"idref"!==a.nodeName&&(r.at(-1).id=null,a=i.toElement(this.opf,r));let s=a?.getAttribute("idref");return{index:this.spine.findIndex(e=>e.idref===s),anchor:e=>i.toRange(e,t)}}}class H{#I=new Map;#v=new Map;#x=new Map;#S=new Map;allowScript=!1;eventTarget=new EventTarget;constructor({loadText:e,loadBlob:t,resources:r}){this.loadText=e,this.loadBlob=t,this.manifest=r.manifest,this.assets=r.manifest}async createURL(e,t,r,i){if(!t)return"";let a={data:t,type:r};Object.defineProperty(a,"name",{value:e});let n=new CustomEvent("data",{detail:a});this.eventTarget.dispatchEvent(n);let l=await n.detail.data,o=await n.detail.type,h=URL.createObjectURL(new Blob([l],{type:o}));if(this.#I.set(e,h),this.#S.set(e,1),o===s.XHTML&&this.#v.set(h,{href:e,type:o,data:l}),i){let t=this.#x.get(i);t?t.push(e):this.#x.set(i,[e])}return h}ref(e,t){let r=this.#x.get(t);return r?.includes(e)||(this.#S.set(e,this.#S.get(e)+1),r?r.push(e):this.#x.set(t,[e])),this.#I.get(e)}unref(e){if(!this.#S.has(e))return;let t=this.#S.get(e)-1;if(t<1){let t=this.#I.get(e);URL.revokeObjectURL(t),this.#I.delete(e),this.#v.delete(t),this.#S.delete(e);let r=this.#x.get(e);if(r)for(;r.length;)this.unref(r.pop());this.#x.delete(e)}else this.#S.set(e,t)}async loadItem(e,t=[]){if(!e)return null;let{href:r,mediaType:i}=e,a=s.JS.test(e.mediaType);if(a&&!this.allowScript)return null;let n=t.at(-1);if(this.#I.has(r))return this.ref(r,n);if((a||[s.XHTML,s.HTML,s.CSS,s.SVG].includes(i))&&t.every(e=>e!==r))return this.loadReplaced(e,t);let l=Promise.resolve().then(()=>this.loadBlob(r));return this.createURL(r,l,i,n)}async loadItemXHTMLContent(e,t=[]){let r=await this.loadItem(e,t);if(r)return this.#v.get(r)?.data}async loadHref(e,t,r=[]){if(g(e))return e;let i=f(e,t),a=this.manifest.find(e=>e.href===i);return a?this.loadItem(a,r.concat(t)):e}async loadReplaced(e,t=[]){let{href:r,mediaType:i}=e,n=t.at(-1),l="";try{l=await this.loadText(r)}catch(e){return this.createURL(r,Promise.reject(e),i,n)}if(!l)return null;if([s.XHTML,s.HTML,s.SVG].includes(i)){let o=new DOMParser().parseFromString(l,i);if(i===s.XHTML&&(o.querySelector("parsererror")||!o.documentElement?.namespaceURI)&&(console.warn(o.querySelector("parsererror")?.innerText??"Invalid XHTML"),e.mediaType=s.HTML,o=new DOMParser().parseFromString(l,e.mediaType)),[s.XHTML,s.SVG].includes(e.mediaType)){let e=o.firstChild;for(;e instanceof ProcessingInstruction;){if(e.data){let i=await w(e.data,/(?:^|\s*)(href\s*=\s*['"])([^'"]*)(['"])/i,(e,i,a,s)=>this.loadHref(a,r,t).then(e=>`${i}${e}${s}`));e.replaceWith(o.createProcessingInstruction(e.target,i))}e=e.nextSibling}}let h=async(e,i)=>e.setAttribute(i,await this.loadHref(e.getAttribute(i),r,t));for(let e of o.querySelectorAll("link[href]"))await h(e,"href");for(let e of o.querySelectorAll("[src]"))await h(e,"src");for(let e of o.querySelectorAll("[poster]"))await h(e,"poster");for(let e of o.querySelectorAll("object[data]"))await h(e,"data");for(let e of o.querySelectorAll("[*|href]:not([href])"))e.setAttributeNS(a.XLINK,"href",await this.loadHref(e.getAttributeNS(a.XLINK,"href"),r,t));for(let e of o.querySelectorAll("style"))e.textContent&&(e.textContent=await this.replaceCSS(e.textContent,r,t));for(let e of o.querySelectorAll("[style]"))e.setAttribute("style",await this.replaceCSS(e.getAttribute("style"),r,t));let c=new XMLSerializer().serializeToString(o);return this.createURL(r,c,e.mediaType,n)}let o=i===s.CSS?await this.replaceCSS(l,r,t):await this.replaceString(l,r,t);return this.createURL(r,o,i,n)}async replaceCSS(e,t,r=[]){let i=await w(e,/url\(\s*["']?([^'"\n]*?)\s*["']?\s*\)/gi,(e,i)=>this.loadHref(i,t,r).then(e=>`url("${e}")`));return w(i,/@import\s*["']([^"'\n]*?)["']/gi,(e,i)=>this.loadHref(i,t,r).then(e=>`@import "${e}"`))}replaceString(e,t,r=[]){let i=new Map,a=this.assets.map(e=>{if(e.href===t)return;let r=y(b(t),e.href),a=encodeURI(r),s="/"+e.href,n=encodeURI(s),l=new Set([r,a,s,n]);for(let t of l)i.set(t,e);return Array.from(l)}).flat().filter(e=>e);return a.length?w(e,RegExp(a.map(I).join("|"),"g"),async e=>this.loadItem(i.get(e.replace(/^\//,"")),r.concat(t))):e}unloadItem(e){this.unref(e?.href)}destroy(){for(let e of this.#I.values())URL.revokeObjectURL(e)}}let P=(e,t)=>e.getElementById(t)??e.querySelector(`[name="${CSS.escape(t)}"]`),j=e=>{for(let t of e){if("page-spread-left"===t||"rendition:page-spread-left"===t)return"left";if("page-spread-right"===t||"rendition:page-spread-right"===t)return"right";if("rendition:page-spread-center"===t)return"center"}},$=e=>e?{fixedLayout:p(e.querySelector('option[name="fixed-layout"]')),openToSpread:p(e.querySelector('option[name="open-to-spread"]'))}:null;class F{parser=new DOMParser;#L;#A;constructor({loadText:e,loadBlob:t,getSize:r,sha1:i}){this.loadText=e,this.loadBlob=t,this.getSize=r,this.#A=new k(U(i))}async #E(e){let t=await this.loadText(e);if(!t)return null;let r=this.parser.parseFromString(t,s.XML);if(r.querySelector("parsererror"))throw Error(`XML parsing error: ${e}
${r.querySelector("parsererror").innerText}`);return r}async init({allowScript:e=!1}={}){let t=await this.#E("META-INF/container.xml");if(!t)throw Error("Failed to load container file");let r=Array.from(t.getElementsByTagNameNS(a.CONTAINER,"rootfile"),u("full-path","media-type")).filter(e=>"application/oebps-package+xml"===e.mediaType);if(!r.length)throw Error("No package document defined in container");let i=r[0].fullPath,s=await this.#E(i);if(!s)throw Error("Failed to load package document");let n=await this.#E("META-INF/encryption.xml");await this.#A.init(n,s),this.resources=new X({opf:s,resolveHref:e=>f(e,i)}),this.#L=new H({loadText:this.loadText,loadBlob:e=>Promise.resolve(this.loadBlob(e)).then(this.#A.getDecoder(e)),resources:this.resources}),this.#L.allowScript=e,this.transformTarget=this.#L.eventTarget,this.sections=this.resources.spine.map((e,t)=>{let{idref:r,linear:i,properties:a=[]}=e,s=this.resources.getItemByID(r);return s?{id:s.href,load:()=>this.#L.loadItem(s),unload:()=>this.#L.unloadItem(s),loadContent:()=>this.#L.loadItemXHTMLContent(s),createDocument:()=>this.loadDocument(s),size:this.getSize(s.href),cfi:this.resources.cfis[t],linear:i,pageSpread:j(a),resolveHref:e=>f(e,s.href),mediaOverlay:s.mediaOverlay?this.resources.getItemByID(s.mediaOverlay):null}:(console.warn(`Could not find item with ID "${r}" in manifest`),null)}).filter(e=>e);let{navPath:l,ncxPath:o}=this.resources;if(l)try{let e=A(await this.#E(l),e=>f(e,l));this.toc=e.toc,this.pageList=e.pageList,this.landmarks=e.landmarks}catch(e){console.warn(e)}if(!this.toc&&o)try{let e=E(await this.#E(o),e=>f(e,o));this.toc=e.toc,this.pageList=e.pageList}catch(e){console.warn(e)}this.landmarks??=this.resources.guide;let{metadata:h,rendition:c,media:d}=L(s);this.metadata=h,this.rendition=c,this.media=d,this.dir=this.resources.pageProgressionDirection;let p=$(await this.#E("META-INF/com.apple.ibooks.display-options.xml")??await this.#E("META-INF/com.kobobooks.display-options.xml"));return p&&("true"===p.fixedLayout&&(this.rendition.layout??="pre-paginated"),"false"===p.openToSpread&&(this.sections.find(e=>"no"!==e.linear).pageSpread??="rtl"===this.dir?"left":"right")),this}async loadDocument(e){let t=await this.loadText(e.href);return this.parser.parseFromString(t,e.mediaType)}getMediaOverlay(){return new M(this,this.#E.bind(this))}resolveCFI(e){return this.resources.resolveCFI(e)}resolveHref(e){let[t,r]=e.split("#"),i=this.resources.getItemByHref(decodeURI(t));return i?{index:this.resources.spine.findIndex(({idref:e})=>e===i.id),anchor:r?e=>P(e,r):()=>0}:null}splitTOCHref(e){return e?.split("#")??[]}getTOCFragment(e,t){return e.getElementById(t)??e.querySelector(`[name="${CSS.escape(t)}"]`)}isExternal(e){return g(e)}async getCover(){let e=this.resources?.cover;return e?.href?new Blob([await this.loadBlob(e.href)],{type:e.mediaType}):null}async getCalibreBookmarks(){let e=await this.loadText("META-INF/calibre_bookmarks.txt"),t="encoding=json+base64:";if(e?.startsWith(t))return JSON.parse(atob(e.slice(t.length)))}destroy(){this.#L?.destroy()}}}}]);