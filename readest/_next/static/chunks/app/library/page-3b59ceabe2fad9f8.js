(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7382],{11705:(e,t,l)=>{"use strict";l.r(t),l.d(t,{default:()=>eM});var a=l(62574),s=l(3073),o=l(84574),n=l(38012),r=l(75454),i=l(58529),d=l(66763),c=l(25289),u=l(65865),p=l(69921),m=l(38174),h=l(40965),x=l(45016),f=l(78893),g=l(57597),b=l(46450),v=l(78549),w=l(58941),y=l(20517);let j=(e,t)=>{(0,o.useEffect)(()=>{let l=e.current;if(l)return l.addEventListener("touchstart",a,{passive:!0}),()=>{l.removeEventListener("touchstart",a)};function a(l){let a=e.current;if(!a||a.scrollTop>0)return;let s=l.touches[0].clientX,o=l.touches[0].clientY;function n(t){let l=e.current;if(!l)return;let a=t.touches[0].clientX,n=t.touches[0].clientY-o;if(n<0||2*Math.abs(a-s)>Math.abs(n))return;let i=l.parentNode;n>120?function(e){let t=e.querySelector(".pull-indicator");t&&!t.classList.contains("flip")&&t.classList.add("flip")}(i):n>60?function(e){let t=e.querySelector(".pull-indicator");if(t){t.classList.contains("flip")&&t.classList.remove("flip");return}let l=document.querySelector(".titlebar"),a=document.createElement("div"),s=(null==l?void 0:l.getBoundingClientRect().bottom)||0;a.style.top="".concat(s+20,"px"),a.className="pull-indicator text-gray-500",a.innerHTML='\n          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 19c-.3 0-.6-.1-.8-.3l-6-6c-.4-.4-.4-1 0-1.4s1-.4 1.4 0L11 16.2V5c0-.6.4-1 1-1s1 .4 1 1v11.2l4.4-4.4c.4-.4 1-.4 1.4 0s.4 1 0 1.4l-6 6c-.2.2-.5.3-.8.3z"/>\n          </svg>\n        ',e.appendChild(a)}(i):r(i);let d=l.querySelector(".transform-wrapper");d&&(d.style.transform="translate3d(0, ".concat(128*(1-Math.exp(-.4*n/128)),"px, 0)"))}function r(e){let t=e.querySelector(".pull-indicator");t&&t.remove()}function i(){let t=e.current;t&&(t.style.transition="",t.removeEventListener("transitionend",i))}a.addEventListener("touchmove",n,{passive:!0}),a.addEventListener("touchend",function l(a){let s=e.current;if(!s)return;let d=s.querySelector(".transform-wrapper");d&&(d.style.transform="translateY(0)"),r(s.parentNode),s.style.transition="transform 0.2s",a.changedTouches[0].clientY-o>120&&t(),s.addEventListener("transitionend",i),s.removeEventListener("touchmove",n),s.removeEventListener("touchend",l)})}},[e.current])};var k=l(15574),A=l(50981);let N={en:JSON.parse('{"library":["https://cdn.readest.com/books/a-room-of-one-s-own.epub","https://cdn.readest.com/books/hamlet.epub","https://cdn.readest.com/books/meditations.epub","https://cdn.readest.com/books/the-great-gatsby.epub","https://cdn.readest.com/books/the-scarlet-letter.epub","https://cdn.readest.com/books/this-side-of-paradise.epub"]}'),zh:JSON.parse('{"library":["https://cdn.readest.com/books/four-great-classics.epub","https://cdn.readest.com/books/journey-to-the-west.epub"]}')},S=()=>{let{envConfig:e}=(0,g.D)(),[t,l]=(0,o.useState)([]),a=(0,o.useRef)(!1);return(0,o.useEffect)(()=>{if(a.current)return;a.current=!0;let t=(0,A.gl)(),s=async()=>{try{let a=await e.getAppService(),s=N[t]||N.en,o=await Promise.all(s.library.map(e=>a.importBook(e,[],!1,!0)));l(o.filter(e=>null!==e))}catch(e){console.error("Failed to import demo books:",e)}},o=localStorage.getItem("demoBooksFetched");(0,p.hx)()&&!o&&(s(),localStorage.setItem("demoBooksFetched","true"))},[]),t};var C=l(56945),B=l(40078);let I=e=>{let{onSyncStart:t,onSyncEnd:l}=e,{user:a}=(0,b.A)(),{appService:s}=(0,g.D)(),{library:n,setLibrary:r}=(0,w.C)(),{syncedBooks:i,syncBooks:d,lastSyncedAtBooks:c}=(0,C.p)(),u=(0,o.useRef)(!1),p=async()=>{a&&d([],"pull")},m=async()=>{a&&d(x(),"push")};(0,o.useEffect)(()=>{a&&(u.current||(u.current=!0,p()))},[]);let x=()=>a?n.filter(e=>{var t;return c<e.updatedAt||c<(null!=(t=e.deletedAt)?t:0)}):[],f=(0,o.useCallback)((0,B.s)(()=>{d(x(),"both")},1e3*h.Hw),[n,c]);(0,o.useEffect)(()=>{a&&f()},[n]);let v=async()=>{if(!(null==i?void 0:i.length))return;i.sort((e,t)=>e.updatedAt-t.updatedAt);let e=async e=>{let t=i.find(t=>t.hash===e.hash);return t?(t.deletedAt||!t.uploadedAt||e.downloadedAt||await (null==s?void 0:s.downloadBook(e,!0)),t.updatedAt>e.updatedAt?{...e,...t}:{...t,...e}):e},a=await Promise.all(n.map(e)),o=async e=>{if(!a.some(t=>t.hash===e.hash)&&e.uploadedAt&&!e.deletedAt)try{await (null==s?void 0:s.downloadBook(e,!0))}catch(t){console.error("Failed to download book:",e)}finally{e.coverImageUrl=await (null==s?void 0:s.generateCoverImageUrl(e)),a.push(e),r(a)}};null==t||t();for(let e=0;e<i.length;e+=3){let t=i.slice(e,e+3);await Promise.all(t.map(o))}null==l||l(),r(a),null==s||s.saveLibraryBooks(a)};return(0,o.useEffect)(()=>{v()},[i]),{pullLibrary:p,pushLibrary:m}};var D=l(98335),L=l(18426),E=l(11437),M=l(58068),P=l(70100),O=l(29353),U=l(22697),R=l(44625),T=l(20867),z=l(72645),_=l(17669),F=l(23511),q=l(90045),G=l(74514),Y=l(25470),W=l(18631),V=l(16161),X=l(77553),$=l(64765),H=l(20856),J=l(35785),K=l(26266),Z=l(84260),Q=l(57832),ee=l(60314),et=l(45322);let el=e=>{var t,l,i;let{setIsDropdownOpen:d}=e,c=(0,v.B)(),u=(0,n.useRouter)(),{envConfig:m,appService:x}=(0,g.D)(),{user:f}=(0,b.A)(),{themeMode:w,setThemeMode:j}=(0,D.C)(),{settings:k,setSettings:A,saveSettings:N}=(0,y.C)(),[S,C]=(0,o.useState)(k.autoUpload),[B,I]=(0,o.useState)(k.autoCheckUpdates),[L,E]=(0,o.useState)(k.alwaysOnTop),[M,P]=(0,o.useState)(k.screenWakeLock),[R,T]=(0,o.useState)(k.openLastBooks),[z,_]=(0,o.useState)(k.autoImportBooksOnOpen),[G,W]=(0,o.useState)(k.telemetryEnabled),V=(0,Y.D)(16),{quotas:X}=(0,K.V)(),$=(null==f||null==(t=f.user_metadata)?void 0:t.picture)||(null==f||null==(l=f.user_metadata)?void 0:l.avatar_url),el=null==f||null==(i=f.user_metadata)?void 0:i.full_name,ea=el?el.split(" ")[0]:null;return(0,a.jsxs)("div",{tabIndex:0,className:(0,s.A)("settings-menu dropdown-content no-triangle border-base-100","z-20 mt-2 max-w-[90vw] shadow-2xl"),children:[f?(0,a.jsx)(ee.A,{label:ea?c("Logged in as {{userDisplayName}}",{userDisplayName:ea}):c("Logged in"),labelClass:"!max-w-40",Icon:$?(0,a.jsx)(Q.A,{url:$,size:V,DefaultIcon:F.LAj}):F.LAj,children:(0,a.jsxs)("ul",{children:[(0,a.jsx)(et.A,{quotas:X,labelClassName:"h-10 pl-3 pr-2"}),(0,a.jsx)(ee.A,{label:c("Account"),noIcon:!0,onClick:()=>{(0,r.Ad)(u),null==d||d(!1)}})]})}):(0,a.jsx)(ee.A,{label:c("Sign In"),Icon:F.NMe,onClick:()=>{(0,r.OO)(u),null==d||d(!1)}}),(0,a.jsx)(ee.A,{label:c("Auto Upload Books to Cloud"),Icon:S?q.g9_:void 0,onClick:()=>{k.autoUpload=!k.autoUpload,A(k),N(m,k),C(k.autoUpload),k.autoUpload&&!f&&(0,r.OO)(u)}}),(0,p.uO)()&&!(null==x?void 0:x.isMobile)&&(0,a.jsx)(ee.A,{label:c("Auto Import on File Open"),Icon:z?q.g9_:void 0,onClick:()=>{k.autoImportBooksOnOpen=!k.autoImportBooksOnOpen,A(k),N(m,k),_(k.autoImportBooksOnOpen)}}),(0,p.uO)()&&(0,a.jsx)(ee.A,{label:c("Open Last Book on Start"),Icon:R?q.g9_:void 0,onClick:()=>{k.openLastBooks=!k.openLastBooks,A(k),N(m,k),T(k.openLastBooks)}}),(null==x?void 0:x.hasUpdater)&&(0,a.jsx)(ee.A,{label:c("Check Updates on Start"),Icon:B?q.g9_:void 0,onClick:()=>{k.autoCheckUpdates=!k.autoCheckUpdates,A(k),N(m,k),I(k.autoCheckUpdates)}}),(0,a.jsx)("hr",{className:"border-base-200 my-1"}),(null==x?void 0:x.hasWindow)&&(0,a.jsx)(ee.A,{label:c("Fullscreen"),onClick:()=>{(0,O.tP)(),null==d||d(!1)}}),(null==x?void 0:x.hasWindow)&&(0,a.jsx)(ee.A,{label:c("Always on Top"),Icon:L?q.g9_:void 0,onClick:()=>{k.alwaysOnTop=!k.alwaysOnTop,A(k),N(m,k),E(k.alwaysOnTop),(0,O.Lj)(k.alwaysOnTop),null==d||d(!1)}}),(0,a.jsx)(ee.A,{label:c("Keep Screen Awake"),Icon:M?q.g9_:void 0,onClick:()=>{k.screenWakeLock=!k.screenWakeLock,A(k),N(m,k),P(k.screenWakeLock)}}),(0,a.jsx)(ee.A,{label:c("Reload Page"),onClick:()=>{window.location.reload(),null==d||d(!1)}}),(0,a.jsx)(ee.A,{label:c("dark"===w?"Dark Mode":"light"===w?"Light Mode":"Auto Mode"),Icon:"dark"===w?J.vVA:"light"===w?J.q9U:H.eV8,onClick:()=>{j("auto"===w?"light":"light"===w?"dark":"auto")}}),(0,a.jsx)("hr",{className:"border-base-200 my-1"}),(0,p.hx)()&&(0,a.jsx)(ee.A,{label:c("Download Readest"),onClick:()=>{window.open(h.cP,"_blank"),null==d||d(!1)}}),(0,a.jsx)(ee.A,{label:c("About Readest"),onClick:()=>{(0,U.o)(!0),null==d||d(!1)}}),(0,a.jsx)(ee.A,{label:c("Help improve Readest"),description:G?c("Sharing anonymized statistics"):"",Icon:G?q.g9_:void 0,onClick:()=>{k.telemetryEnabled=!k.telemetryEnabled,k.telemetryEnabled?(0,Z.Iv)():(0,Z.xe)(),A(k),N(m,k),W(k.telemetryEnabled)}})]})},ea=e=>{let{setIsDropdownOpen:t,onImportBooks:l}=e,o=(0,v.B)(),{appService:n}=(0,g.D)();return(0,a.jsx)("ul",{tabIndex:-1,className:(0,s.A)("dropdown-content bg-base-100 menu rounded-box z-[1] mt-3 w-52 p-2 shadow",(null==n?void 0:n.isMobile)?"no-triangle":"dropdown-center"),children:(0,a.jsx)(ee.A,{label:o("From Local File"),onClick:()=>{l(),null==t||t(!1)}})})},es=e=>{let{setIsDropdownOpen:t}=e,l=(0,v.B)(),s=(0,n.useRouter)(),o=(0,n.useSearchParams)(),{envConfig:i}=(0,g.D)(),{settings:d,setSettings:c,saveSettings:u}=(0,y.C)(),p=d.libraryViewMode,m=d.librarySortBy,h=d.librarySortAscending,x=[{label:l("List"),value:"list"},{label:l("Grid"),value:"grid"}],f=[{label:l("Title"),value:"title"},{label:l("Author"),value:"author"},{label:l("Format"),value:"format"},{label:l("Date Read"),value:"updated"},{label:l("Date Added"),value:"created"}],b=[{label:l("Ascending"),value:!0},{label:l("Descending"),value:!1}],w=e=>{d.libraryViewMode=e,c(d),u(i,d),null==t||t(!1);let l=new URLSearchParams(null==o?void 0:o.toString());l.set("view",e),(0,r.i7)(s,"".concat(l.toString()))},j=e=>{d.librarySortBy=e,c(d),u(i,d),null==t||t(!1);let l=new URLSearchParams(null==o?void 0:o.toString());l.set("sort",e),(0,r.i7)(s,"".concat(l.toString()))},k=e=>{d.librarySortAscending=e,c(d),u(i,d),null==t||t(!1);let l=new URLSearchParams(null==o?void 0:o.toString());l.set("order",e?"asc":"desc"),(0,r.i7)(s,"".concat(l.toString()))};return(0,a.jsxs)("div",{tabIndex:0,className:"settings-menu dropdown-content no-triangle border-base-100 z-20 mt-2 shadow-2xl",children:[x.map(e=>(0,a.jsx)(ee.A,{label:e.label,buttonClass:"h-8",Icon:p===e.value?q.g9_:void 0,onClick:()=>w(e.value)},e.value)),(0,a.jsx)("hr",{className:"border-base-200 my-1"}),(0,a.jsx)(ee.A,{label:l("Sort by..."),buttonClass:"h-8",labelClass:"text-sm sm:text-xs",disabled:!0}),f.map(e=>(0,a.jsx)(ee.A,{label:e.label,buttonClass:"h-8",Icon:m===e.value?q.g9_:void 0,onClick:()=>j(e.value)},e.value)),(0,a.jsx)("hr",{className:"border-base-200 my-1"}),b.map(e=>(0,a.jsx)(ee.A,{label:e.label,buttonClass:"h-8",Icon:h===e.value?q.g9_:void 0,onClick:()=>k(e.value)},e.value.toString()))]})},eo=e=>{var t;let{isSelectMode:l,isSelectAll:i,onImportBooks:d,onToggleSelectMode:c,onSelectAll:u,onDeselectAll:p}=e,m=(0,v.B)(),h=(0,n.useRouter)(),x=(0,n.useSearchParams)(),{appService:f}=(0,g.D)(),{statusBarHeight:b}=(0,D.C)(),{currentBookshelf:y}=(0,w.C)(),{isTrafficLightVisible:j,initializeTrafficLightStore:k,initializeTrafficLightListeners:A,setTrafficLightVisibility:N,cleanupTrafficLightListeners:S}=(0,W.w)(),[C,I]=(0,o.useState)(null!=(t=null==x?void 0:x.get("q"))?t:""),L=(0,o.useRef)(null),E=(0,Y.D)(18),M=(0,Y.D)(20);(0,V.A)({onToggleSelectMode:c});let P=(0,o.useCallback)((0,B.s)(e=>{let t=new URLSearchParams(null==x?void 0:x.toString());e?t.set("q",e):t.delete("q"),h.push("?".concat(t.toString()))},500),[x]);(0,o.useEffect)(()=>{if(null==f?void 0:f.hasTrafficLight)return k(f),A(),N(!0),()=>{S()}},[]);let O=(null==f?void 0:f.hasWindowBar)&&!j,U=!!(null==x?void 0:x.get("group")),R=y.reduce((e,t)=>e+("books"in t?t.books.length:1),0);return(0,a.jsx)("div",{ref:L,className:(0,s.A)("titlebar bg-base-200 z-10 flex h-[52px] w-full items-center py-2 pr-4 sm:h-[48px] sm:pr-6",j?"pl-16":"pl-0 sm:pl-2"),style:{marginTop:(null==f?void 0:f.hasSafeAreaInset)?"max(env(safe-area-inset-top), ".concat(b,"px)"):""},children:(0,a.jsxs)("div",{className:"flex w-full items-center justify-between space-x-6 sm:space-x-12",children:[(0,a.jsxs)("div",{className:"exclude-title-bar-mousedown relative flex w-full items-center pl-4",children:[U&&(0,a.jsx)("button",{onClick:()=>{(0,r.i7)(h)},className:"ml-[-6px] mr-4 flex h-7 min-h-7 w-7 items-center p-0",children:(0,a.jsx)("div",{className:"lg:tooltip lg:tooltip-bottom","data-tip":m("Go Back"),children:(0,a.jsx)(q.VR3,{size:M})})}),(0,a.jsxs)("div",{className:"relative flex h-9 w-full items-center sm:h-7",children:[(0,a.jsx)("span",{className:"absolute left-3 text-gray-500",children:(0,a.jsx)(_.KSO,{className:"h-4 w-4"})}),(0,a.jsx)("input",{type:"text",value:C,placeholder:R>1?m("Search in {{count}} Book(s)...",{count:R}):m("Search Books..."),onChange:e=>{let t=e.target.value;I(t),P(t)},spellCheck:"false",className:(0,s.A)("input rounded-badge bg-base-300/50 h-9 w-full pl-10 pr-10 sm:h-7","font-sans text-sm font-light","border-none focus:outline-none focus:ring-0")})]}),(0,a.jsxs)("div",{className:"absolute right-4 flex items-center space-x-2 text-gray-500 sm:space-x-4",children:[C&&(0,a.jsx)("button",{type:"button",onClick:()=>{I(""),P("")},className:"pe-1 text-gray-400 hover:text-gray-600","aria-label":m("Clear Search"),children:(0,a.jsx)(G.W0M,{className:"h-4 w-4"})}),(0,a.jsx)("span",{className:"bg-base-content/50 mx-2 h-4 w-[0.5px]"}),(0,a.jsx)($.A,{className:(0,s.A)("exclude-title-bar-mousedown dropdown-bottom flex h-6 cursor-pointer justify-center",(null==f?void 0:f.isMobile)?"dropdown-end":"dropdown-center"),buttonClassName:"p-0 h-6 min-h-6 w-6 flex items-center justify-center",toggleButton:(0,a.jsx)("div",{className:"lg:tooltip lg:tooltip-bottom","data-tip":m("Import Books"),children:(0,a.jsx)(F.enO,{className:"m-0.5 h-5 w-5"})}),children:(0,a.jsx)(ea,{onImportBooks:d})}),(null==f?void 0:f.isMobile)?null:(0,a.jsx)("button",{onClick:c,"aria-label":m("Select Multiple Books"),className:"h-6",children:(0,a.jsx)("div",{className:"lg:tooltip lg:tooltip-bottom cursor-pointer","data-tip":m("Select Books"),children:(0,a.jsx)(F.xKX,{role:"button",className:"h-6 w-6 ".concat(l?"fill-gray-400":"fill-gray-500")})})})]})]}),l?(0,a.jsx)("div",{className:(0,s.A)("flex h-full items-center","w-max-[72px] w-min-[72px] sm:w-max-[80px] sm:w-min-[80px]"),children:(0,a.jsx)("button",{onClick:i?p:u,className:"btn btn-ghost text-base-content/85 h-8 min-h-8 w-[72px] p-0 sm:w-[80px]","aria-label":m(i?"Deselect":"Select All"),children:(0,a.jsx)("span",{className:"font-sans text-base font-normal sm:text-sm",children:m(i?"Deselect":"Select All")})})}):(0,a.jsxs)("div",{className:"flex h-full items-center gap-x-2 sm:gap-x-4",children:[(0,a.jsx)($.A,{className:"exclude-title-bar-mousedown dropdown-bottom dropdown-end",buttonClassName:"btn btn-ghost h-8 min-h-8 w-8 p-0",toggleButton:(0,a.jsx)(F.CzE,{size:E}),children:(0,a.jsx)(es,{})}),(0,a.jsx)($.A,{className:"exclude-title-bar-mousedown dropdown-bottom dropdown-end",buttonClassName:"btn btn-ghost h-8 min-h-8 w-8 p-0",toggleButton:(0,a.jsx)(q.hCN,{size:E}),children:(0,a.jsx)(el,{})}),(null==f?void 0:f.hasWindowBar)&&(0,a.jsx)(X.A,{headerRef:L,showMinimize:O,showMaximize:O,showClose:O})]})]})})};var en=l(1183),er=l(45375),ei=l(89412),ed=l(58491);let ec=e=>{let{children:t,showOverlay:l=!0}=e;return ed.createPortal((0,a.jsx)("div",{className:(0,s.A)("fixed inset-0 isolate z-50 flex items-center justify-center",l&&"bg-black bg-opacity-50"),style:{transform:"translateZ(0)"},children:t}),document.body)},eu=e=>{let{onTap:t,onLongPress:l,onContextMenu:a,onCancel:s,threshold:n=500,moveThreshold:r=10}=e,[i,d]=(0,o.useState)(!1),c=(0,o.useRef)(),u=(0,o.useRef)(null),p=(0,o.useRef)(null),m=(0,o.useRef)(!1),h=(0,o.useCallback)(()=>{d(!1),m.current=!1,u.current=null,p.current=null,clearTimeout(c.current)},[]),x=(0,o.useCallback)(e=>{("mouse"!==e.pointerType||0===e.button)&&(p.current=e.pointerId,u.current={x:e.clientX,y:e.clientY},m.current=!1,d(!0),c.current=setTimeout(()=>{u.current&&(m.current=!0,null==l||l(),d(!1))},n))},[l,n]),f=(0,o.useCallback)(e=>{if(e.pointerId!==p.current||!u.current)return;let t=Math.abs(e.clientX-u.current.x),l=Math.abs(e.clientY-u.current.y);(t>r||l>r)&&(null==s||s(),h())},[r,s,h]),g=(0,o.useCallback)(e=>{if(e.pointerId===p.current){if(!m.current&&u.current){let l=Math.abs(e.clientX-u.current.x),a=Math.abs(e.clientY-u.current.y);l<=r&&a<=r&&(null==t||t())}h()}},[t,r,h]),b=(0,o.useCallback)(e=>{e.pointerId===p.current&&(null==s||s(),h())},[s,h]),v=(0,o.useCallback)(e=>{a&&(e.preventDefault(),e.stopPropagation(),a())},[a]);return(0,o.useEffect)(()=>()=>{clearTimeout(c.current)},[]),{pressing:i,handlers:{onPointerDown:x,onPointerUp:g,onPointerMove:f,onPointerCancel:b,onPointerLeave:b,onContextMenu:v}}};var ep=l(55849),em=l(90734);let eh={macos:(0,A.Gg)("Reveal in Finder"),windows:(0,A.Gg)("Reveal in File Explorer"),linux:(0,A.Gg)("Reveal in Folder"),default:(0,A.Gg)("Reveal in Folder")};var ex=l(1768);let ef=e=>e.progress&&e.progress[1]?e.progress&&1===e.progress[1]?100:Math.max(0,Math.min(100,Math.round(e.progress[0]/e.progress[1]*100))):null,eg=(0,o.memo)(e=>{let{book:t}=e,l=(0,o.useMemo)(()=>ef(t),[t]);return null===l?null:(0,a.jsx)("div",{className:"text-neutral-content/70 flex justify-between text-xs",children:(0,a.jsxs)("span",{children:[l,"%"]})})},(e,t)=>e.book.hash===t.book.hash&&e.book.updatedAt===t.book.updatedAt);eg.displayName="ReadingProgress";var eb=l(25538);let ev=e=>{let{mode:t,book:l,isSelectMode:o,selectedBooks:d,transferProgress:c,handleBookUpload:u,handleBookDownload:p,showBookDetailsModal:m}=e,h=(0,n.useRouter)(),{user:x}=(0,b.A)(),{appService:f}=(0,g.D)(),v=(0,Y.D)(15),w=e=>{e.preventDefault(),e.stopPropagation()};return(0,a.jsxs)("div",{className:(0,s.A)("book-item flex","grid"===t&&"h-full flex-col","list"===t&&"h-28 flex-row gap-4 overflow-hidden",(null==f?void 0:f.hasContextMenu)?"cursor-pointer":""),children:[(0,a.jsxs)("div",{className:(0,s.A)("bg-base-100 relative flex aspect-[28/41] items-center justify-center overflow-hidden shadow-md","list"===t&&"min-w-20"),children:[(0,a.jsx)(eb.A,{mode:t,book:l}),d.includes(l.hash)&&(0,a.jsx)("div",{className:"absolute inset-0 bg-black opacity-30 transition-opacity duration-300"}),o&&(0,a.jsx)("div",{className:"absolute bottom-1 right-1",children:d.includes(l.hash)?(0,a.jsx)(q.mU9,{className:"fill-blue-500"}):(0,a.jsx)(q.o_$,{className:"fill-gray-300 drop-shadow-sm"})})]}),(0,a.jsxs)("div",{className:(0,s.A)("flex w-full flex-col p-0","grid"===t&&"pt-2","list"===t&&"py-2"),children:[(0,a.jsxs)("div",{className:(0,s.A)("min-w-0 flex-1","list"===t&&"flex flex-col gap-2"),children:[(0,a.jsx)("h4",{className:(0,s.A)("overflow-hidden text-ellipsis font-semibold","grid"===t&&"block whitespace-nowrap text-[0.6em] text-xs","list"===t&&"line-clamp-2 text-base"),children:l.title}),"list"===t&&(0,a.jsx)("p",{className:"text-neutral-content line-clamp-1 text-sm",children:(0,i.kY)(l.author,l.primaryLanguage)||""})]}),(0,a.jsxs)("div",{className:(0,s.A)("flex items-center",l.progress?"justify-between":"justify-end"),children:[l.progress&&(0,a.jsx)(eg,{book:l}),(0,a.jsxs)("div",{className:"flex items-center justify-center gap-x-2",children:[!(null==f?void 0:f.isMobile)&&(0,a.jsx)("button",{className:"show-detail-button -m-2 p-2 sm:opacity-0 sm:group-hover:opacity-100",onPointerDown:e=>w(e),onPointerUp:e=>w(e),onPointerMove:e=>w(e),onPointerCancel:e=>w(e),onPointerLeave:e=>w(e),onClick:()=>m(l),children:(0,a.jsx)("div",{className:"pt-[1px]",children:(0,a.jsx)(ex.s5l,{size:v})})}),null!==c?100===c?null:(0,a.jsx)("div",{className:"radial-progress",style:{"--value":c,"--size":"".concat(v,"px"),"--thickness":"2px"},role:"progressbar"}):(!l.uploadedAt||l.uploadedAt&&!l.downloadedAt)&&(0,a.jsxs)("button",{className:"show-cloud-button -m-2 p-2",onPointerDown:e=>w(e),onPointerUp:e=>w(e),onPointerMove:e=>w(e),onPointerCancel:e=>w(e),onPointerLeave:e=>w(e),onClick:()=>{if(!x)return void(0,r.OO)(h);l.uploadedAt?l.downloadedAt||p(l):u(l)},children:[!l.uploadedAt&&(0,a.jsx)(ex.tWs,{size:v}),l.uploadedAt&&!l.downloadedAt&&(0,a.jsx)(ex.wfh,{size:v})]})]})]})]})]})},ew=e=>{let{group:t,isSelectMode:l,selectedBooks:o}=e,{appService:n}=(0,g.D)();return(0,a.jsxs)("div",{className:(0,s.A)("group-item flex h-full flex-col",(null==n?void 0:n.hasContextMenu)?"cursor-pointer":""),children:[(0,a.jsxs)("div",{className:"bg-base-100 relative flex aspect-[28/41] items-center justify-center overflow-hidden p-2 shadow-md",children:[(0,a.jsx)("div",{className:"grid w-full grid-cols-2 grid-rows-2 gap-1 overflow-hidden",children:t.books.slice(0,4).map(e=>(0,a.jsx)("div",{className:"relative aspect-[28/41] h-full w-full",children:(0,a.jsx)(eb.A,{book:e,isPreview:!0})},e.hash))}),o.includes(t.id)&&(0,a.jsx)("div",{className:"absolute inset-0 bg-black opacity-30 transition-opacity duration-300"}),l&&(0,a.jsx)("div",{className:"absolute bottom-1 right-1",children:o.includes(t.id)?(0,a.jsx)(q.mU9,{className:"fill-blue-500"}):(0,a.jsx)(q.o_$,{className:"fill-gray-300 drop-shadow-sm"})})]}),(0,a.jsx)("div",{className:"min-w-0 flex-1 pt-2",children:(0,a.jsx)("h4",{className:"block overflow-hidden text-ellipsis whitespace-nowrap text-xs font-semibold",children:t.name})})]})},ey=e=>{var t;let l=e.reduce((e,t)=>{if(t.deletedAt)return e;t.groupId=t.groupId||h.Y$,t.groupName=t.groupName||h.G1;let l=e.findIndex(e=>e.id===t.groupId),a=e[e.findIndex(e=>e.id===t.groupId)];return a?(a.books.push(t),a.updatedAt=Math.max(e[l].updatedAt,t.updatedAt)):e.push({id:t.groupId,name:t.groupName,books:[t],updatedAt:t.updatedAt}),e},[]);return l.forEach(e=>{e.books.sort((e,t)=>t.updatedAt-e.updatedAt)}),[...(null==(t=l.find(e=>e.name===h.G1))?void 0:t.books)||[],...l.filter(e=>e.name!==h.G1)].sort((e,t)=>t.updatedAt-e.updatedAt)},ej=e=>e.filter(e=>!e.deletedAt).sort((e,t)=>t.updatedAt-e.updatedAt),ek=e=>e.sort((e,t)=>t.updatedAt-e.updatedAt).reduce((e,t)=>(t.deletedAt||t.groupId&&t.groupName&&t.groupId!==h.Y$&&t.groupName!==h.G1&&!e.find(e=>e.id===t.groupId)&&e.push({id:t.groupId,name:t.groupName}),e),[]),eA=e=>{let{mode:t,item:l,isSelectMode:o,selectedBooks:d,transferProgress:c,setLoading:u,toggleSelection:p,handleBookUpload:m,handleBookDownload:h,handleBookDelete:x,handleSetSelectMode:f,handleShowDetailsBook:b}=e,j=(0,v.B)(),k=(0,n.useRouter)(),N=(0,n.useSearchParams)(),{envConfig:S,appService:C}=(0,g.D)(),{settings:B}=(0,y.C)(),{updateBook:I}=(0,w.C)(),D=async e=>{await L(e)&&b(e)},L=async e=>{if(e.uploadedAt&&!e.downloadedAt){if(await (null==C?void 0:C.isBookAvailable(e)))return!0;let t=!1,l=setTimeout(()=>u(!0),200);try{t=await h(e),I(S,e)}finally{return l&&clearTimeout(l),u(!1),t}}return!0},E=async e=>{if(o)p(e.hash);else{if(!await L(e))return;(0,r.YF)(k,[e.hash])}},M=e=>{if(o)p(e.id);else{let t=new URLSearchParams(null==N?void 0:N.toString());t.set("group",e.id),(0,r.i7)(k,"".concat(t.toString()))}},P=async e=>{if(!(null==C?void 0:C.hasContextMenu))return;let t=eh[(0,A.Ox)()]||eh.default,l=await ep.Dr.new({text:d.includes(e.hash)?j("Deselect Book"):j("Select Book"),action:async()=>{o||f(!0),p(e.hash)}}),a=await ep.Dr.new({text:j(t),action:async()=>{let t="".concat(B.localBooksDir,"/").concat((0,i.ow)(e));(0,em.b4)(t)}}),s=await ep.Dr.new({text:j("Show Book Details"),action:async()=>{D(e)}}),n=await ep.Dr.new({text:j("Download Book"),action:async()=>{h(e)}}),r=await ep.Dr.new({text:j("Upload Book"),action:async()=>{m(e)}}),c=await ep.Dr.new({text:j("Delete"),action:async()=>{await x(e)}}),u=await ep.W1.new();u.append(l),u.append(s),u.append(a),e.uploadedAt&&!e.downloadedAt&&u.append(n),!e.uploadedAt&&e.downloadedAt&&u.append(r),u.append(c),u.popup()},O=async e=>{if(!(null==C?void 0:C.hasContextMenu))return;let t=await ep.Dr.new({text:d.includes(e.id)?j("Deselect Group"):j("Select Group"),action:async()=>{o||f(!0),p(e.id)}}),l=await ep.Dr.new({text:j("Delete"),action:async()=>{for(let t of e.books)await x(t)}}),a=await ep.W1.new();a.append(t),a.append(l),a.popup()},{pressing:U,handlers:R}=eu({onLongPress:async()=>{o||f(!0),"format"in l?p(l.hash):p(l.id)},onTap:()=>{"format"in l?E(l):M(l)},onContextMenu:()=>{"format"in l?P(l):O(l)}});return(0,a.jsx)("div",{className:(0,s.A)("list"===t&&"sm:hover:bg-base-300/50 px-4 sm:px-6"),children:(0,a.jsx)("div",{className:(0,s.A)("group","grid"===t&&"sm:hover:bg-base-300/50 flex h-full flex-col px-0 py-4 sm:px-4","list"===t&&"border-base-300 flex flex-col border-b py-2",U?"grid"===t?"scale-95":"scale-98":"scale-100"),style:{transition:"transform 0.2s"},...R,children:(0,a.jsx)("div",{className:"flex-grow",children:"format"in l?(0,a.jsx)(ev,{mode:t,book:l,isSelectMode:o,selectedBooks:d,transferProgress:c,handleBookUpload:m,handleBookDownload:h,showBookDetailsModal:D}):(0,a.jsx)(ew,{group:l,isSelectMode:o,selectedBooks:d})})})})};var eN=l(27711);let eS=e=>{let{libraryBooks:t,selectedBooks:l,onCancel:n,onConfirm:r}=e,i=(0,v.B)(),{appService:d}=(0,g.D)(),{setLibrary:c}=(0,w.C)(),u=ek(t),[p,m]=(0,o.useState)(!1),[x,f]=(0,o.useState)(i("Untitled Group")),[b,y]=(0,o.useState)(null),[j,k]=(0,o.useState)([]),[A,N]=(0,o.useState)(u),S=(0,o.useRef)(null),C=(0,Y.D)(16),B=l.some(e=>!(0,er.Xu)(e))||l.map(e=>{var l;return null==(l=t.find(t=>t.hash===e))?void 0:l.groupId}).some(e=>e&&e!==h.G1),I=()=>{let e=x.trim();if(e){let t={id:(0,er.Pr)(e),name:e},l=j.findIndex(t=>t.name===e);for(let e of(l>-1&&j.splice(l,1),j.push(t),y(t),k(j),j)){let t=u.findIndex(t=>t.id===e.id);t>-1&&u.splice(t,1),u.unshift(e)}N(u);let a=new RegExp("^".concat(i("Untitled Group"),"\\s*(\\d+)?$")),s=u.map(e=>{let t=e.name.match(a);return t?parseInt(t[1]||"0",10):null}).filter(e=>null!==e),o=s.length>0?Math.max(...s)+1:1;f("".concat(i("Untitled Group")," ").concat(o)),m(!1)}},D=e=>{y(t=>(null==t?void 0:t.id)===e.id?null:e)};return(0,o.useEffect)(()=>{S.current&&S.current.select()},[p]),(0,o.useEffect)(()=>{let e=l.map(e=>{var l;return null==(l=t.find(t=>t.hash===e||t.groupId===e))?void 0:l.groupId}).filter(e=>e);1===Array.from(new Set(e)).length&&y(u.find(t=>t.id===e[0])||null)},[l]),(0,a.jsx)("div",{className:"fixed inset-0 flex items-center justify-center",children:(0,a.jsxs)("div",{className:(0,s.A)("modal-box bg-base-100 overflow-y-auto rounded-2xl shadow-xl","max-h-[85%] w-[95%] min-w-64 max-w-[440px] p-6 sm:w-[70%]"),children:[(0,a.jsx)("h2",{className:"text-center text-lg font-bold",children:i("Group Books")}),(0,a.jsxs)("div",{className:(0,s.A)("mt-4 grid grid-cols-1 gap-2 text-base md:grid-cols-2"),children:[B&&(0,a.jsxs)("div",{onClick:()=>{l.forEach(e=>{for(let l of t.filter(t=>t.hash===e||t.groupId===e))l&&l.groupId&&l.groupName&&l.groupId!==h.Y$&&l.groupName!==h.G1&&(l.groupId=void 0,l.groupName=void 0,l.updatedAt=Date.now())}),c(t),null==d||d.saveLibraryBooks(t),r()},role:"button",className:"flex items-center space-x-2 p-2 text-blue-500",children:[(0,a.jsx)(eN.uwl,{size:C}),(0,a.jsx)("span",{children:i("Remove From Group")})]}),(0,a.jsxs)("div",{onClick:()=>{m(!0)},role:"button",className:"flex items-center space-x-2 p-2 text-blue-500",children:[(0,a.jsx)(eN.rC3,{size:C}),(0,a.jsx)("span",{children:i("Create New Group")})]})]}),p&&(0,a.jsxs)("div",{className:"mt-4 flex items-center gap-2",children:[(0,a.jsx)("input",{type:"text",autoFocus:!0,ref:S,value:x,onChange:e=>f(e.target.value),onKeyDown:e=>{"Enter"===e.key&&I(),e.stopPropagation()},className:"input input-ghost w-full border-0 px-2 text-base !outline-none sm:text-sm"}),(0,a.jsx)("button",{className:(0,s.A)("btn btn-ghost settings-content hover:bg-transparent","flex h-[1.3em] min-h-[1.3em] items-end p-0",S.current&&S.current.value?"":"btn-disabled !bg-opacity-0"),onClick:()=>I(),children:(0,a.jsx)("div",{className:"pr-1 align-bottom text-base text-blue-500 sm:text-sm",children:i("Save")})})]}),(0,a.jsx)("ul",{className:"groups-list mt-4 grid grid-cols-2 gap-2",children:A.map((e,t)=>(0,a.jsxs)("button",{className:(0,s.A)("hover:bg-base-300 text-base-content flex w-full","items-center justify-between rounded-md px-2 py-2"),onClick:()=>D(e),children:[(0,a.jsxs)("div",{className:"flex min-w-0 items-center",children:[(0,a.jsx)("span",{style:{minWidth:"".concat(C,"px")},children:(0,a.jsx)(eN.mUU,{size:C})}),(0,a.jsx)("span",{className:(0,s.A)("mx-2 flex-1 truncate text-base sm:text-sm"),style:{minWidth:0},children:e.name})]}),(0,a.jsx)("span",{className:"text-neutral-content flex shrink-0 text-sm",children:b&&b.id==e.id&&(0,a.jsx)(q.g9_,{className:"fill-blue-500",size:C})})]},t))}),(0,a.jsxs)("div",{className:"mt-6 flex justify-end gap-x-8 p-2",children:[(0,a.jsx)("button",{onClick:n,className:"flex items-center",children:i("Cancel")}),(0,a.jsx)("button",{onClick:()=>{l.forEach(e=>{for(let l of t.filter(t=>t.hash===e||t.groupId===e))l&&b&&(l.groupId=b.id,l.groupName=b.name,l.updatedAt=Date.now())}),c(t),null==d||d.saveLibraryBooks(t),r()},className:(0,s.A)("flex items-center text-blue-500",!b&&"btn-disabled opacity-50"),children:i("Confirm")})]})]})})},eC=e=>{let{libraryBooks:t,isSelectMode:l,isSelectAll:d,isSelectNone:c,handleImportBooks:u,handleBookUpload:p,handleBookDownload:m,handleBookDelete:h,handleSetSelectMode:x,handleShowDetailsBook:f,booksTransferProgress:b}=e,j=(0,v.B)(),k=(0,n.useRouter)(),A=(0,n.useSearchParams)(),{appService:N}=(0,g.D)(),{settings:S}=(0,y.C)(),[C,B]=(0,o.useState)(!1),[I,D]=(0,o.useState)([]),[L,E]=(0,o.useState)(!1),[M,P]=(0,o.useState)(!1),[O,U]=(0,o.useState)(!1),[R,T]=(0,o.useState)(null),[_,G]=(0,o.useState)(null),[Y]=(0,o.useState)((null==A?void 0:A.get("url"))||""),[W,V]=(0,o.useState)((null==A?void 0:A.get("view"))||S.libraryViewMode),[X,$]=(0,o.useState)((null==A?void 0:A.get("sort"))||S.librarySortBy),[H,J]=(0,o.useState)((null==A?void 0:A.get("order"))||(S.librarySortAscending?"asc":"desc")),K=(0,o.useRef)(!1),{setCurrentBookshelf:Z,setLibrary:Q}=(0,w.C)(),ee="grid"===W?ey(t):ej(t);(0,o.useEffect)(()=>{!K.current&&(K.current=!0,Y&&N&&(async()=>{console.log("Importing book from URL:",Y);let e=await N.importBook(Y,t);e&&(Q(t),N.saveLibraryBooks(t),(0,r.YF)(k,[e.hash]))})())},[Y,N]),(0,o.useEffect)(()=>{_?Z(_.books):Z(ee)},[t,_]),(0,o.useEffect)(()=>{let e=(null==A?void 0:A.get("group"))||"",t=(null==A?void 0:A.get("q"))||"",l=(null==A?void 0:A.get("view"))||S.libraryViewMode,a=(null==A?void 0:A.get("sort"))||S.librarySortBy,s=(null==A?void 0:A.get("order"))||(S.librarySortAscending?"asc":"desc"),o=new URLSearchParams(null==A?void 0:A.toString());if(t?(o.set("q",t),T(t)):(o.delete("q"),T(null)),a?(o.set("sort",a),$(a)):o.delete("sort"),s?(o.set("order",s),J(s)):o.delete("order"),l?(o.set("view",l),V(l)):o.delete("view"),"updated"===a&&"desc"===s&&"grid"===l&&(o.delete("sort"),o.delete("order"),o.delete("view")),e){let t=ee.find(t=>"name"in t&&t.id===e);t?(G(t),o.set("group",e)):(o.delete("group"),(0,r.i7)(k,"".concat(o.toString())))}else G(null),o.delete("group"),(0,r.i7)(k,"".concat(o.toString()))},[A,t,O]);let et=e=>{D(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},el=()=>{let e=[];return I.forEach(l=>{for(let a of t.filter(e=>e.hash===l||e.groupId===l))a&&!a.deletedAt&&e.push(a)}),e},ea=async()=>{for(let e of el())h(e);D([]),P(!1),E(!0)},es=(e,t)=>{if(e.deletedAt)return!1;let l=RegExp(t,"i"),a=(0,i.Ef)(e.title),s=(0,i.kY)(e.author);return l.test(a)||l.test(s)},eo=(e,t)=>{var l;let a=(null==(l=localStorage)?void 0:l.getItem("i18nextLng"))||"";switch(X){case"title":let s=(0,i.Ef)(e.title),o=(0,i.Ef)(t.title);return s.localeCompare(o,a||navigator.language);case"author":let n=(0,i.kY)(e.author),r=(0,i.kY)(t.author);return n.localeCompare(r,a||navigator.language);case"updated":default:return new Date(e.updatedAt).getTime()-new Date(t.updatedAt).getTime();case"created":return new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime();case"format":return e.format.localeCompare(t.format,a||navigator.language)}},ed="asc"===H?1:-1,eu=(_?_.books:ee).filter(e=>"name"in e?e.books.some(e=>es(e,R||"")):!R||es(e,R)).sort((e,t)=>{var l;let a=(null==(l=localStorage)?void 0:l.getItem("i18nextLng"))||"";if("updated"===X)return(new Date(e.updatedAt).getTime()-new Date(t.updatedAt).getTime())*ed;if("name"in e||"name"in t){let l="name"in e?e.name:(0,i.Ef)(e.title),s="name"in t?t.name:(0,i.Ef)(t.title);return l.localeCompare(s,a||navigator.language)*ed}return"name"in e||"name"in t?0:eo(e,t)*ed});return(0,o.useEffect)(()=>{l?(E(!0),d?D(eu.map(e=>"hash"in e?e.hash:e.id)):c&&D([])):(D([]),E(!1))},[l,d,c]),(0,a.jsxs)("div",{className:"bookshelf",children:[(0,a.jsxs)("div",{className:(0,s.A)("transform-wrapper","grid"===W&&"grid flex-1 grid-cols-3 gap-x-4 px-4 sm:gap-x-0 sm:px-2","grid"===W&&"sm:grid-cols-4 md:grid-cols-6 xl:grid-cols-8 2xl:grid-cols-12","list"===W&&"flex flex-col"),children:[eu.map((e,t)=>(0,a.jsx)(eA,{mode:W,item:e,isSelectMode:l,selectedBooks:I,setLoading:B,toggleSelection:et,handleBookUpload:p,handleBookDownload:m,handleBookDelete:h,handleSetSelectMode:x,handleShowDetailsBook:f,transferProgress:"hash"in e&&b[e.hash]||null},"library-item-".concat(t))),"grid"===W&&!_&&ee.length>0&&(0,a.jsx)("div",{className:(0,s.A)("border-1 bg-base-100 hover:bg-base-300/50 flex items-center justify-center","mx-0 my-4 aspect-[28/41] sm:mx-4"),role:"button",onClick:u,children:(0,a.jsx)(F.enO,{className:"size-10",color:"gray"})})]}),C&&(0,a.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:(0,a.jsx)(z.A,{loading:!0})}),(0,a.jsx)("div",{className:"fixed bottom-0 left-0 right-0 z-40 pb-[calc(env(safe-area-inset-bottom)+16px)]",children:l&&L&&(0,a.jsxs)("div",{className:(0,s.A)("flex items-center justify-center shadow-lg","bg-gray-600 text-xs text-white","mx-auto w-fit space-x-6 rounded-lg p-4"),children:[(0,a.jsxs)("button",{onClick:()=>{setTimeout(()=>B(!0),200),(0,r.YF)(k,I)},className:(0,s.A)("flex flex-col items-center justify-center gap-1",(!I.length||!I.every(e=>(0,er.Xu)(e)))&&"btn-disabled opacity-50"),children:[(0,a.jsx)(q.JvP,{}),(0,a.jsx)("div",{children:j("Open")})]}),(0,a.jsxs)("button",{onClick:()=>{E(!1),U(!0)},className:(0,s.A)("flex flex-col items-center justify-center gap-1",!I.length&&"btn-disabled opacity-50"),children:[(0,a.jsx)(en.efR,{}),(0,a.jsx)("div",{children:j("Group")})]}),(0,a.jsxs)("button",{onClick:()=>{let e=t.find(e=>e.hash===I[0]);e&&f(e)},className:(0,s.A)("flex flex-col items-center justify-center gap-1",(1!==I.length||!I.every(e=>(0,er.Xu)(e)))&&"btn-disabled opacity-50"),children:[(0,a.jsx)(q.k4P,{}),(0,a.jsx)("div",{children:j("Details")})]}),(0,a.jsxs)("button",{onClick:()=>{E(!1),P(!0)},className:(0,s.A)("flex flex-col items-center justify-center gap-1",!I.length&&"btn-disabled opacity-50"),children:[(0,a.jsx)(q.b6i,{className:"fill-red-500"}),(0,a.jsx)("div",{className:"text-red-500",children:j("Delete")})]}),(0,a.jsxs)("button",{onClick:()=>x(!1),className:(0,s.A)("flex flex-col items-center justify-center gap-1"),children:[(0,a.jsx)(q.qiG,{}),(0,a.jsx)("div",{children:j("Cancel")})]})]})}),O&&(0,a.jsx)(ec,{children:(0,a.jsx)(eS,{libraryBooks:t,selectedBooks:I,onCancel:()=>{U(!1),E(!0)},onConfirm:()=>{U(!1),x(!1)}})}),M&&(0,a.jsx)("div",{className:(0,s.A)("fixed bottom-0 left-0 right-0 z-50 flex justify-center","pb-[calc(env(safe-area-inset-bottom)+16px)]"),children:(0,a.jsx)(ei.A,{title:j("Confirm Deletion"),message:j("Are you sure to delete {{count}} selected book(s)?",{count:el().length}),onCancel:()=>{P(!1),E(!0)},onConfirm:ea})})]})};var eB=l(99613),eI=l(29735);let eD=()=>{let e=(0,v.B)();return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"drag-overlay"}),(0,a.jsx)("div",{className:"drop-indicator",children:(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center",children:[(0,a.jsx)(eI.d3E,{className:"h-12 w-12"}),(0,a.jsx)("p",{className:"mt-2 font-medium",children:e("Drop to Import Books")})]})})]})},eL=()=>{let e=(0,n.useSearchParams)();return(0,a.jsx)(eE,{searchParams:e})},eE=e=>{let{searchParams:t}=e,l=(0,n.useRouter)(),{envConfig:A,appService:N}=(0,g.D)(),{token:C,user:B}=(0,b.A)(),{library:_,updateBook:F,setLibrary:q,checkOpenWithBooks:G,checkLastOpenBooks:Y,setCheckOpenWithBooks:W,setCheckLastOpenBooks:X}=(0,w.C)(),$=(0,v.B)();(0,k.D)({systemUIVisible:!0,appThemeColor:"base-200"});let{settings:H,setSettings:J,saveSettings:K}=(0,y.C)(),{statusBarHeight:Z}=(0,D.C)(),[Q,ee]=(0,o.useState)(!1),et=(0,o.useRef)(!1),[el,ea]=(0,o.useState)(!1),[es,en]=(0,o.useState)(!1),[er,ei]=(0,o.useState)(!1),[ed,ec]=(0,o.useState)(!1),[eu,ep]=(0,o.useState)(null),[em,eh]=(0,o.useState)({}),[ex,ef]=(0,o.useState)(null),[eg,eb]=(0,o.useState)(!1),ev=S(),ew=(0,o.useRef)(null),ey=(0,o.useRef)(null);(0,E._)();let{pullLibrary:ej,pushLibrary:ek}=I({onSyncStart:()=>ee(!0),onSyncEnd:()=>ee(!1)});j(ew,ej),(0,L.N)(H.screenWakeLock),(0,V.A)({onToggleFullscreen:async()=>{(0,p.uO)()&&await (0,O.tP)()},onQuitApp:async()=>{(0,p.uO)()&&await (0,O.c_)()}}),(0,o.useEffect)(()=>{(0,P.D)(document)},[]),(0,o.useEffect)(()=>{let e=async()=>{(null==N?void 0:N.hasUpdater)&&H.autoCheckUpdates&&await (0,m.J)($)};H.alwaysOnTop&&(0,O.Lj)(H.alwaysOnTop),e()},[H]),(0,o.useEffect)(()=>{(null==N?void 0:N.isMobileApp)&&(0,M.ot)({orientation:"auto"})},[N]);let eA=async e=>{if(0===e.length)return;let t=e.filter(e=>{var t,l;let a;return a="string"==typeof e?null==(t=e.split(".").pop())?void 0:t.toLowerCase():null==(l=e.name.split(".").pop())?void 0:l.toLowerCase(),h.dp.includes(".".concat(a))});if(0===t.length)return void d.I.dispatch("toast",{message:$("No supported files found. Supported formats: {{formats}}",{formats:h.dp}),type:"error"});(null==N?void 0:N.hasHaptics)&&(0,x._q)("medium"),await eM(t)},eN=e=>{e.preventDefault(),e.stopPropagation(),eb(!0)},eS=e=>{e.preventDefault(),e.stopPropagation(),eb(!1)},eI=async e=>{var t;e.preventDefault(),e.stopPropagation(),eb(!1),(null==(t=e.dataTransfer)?void 0:t.files)&&e.dataTransfer.files.length>0&&eA(Array.from(e.dataTransfer.files))};(0,o.useEffect)(()=>{let e=document.querySelector(".library-page");if((null==N?void 0:N.isMobile)||(null==e||e.addEventListener("dragover",eN),null==e||e.addEventListener("dragleave",eS),null==e||e.addEventListener("drop",eI)),(0,p.uO)()){let e=(0,f.zo)().onDragDropEvent(e=>{"over"===e.payload.type?eb(!0):"drop"===e.payload.type?(eb(!1),eA(e.payload.paths)):eb(!1)});return()=>{e.then(e=>e())}}return()=>{(null==N?void 0:N.isMobile)||(null==e||e.removeEventListener("dragover",eN),null==e||e.removeEventListener("dragleave",eS),null==e||e.removeEventListener("drop",eI))}},[ey.current]),(0,o.useEffect)(()=>{_.some(e=>!e.deletedAt)||eF(!1)},[_]);let eL=o.useCallback(async(e,t,l)=>{let a=await e.loadSettings(),s=[];for(let o of t){console.log("Open with book:",o);try{let t=!e.isMobile&&!a.autoImportBooksOnOpen,n=await e.importBook(o,l,!0,!0,!1,t);n&&s.push(n.hash)}catch(e){console.log("Failed to import book:",o,e)}}return q(l),e.saveLibraryBooks(l),console.log("Opening books:",s),s.length>0&&(ef(s),!0)},[]),eE=async(e,t,l)=>{if(0===t.length)return!1;let a=[];for(let s of t){let t=l.find(e=>e.hash===s);t&&await e.isBookAvailable(t)&&a.push(t.hash)}return console.log("Opening last books:",a),a.length>0&&(ef(a),!0)};(0,o.useEffect)(()=>{ex&&(ef(null),ex.length>0&&(0,r.YF)(l,ex))},[ex,l]),(0,o.useEffect)(()=>{if(et.current)return;et.current=!0;let e=async()=>{let e=await A.getAppService(),t=await e.loadSettings();C&&B?t.keepLogin||(t.keepLogin=!0,J(t),K(A,t)):t.keepLogin&&l.push("/auth")},t=setTimeout(()=>ee(!0),300),a=async()=>{let e=await A.getAppService(),l=await e.loadSettings();J(l);let a=_.length>0?_:await e.loadLibraryBooks();W(G&&await s(e,a)),X(Y&&l.openLastBooks&&await eE(e,l.lastOpenBooks,a)),q(a),ea(!0),t&&clearTimeout(t),ee(!1)},s=async(e,t)=>{let l=await (0,u.L)()||[];return l.length>0&&await eL(e,l,t)};return e(),a(),()=>{W(!1),X(!1),et.current=!1}},[t]),(0,o.useEffect)(()=>{if(ev.length>0&&el){let e=[..._];for(let t of ev){let l=e.findIndex(e=>e.hash===t.hash);-1===l?e.push(t):e[l]=t}q(e),null==N||N.saveLibraryBooks(e)}},[ev,el]);let eM=async e=>{ee(!0);let t=[],l=[["No chapters detected.",$("No chapters detected.")],["Failed to parse EPUB.",$("Failed to parse the EPUB file.")],["Unsupported format.",$("This book format is not supported.")]],{library:a}=w.C.getState();for(let o of e)try{let e=await (null==N?void 0:N.importBook(o,a));q([...a]),B&&e&&!e.uploadedAt&&H.autoUpload&&(console.log("Uploading book:",e.title),eR(e))}catch(r){var s;let e="string"==typeof o?o:o.name,a=(0,i.e7)(e);t.push(a);let n=r instanceof Error&&(null==(s=l.find(e=>{let[t]=e;return r.message.includes(t)}))?void 0:s[1])||"";d.I.dispatch("toast",{message:$("Failed to import book(s): {{filenames}}",{filenames:(0,i.jR)(!1).format(t)})+(n?"\n".concat(n):""),type:"error"}),console.error("Failed to import book:",e,r)}null==N||N.saveLibraryBooks(a),ee(!1)},eP=async()=>{let e=(null==N?void 0:N.isAndroidApp)?[]:h.Jy;return await (null==N?void 0:N.selectFiles($("Select Books"),e))||[]},eO=()=>new Promise(e=>{let t=document.createElement("input");t.type="file",t.accept=h.dp,t.multiple=!0,t.click(),t.onchange=()=>{e(t.files)}}),eU=(0,c.n)((e,t)=>{if(0===t.total)return;let l=t.progress/t.total*100;eh(t=>({...t,[e]:l}))},500),eR=async e=>{try{return await (null==N?void 0:N.uploadBook(e,t=>{eU(e.hash,t)})),await F(A,e),ek(),d.I.dispatch("toast",{type:"info",timeout:2e3,message:$("Book uploaded: {{title}}",{title:e.title})}),!0}catch(t){if(t instanceof Error){if(t.message.includes("Not authenticated")&&H.keepLogin)return H.keepLogin=!1,J(H),(0,r.OO)(l),!1;else if(t.message.includes("Insufficient storage quota"))return d.I.dispatch("toast",{type:"error",message:$("Insufficient storage quota")}),!1}return d.I.dispatch("toast",{type:"error",message:$("Failed to upload book: {{title}}",{title:e.title})}),!1}},eT=async e=>{try{return await (null==N?void 0:N.downloadBook(e,!1,t=>{eU(e.hash,t)})),await F(A,e),d.I.dispatch("toast",{type:"info",timeout:2e3,message:$("Book downloaded: {{title}}",{title:e.title})}),!0}catch(t){return d.I.dispatch("toast",{message:$("Failed to download book: {{title}}",{title:e.title}),type:"error"}),!1}},ez=async e=>{try{return await (null==N?void 0:N.deleteBook(e,!!e.uploadedAt)),await F(A,e),ek(),d.I.dispatch("toast",{type:"info",timeout:2e3,message:$("Book deleted: {{title}}",{title:e.title})}),!0}catch(t){return d.I.dispatch("toast",{message:$("Failed to delete book: {{title}}",{title:e.title}),type:"error"}),!1}},e_=async()=>{let e;en(!1),console.log("Importing books..."),eM((0,p.uO)()?(null==N?void 0:N.isIOSApp)?await eO():await eP():await eO())},eF=e=>{e&&(null==N?void 0:N.hasHaptics)&&(0,x._q)("medium"),en(e),ei(!1),ec(!1)};return N?G||Y?Q&&(0,a.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:(0,a.jsx)(z.A,{loading:!0})}):(0,a.jsxs)("div",{ref:ey,className:(0,s.A)("library-page bg-base-200 text-base-content flex select-none flex-col overflow-hidden",(null==N?void 0:N.isIOSApp)?"h-[100vh]":"h-dvh",(null==N?void 0:N.hasRoundedWindow)&&"rounded-window"),children:[(0,a.jsx)("div",{className:"fixed top-0 z-40 w-full",children:(0,a.jsx)(eo,{isSelectMode:es,isSelectAll:er,onImportBooks:e_,onToggleSelectMode:()=>eF(!es),onSelectAll:()=>{ei(!0),ec(!1)},onDeselectAll:()=>{ec(!0),ei(!1)}})}),Q&&(0,a.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:(0,a.jsx)(z.A,{loading:!0})}),el&&(_.some(e=>!e.deletedAt)?(0,a.jsxs)("div",{ref:ew,className:(0,s.A)("scroll-container drop-zone flex-grow overflow-y-auto",(null==N?void 0:N.hasSafeAreaInset)&&"pt-[52px]",(null==N?void 0:N.hasSafeAreaInset)&&"pb-[calc(env(safe-area-inset-bottom))]",eg&&"drag-over"),style:{marginTop:(null==N?void 0:N.hasSafeAreaInset)?"max(env(safe-area-inset-top), ".concat(Z,"px)"):"48px"},children:[(0,a.jsx)(eD,{}),(0,a.jsx)(eC,{libraryBooks:_,isSelectMode:es,isSelectAll:er,isSelectNone:ed,handleImportBooks:e_,handleBookUpload:eR,handleBookDownload:eT,handleBookDelete:ez,handleSetSelectMode:eF,handleShowDetailsBook:e=>{ep(e)},booksTransferProgress:em})]}):(0,a.jsxs)("div",{className:"hero drop-zone h-screen items-center justify-center",children:[(0,a.jsx)(eD,{}),(0,a.jsx)("div",{className:"hero-content text-neutral-content text-center",children:(0,a.jsxs)("div",{className:"max-w-md",children:[(0,a.jsx)("h1",{className:"mb-5 text-5xl font-bold",children:$("Your Library")}),(0,a.jsx)("p",{className:"mb-5",children:$("Welcome to your library. You can import your books here and read them anytime.")}),(0,a.jsx)("button",{className:"btn btn-primary rounded-xl",onClick:e_,children:$("Import Books")})]})})]})),eu&&(0,a.jsx)(eB.A,{isOpen:!!eu,book:eu,onClose:()=>ep(null),handleBookUpload:eR,handleBookDownload:eT,handleBookDelete:ez}),(0,a.jsx)(U.i,{}),(null==N?void 0:N.isAndroidApp)&&(0,a.jsx)(R.Y0,{}),(0,a.jsx)(T.y,{})]}):null},eM=()=>(0,a.jsx)(o.Suspense,{fallback:(0,a.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:(0,a.jsx)(z.A,{loading:!0})}),children:(0,a.jsx)(eL,{})})},26266:(e,t,l)=>{"use strict";l.d(t,{V:()=>r});var a=l(84574),s=l(46450),o=l(28039),n=l(78549);let r=()=>{let e=(0,n.B)(),{token:t,user:l}=(0,s.A)(),[r,i]=(0,a.useState)([]),[d,c]=(0,a.useState)("free");return(0,a.useEffect)(()=>{if(!l||!t)return;let a=(0,o.l3)(t),s=(0,o.r2)(t),n={name:e("Storage"),tooltip:e("{{percentage}}% of Cloud Storage Used.",{percentage:Math.round(s.usage/s.quota*100)}),used:Math.round(s.usage/1024/1024),total:Math.round(s.quota/1024/1024),unit:"MB"},r=(0,o.Bg)(t),d={name:e("Translation Characters"),tooltip:e("{{percentage}}% of Daily Translation Characters Used.",{percentage:Math.round(r.usage/r.quota*100)}),used:Math.round(r.usage/1024),total:Math.round(r.quota/1024),unit:"K"};c(a),i([n,d])},[t]),{quotas:r,userPlan:d}}},45322:(e,t,l)=>{"use strict";l.d(t,{A:()=>o});var a=l(62574),s=l(3073);l(84574);let o=e=>{let{quotas:t,showProgress:l,className:o,labelClassName:n}=e;return(0,a.jsx)("div",{className:(0,s.A)("text-base-content w-full rounded-md text-base sm:text-sm",o),children:t.map(e=>{let t=e.used/e.total*100,o="bg-green-500";return t>80?o="bg-red-500":t>50&&(o="bg-yellow-500"),(0,a.jsxs)("div",{className:(0,s.A)("relative w-full overflow-hidden rounded-md",l&&"bg-base-300"),children:[l&&(0,a.jsx)("div",{className:"absolute left-0 top-0 h-full ".concat(o),style:{width:"".concat(t,"%")}}),(0,a.jsxs)("div",{className:(0,s.A)("relative flex items-center justify-between gap-4 p-2",n),children:[(0,a.jsx)("div",{className:"lg:tooltip lg:tooltip-right","data-tip":e.tooltip,children:(0,a.jsx)("span",{className:"truncate",children:e.name})}),(0,a.jsxs)("div",{className:"text-right text-xs",children:[e.used," / ",e.total," ",e.unit]})]})]},e.name)})})}},57832:(e,t,l)=>{"use strict";l.d(t,{A:()=>r});var a=l(62574),s=l(3073),o=l(25143),n=l(84574);let r=e=>{let{url:t,size:l,className:r,borderClassName:i,DefaultIcon:d}=e,[c,u]=(0,n.useState)(null);return(0,n.useEffect)(()=>{if(!t)return;let e="avatar_".concat(btoa(t).replace(/[^a-zA-Z0-9]/g,"")),l=localStorage.getItem(e);if(l)return void u(l);(async()=>{try{let l=await fetch(t,{referrerPolicy:"no-referrer"}),a=await l.blob(),s=new FileReader;s.onloadend=()=>{let t=s.result;try{localStorage.setItem(e,t),u(t)}catch(e){console.warn("Failed to cache avatar in localStorage:",e)}},s.readAsDataURL(a)}catch(e){console.error("Failed to cache avatar:",e)}})()},[t]),(0,a.jsx)("div",{className:"relative flex h-full w-full items-center justify-center rounded-full",style:{width:l,height:l},children:t?(0,a.jsxs)("div",{children:[(0,a.jsx)(o.default,{src:c||t,alt:"User Avatar",className:(0,s.A)("rounded-full",r,i),referrerPolicy:"no-referrer",width:l,height:l,onError:e=>{var t;e.target.style.display="none",null==(t=e.target.nextElementSibling)||t.classList.remove("invisible")}}),(0,a.jsx)("div",{className:"invisible absolute inset-0 flex items-center justify-center",children:(0,a.jsx)(d,{className:(0,s.A)("text-neutral-content",r)})})]}):(0,a.jsx)(d,{className:"text-neutral-content",size:l})})}},84260:(e,t,l)=>{"use strict";l.d(t,{Iv:()=>o,xe:()=>n,z7:()=>s});var a=l(28091);let s="readest-telemetry-opt-out",o=()=>{localStorage.setItem(s,"false"),a.Ay.opt_in_capturing()},n=()=>{localStorage.setItem(s,"true"),a.Ay.opt_out_capturing()}},90357:(e,t,l)=>{Promise.resolve().then(l.bind(l,11705))}},e=>{var t=t=>e(e.s=t);e.O(0,[7412,1868,2848,7324,951,3564,1336,6258,868,3064,6141,6278,1029,6261,743,8769,348,935,1503,2722,1660,1985,1426,9743,6821,426,3125,7358],()=>t(90357)),_N_E=e.O()}]);