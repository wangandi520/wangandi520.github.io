"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8815],{10279:(e,t,r)=>{r.d(t,{A:()=>a,i:()=>i});var n=r(29803);let i=e=>{if(!e)return"auto";let t=new Set(["ar","he","fa","ur","dv","ps","sd","yi"]),r=e.split("-")[0].toLowerCase();return t.has(r)?"rtl":"auto"},a=()=>i((0,n.gl)())},19860:(e,t,r)=>{r.d(t,{B6:()=>a,Bq:()=>l,WC:()=>i,e2:()=>s});var n=r(32450);let i=(e,t,r)=>new Promise((n,i)=>{let a=Date.now(),l=new XMLHttpRequest;l.open("PUT",t,!0),l.upload.onprogress=e=>{r&&e.lengthComputable&&r({progress:e.loaded,total:e.total,transferSpeed:e.loaded/((Date.now()-a)/1e3)})},l.onload=()=>{l.status>=200&&l.status<300?n():i(Error("Upload failed with status ".concat(l.status)))},l.onerror=()=>i(Error("Upload failed")),l.send(e)}),a=async(e,t)=>{let r=await fetch(e);if(!r.ok)throw Error("File download failed");let n=r.headers.get("Content-Length");if(!n)throw Error("Cannot track progress: Content-Length missing");let i=parseInt(n,10),a=0,l=r.body.getReader(),s=[],o=Date.now();for(;;){let{done:e,value:r}=await l.read();if(e)break;s.push(r),a+=r.length,t&&t({progress:a,total:i,transferSpeed:a/((Date.now()-o)/1e3)})}return new Blob(s)},l=async(e,t,r,i,a)=>{let l=new Uint32Array(1);window.crypto.getRandomValues(l);let s=l[0],o=new n.c3;return i&&(o.onmessage=i),await (0,n.lA)("upload_file",{id:s,url:e,filePath:t,method:r,headers:null!=a?a:{},onProgress:o})},s=async(e,t,r,i,a)=>{let l=new Uint32Array(1);window.crypto.getRandomValues(l);let s=l[0],o=new n.c3;r&&(o.onmessage=r),await (0,n.lA)("download_file",{id:s,url:e,filePath:t,headers:null!=i?i:{},onProgress:o,body:a})}},23471:(e,t,r)=>{r.d(t,{HY:()=>f,Rg:()=>u,u6:()=>d,xb:()=>c});var n,i,a,l,s=r(72101),o=r(28377);null!=(n=Object).groupBy||(n.groupBy=(e,t)=>{let r=Object.create(null),n=0;for(let i of e){let e=t(i,n++);e in r?r[e].push(i):r[e]=[i]}return r}),null!=(i=Map).groupBy||(i.groupBy=(e,t)=>{let r=new Map,n=0;for(let i of e){let e=t(i,n++),a=r.get(e);a?a.push(i):r.set(e,[i])}return r});let f=o,u={EPUB:"epub",PDF:"pdf",MOBI:"mobi",CBZ:"cbz",FB2:"fb2",FBZ:"fbz"};class c{async isZip(){let e=new Uint8Array(await this.file.slice(0,4).arrayBuffer());return 80===e[0]&&75===e[1]&&3===e[2]&&4===e[3]}async isPDF(){let e=new Uint8Array(await this.file.slice(0,5).arrayBuffer());return 37===e[0]&&80===e[1]&&68===e[2]&&70===e[3]&&45===e[4]}async makeZipLoader(){let e=async()=>{let e=Math.min(65536,this.file.size),t=new Uint8Array(await this.file.slice(this.file.size-e,this.file.size).arrayBuffer());for(let e=t.length-22;e>=0;e--)if(80===t[e]&&75===t[e+1]&&5===t[e+2]&&6===t[e+3]){let r=t[e+20]+(t[e+21]<<8),n=e+22,i=t.slice(n,n+r);return new TextDecoder().decode(i)}return null},{configure:t,ZipReader:n,BlobReader:i,TextWriter:a,BlobWriter:l}=await r.e(4477).then(r.bind(r,54477));t({useWebWorkers:!1});let s=new n(new i(this.file)),o=await s.getEntries(),f=new Map(o.map(e=>[e.filename,e])),u=e=>function(t){for(var r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];return f.has(t)?e(f.get(t),...n):null},c=u(e=>e.getData?e.getData(new a):null);return{entries:o,loadText:c,loadBlob:u((e,t)=>e.getData?e.getData(new l(t)):null),getSize:e=>{var t,r;return null!=(r=null==(t=f.get(e))?void 0:t.uncompressedSize)?r:0},getComment:e,sha1:void 0}}isCBZ(){return"application/vnd.comicbook+zip"===this.file.type||this.file.name.endsWith(".".concat(u.CBZ))}isFB2(){return"application/x-fictionbook+xml"===this.file.type||this.file.name.endsWith(".".concat(u.FB2))}isFBZ(){return"application/x-zip-compressed-fb2"===this.file.type||this.file.name.endsWith(".fb2.zip")||this.file.name.endsWith(".".concat(u.FBZ))}async open(){let{allowScript:e=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=null,n="EPUB";if(!this.file.size)throw Error("File is empty");if(await this.isZip()){let i=await this.makeZipLoader(),{entries:a}=i;if(this.isCBZ()){let{makeComicBook:e}=await r.e(6040).then(r.bind(r,76040));t=await e(i,this.file),n="CBZ"}else if(this.isFBZ()){let e=a.find(e=>e.filename.endsWith(".".concat(u.FB2))),l=await i.loadBlob((null!=e?e:a[0]).filename),{makeFB2:s}=await r.e(2189).then(r.bind(r,62189));t=await s(l),n="FBZ"}else{let{EPUB:a}=await r.e(5935).then(r.bind(r,65935));t=await new a(i).init({allowScript:e}),n="EPUB"}}else if(await this.isPDF()){let{makePDF:e}=await Promise.all([r.e(8031),r.e(6885)]).then(r.bind(r,38031));t=await e(this.file),n="PDF"}else if(await (await r.e(2200).then(r.bind(r,42200))).isMOBI(this.file)){let e=await r.e(3352).then(r.bind(r,33352)),{MOBI:i}=await r.e(2200).then(r.bind(r,42200));t=await new i({unzlib:e.unzlibSync}).open(this.file),n="MOBI"}else if(this.isFB2()){let{makeFB2:e}=await r.e(2189).then(r.bind(r,62189));t=await e(this.file),n="FB2"}return{book:t,format:n}}constructor(e){(0,s._)(this,"file",void 0),this.file=e}}let d=e=>{let{defaultView:t}=e,{writingMode:r,direction:n}=t.getComputedStyle(e.body);return{vertical:"vertical-rl"===r||"vertical-lr"===r,rtl:"rtl"===e.body.dir||"rtl"===n||"rtl"===e.documentElement.dir}}},28377:(e,t,r)=>{let n;r.r(t),r.d(t,{collapse:()=>E,compare:()=>v,fake:()=>R,fromCalibreHighlight:()=>O,fromCalibrePos:()=>k,fromElements:()=>P,fromRange:()=>D,isCFI:()=>o,joinIndir:()=>d,parse:()=>w,toElement:()=>j,toRange:()=>z});let i=(e,t)=>e.map((e,r,n)=>t(e,r,n)?r:null).filter(e=>null!=e),a=(e,t)=>[-1,...t,e.length].reduce(({xs:t,a:r},n)=>({xs:t?.concat([e.slice(r+1,n)])??[],a:n}),{}).xs,l=(e,t)=>e.slice(0,-1).concat([e[e.length-1].concat(t[0])]).concat(t.slice(1)),s=/\d/,o=/^epubcfi\((.*)\)$/,f=e=>e.replace(/[\^[\](),;=]/g,"^$&"),u=e=>o.test(e)?e:`epubcfi(${e})`,c=e=>e.match(o)?.[1]??e,d=(n=(...e)=>e.join("!"),(...e)=>`epubcfi(${n(...e.map(e=>e.match(o)?.[1]??e))})`),h=e=>{let t=[],r,n,i="",a=e=>(t.push(e),r=null,i=""),l=e=>(i+=e,n=!1);for(let t of Array.from(e.trim()).concat("")){if("^"===t&&!n){n=!0;continue}if("!"===r)a(["!"]);else if(","===r)a([","]);else if("/"===r||":"===r)if(s.test(t)){l(t);continue}else a([r,parseInt(i)]);else if("~"===r)if(s.test(t)||"."===t){l(t);continue}else a(["~",parseFloat(i)]);else if("@"===r){if(":"===t){a(["@",parseFloat(i)]),r="@";continue}if(s.test(t)||"."===t){l(t);continue}a(["@",parseFloat(i)])}else if("["===r){";"!==t||n?","!==t||n?"]"!==t||n?l(t):a(["[",i]):(a(["[",i]),r="["):(a(["[",i]),r=";");continue}else if(r?.startsWith(";")){"="!==t||n?";"!==t||n?"]"!==t||n?l(t):a([r,i]):(a([r,i]),r=";"):(r=`;${i}`,i="");continue}("/"===t||":"===t||"~"===t||"@"===t||"["===t||"!"===t||","===t)&&(r=t)}return t},p=(e,t)=>i(e,([e])=>e===t),g=e=>{let t,r=[];for(let[n,i]of e){if("/"===n)r.push({index:i});else{let e=r[r.length-1];if(":"===n)e.offset=i;else if("~"===n)e.temporal=i;else if("@"===n)e.spatial=(e.spatial??[]).concat(i);else if(";s"===n)e.side=i;else if("["===n)if("/"===t&&i)e.id=i;else{e.text=(e.text??[]).concat(i);continue}}t=n}return r},m=e=>a(e,p(e,"!")).map(g),w=e=>{let t=h(c(e)),r=p(t,",");if(!r.length)return m(t);let[n,i,l]=a(t,r).map(m);return{parent:n,start:i,end:l}},y=({index:e,id:t,offset:r,temporal:n,spatial:i,text:a,side:l})=>{let s=l?`;s=${l}`:"";return`/${e}`+(t?`[${f(t)}${s}]`:"")+(null!=r&&e%2?`:${r}`:"")+(n?`~${n}`:"")+(i?`@${i.join(":")}`:"")+(a||!t&&l?"["+(a?.map(f)?.join(",")??"")+s+"]":"")},b=e=>e.parent?[e.parent,e.start,e.end].map(b).join(","):e.map(e=>e.map(y).join("")).join("!"),B=e=>u(b(e)),E=(e,t)=>"string"==typeof e?B(E(w(e),t)):e.parent?l(e.parent,e[t?"end":"start"]):e,A=(e,t)=>{"string"==typeof e&&(e=w(e)),"string"==typeof t&&(t=w(t)),e=E(e),t=E(t,!0);let r=e[e.length-1],n=t[t.length-1],i=[],a=[],l=[],s=!0,o=Math.max(r.length,n.length);for(let e=0;e<o;e++){let t=r[e],o=n[e];(s&&=t?.index===o?.index&&!t?.offset&&!o?.offset)?i.push(t):(t&&a.push(t),o&&l.push(o))}return B({parent:e.slice(0,-1).concat([i]),start:[a],end:[l]})},v=(e,t)=>{if("string"==typeof e&&(e=w(e)),"string"==typeof t&&(t=w(t)),e.start||t.start)return v(E(e),E(t))||v(E(e,!0),E(t,!0));for(let r=0;r<Math.max(e.length,t.length);r++){let n=e[r]??[],i=t[r]??[],a=Math.max(n.length,i.length)-1;for(let e=0;e<=a;e++){let t=n[e],r=i[e];if(!t)return -1;if(!r||t.index>r.index)return 1;if(t.index<r.index)return -1;if(e===a){if(t.offset>r.offset)return 1;if(t.offset<r.offset)return -1}}}return 0},C=({nodeType:e})=>3===e||4===e,S=({nodeType:e})=>1===e,F=(e,t)=>{let r=Array.from(e.childNodes).filter(e=>C(e)||S(e));return t?r.map(e=>{let r=t(e);return r===NodeFilter.FILTER_REJECT?null:r===NodeFilter.FILTER_SKIP?F(e,t):e}).flat().filter(e=>e):r},x=(e,t)=>{let r=F(e,t).reduce((e,t)=>{let r=e[e.length-1];return r?C(t)?Array.isArray(r)?r.push(t):C(r)?e[e.length-1]=[r,t]:e.push(t):S(r)?e.push(null,t):e.push(t):e.push(t),e},[]);return S(r[0])&&r.unshift("first"),S(r[r.length-1])&&r.push("last"),r.unshift("before"),r.push("after"),r},_=(e,t,r)=>{let{id:n}=t[t.length-1];if(n){let t=e.ownerDocument.getElementById(n);if(t)return{node:t,offset:0}}for(let{index:n}of t){let t=e?x(e,r)[n]:null;if("first"===t)return{node:e.firstChild??e};if("last"===t)return{node:e.lastChild??e};if("before"===t)return{node:e,before:!0};if("after"===t)return{node:e,after:!0};e=t}let{offset:i}=t[t.length-1];if(!Array.isArray(e))return{node:e,offset:i};let a=0;for(let t of e){let{length:e}=t.nodeValue;if(a+e>=i)return{node:t,offset:i-a};a+=e}},I=(e,t,r)=>{let{parentNode:n,id:i}=e,a=x(n,r),l=a.findIndex(t=>Array.isArray(t)?t.some(t=>t===e):t===e),s=a[l];if(Array.isArray(s)){let r=0;for(let n of s)if(n===e){r+=t;break}else r+=n.nodeValue.length;t=r}let o={id:i,index:l,offset:t};return(n!==e.ownerDocument.documentElement?I(n,null,r).concat(o):[o]).filter(e=>-1!==e.index)},D=(e,t)=>{let{startContainer:r,startOffset:n,endContainer:i,endOffset:a}=e,l=I(r,n,t);return e.collapsed?B([l]):A([l],[I(i,a,t)])},z=(e,t,r)=>{let n=E(t),i=E(t,!0),a=e.documentElement,l=_(a,n[0],r),s=_(a,i[0],r),o=e.createRange();return l.before?o.setStartBefore(l.node):l.after?o.setStartAfter(l.node):o.setStart(l.node,l.offset),s.before?o.setEndBefore(s.node):s.after?o.setEndAfter(s.node):o.setEnd(s.node,s.offset),o},P=e=>{let t=[],{parentNode:r}=e[0],n=I(r);for(let[i,a]of x(r).entries()){let r=e[t.length];a===r&&t.push(B([n.concat({id:r.id,index:i})]))}return t},j=(e,t)=>_(e.documentElement,E(t)).node,R={fromIndex:e=>u(`/6/${(e+1)*2}`),toIndex:e=>e?.at(-1).index/2-1},k=e=>{let[t]=w(e),r=t.shift();return t.shift(),B([[{index:6},r],t])},O=({spine_index:e,start_cfi:t,end_cfi:r})=>{let n=R.fromIndex(e)+"!";return A(n+t.slice(2),n+r.slice(2))}},40459:(e,t,r)=>{r.d(t,{Lg:()=>n,ub:()=>i});let n=(e,t,r)=>{let n=(e=JSON.parse(JSON.stringify(e))).viewSettings,i=e.searchConfig;return e.viewSettings=Object.entries(n).reduce((e,r)=>{let[n,i]=r;return t[n]!==i&&(e[n]=i),e},{}),e.searchConfig=Object.entries(i).reduce((e,t)=>{let[n,i]=t;return r[n]!==i&&(e[n]=i),e},{}),JSON.stringify(e)},i=(e,t,r)=>{var n;let i=JSON.parse(e),{viewSettings:a,searchConfig:l}=i;return i.viewSettings={...t,...a},i.searchConfig={...r,...l},null!=i.updatedAt||(i.updatedAt=Date.now()),i}},84797:(e,t,r)=>{r.d(t,{Pr:()=>i,Yw:()=>a});var n=r(97384);function i(e){return(0,n.md5)(e).slice(0,7)}async function a(e){let t=n.md5.create();for(let r=-1;r<=10;r++){let n=Math.min(e.size,1024<<2*r),i=Math.min(n+1024,e.size);if(n>=e.size)break;let a=e.slice(n,i),l=new Uint8Array(await a.arrayBuffer());t.update(l)}return t.hex()}},94074:(e,t,r)=>{r.d(t,{iY:()=>v,kY:()=>x,Yq:()=>j,v7:()=>k,qq:()=>z,ud:()=>I,QK:()=>R,Ef:()=>_,t7:()=>A,jk:()=>U,is:()=>T,fM:()=>F,An:()=>B,df:()=>b,p$:()=>O,_T:()=>g,e7:()=>E,pX:()=>m,ow:()=>y,hM:()=>P,z1:()=>w});var n=r(23471),i=r(29803),a=r(19421),l=(r(10375),r(6588),r(49880),r(59686),r(57643));let s=l.env.S3_ENDPOINT||"",o=l.env.S3_REGION||"auto",f=l.env.S3_ACCESS_KEY_ID||"",u=l.env.S3_SECRET_ACCESS_KEY||"";new a.Y({forcePathStyle:!0,region:o,endpoint:s,credentials:{accessKeyId:f,secretAccessKey:u}}),r(9865),r(57643);var c=r(57643);let d=()=>c.env.NEXT_PUBLIC_OBJECT_STORAGE_TYPE?c.env.NEXT_PUBLIC_OBJECT_STORAGE_TYPE:"r2";var h=r(10279),p=r(64371);let g=e=>"".concat(e.hash),m=()=>"library.json",w=e=>"r2"===d()?"".concat(e.hash,"/").concat((0,i.Xw)(e.title),".").concat(n.Rg[e.format]):"s3"===d()?"".concat(e.hash,"/").concat(e.hash,".").concat(n.Rg[e.format]):"",y=e=>"".concat(e.hash,"/").concat((0,i.Xw)(e.title),".").concat(n.Rg[e.format]),b=e=>"".concat(e.hash,"/cover.png"),B=e=>"".concat(e.hash,"/config.json"),E=e=>(((0,i.Gz)(e)||(0,i.em)(e))&&(e=decodeURI(e)),e.replace(/\\/g,"/").split("/").pop().split("?")[0]),A=e=>{var t;return(null==(t=e.replace(/\\/g,"/").split("/").pop())?void 0:t.split(".").slice(0,-1).join("."))||""},v={updatedAt:0},C=e=>{let t=(0,i.gl)();if(!e)return"";if("string"==typeof e)return e;let r=Object.keys(e);return e[t]||e[r[0]]},S=function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return(t=t||(0,i.gl)(),e)?new Intl.ListFormat("en",{style:"narrow",type:"unit"}):new Intl.ListFormat(t,{style:"long",type:"conjunction"})},F=e=>{try{let t="string"==typeof e?e:null==e?void 0:e[0];return t?t.split("-")[0]:""}catch(e){return""}},x=(e,t)=>{let r=F(t)||"en";return Array.isArray(e)?S("zh"===r,r).format(e.map(e=>"string"==typeof e?e:C(null==e?void 0:e.name))):"string"==typeof e?e:C(null==e?void 0:e.name)},_=e=>"string"==typeof e?e:C(e),I=e=>"string"==typeof e?e:C(e),D=e=>p.Lq[e]||e.toUpperCase(),z=e=>Array.isArray(e)?e.map(D).join(", "):D(e||""),P=e=>Array.isArray(e)?e[0]:e,j=e=>{if(!e)return;let t=(0,i.gl)();try{return new Date(e).toLocaleDateString(t,{year:"numeric",month:"long",day:"numeric"})}catch(e){return}},R=e=>e?Array.isArray(e)?e.join(", "):e:"",k=e=>null===e?"":new Intl.NumberFormat("en",{style:"unit",unit:"byte",unitDisplay:"narrow",notation:"compact",compactDisplay:"short"}).format(e),O=(e,t)=>{let r=e.format,{section:n,pageinfo:i}=t;return"PDF"===r?n?n.current+1:0:i?i.current+1:0},T=e=>{switch(e){case"horizontal-tb":return"ltr";case"horizontal-rl":case"vertical-rl":return"rtl";default:return"auto"}},U=e=>{let t=P(e)||"";return(0,h.i)(t)}}}]);