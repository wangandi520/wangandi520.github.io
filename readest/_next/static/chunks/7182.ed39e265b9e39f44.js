"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7182],{77182:(e,t,i)=>{i.r(t),i.d(t,{NotFoundError:()=>T,ResponseError:()=>P,UnsupportedTypeError:()=>k,View:()=>I,makeBook:()=>F});var s=i(28377);let r=e=>{let t=0,i=e=>{if(e.id=t++,e.subitems)for(let t of e.subitems)i(t)};for(let t of e)i(t);return e},n=e=>e.map(e=>e.subitems?.length?[e,n(e.subitems)].flat():e).flat();class a{async init({toc:e,ids:t,splitHref:i,getFragment:s}){r(e);let a=n(e),o=new Map;for(let[e,t]of a.entries()){let[s,r]=await i(t?.href)??[],n={fragment:r,item:t};o.has(s)?o.get(s).items.push(n):o.set(s,{prev:a[e-1],items:[n]})}let l=new Map;for(let[e,i]of t.entries())o.has(i)?l.set(i,o.get(i)):l.set(i,l.get(t[e-1]));this.ids=t,this.map=l,this.getFragment=s}getProgress(e,t){if(!this.ids)return;let i=this.ids[e],s=this.map.get(i);if(!s)return null;let{prev:r,items:n}=s;if(!n)return r;if(!t||1===n.length&&!n[0].fragment)return n[0].item;let a=t.startContainer.getRootNode();for(let[e,{fragment:i}]of n.entries()){let s=this.getFragment(a,i);if(s&&t.comparePoint(s,0)>0)return n[e-1]?.item??r}return n[n.length-1].item}}class o{constructor(e,t,i){this.sizes=e.map(e=>"no"!=e.linear&&e.size>0?e.size:0),this.sizePerLoc=t,this.sizePerTimeUnit=i,this.sizeTotal=this.sizes.reduce((e,t)=>e+t,0),this.sectionFractions=this.#e()}#e(){let{sizeTotal:e}=this,t=[0],i=0;for(let s of this.sizes)t.push((i+=s)/e);return t}getProgress(e,t,i=0){let{sizes:s,sizePerLoc:r,sizePerTimeUnit:n,sizeTotal:a}=this,o=s[e]??0,l=s.slice(0,e).reduce((e,t)=>e+t,0)+t*o,h=l+i*o;return{fraction:h/a,section:{current:e,total:s.length},location:{current:Math.floor(l/r),next:Math.floor(h/r),total:Math.ceil(a/r)},time:{section:(1-t)*o/n,total:(a-l)/n}}}getSection(e){if(e<=0)return[0,0];if(e>=1)return[this.sizes.length-1,1];e+=Number.EPSILON;let{sizeTotal:t}=this,i=this.sectionFractions.findIndex(t=>t>e)-1;if(i<0)return[0,0];for(;!this.sizes[i];)i++;let s=(e-this.sectionFractions[i])/(this.sizes[i]/t);return[i,s]}}var l=i(50776);let h=(e,t)=>{let i=[];for(let s=t.currentNode;s;s=t.nextNode()){let t=e.comparePoint(s,0);if(0===t)i.push(s);else if(t>0)break}return i},c=(e,t)=>{let i=[];for(let e=t.nextNode();e;e=t.nextNode())i.push(e);return i},d=NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT|NodeFilter.SHOW_CDATA_SECTION,u=e=>{if(1===e.nodeType){let t=e.tagName.toLowerCase();return"script"===t||"style"===t?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_SKIP}return NodeFilter.FILTER_ACCEPT},g=function*(e,t,i){let s=e.commonAncestorContainer??e.body??e,r=document.createTreeWalker(s,d,{acceptNode:i||u}),n=(e.commonAncestorContainer?h:c)(e,r);for(let e of t(n.map(e=>e.nodeValue??""),(e,t,i,s)=>{let r=document.createRange();return r.setStart(n[e],t),r.setEnd(n[i],s),r}))yield e},f="foliate-search:",m=async e=>{let t=new Uint8Array(await e.slice(0,4).arrayBuffer());return 80===t[0]&&75===t[1]&&3===t[2]&&4===t[3]},w=async e=>{let t=new Uint8Array(await e.slice(0,5).arrayBuffer());return 37===t[0]&&80===t[1]&&68===t[2]&&70===t[3]&&45===t[4]},p=({name:e,type:t})=>"application/vnd.comicbook+zip"===t||e.endsWith(".cbz"),y=({name:e,type:t})=>"application/x-fictionbook+xml"===t||e.endsWith(".fb2"),v=({name:e,type:t})=>"application/x-zip-compressed-fb2"===t||e.endsWith(".fb2.zip")||e.endsWith(".fbz"),b=async e=>{let{configure:t,ZipReader:s,BlobReader:r,TextWriter:n,BlobWriter:a}=await i.e(9023).then(i.bind(i,9023));t({useWebWorkers:!1});let o=new s(new r(e)),l=await o.getEntries(),h=new Map(l.map(e=>[e.filename,e])),c=e=>(t,...i)=>h.has(t)?e(h.get(t),...i):null,d=c(e=>e.getData(new n));return{entries:l,loadText:d,loadBlob:c((e,t)=>e.getData(new a(t))),getSize:e=>h.get(e)?.uncompressedSize??0}},x=async e=>e.isFile?e:(await Promise.all(Array.from(await new Promise((t,i)=>e.createReader().readEntries(e=>t(e),e=>i(e))),x))).flat(),E=async e=>{let t=await x(e),i=new Map((await Promise.all(t.map(e=>new Promise((t,i)=>e.file(i=>t([i,e.fullPath]),e=>i(e)))))).map(([t,i])=>[i.replace(e.fullPath+"/",""),t])),s=new TextDecoder,r=e=>e?s.decode(e):null,n=e=>i.get(e)?.arrayBuffer()??null;return{loadText:async e=>r(await n(e)),loadBlob:e=>i.get(e),getSize:e=>i.get(e)?.size??0}};class P extends Error{}class T extends Error{}class k extends Error{}let C=async e=>{let t=await fetch(e);if(!t.ok)throw new P(`${t.status} ${t.statusText}`,{cause:t});return new File([await t.blob()],new URL(t.url).pathname)},F=async e=>{let t;if("string"==typeof e&&(e=await C(e)),e.isDirectory){let s=await E(e),{EPUB:r}=await i.e(5935).then(i.bind(i,65935));t=await new r(s).init()}else if(e.size)if(await m(e)){let s=await b(e);if(p(e)){let{makeComicBook:r}=await i.e(6040).then(i.bind(i,76040));t=r(s,e)}else if(v(e)){let{makeFB2:e}=await i.e(2189).then(i.bind(i,62189)),{entries:r}=s,n=r.find(e=>e.filename.endsWith(".fb2")),a=await s.loadBlob((n??r[0]).filename);t=await e(a)}else{let{EPUB:e}=await i.e(5935).then(i.bind(i,65935));t=await new e(s).init()}}else if(await w(e)){let{makePDF:s}=await i.e(8031).then(i.bind(i,38031));t=await s(e)}else{let{isMOBI:s,MOBI:r}=await i.e(2200).then(i.bind(i,42200));if(await s(e)){let s=await i.e(3352).then(i.bind(i,33352));t=await new r({unzlib:s.unzlibSync}).open(e)}else if(y(e)){let{makeFB2:s}=await i.e(2189).then(i.bind(i,62189));t=await s(e)}}else throw new T("File not found");if(!t)throw new k("File type not supported");return t};class L{#t;#i;#s;#r;constructor(e,t,i={}){this.#i=e,this.#s=t,this.#r=i,this.#r.hidden&&this.hide(),this.#i.addEventListener("mousemove",({screenX:e,screenY:i})=>{(e!==this.#r.x||i!==this.#r.y)&&(this.#r.x=e,this.#r.y=i,this.show(),this.#t&&clearTimeout(this.#t),t()&&(this.#t=setTimeout(this.hide.bind(this),1e3)))},!1)}cloneFor(e){return new L(e,this.#s,this.#r)}hide(){this.#i.style.cursor="none",this.#r.hidden=!0}show(){this.#i.style.removeProperty("cursor"),this.#r.hidden=!1}}class S extends EventTarget{#n=[];#a=-1;pushState(e){let t=this.#n[this.#a];t===e||t?.fraction&&t.fraction===e.fraction||(this.#n[++this.#a]=e,this.#n.length=this.#a+1,this.dispatchEvent(new Event("index-change")))}replaceState(e){let t=this.#a;this.#n[t]=e}back(){let e=this.#a;if(e<=0)return;let t={state:this.#n[e-1]};this.#a=e-1,this.dispatchEvent(new CustomEvent("popstate",{detail:t})),this.dispatchEvent(new Event("index-change"))}forward(){let e=this.#a;if(e>=this.#n.length-1)return;let t={state:this.#n[e+1]};this.#a=e+1,this.dispatchEvent(new CustomEvent("popstate",{detail:t})),this.dispatchEvent(new Event("index-change"))}get canGoBack(){return this.#a>0}get canGoForward(){return this.#a<this.#n.length-1}clear(){this.#n=[],this.#a=-1}}let N=e=>{if(!e)return{};try{let t=Intl.getCanonicalLocales(e)[0],i=new Intl.Locale(t),s=["zh","ja","kr"].includes(i.language),r=(i.getTextInfo?.()??i.textInfo)?.direction;return{canonical:t,locale:i,isCJK:s,direction:r}}catch(e){return console.warn(e),{}}};class I extends HTMLElement{#o=this.attachShadow({mode:"open"});#l;#h;#c;#d=new Map;#u=new L(this,()=>this.hasAttribute("autohide-cursor"));isFixedLayout=!1;lastLocation;history=new S;constructor(){super(),this.history.addEventListener("popstate",({detail:e})=>{let t=this.resolveNavigation(e.state);this.renderer.goTo(t)})}async open(e){if(("string"==typeof e||"function"==typeof e.arrayBuffer||e.isDirectory)&&(e=await F(e)),this.book=e,this.language=N(e.metadata?.language),e.splitTOCHref&&e.getTOCFragment){let t=e.sections.map(e=>e.id);this.#l=new o(e.sections,1500,1600);let i=e.splitTOCHref.bind(e),s=e.getTOCFragment.bind(e);this.#h=new a,await this.#h.init({toc:e.toc??[],ids:t,splitHref:i,getFragment:s}),this.#c=new a,await this.#c.init({toc:e.pageList??[],ids:t,splitHref:i,getFragment:s})}if(this.isFixedLayout=this.book.rendition?.layout==="pre-paginated",this.isFixedLayout?(await i.e(8246).then(i.bind(i,58246)),this.renderer=document.createElement("foliate-fxl")):(await i.e(7216).then(i.bind(i,27216)),this.renderer=document.createElement("foliate-paginator")),this.renderer.setAttribute("exportparts","head,foot,filter,container"),this.renderer.addEventListener("load",e=>this.#g(e.detail)),this.renderer.addEventListener("relocate",e=>this.#f(e.detail)),this.renderer.addEventListener("create-overlayer",e=>e.detail.attach(this.#m(e.detail))),this.renderer.open(e),this.#o.append(this.renderer),e.sections.some(e=>e.mediaOverlay)){let t,i=e.media.activeClass,s=e.media.playbackActiveClass;this.mediaOverlay=e.getMediaOverlay(),this.mediaOverlay.addEventListener("highlight",e=>{let r=this.resolveNavigation(e.detail.text);this.renderer.goTo(r).then(()=>{let{doc:e}=this.renderer.getContents().find(e=>e.index=r.index),n=r.anchor(e);n.classList.add(i),s&&n.ownerDocument.documentElement.classList.add(s),t=new WeakRef(n)})}),this.mediaOverlay.addEventListener("unhighlight",()=>{let e=t?.deref();e&&(e.classList.remove(i),s&&e.ownerDocument.documentElement.classList.remove(s))})}}close(){this.renderer?.destroy(),this.renderer?.remove(),this.#l=null,this.#h=null,this.#c=null,this.#d=new Map,this.lastLocation=null,this.history.clear(),this.tts=null,this.mediaOverlay=null}goToTextStart(){return this.goTo(this.book.landmarks?.find(e=>e.type.includes("bodymatter")||e.type.includes("text"))?.href??this.book.sections.findIndex(e=>"no"!==e.linear))}async init({lastLocation:e,showTextStart:t}){let i=e?this.resolveNavigation(e):null;i?(await this.renderer.goTo(i),this.history.pushState(e)):t?await this.goToTextStart():(this.history.pushState(0),await this.next())}#w(e,t,i){return this.dispatchEvent(new CustomEvent(e,{detail:t,cancelable:i}))}#f({reason:e,range:t,index:i,fraction:s,size:r}){let n=this.#l?.getProgress(i,s,r)??{},a=this.#h?.getProgress(i,t),o=this.#c?.getProgress(i,t),l=this.getCFI(i,t);this.lastLocation={...n,tocItem:a,pageItem:o,cfi:l,range:t},("snap"===e||"page"===e||"scroll"===e)&&this.history.replaceState(l),this.#w("relocate",this.lastLocation)}#g({doc:e,index:t}){e.documentElement.lang||=this.language.canonical??"",this.language.isCJK||(e.documentElement.dir||=this.language.direction??""),this.#p(e,t),this.#u.cloneFor(e.documentElement),this.#w("load",{doc:e,index:t})}#p(e,t){let{book:i}=this,s=i.sections[t];e.addEventListener("click",e=>{let t=e.target.closest("a[href]");if(!t)return;e.preventDefault();let r=t.getAttribute("href"),n=s?.resolveHref?.(r)??r;i?.isExternal?.(n)?Promise.resolve(this.#w("external-link",{a:t,href:n},!0)).then(e=>e?globalThis.open(n,"_blank"):null).catch(e=>console.error(e)):Promise.resolve(this.#w("link",{a:t,href:n},!0)).then(e=>e?this.goTo(n):null).catch(e=>console.error(e))})}async addAnnotation(e,t){let{value:i}=e;if(i.startsWith(f)){let e=i.replace(f,""),{index:s,anchor:r}=await this.resolveNavigation(e),n=this.#y(s);if(n){let{overlayer:e,doc:s}=n;if(t)return void e.remove(i);let a=s?r(s):r;e.add(i,a,l.u.outline)}return}let{index:s,anchor:r}=await this.resolveNavigation(i),n=this.#y(s);if(n){let{overlayer:s,doc:a}=n;if(s.remove(i),!t){let t=a?r(a):r;this.#w("draw-annotation",{draw:(e,r)=>s.add(i,t,e,r),annotation:e,doc:a,range:t})}}let a=this.#h.getProgress(s)?.label??"";return{index:s,label:a}}deleteAnnotation(e){return this.addAnnotation(e,!0)}#y(e){return this.renderer.getContents().find(t=>t.index===e&&t.overlayer)}#m({doc:e,index:t}){let i=new l.u(e);e.addEventListener("click",e=>{let[s,r]=i.hitTest(e);s&&!s.startsWith(f)&&this.#w("show-annotation",{value:s,index:t,range:r})},!1);let s=this.#d.get(t);if(s)for(let e of s)this.addAnnotation(e);return this.#w("create-overlay",{index:t}),i}async showAnnotation(e){let{value:t}=e,i=await this.goTo(t);if(i){let{index:e,anchor:s}=i,{doc:r}=this.#y(e),n=s(r);this.#w("show-annotation",{value:t,index:e,range:n})}}getCFI(e,t){let i=this.book.sections[e].cfi??s.fake.fromIndex(e);return t?s.joinIndir(i,s.fromRange(t)):i}resolveCFI(e){if(this.book.resolveCFI)return this.book.resolveCFI(e);{let t=s.parse(e);return{index:s.fake.toIndex((t.parent??t).shift()),anchor:e=>s.toRange(e,t)}}}resolveNavigation(e){try{if("number"==typeof e)return{index:e};if("number"==typeof e.fraction){let[t,i]=this.#l.getSection(e.fraction);return{index:t,anchor:i}}if(s.isCFI.test(e))return this.resolveCFI(e);return this.book.resolveHref(e)}catch(t){console.error(t),console.error(`Could not resolve target ${e}`)}}async goTo(e){let t=this.resolveNavigation(e);try{return await this.renderer.goTo(t),this.history.pushState(e),t}catch(t){console.error(t),console.error(`Could not go to ${e}`)}}async goToFraction(e){let[t,i]=this.#l.getSection(e);await this.renderer.goTo({index:t,anchor:i}),this.history.pushState({fraction:e})}async select(e){try{let t=await this.resolveNavigation(e);await this.renderer.goTo({...t,select:!0}),this.history.pushState(e)}catch(t){console.error(t),console.error(`Could not go to ${e}`)}}deselect(){for(let{doc:e}of this.renderer.getContents())e.defaultView.getSelection().removeAllRanges()}getSectionFractions(){return(this.#l?.sectionFractions??[]).map(e=>e+Number.EPSILON)}getProgressOf(e,t){return{tocItem:this.#h?.getProgress(e,t),pageItem:this.#c?.getProgress(e,t)}}async getTOCItemOf(e){try{let{index:t,anchor:i}=await this.resolveNavigation(e),s=await this.book.sections[t].createDocument(),r=i(s),n=r instanceof Range,a=n?r:s.createRange();return n||a.selectNodeContents(r),this.#h.getProgress(t,a)}catch(t){console.error(t),console.error(`Could not get ${e}`)}}async prev(e){await this.renderer.prev(e)}async next(e){await this.renderer.next(e)}goLeft(){return"rtl"===this.book.dir?this.next():this.prev()}goRight(){return"rtl"===this.book.dir?this.prev():this.next()}async *#v(e,t,i){for(let{range:s,excerpt:r}of e(await this.book.sections[i].createDocument(),t))yield{cfi:this.getCFI(i,s),excerpt:r}}async *#b(e,t){let{sections:i}=this.book;for(let[s,{createDocument:r}]of i.entries()){if(!r)continue;let n=Array.from(e(await r(),t),({range:e,excerpt:t})=>({cfi:this.getCFI(s,e),excerpt:t})),a=(s+1)/i.length;yield{progress:a},n.length&&(yield{index:s,subitems:n})}}async *search(e){this.clearSearch();let{searchMatcher:t}=await i.e(681).then(i.bind(i,20681)),{query:s,index:r}=e,n=t(g,{defaultLocale:this.language,...e}),a=null!=r?this.#v(n,s,r):this.#b(n,s),o=[];for await(let e of(this.#d.set(r,o),a))if(e.subitems){let t=e.subitems.map(({cfi:e})=>({value:f+e}));for(let i of(this.#d.set(e.index,t),t))this.addAnnotation(i);yield{label:this.#h.getProgress(e.index)?.label??"",subitems:e.subitems}}else{if(e.cfi){let t={value:f+e.cfi};o.push(t),this.addAnnotation(t)}yield e}yield"done"}clearSearch(){for(let e of this.#d.values())for(let t of e)this.deleteAnnotation(t);this.#d.clear()}async initTTS(e="word"){let t=this.renderer.getContents()[0].doc;if(this.tts&&this.tts.doc===t)return;let{TTS:s}=await i.e(6550).then(i.bind(i,26550));this.tts=new s(t,g,e=>this.renderer.scrollToAnchor(e,!0),e)}startMediaOverlay(){let{index:e}=this.renderer.getContents()[0];return this.mediaOverlay.start(e)}}customElements.define("foliate-view",I)}}]);