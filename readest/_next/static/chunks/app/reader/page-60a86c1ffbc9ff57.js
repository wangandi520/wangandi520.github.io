(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4804,9743],{3189:(e,t,n)=>{"use strict";n.d(t,{HY:()=>c,Rg:()=>d,u6:()=>h,xb:()=>u});var a,l,s,i,r=n(84648),o=n(47868);null!=(a=Object).groupBy||(a.groupBy=(e,t)=>{let n=Object.create(null),a=0;for(let l of e){let e=t(l,a++);e in n?n[e].push(l):n[e]=[l]}return n}),null!=(l=Map).groupBy||(l.groupBy=(e,t)=>{let n=new Map,a=0;for(let l of e){let e=t(l,a++),s=n.get(e);s?s.push(l):n.set(e,[l])}return n});let c=o,d={EPUB:"epub",PDF:"pdf",MOBI:"mobi",CBZ:"cbz",FB2:"fb2",FBZ:"fbz"};class u{async isZip(){let e=new Uint8Array(await this.file.slice(0,4).arrayBuffer());return 80===e[0]&&75===e[1]&&3===e[2]&&4===e[3]}async isPDF(){let e=new Uint8Array(await this.file.slice(0,5).arrayBuffer());return 37===e[0]&&80===e[1]&&68===e[2]&&70===e[3]&&45===e[4]}async makeZipLoader(){let e=async()=>{let e=Math.min(65536,this.file.size),t=new Uint8Array(await this.file.slice(this.file.size-e,this.file.size).arrayBuffer());for(let e=t.length-22;e>=0;e--)if(80===t[e]&&75===t[e+1]&&5===t[e+2]&&6===t[e+3]){let n=t[e+20]+(t[e+21]<<8),a=e+22,l=t.slice(a,a+n);return new TextDecoder().decode(l)}return null},{configure:t,ZipReader:a,BlobReader:l,TextWriter:s,BlobWriter:i}=await n.e(2363).then(n.bind(n,92363));t({useWebWorkers:!1});let r=new a(new l(this.file)),o=await r.getEntries(),c=new Map(o.map(e=>[e.filename,e])),d=e=>function(t){for(var n=arguments.length,a=Array(n>1?n-1:0),l=1;l<n;l++)a[l-1]=arguments[l];return c.has(t)?e(c.get(t),...a):null},u=d(e=>e.getData?e.getData(new s):null);return{entries:o,loadText:u,loadBlob:d((e,t)=>e.getData?e.getData(new i(t)):null),getSize:e=>{var t,n;return null!=(n=null==(t=c.get(e))?void 0:t.uncompressedSize)?n:0},getComment:e,sha1:void 0}}isCBZ(){return"application/vnd.comicbook+zip"===this.file.type||this.file.name.endsWith(".".concat(d.CBZ))}isFB2(){return"application/x-fictionbook+xml"===this.file.type||this.file.name.endsWith(".".concat(d.FB2))}isFBZ(){return"application/x-zip-compressed-fb2"===this.file.type||this.file.name.endsWith(".fb2.zip")||this.file.name.endsWith(".".concat(d.FBZ))}async open(){let{allowScript:e=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=null,a="EPUB";if(!this.file.size)throw Error("File is empty");if(await this.isZip()){let l=await this.makeZipLoader(),{entries:s}=l;if(this.isCBZ()){let{makeComicBook:e}=await n.e(8531).then(n.bind(n,28531));t=await e(l,this.file),a="CBZ"}else if(this.isFBZ()){let e=s.find(e=>e.filename.endsWith(".".concat(d.FB2))),i=await l.loadBlob((null!=e?e:s[0]).filename),{makeFB2:r}=await n.e(5796).then(n.bind(n,5796));t=await r(i),a="FBZ"}else{let{EPUB:s}=await Promise.all([n.e(4300),n.e(8052)]).then(n.bind(n,44300));t=await new s(l).init({allowScript:e}),a="EPUB"}}else if(await this.isPDF()){let{makePDF:e}=await Promise.all([n.e(8189),n.e(5671)]).then(n.bind(n,38189));t=await e(this.file),a="PDF"}else if(await (await Promise.all([n.e(9867),n.e(3290)]).then(n.bind(n,59867))).isMOBI(this.file)){let e=await n.e(9393).then(n.bind(n,19393)),{MOBI:l}=await Promise.all([n.e(9867),n.e(3290)]).then(n.bind(n,59867));t=await new l({unzlib:e.unzlibSync}).open(this.file),a="MOBI"}else if(this.isFB2()){let{makeFB2:e}=await n.e(5796).then(n.bind(n,5796));t=await e(this.file),a="FB2"}return{book:t,format:a}}constructor(e){(0,r._)(this,"file",void 0),this.file=e}}let h=e=>{let{defaultView:t}=e,{writingMode:n,direction:a}=t.getComputedStyle(e.body);return{vertical:"vertical-rl"===n||"vertical-lr"===n,rtl:"rtl"===e.body.dir||"rtl"===a||"rtl"===e.documentElement.dir}}},35913:(e,t,n)=>{"use strict";n.d(t,{u:()=>f});var a=n(96261),l=n(89657),s=n(49033),i=n(19780),r=n(25842);let o=e=>document.createElementNS("http://www.w3.org/2000/svg",e);var c=new WeakMap,d=new WeakMap,u=new WeakMap,h=new WeakMap,m=new WeakSet;class f{get element(){return(0,a._)(this,c)}add(e,t,n,l){(0,a._)(this,d).has(e)&&this.remove(e),"function"==typeof t&&(t=t((0,a._)(this,c).getRootNode()));let s=(0,a._)(this,h),r=[];(0,i._)(this,m,g).call(this,t).forEach(e=>{let t=Array.from(e.getClientRects()).map(e=>({left:e.left*s,top:e.top*s,right:e.right*s,bottom:e.bottom*s,width:e.width*s,height:e.height*s}));r=r.concat(t)});let o=n(r,l);(0,a._)(this,c).append(o),(0,a._)(this,d).set(e,{range:t,draw:n,options:l,element:o,rects:r})}remove(e){(0,a._)(this,d).has(e)&&((0,a._)(this,c).removeChild((0,a._)(this,d).get(e).element),(0,a._)(this,d).delete(e))}redraw(){for(let e of(0,a._)(this,d).values()){let{range:t,draw:n,options:l,element:s}=e;(0,a._)(this,c).removeChild(s);let r=(0,a._)(this,h),o=[];(0,i._)(this,m,g).call(this,t).forEach(e=>{let t=Array.from(e.getClientRects()).map(e=>({left:e.left*r,top:e.top*r,right:e.right*r,bottom:e.bottom*r,width:e.width*r,height:e.height*r}));o=o.concat(t)});let d=n(o,l);(0,a._)(this,c).append(d),e.element=d,e.rects=o}}hitTest(e){let{x:t,y:n}=e,l=Array.from((0,a._)(this,d).entries());for(let e=l.length-1;e>=0;e--){let[a,s]=l[e];for(let{left:e,top:l,right:i,bottom:r}of s.rects)if(l<=n&&e<=t&&r>n&&i>t)return[a,s.range]}return[]}static underline(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{color:n="red",width:a=2,padding:l=0,writingMode:s}=t,i=o("g");if(i.setAttribute("fill",n),"vertical-rl"===s||"vertical-lr"===s)for(let{right:t,top:n,height:s}of e){let e=o("rect");e.setAttribute("x",t-a/2+l),e.setAttribute("y",n),e.setAttribute("height",s),e.setAttribute("width",a),i.append(e)}else for(let{left:t,bottom:n,width:s}of e){let e=o("rect");e.setAttribute("x",t),e.setAttribute("y",n-a/2+l),e.setAttribute("height",a),e.setAttribute("width",s),i.append(e)}return i}static strikethrough(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{color:n="red",width:a=2,writingMode:l}=t,s=o("g");if(s.setAttribute("fill",n),"vertical-rl"===l||"vertical-lr"===l)for(let{right:t,left:n,top:l,height:i}of e){let e=o("rect");e.setAttribute("x",(t+n)/2),e.setAttribute("y",l),e.setAttribute("height",i),e.setAttribute("width",a),s.append(e)}else for(let{left:t,top:n,bottom:l,width:i}of e){let e=o("rect");e.setAttribute("x",t),e.setAttribute("y",(n+l)/2),e.setAttribute("height",a),e.setAttribute("width",i),s.append(e)}return s}static squiggly(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{color:n="red",width:a=2,padding:l=0,writingMode:s}=t,i=o("g");i.setAttribute("fill","none"),i.setAttribute("stroke",n),i.setAttribute("stroke-width",a);let r=1.5*a;if("vertical-rl"===s||"vertical-lr"===s)for(let{right:t,top:n,height:s}of e){let e=o("path"),c=Math.round(s/r/1.5),d=s/c,u=Array.from({length:c},(e,t)=>"l".concat(t%2?-r:r," ").concat(d)).join("");e.setAttribute("d","M".concat(t-a/2+l," ").concat(n).concat(u)),i.append(e)}else for(let{left:t,bottom:n,width:s}of e){let e=o("path"),c=Math.round(s/r/1.5),d=s/c,u=Array.from({length:c},(e,t)=>"l".concat(d," ").concat(t%2?r:-r)).join("");e.setAttribute("d","M".concat(t," ").concat(n+a/2+l).concat(u)),i.append(e)}return i}static highlight(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{color:n="red",padding:a=0}=t,l=o("g");for(let{left:t,top:s,height:i,width:r}of(l.setAttribute("fill",n),l.style.opacity="var(--overlayer-highlight-opacity, .3)",l.style.mixBlendMode="var(--overlayer-highlight-blend-mode, normal)",e)){let e=o("rect");e.setAttribute("x",t-a),e.setAttribute("y",s-a),e.setAttribute("height",i+2*a),e.setAttribute("width",r+2*a),l.append(e)}return l}static outline(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{color:n="red",width:a=3,padding:l=0,radius:s=3}=t,i=o("g");for(let{left:t,top:r,height:c,width:d}of(i.setAttribute("fill","none"),i.setAttribute("stroke",n),i.setAttribute("stroke-width",a),e)){let e=o("rect");e.setAttribute("x",t-l),e.setAttribute("y",r-l),e.setAttribute("height",c+2*l),e.setAttribute("width",d+2*l),e.setAttribute("rx",s),i.append(e)}return i}static copyImage(e){let[t]=e,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{src:a}=n,l=o("image"),{left:s,top:i,height:r,width:c}=t;return l.setAttribute("href",a),l.setAttribute("x",s),l.setAttribute("y",i),l.setAttribute("height",r),l.setAttribute("width",c),l}constructor(e){(0,l._)(this,h,{get:p,set:void 0}),(0,r._)(this,m),(0,l._)(this,c,{writable:!0,value:o("svg")}),(0,l._)(this,d,{writable:!0,value:new Map}),(0,l._)(this,u,{writable:!0,value:null}),(0,s._)(this,u,e),Object.assign((0,a._)(this,c).style,{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none"})}}function p(){return/^((?!chrome|android).)*AppleWebKit/i.test(navigator.userAgent)&&!window.chrome&&window.getComputedStyle((0,a._)(this,u).body).zoom||1}function g(e){var t;let n=e.commonAncestorContainer,a=Array.from((null==(t=n.querySelectorAll)?void 0:t.call(n,"p"))||[]);if(0===a.length)return[e];let l=[];return a.forEach(t=>{let n=document.createRange();e.intersectsNode(t)&&(n.selectNodeContents(t),0>n.compareBoundaryPoints(Range.START_TO_START,e)&&n.setStart(e.startContainer,e.startOffset),n.compareBoundaryPoints(Range.END_TO_END,e)>0&&n.setEnd(e.endContainer,e.endOffset),l.push(n))}),l}},36995:(e,t,n)=>{Promise.resolve().then(n.bind(n,98136))},45375:(e,t,n)=>{"use strict";n.d(t,{Pr:()=>s,Xu:()=>l,Yw:()=>i});var a=n(36261);function l(e){return/^[0-9a-f]{32}$/.test(e)}function s(e){return(0,a.md5)(e).slice(0,7)}async function i(e){let t=a.md5.create();for(let n=-1;n<=10;n++){let a=Math.min(e.size,1024<<2*n),l=Math.min(a+1024,e.size);if(a>=e.size)break;let s=e.slice(a,l),i=new Uint8Array(await s.arrayBuffer());t.update(i)}return t.hex()}},47868:(e,t,n)=>{"use strict";let a;n.r(t),n.d(t,{collapse:()=>y,compare:()=>N,fake:()=>R,fromCalibreHighlight:()=>_,fromCalibrePos:()=>P,fromElements:()=>I,fromRange:()=>L,isCFI:()=>o,joinIndir:()=>h,parse:()=>b,toElement:()=>B,toRange:()=>M});let l=(e,t)=>e.map((e,n,a)=>t(e,n,a)?n:null).filter(e=>null!=e),s=(e,t)=>[-1,...t,e.length].reduce((t,n)=>{var a;let{xs:l,a:s}=t;return{xs:null!=(a=null==l?void 0:l.concat([e.slice(s+1,n)]))?a:[],a:n}},{}).xs,i=(e,t)=>e.slice(0,-1).concat([e[e.length-1].concat(t[0])]).concat(t.slice(1)),r=/\d/,o=/^epubcfi\((.*)\)$/,c=e=>e.replace(/[\^[\](),;=]/g,"^$&"),d=e=>o.test(e)?e:"epubcfi(".concat(e,")"),u=e=>{var t,n;return null!=(n=null==(t=e.match(o))?void 0:t[1])?n:e},h=(a=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.join("!")},function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return"epubcfi(".concat(a(...t.map(e=>{var t,n;return null!=(n=null==(t=e.match(o))?void 0:t[1])?n:e})),")")}),m=e=>{let t=[],n,a,l="",s=e=>(t.push(e),n=null,l=""),i=e=>(l+=e,a=!1);for(let t of Array.from(e.trim()).concat("")){if("^"===t&&!a){a=!0;continue}if("!"===n)s(["!"]);else if(","===n)s([","]);else if("/"===n||":"===n)if(r.test(t)){i(t);continue}else s([n,parseInt(l)]);else if("~"===n)if(r.test(t)||"."===t){i(t);continue}else s(["~",parseFloat(l)]);else if("@"===n){if(":"===t){s(["@",parseFloat(l)]),n="@";continue}if(r.test(t)||"."===t){i(t);continue}s(["@",parseFloat(l)])}else if("["===n){";"!==t||a?","!==t||a?"]"!==t||a?i(t):s(["[",l]):(s(["[",l]),n="["):(s(["[",l]),n=";");continue}else if(null==n?void 0:n.startsWith(";")){"="!==t||a?";"!==t||a?"]"!==t||a?i(t):s([n,l]):(s([n,l]),n=";"):(n=";".concat(l),l="");continue}("/"===t||":"===t||"~"===t||"@"===t||"["===t||"!"===t||","===t)&&(n=t)}return t},f=(e,t)=>l(e,e=>{let[n]=e;return n===t}),p=e=>{let t,n=[];for(let[s,i]of e){if("/"===s)n.push({index:i});else{var a,l;let e=n[n.length-1];if(":"===s)e.offset=i;else if("~"===s)e.temporal=i;else if("@"===s)e.spatial=(null!=(a=e.spatial)?a:[]).concat(i);else if(";s"===s)e.side=i;else if("["===s)if("/"===t&&i)e.id=i;else{e.text=(null!=(l=e.text)?l:[]).concat(i);continue}}t=s}return n},g=e=>s(e,f(e,"!")).map(p),b=e=>{let t=m(u(e)),n=f(t,",");if(!n.length)return g(t);let[a,l,i]=s(t,n).map(g);return{parent:a,start:l,end:i}},x=e=>{var t,n;let{index:a,id:l,offset:s,temporal:i,spatial:r,text:o,side:d}=e,u=d?";s=".concat(d):"";return"/".concat(a)+(l?"[".concat(c(l)).concat(u,"]"):"")+(null!=s&&a%2?":".concat(s):"")+(i?"~".concat(i):"")+(r?"@".concat(r.join(":")):"")+(o||!l&&d?"["+(null!=(n=null==o||null==(t=o.map(c))?void 0:t.join(","))?n:"")+u+"]":"")},v=e=>e.parent?[e.parent,e.start,e.end].map(v).join(","):e.map(e=>e.map(x).join("")).join("!"),w=e=>d(v(e)),y=(e,t)=>"string"==typeof e?w(y(b(e),t)):e.parent?i(e.parent,e[t?"end":"start"]):e,j=(e,t)=>{"string"==typeof e&&(e=b(e)),"string"==typeof t&&(t=b(t)),e=y(e),t=y(t,!0);let n=e[e.length-1],a=t[t.length-1],l=[],s=[],i=[],r=!0,o=Math.max(n.length,a.length);for(let e=0;e<o;e++){let t=n[e],o=a[e];r&&(r=(null==t?void 0:t.index)===(null==o?void 0:o.index)&&!(null==t?void 0:t.offset)&&!(null==o?void 0:o.offset)),r?l.push(t):(t&&s.push(t),o&&i.push(o))}return w({parent:e.slice(0,-1).concat([l]),start:[s],end:[i]})},N=(e,t)=>{if("string"==typeof e&&(e=b(e)),"string"==typeof t&&(t=b(t)),e.start||t.start)return N(y(e),y(t))||N(y(e,!0),y(t,!0));for(let l=0;l<Math.max(e.length,t.length);l++){var n,a;let s=null!=(n=e[l])?n:[],i=null!=(a=t[l])?a:[],r=Math.max(s.length,i.length)-1;for(let e=0;e<=r;e++){let t=s[e],n=i[e];if(!t)return -1;if(!n||t.index>n.index)return 1;if(t.index<n.index)return -1;if(e===r){if(t.offset>n.offset)return 1;if(t.offset<n.offset)return -1}}}return 0},k=e=>{let{nodeType:t}=e;return 3===t||4===t},S=e=>{let{nodeType:t}=e;return 1===t},C=(e,t)=>{let n=Array.from(e.childNodes).filter(e=>k(e)||S(e));return t?n.map(e=>{let n=t(e);return n===NodeFilter.FILTER_REJECT?null:n===NodeFilter.FILTER_SKIP?C(e,t):e}).flat().filter(e=>e):n},A=(e,t)=>{let n=C(e,t).reduce((e,t)=>{let n=e[e.length-1];return n?k(t)?Array.isArray(n)?n.push(t):k(n)?e[e.length-1]=[n,t]:e.push(t):S(n)?e.push(null,t):e.push(t):e.push(t),e},[]);return S(n[0])&&n.unshift("first"),S(n[n.length-1])&&n.push("last"),n.unshift("before"),n.push("after"),n},E=(e,t,n)=>{let{id:a}=t[t.length-1];if(a){let t=e.ownerDocument.getElementById(a);if(t)return{node:t,offset:0}}for(let{index:a}of t){var l,s;let t=e?A(e,n)[a]:null;if("first"===t)return{node:null!=(l=e.firstChild)?l:e};if("last"===t)return{node:null!=(s=e.lastChild)?s:e};if("before"===t)return{node:e,before:!0};if("after"===t)return{node:e,after:!0};e=t}let{offset:i}=t[t.length-1];if(!Array.isArray(e))return{node:e,offset:i};let r=0;for(let t of e){let{length:e}=t.nodeValue;if(r+e>=i)return{node:t,offset:i-r};r+=e}},T=(e,t,n)=>{let{parentNode:a,id:l}=e,s=A(a,n),i=s.findIndex(t=>Array.isArray(t)?t.some(t=>t===e):t===e),r=s[i];if(Array.isArray(r)){let n=0;for(let a of r)if(a===e){n+=t;break}else n+=a.nodeValue.length;t=n}let o={id:l,index:i,offset:t};return(a!==e.ownerDocument.documentElement?T(a,null,n).concat(o):[o]).filter(e=>-1!==e.index)},L=(e,t)=>{let{startContainer:n,startOffset:a,endContainer:l,endOffset:s}=e,i=T(n,a,t);return e.collapsed?w([i]):j([i],[T(l,s,t)])},M=(e,t,n)=>{let a=y(t),l=y(t,!0),s=e.documentElement,i=E(s,a[0],n),r=E(s,l[0],n),o=e.createRange();return i.before?o.setStartBefore(i.node):i.after?o.setStartAfter(i.node):o.setStart(i.node,i.offset),r.before?o.setEndBefore(r.node):r.after?o.setEndAfter(r.node):o.setEnd(r.node,r.offset),o},I=e=>{let t=[],{parentNode:n}=e[0],a=T(n);for(let[l,s]of A(n).entries()){let n=e[t.length];s===n&&t.push(w([a.concat({id:n.id,index:l})]))}return t},B=(e,t)=>E(e.documentElement,y(t)).node,R={fromIndex:e=>d("/6/".concat((e+1)*2)),toIndex:e=>(null==e?void 0:e.at(-1).index)/2-1},P=e=>{let[t]=b(e),n=t.shift();return t.shift(),w([[{index:6},n],t])},_=e=>{let{spine_index:t,start_cfi:n,end_cfi:a}=e,l=R.fromIndex(t)+"!";return j(l+n.slice(2),l+a.slice(2))}},58529:(e,t,n)=>{"use strict";n.d(t,{iY:()=>N,kY:()=>A,Yq:()=>B,v7:()=>P,qq:()=>M,ud:()=>T,QK:()=>R,Ef:()=>E,t7:()=>j,jk:()=>z,is:()=>D,fM:()=>C,An:()=>w,df:()=>v,p$:()=>_,_T:()=>p,e7:()=>y,pX:()=>g,ow:()=>x,hM:()=>I,z1:()=>b,jR:()=>S});var a=n(3189),l=n(50981),s=n(59092),i=(n(99122),n(12049),n(53151),n(89008),n(79336));let r=i.env.S3_ENDPOINT||"",o=i.env.S3_REGION||"auto",c=i.env.S3_ACCESS_KEY_ID||"",d=i.env.S3_SECRET_ACCESS_KEY||"";new s.Y({forcePathStyle:!0,region:o,endpoint:r,credentials:{accessKeyId:c,secretAccessKey:d}}),n(97798),n(79336);var u=n(79336);let h=()=>u.env.NEXT_PUBLIC_OBJECT_STORAGE_TYPE?u.env.NEXT_PUBLIC_OBJECT_STORAGE_TYPE:"r2";var m=n(91225),f=n(40965);let p=e=>"".concat(e.hash),g=()=>"library.json",b=e=>"r2"===h()?"".concat(e.hash,"/").concat((0,l.Xw)(e.title),".").concat(a.Rg[e.format]):"s3"===h()?"".concat(e.hash,"/").concat(e.hash,".").concat(a.Rg[e.format]):"",x=e=>"".concat(e.hash,"/").concat((0,l.Xw)(e.title),".").concat(a.Rg[e.format]),v=e=>"".concat(e.hash,"/cover.png"),w=e=>"".concat(e.hash,"/config.json"),y=e=>(((0,l.Gz)(e)||(0,l.em)(e))&&(e=decodeURI(e)),e.replace(/\\/g,"/").split("/").pop().split("?")[0]),j=e=>{var t;return(null==(t=e.replace(/\\/g,"/").split("/").pop())?void 0:t.split(".").slice(0,-1).join("."))||""},N={updatedAt:0},k=e=>{let t=(0,l.gl)();if(!e)return"";if("string"==typeof e)return e;let n=Object.keys(e);return e[t]||e[n[0]]},S=function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return(t=t||(0,l.gl)(),e)?new Intl.ListFormat("en",{style:"narrow",type:"unit"}):new Intl.ListFormat(t,{style:"long",type:"conjunction"})},C=e=>{try{let t="string"==typeof e?e:null==e?void 0:e[0];return t?t.split("-")[0]:""}catch(e){return""}},A=(e,t)=>{let n=C(t)||"en";return Array.isArray(e)?S("zh"===n,n).format(e.map(e=>"string"==typeof e?e:k(null==e?void 0:e.name))):"string"==typeof e?e:k(null==e?void 0:e.name)},E=e=>"string"==typeof e?e:k(e),T=e=>"string"==typeof e?e:k(e),L=e=>f.Lq[e]||e.toUpperCase(),M=e=>Array.isArray(e)?e.map(L).join(", "):L(e||""),I=e=>Array.isArray(e)?e[0]:e,B=e=>{if(!e)return;let t=(0,l.gl)();try{return new Date(e).toLocaleDateString(t,{year:"numeric",month:"long",day:"numeric"})}catch(e){return}},R=e=>e?Array.isArray(e)?e.join(", "):e:"",P=e=>null===e?"":new Intl.NumberFormat("en",{style:"unit",unit:"byte",unitDisplay:"narrow",notation:"compact",compactDisplay:"short"}).format(e),_=(e,t)=>{let n=e.format,{section:a,pageinfo:l}=t;return"PDF"===n?a?a.current+1:0:l?l.current+1:0},D=e=>{switch(e){case"horizontal-tb":return"ltr";case"horizontal-rl":case"vertical-rl":return"rtl";default:return"auto"}},z=e=>{let t=I(e)||"";return(0,m.i)(t)}},72997:(e,t,n)=>{"use strict";n.d(t,{Lg:()=>a,ub:()=>l});let a=(e,t,n)=>{let a=(e=JSON.parse(JSON.stringify(e))).viewSettings,l=e.searchConfig;return e.viewSettings=Object.entries(a).reduce((e,n)=>{let[a,l]=n;return t[a]!==l&&(e[a]=l),e},{}),e.searchConfig=Object.entries(l).reduce((e,t)=>{let[a,l]=t;return n[a]!==l&&(e[a]=l),e},{}),JSON.stringify(e)},l=(e,t,n)=>{var a;let l=JSON.parse(e),{viewSettings:s,searchConfig:i}=l;return l.viewSettings={...t,...s},l.searchConfig={...n,...i},null!=l.updatedAt||(l.updatedAt=Date.now()),l}},98136:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>aL});var a=n(62574),l=n(84574),s=n(57597),i=n(78549),r=n(11437),o=n(20517),c=n(38174),d=n(3073),u=n(15574),h=n(98335),m=n(75972),f=n(3189);let p=(e,t)=>{for(let n of e){if(n.href===t)return[n];if(n.subitems){let e=p(n.subitems,t);if(e.length)return[n,...e]}}return[]},g=(e,t)=>{let n=0,a=e.length-1,l=null;for(;n<=a;){let s=Math.floor((n+a)/2),i=e[s].cfi||"",r=f.HY.compare(i,t);if(0===r)return e[s];r<0?(l=e[s],n=s+1):a=s-1}return l},b=(e,t)=>{let n=(null==e?void 0:e.toc)||[],a=(null==e?void 0:e.sections)||[];if(!n.length||!a.length)return;let l=a.map(e=>"no"!=e.linear&&e.size>0?e.size:0),s=0,i=l.reduce((e,t)=>(e.push(s),s+=t,e),[]),r=i[i.length-1]||0;a.forEach((e,t)=>{e.location={current:Math.floor(i[t]/1500),next:Math.floor((i[t]+l[t])/1500),total:Math.floor(r/1500)}});let o=a.reduce((e,t)=>(e[t.id]=t,e),{});x(e,n,a,o),t&&v(n)},x=function(e,t,n,a){let l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return t.forEach(s=>{var i;if(null!=s.id||(s.id=l++),s.href){let l=e.splitTOCHref(s.href)[0],i=a[l];i&&(s.cfi=i.cfi,(l===s.href||t.length<=n.length)&&(s.location=i.location))}s.subitems&&(l=x(e,s.subitems,n,a,l))}),l},v=e=>{e.sort((e,t)=>e.location&&t.location?e.location.current-t.location.current:0)};var w=n(29613),y=n(58941),j=n(58529);let N=(0,m.v)((e,t)=>({viewStates:{},bookKeys:[],hoveredBookKey:null,setBookKeys:t=>e({bookKeys:t}),setHoveredBookKey:t=>e({hoveredBookKey:t}),getView:e=>{var n;return e&&(null==(n=t().viewStates[e])?void 0:n.view)||null},setView:(t,n)=>e(e=>({viewStates:{...e.viewStates,[t]:{...e.viewStates[t],view:n}}})),getViews:()=>Object.values(t().viewStates).map(e=>e.view),getViewsById:e=>{let{viewStates:n}=t();return Object.values(n).filter(t=>t.key.startsWith(e)).map(e=>e.view)},clearViewState:t=>{e(e=>{let n={...e.viewStates};return delete n[t],{viewStates:n}})},getViewState:e=>t().viewStates[e]||null,initViewState:async function(t,n,a){let l=!(arguments.length>3)||void 0===arguments[3]||arguments[3],s=w.I.getState().booksData[n];e(e=>({viewStates:{...e.viewStates,[a]:{key:"",view:null,isPrimary:!1,loading:!0,error:null,progress:null,ribbonVisible:!1,ttsEnabled:!1,viewSettings:null}}}));try{var i,r,c,d,u;if(!s){let e=await t.getAppService(),{settings:l}=o.C.getState(),{library:s}=y.C.getState(),i=s.find(e=>e.hash===n);if(!i)throw Error("Book not found");let{file:h,config:m}=await e.loadBookContent(i,l);console.log("Loading book",a);let{book:p}=await new f.xb(h).open({allowScript:null==(r=m.viewSettings)?void 0:r.allowScript});b(p,null!=(d=null==(c=m.viewSettings)?void 0:c.sortedTOC)&&d),i.primaryLanguage=null!=(u=i.primaryLanguage)?u:(0,j.hM)(p.metadata.language),w.I.setState(e=>({booksData:{...e.booksData,[n]:{id:n,book:i,file:h,config:m,bookDoc:p}}}))}let h=(null==(i=w.I.getState().booksData[n])?void 0:i.config).viewSettings;e(e=>({viewStates:{...e.viewStates,[a]:{...e.viewStates[a],key:a,view:null,isPrimary:l,loading:!1,error:null,progress:null,ribbonVisible:!1,ttsEnabled:!1,viewSettings:JSON.parse(JSON.stringify(h))}}}))}catch(t){console.error(t),e(e=>({viewStates:{...e.viewStates,[a]:{...e.viewStates[a],key:"",view:null,isPrimary:!1,loading:!1,error:"Failed to load book.",progress:null,ribbonVisible:!1,ttsEnabled:!1,viewSettings:null}}}))}},getViewSettings:e=>{var n;return(null==(n=t().viewStates[e])?void 0:n.viewSettings)||null},setViewSettings:(n,a)=>{let l=n.split("-")[0],s=w.I.getState().booksData[l],i=t().viewStates[n];i&&s&&(i.isPrimary&&w.I.setState(e=>({booksData:{...e.booksData,[l]:{...s,config:{...s.config,updatedAt:Date.now(),viewSettings:a}}}})),e(e=>({viewStates:{...e.viewStates,[n]:{...e.viewStates[n],viewSettings:a}}})))},getProgress:e=>{var n;return(null==(n=t().viewStates[e])?void 0:n.progress)||null},setProgress:(t,n,a,l,s,i,r)=>e(e=>{var o;let c=t.split("-")[0],d=w.I.getState().booksData[c],u=e.viewStates[t];if(!u||!d)return e;let h=[(null!=(o=s.next)?o:s.current)+1,s.total],{library:m,setLibrary:f}=y.C.getState(),p=m.findIndex(e=>e.hash===c);if(-1!==p){let e=[...m],t=e[p];e[p]={...t,progress:h,updatedAt:Date.now()},f(e)}let g=d.config,b={...d.config,updatedAt:Date.now(),progress:h,location:n};return w.I.setState(e=>({booksData:{...e.booksData,[c]:{...d,config:u.isPrimary?b:g}}})),{viewStates:{...e.viewStates,[t]:{...u,progress:{...u.progress,location:n,sectionHref:null==a?void 0:a.href,sectionLabel:null==a?void 0:a.label,sectionId:null==a?void 0:a.id,section:l,pageinfo:s,timeinfo:i,range:r}}}}}),setBookmarkRibbonVisibility:(t,n)=>e(e=>({viewStates:{...e.viewStates,[t]:{...e.viewStates[t],ribbonVisible:n}}})),setTTSEnabled:(t,n)=>e(e=>({viewStates:{...e.viewStates,[t]:{...e.viewStates[t],ttsEnabled:n}}}))})),k=(0,m.v)(e=>({sideBarBookKey:null,sideBarWidth:"",isSideBarVisible:!1,isSideBarPinned:!1,setSideBarBookKey:t=>e({sideBarBookKey:t}),setSideBarWidth:t=>e({sideBarWidth:t}),toggleSideBar:()=>e(e=>({isSideBarVisible:!e.isSideBarVisible})),toggleSideBarPin:()=>e(e=>({isSideBarPinned:!e.isSideBarPinned})),setSideBarVisible:t=>e({isSideBarVisible:t}),setSideBarPin:t=>e({isSideBarPinned:t})})),S=(0,m.v)((e,t)=>({notebookWidth:"",isNotebookVisible:!1,isNotebookPinned:!1,notebookNewAnnotation:null,notebookEditAnnotation:null,notebookAnnotationDrafts:{},setNotebookWidth:t=>e({notebookWidth:t}),toggleNotebook:()=>e(e=>({isNotebookVisible:!e.isNotebookVisible})),toggleNotebookPin:()=>e(e=>({isNotebookPinned:!e.isNotebookPinned})),setNotebookVisible:t=>e({isNotebookVisible:t}),setNotebookPin:t=>e({isNotebookPinned:t}),setNotebookNewAnnotation:t=>e({notebookNewAnnotation:t}),setNotebookEditAnnotation:t=>e({notebookEditAnnotation:t}),saveNotebookAnnotationDraft:(t,n)=>e(e=>({notebookAnnotationDrafts:{...e.notebookAnnotationDrafts,[t]:n}})),getNotebookAnnotationDraft:e=>t().notebookAnnotationDrafts[e]}));var C=n(85376),A=n(18426),E=n(66763),T=n(90734),L=n(69921);let M=()=>{let e=window.open;globalThis.open=function(t,n,a){return(0,L.uO)()?((0,T.CZ)((null==t?void 0:t.toString())||""),null):e(t,n,a)}};var I=n(70100),B=n(58068),R=n(22697),P=n(44625),_=n(20867),D=n(38012),z=n(65865),V=n(29353),F=n(50981),W=n(75454),O=n(40965);let H=(0,m.v)((e,t)=>({parallelViews:[],setParallel:(t,n)=>{e(e=>{let a=[...e.parallelViews],l=a.find(e=>e.has(t)),s=a.find(e=>e.has(n));return l&&s?l!==s&&(l.forEach(e=>s.add(e)),a.splice(a.indexOf(l),1)):l?l.add(n):s?s.add(t):a.push(new Set([t,n])),{parallelViews:a}})},unsetParallel:(t,n)=>{e(e=>{let a=[...e.parallelViews],l=a.find(e=>e.has(t)&&e.has(n));if(l){l.delete(t),l.delete(n);let e=Array.from(l);e.length>0&&a.push(new Set(e)),a.splice(a.indexOf(l),1)}return{parallelViews:a}})},areParallels(e,n){let{parallelViews:a}=t();return a.some(t=>t.has(e)&&t.has(n))},getParallels(e){let{parallelViews:n}=t();return n.find(t=>t.has(e))||null}})),K=()=>{let e=(0,D.useRouter)(),t=(0,D.useSearchParams)(),{envConfig:n}=(0,s.D)(),{bookKeys:a}=N(),{setBookKeys:i,initViewState:r}=N(),{sideBarBookKey:o,setSideBarBookKey:c}=k(),[d,u]=(0,l.useState)(!1),{setParallel:h}=H();(0,l.useEffect)(()=>{if(d){let n=a.map(e=>e.split("-")[0]);n&&(0,W.YF)(e,n,(null==t?void 0:t.toString())||"",{scroll:!1}),u(!1)}},[a,d]);let m=(e,t,l)=>{let s="".concat(e,"-").concat((0,F.NF)());r(n,e,s,t),a.includes(s)||i([...a,s]),l&&h(o,s),c(s),u(!0)};return{bookKeys:a,appendBook:m,dismissBook:e=>{i(a.filter(t=>t!==e)),u(!0)},getNextBookKey:e=>{let t=(a.findIndex(t=>t===e)+1)%a.length;return a[t]},openParallelView:e=>{m(e,(null==o?void 0:o.split("-")[0])!=e,!0)}}};var U=n(16161),Y=n(80258);let G=(e,t,n)=>{if(!e||!t)return;let a=e.renderer;if(!a.scrolled)return"left"===n?e.goLeft():e.goRight();{"rtl"===e.book.dir&&(n="left"===n?"right":"left");let{size:l}=a,s=t.showHeader&&t.showBarsOnScroll,i=t.showFooter&&t.showBarsOnScroll,r=l-t.scrollingOverlap-44*!!s-44*!!i;return"left"===n?e.prev(r):e.next(r)}},X=(e,t,n)=>{let{appService:a}=(0,s.D)(),{getViewSettings:i}=N(),{hoveredBookKey:r,setHoveredBookKey:o}=N(),{acquireVolumeKeyInterception:c,releaseVolumeKeyInterception:d}=(0,C.A)(),u=async l=>{if(l instanceof MessageEvent){if(l.data&&l.data.bookKey===e){var s,c,d,u;let h=i(e);if("iframe-single-click"===l.data.type){let s=n.current;if(s){let n,{screenX:i}=l.data,c=s.getBoundingClientRect(),d=((0,L.uO)()?(null==a?void 0:a.isMobile)?0:(await (0,V._Y)()).x:window.screenX)+c.left,u=d+c.width/2;if(!E.I.dispatchSync("iframe-single-click")){let n=d+.375*c.width,a=d+.625*c.width;if(h.disableClick||i>=n&&i<=a)o(r?null:e);else{if(r)return void o(null);!h.disableClick&&i>=u?h.swapClickArea?G(t.current,h,"left"):G(t.current,h,"right"):!h.disableClick&&i<u&&(h.swapClickArea?G(t.current,h,"right"):G(t.current,h,"left"))}}}}else if("iframe-wheel"!==l.data.type||h.scrolled)"iframe-mouseup"===l.data.type&&(3===l.data.button?null==(d=t.current)||d.history.back():4===l.data.button&&(null==(u=t.current)||u.history.forward()));else{let{deltaY:e}=l.data;e>0?null==(s=t.current)||s.next(1):e<0&&(null==(c=t.current)||c.prev(1))}}}else if(l instanceof CustomEvent){let{keyName:n}=l.detail,a=i(e);(null==a?void 0:a.volumeKeysToFlip)&&(o(""),"VolumeUp"===n?G(t.current,a,"left"):"VolumeDown"===n&&G(t.current,a,"right"))}else if("click"===l.type){let{clientX:n}=l,a=window.innerWidth,s=i(e);n<.5*a?G(t.current,s,"left"):n>.5*a&&G(t.current,s,"right")}};return(0,l.useEffect)(()=>{if(!(null==a?void 0:a.isMobileApp))return;let t=i(e);return(null==t?void 0:t.volumeKeysToFlip)?c():d(),E.I.on("native-key-down",u),()=>{d(),E.I.off("native-key-down",u)}},[]),{handlePageFlip:u,handleContinuousScroll:(n,a,l)=>{var s;let r=null==(s=t.current)?void 0:s.renderer,o=i(e);if(r&&o.scrolled&&o.continuousScroll){let e=()=>{r.start<=a&&a>l?setTimeout(()=>{var e;null==(e=t.current)||e.prev(r.start+1)},100):Math.ceil(r.end)-a>=r.viewSize&&a<-l&&setTimeout(()=>{var e;null==(e=t.current)||e.next(r.viewSize-Math.floor(r.end)+1)},100)};"mouse"===n?e():"touch"===n&&(r.size>=r.viewSize?e():r.addEventListener("relocate",()=>e(),{once:!0}))}}}},q=e=>{var t,n;let{sideBarBookKey:a,bookKeys:l}=e,{getView:s,getViewSettings:i,setViewSettings:r}=N(),{toggleSideBar:c,setSideBarBookKey:d}=k(),{setFontLayoutSettingsDialogOpen:u}=(0,o.C)(),{toggleNotebook:h}=S(),{getNextBookKey:m}=K(),f=i(null!=a?a:""),p=(null!=(t=null==f?void 0:f.defaultFontSize)?t:16)*(null!=(n=null==f?void 0:f.lineHeight)?n:1.6)*3,g=async()=>{(0,L.uO)()&&await (0,V.tP)()},b=async()=>{(0,L.uO)()&&await (0,V.c_)()};(0,U.A)({onSwitchSideBar:()=>{a&&d(m(a))},onToggleSideBar:c,onToggleNotebook:h,onToggleScrollMode:()=>{let e=i(null!=a?a:"");if(e&&a){var t;e.scrolled=!e.scrolled,r(a,e);let n=e.scrolled?"scrolled":"paginated";null==(t=s(a))||t.renderer.setAttribute("flow",n)}},onOpenFontLayoutSettings:()=>u(!0),onToggleSearchBar:()=>{E.I.dispatch("search",{term:""})},onReloadPage:()=>{window.location.reload()},onToggleFullscreen:g,onQuitApp:b,onGoLeft:()=>{let e=i(null!=a?a:"");G(s(a),e,"left")},onGoRight:()=>{let e=i(null!=a?a:"");G(s(a),e,"right")},onGoPrev:()=>{var e;null==(e=s(a))||e.prev(p)},onGoNext:()=>{var e;null==(e=s(a))||e.next(p)},onGoHalfPageDown:()=>{let e=s(a),t=i(null!=a?a:"");e&&t&&t.scrolled&&e.next(e.renderer.size/2)},onGoHalfPageUp:()=>{let e=s(a),t=i(null!=a?a:"");e&&t&&t.scrolled&&e.prev(e.renderer.size/2)},onGoBack:()=>{var e;null==(e=s(a))||e.history.back()},onGoForward:()=>{var e;null==(e=s(a))||e.history.forward()},onZoomIn:()=>{var e,t,n;if(!a)return;let l=s(a);if(!(null==l||null==(e=l.renderer)?void 0:e.setStyles))return;let o=i(a),c=o.zoomLevel+O.bL;o.zoomLevel=Math.min(c,O.ec),r(a,o),null==l||null==(t=(n=l.renderer).setStyles)||t.call(n,(0,Y.$f)(o))},onZoomOut:()=>{var e,t,n;if(!a)return;let l=s(a);if(!(null==l||null==(e=l.renderer)?void 0:e.setStyles))return;let o=i(a),c=o.zoomLevel-O.bL;o.zoomLevel=Math.max(c,O.cA),r(a,o),null==l||null==(t=(n=l.renderer).setStyles)||t.call(n,(0,Y.$f)(o))},onResetZoom:()=>{var e,t,n;if(!a)return;let l=s(a);if(!(null==l||null==(e=l.renderer)?void 0:e.setStyles))return;let o=i(a);o.zoomLevel=100,r(a,o),null==l||null==(t=(n=l.renderer).setStyles)||t.call(n,(0,Y.$f)(o))}},[a,l])};var J=n(99613),Z=n(72645),Q=n(4603),$=n.n(Q),ee=n(45016),et=n(83703),en=n(99322),ea=n(27805),el=n(90045),es=n(25470),ei=n(18631),er=n(64765),eo=n(25143),ec=n(60314);let ed=e=>{let{menuClassName:t,setIsDropdownOpen:n}=e,s=(0,i.B)(),{getViewSettings:r,setViewSettings:o}=N(),{getVisibleLibrary:c}=(0,y.C)(),{openParallelView:u}=K(),{sideBarBookKey:h}=k(),m=r(h),[f,p]=l.useState((null==m?void 0:m.sortedTOC)||!1),g=e=>{u(e),null==n||n(!1)},b=(0,L.hx)();return(0,a.jsxs)("div",{tabIndex:0,className:(0,d.A)("book-menu dropdown-content border-base-100 z-20 shadow-2xl",t),children:[(0,a.jsx)(ec.A,{label:s("Parallel Read"),children:(0,a.jsx)("ul",{className:"max-h-60 overflow-y-auto",children:c().filter(e=>"PDF"!==e.format&&"CBZ"!==e.format).slice(0,20).map(e=>(0,a.jsx)(ec.A,{Icon:(0,a.jsx)(eo.default,{src:e.coverImageUrl,alt:e.title,width:56,height:80,className:"aspect-auto max-h-8 max-w-4 rounded-sm shadow-md",onError:e=>{e.target.style.display="none"}}),label:e.title,labelClass:"max-w-36",onClick:()=>g(e.hash)},e.hash))})}),(0,a.jsx)(ec.A,{label:s("Export Annotations"),onClick:()=>{E.I.dispatch("export-annotations",{bookKey:h}),null==n||n(!1)}}),(0,a.jsx)(ec.A,{label:s("Sort TOC by Page"),Icon:f?el.g9_:void 0,onClick:()=>{if(p(e=>!e),null==n||n(!1),h){let e=r(h);e.sortedTOC=!f,o(h,e)}setTimeout(()=>window.location.reload(),100)}}),(0,a.jsx)(ec.A,{label:s("Reload Page"),shortcut:"Shift+R",onClick:()=>{window.location.reload(),null==n||n(!1)}}),(0,a.jsx)("hr",{className:"border-base-200 my-1"}),b&&(0,a.jsx)(ec.A,{label:s("Download Readest"),onClick:()=>{window.open(O.cP,"_blank"),null==n||n(!1)}}),(0,a.jsx)(ec.A,{label:s("About Readest"),onClick:()=>{(0,R.o)(!0),null==n||n(!1)}})]})},eu=e=>{let{isPinned:t,isSearchBarVisible:n,onGoToLibrary:l,onClose:s,onTogglePin:i,onToggleSearchBar:r}=e,{isTrafficLightVisible:o}=(0,ei.w)(),c=(0,es.D)(14),u=(0,es.D)(18),h=(0,es.D)(22);return(0,a.jsxs)("div",{className:(0,d.A)("sidebar-header flex h-11 items-center justify-between pe-2",o?"pl-20":"ps-1.5"),dir:"ltr",children:[(0,a.jsxs)("div",{className:"flex items-center gap-x-8",children:[(0,a.jsx)("button",{onClick:s,className:"btn btn-ghost btn-circle flex h-6 min-h-6 w-6 hover:bg-transparent sm:hidden",children:(0,a.jsx)(el.VR3,{size:h})}),(0,a.jsx)("button",{className:"btn btn-ghost hidden h-8 min-h-8 w-8 p-0 sm:flex",onClick:l,children:(0,a.jsx)(en.cNd,{className:"fill-base-content"})})]}),(0,a.jsxs)("div",{className:"flex min-w-24 max-w-32 items-center justify-between sm:size-[70%]",children:[(0,a.jsx)("button",{onClick:r,className:(0,d.A)("btn btn-ghost left-0 h-8 min-h-8 w-8 p-0",n?"bg-base-300":""),children:(0,a.jsx)(ea.CKj,{size:u,className:"text-base-content"})}),(0,a.jsx)(er.A,{className:(0,d.A)(window.innerWidth<640&&"dropdown-end","dropdown-bottom flex justify-center"),menuClassName:window.innerWidth<640?"no-triangle mt-1":"dropdown-center mt-3",buttonClassName:"btn btn-ghost h-8 min-h-8 w-8 p-0",toggleButton:(0,a.jsx)(el.hCN,{className:"fill-base-content"}),children:(0,a.jsx)(ed,{})}),(0,a.jsx)("div",{className:"right-0 hidden h-8 w-8 items-center justify-center sm:flex",children:(0,a.jsx)("button",{onClick:i,className:(0,d.A)("sidebar-pin-btn btn btn-ghost btn-circle hidden h-6 min-h-6 w-6 sm:flex",t?"bg-base-300":"bg-base-300/65"),children:t?(0,a.jsx)(el.RR4,{size:c}):(0,a.jsx)(el.nDj,{size:c})})})]})]})};var eh=n(82428),em=n(20627);let ef=e=>{let t=[],n=function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!(a>15))for(let i of(e instanceof HTMLElement&&e.shadowRoot&&n(e.shadowRoot,a+1),"children"in e?Array.from(e.children):[])){var l,s;if("STYLE"===i.tagName||"LINK"===i.tagName)continue;if(i.shadowRoot&&n(i.shadowRoot,a+1),"IFRAME"===i.tagName){let e=i.contentDocument||(null==(s=i.contentWindow)?void 0:s.document);e&&e.body&&n(e.body,a+1)}let e=i.childNodes&&Array.from(i.childNodes).some(e=>{var t;return e.nodeType===Node.TEXT_NODE&&(null==(t=e.textContent)?void 0:t.trim())});0===i.children.length&&(null==(l=i.textContent)?void 0:l.trim())||e?t.push(i):i.children.length>0&&n(i,a+1)}};return n(e),t};var ep=n(80913);function eg(e,t){let{getViewSettings:n}=N(),a=n(e),s=(0,l.useRef)(null==a?void 0:a.translationEnabled),[i,r]=(0,l.useState)(null==a?void 0:a.translationProvider),[o,c]=(0,l.useState)(null==a?void 0:a.translateTargetLang),{translate:d}=(0,em.m)({provider:i,targetLang:(0,ep.GV)(o||(0,F.JK)())}),u=(0,l.useRef)(d),h=(0,l.useRef)(null),m=(0,l.useRef)([]),f=(0,l.useRef)([]),p=e=>{m.current.forEach(t=>{t.querySelectorAll(".translation-target").forEach(t=>{e?t.classList.remove("hidden"):t.classList.add("hidden")})})};(0,l.useEffect)(()=>{u.current=d},[d]);let g=()=>{if(!t||!s.current)return;let e=x();h.current=e;let n=ef(t);console.log("Observing text nodes for translation:",n.length),f.current=n,n.forEach(t=>e.observe(t))},b=()=>{m.current.forEach(e=>{e.querySelectorAll(".translation-target").forEach(e=>e.remove())}),m.current=[],(null==a?void 0:a.translationEnabled)&&t&&w()},x=()=>new IntersectionObserver(e=>{let t=null,n=null;for(let a of e){if(!a.isIntersecting){n||(t=a.target);continue}let e=a.target;y(e),n=e}t&&y(t),n&&v(n,2)},{rootMargin:"1280px",threshold:0}),v=(e,t)=>{if(!f.current||t<=0)return;let n=f.current.indexOf(e);-1!==n&&f.current.slice(n+1,n+1+t).forEach((e,t)=>{setTimeout(()=>{y(e)},500*t)})},w=()=>{var e;let t=x();null==(e=h.current)||e.disconnect(),h.current=t,f.current.forEach(e=>t.observe(e))},y=async e=>{var t;if(!s.current)return;let n=null==(t=e.textContent)?void 0:t.trim();if(n&&!e.querySelector(".translation-target"))try{let t=(await u.current([n]))[0];if(!t||n===t)return;let a=document.createElement("font");a.className="translation-target ".concat(s.current?"":"hidden"),a.setAttribute("translation-element-mark","1"),a.setAttribute("lang",o||(0,F.JK)()),a.appendChild(document.createElement("br"));let l=document.createElement("font");l.className="translation-target translation-block-wrapper";let i=document.createElement("font");if(i.className="translation-target target-inner target-inner-theme-none",i.textContent=t,l.appendChild(i),a.appendChild(l),e.querySelector(".translation-target"))return;e.appendChild(a),m.current.push(e)}catch(e){console.warn("Translation failed:",e)}};(0,l.useEffect)(()=>{if(!a)return;let e=s.current!==a.translationEnabled,t=i!==a.translationProvider,n=o!==a.translateTargetLang;e&&(s.current=a.translationEnabled),t&&r(a.translationProvider),n&&c(a.translateTargetLang),e?(p(a.translationEnabled),s.current&&g()):(t||n)&&b()},[e,a,i,o]),(0,l.useEffect)(()=>{if(t&&s.current)return"renderer"in t?t.addEventListener("load",g):g(),()=>{var e;"renderer"in t&&t.removeEventListener("load",g),null==(e=h.current)||e.disconnect(),m.current=[]}},[t])}let eb=e=>(0,a.jsx)("svg",{viewBox:"0 0 8 10",width:"8",height:"10",className:(0,d.A)("text-base-content transform transition-transform",e?"rotate-90":"rotate-0"),style:{transformOrigin:"center"},fill:"currentColor",children:(0,a.jsx)("polygon",{points:"0 0, 8 5, 0 10"})}),ex=l.memo(e=>{let{flatItem:t,itemSize:n,isActive:s,onToggleExpand:i,onItemClick:r}=e,{item:o,depth:c}=t,u=(0,l.useCallback)(e=>{e.preventDefault(),e.stopPropagation(),i(o)},[o,i]),h=(0,l.useCallback)(e=>{e.preventDefault(),r(o)},[o,r]);return(0,a.jsxs)("span",{role:"treeitem",tabIndex:-1,onClick:o.href?h:void 0,"aria-expanded":t.isExpanded?"true":"false","aria-selected":s?"true":"false","data-href":o.href?(0,F.aY)(o.href):void 0,className:(0,d.A)("flex w-full cursor-pointer items-center rounded-md py-4 sm:py-2",s?"sm:bg-base-300/85 sm:hover:bg-base-300 sm:text-base-content text-blue-500":"sm:hover:bg-base-300/85"),style:{height:n?"".concat(n,"px"):"auto",paddingInlineStart:"".concat((c+1)*12,"px")},children:[o.subitems&&(0,a.jsx)("span",{onClick:u,className:"inline-block cursor-pointer",style:{padding:"12px",margin:"-12px"},children:eb(t.isExpanded||!1)}),(0,a.jsx)("span",{className:"ms-2 truncate text-ellipsis",style:{maxWidth:"calc(100% - 24px)",whiteSpace:"nowrap",textOverflow:"ellipsis"},children:o.label}),o.location&&(0,a.jsx)("span",{className:"text-base-content/50 ms-auto ps-1 text-xs sm:pe-1",children:o.location.current+1})]})});ex.displayName="TOCItemView";let ev=e=>{let{bookKey:t,flatItem:n,itemSize:l,activeHref:s,onToggleExpand:i,onItemClick:r}=e,o=s===n.item.href;return(0,a.jsx)("div",{className:(0,d.A)("border-base-300 w-full border-b sm:border-none","pe-4 ps-2 pt-[1px] sm:pe-2"),children:(0,a.jsx)(ex,{bookKey:t,flatItem:n,itemSize:l,isActive:o,onToggleExpand:i,onItemClick:r})})},ew=e=>{let{index:t,style:n,data:l}=e,{flatItems:s,bookKey:i,activeHref:r,itemSize:o,onToggleExpand:c,onItemClick:d}=l,u=s[t];return(0,a.jsx)("div",{style:n,children:(0,a.jsx)(ev,{bookKey:i,flatItem:u,itemSize:o-1,activeHref:r,onToggleExpand:c,onItemClick:d})})},ey=(e,t)=>(0,l.useMemo)(()=>{let n=function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,l=[];return e.forEach((e,s)=>{let i=t.has(e.href||"");l.push({item:e,depth:a,index:s,isExpanded:i}),e.subitems&&i&&l.push(...n(e.subitems,a+1))}),l};return n(e)},[e,t]),ej=e=>{let{bookKey:t,toc:n}=e,{getView:s,getProgress:i,getViewSettings:r}=N(),{sideBarBookKey:o,isSideBarVisible:c}=k(),d=r(t),u=i(t),[h,m]=(0,l.useState)(new Set),[f,g]=(0,l.useState)(400),b=(0,l.useRef)(null),x=(0,l.useRef)(null),v=(0,l.useRef)(null);eg(t,b.current),(0,l.useEffect)(()=>{let e=()=>{if(b.current){let e=b.current.getBoundingClientRect(),t=b.current.closest(".scroll-container");if(t){let n=t.getBoundingClientRect();g(Math.max(400,n.height-(e.top-n.top)))}}};e(),window.addEventListener("resize",e);let t=null;if(b.current){let n=b.current.closest(".scroll-container");n&&(t=new ResizeObserver(e)).observe(n)}return()=>{window.removeEventListener("resize",e),t&&t.disconnect()}},[]);let w=(0,l.useMemo)(()=>(null==u?void 0:u.sectionHref)||null,[u]),y=ey(n,h),j=(0,l.useCallback)(e=>{let t=e.href||"";m(e=>{let n=new Set(e);return n.has(t)?n.delete(t):n.add(t),n})},[]),S=(0,l.useCallback)(e=>{if(E.I.dispatch("navigate",{bookKey:t,href:e.href}),e.href){var n;null==(n=s(t))||n.goTo(e.href)}},[t,s]),C=(0,l.useCallback)((e,t)=>{m(new Set(p(e,t).map(e=>e.href).filter(Boolean)))},[]),A=(0,l.useCallback)(()=>{if(w){if(x.current){let e=y.findIndex(e=>e.item.href===w);-1!==e&&x.current.scrollToItem(e,"center")}if(v.current){var e;let t=w?(0,F.aY)(w):"",n=null==(e=v.current)?void 0:e.querySelector('[data-href="'.concat(t,'"]'));if(n){let e=n.getBoundingClientRect();e.top>=0&&e.bottom<=window.innerHeight||n.scrollIntoView({behavior:"instant",block:"center"}),n.setAttribute("aria-current","page")}}}},[w,y]),T=(0,l.useMemo)(()=>!(window.innerWidth>=640)||(null==d?void 0:d.translationEnabled)?57:37,[d]),L=(0,l.useMemo)(()=>({flatItems:y,itemSize:T,bookKey:t,activeHref:w,onToggleExpand:j,onItemClick:S}),[y,T,t,w,j,S]);return(0,l.useEffect)(()=>{if(!u||E.I.dispatchSync("tts-is-speaking")||o!==t||!c)return;let{sectionHref:e}=u;e&&C(n,e)},[n,u,o,c,t,C]),(0,l.useEffect)(()=>{y.length>0&&setTimeout(A,0)},[y,A]),(0,a.jsx)("div",{className:"rounded",ref:b,children:y.length>256?(0,a.jsx)(eh.Y1,{ref:x,width:"100%",height:f,itemCount:y.length,itemSize:T,itemData:L,overscanCount:20,children:ew}):(0,a.jsx)("div",{className:"pt-2",ref:v,children:y.map((e,n)=>(0,a.jsx)(ev,{bookKey:t,flatItem:e,activeHref:w,onToggleExpand:j,onItemClick:S},"static-row-".concat(n)))})})};var eN=n(47868),ek=n(43903);let eS=(e,t)=>{let n=(0,l.useRef)(null),[a,s]=(0,l.useState)(!1);return(0,l.useEffect)(()=>{if(!n.current||!t)return;let{location:a}=t,l=eN.collapse(a),i=eN.collapse(a,!0),r=eN.compare(e,l)>=0&&0>=eN.compare(e,i);if(s(r),r){let e=n.current,t=e.getBoundingClientRect();t.top>=0&&t.bottom<=window.innerHeight||e.scrollIntoView({behavior:"smooth",block:"center"}),e.setAttribute("aria-current","page")}},[e,t,n]),{isCurrent:a,viewRef:n}},eC=e=>{let{bookKey:t,item:n}=e,l=(0,i.B)(),{envConfig:r}=(0,s.D)(),{settings:c}=(0,o.C)(),{getConfig:u,saveConfig:h,updateBooknotes:m}=(0,w.I)(),{getProgress:f,getView:p,getViewsById:g}=N(),{setNotebookEditAnnotation:b,setNotebookVisible:x}=S(),v=(0,es.D)(3),{text:y,cfi:j,note:k}=n,{isCurrent:C,viewRef:A}=eS(j,f(t));return(0,a.jsxs)("li",{ref:A,className:(0,d.A)("border-base-300 content group relative my-2 cursor-pointer rounded-lg p-2",C?"bg-base-300/85 hover:bg-base-300":"hover:bg-base-300/55 bg-base-100","transition-all duration-300 ease-in-out"),tabIndex:0,onClick:e=>{var n;e.preventDefault(),E.I.dispatch("navigate",{bookKey:t,cfi:j}),null==(n=p(t))||n.goTo(j),k&&x(!0)},children:[(0,a.jsxs)("div",{className:(0,d.A)("min-h-4 p-0 transition-all duration-300 ease-in-out"),style:{"--top-override":"0.7rem","--end-override":"0.3rem"},children:[n.note&&(0,a.jsx)("div",{className:"content prose prose-sm font-size-sm",dir:"auto",dangerouslySetInnerHTML:{__html:ek.xI.parse(n.note)}}),(0,a.jsxs)("div",{className:"flex items-start",children:[n.note&&(0,a.jsx)("div",{className:"me-2 mt-2.5 min-h-full self-stretch rounded-xl bg-gray-300",style:{minWidth:"".concat(v,"px")}}),(0,a.jsx)("div",{className:(0,d.A)("content font-size-sm line-clamp-3",n.note&&"mt-2"),children:(0,a.jsx)("span",{className:(0,d.A)("inline",n.note&&"content font-size-xs text-gray-500",("underline"===n.style||"squiggly"===n.style)&&"underline decoration-2","highlight"===n.style&&"bg-".concat(n.color,"-500 bg-opacity-40"),"underline"===n.style&&"decoration-".concat(n.color,"-400"),"squiggly"===n.style&&"decoration-wavy decoration-".concat(n.color,"-400")),children:y||""})})]})]}),(0,a.jsx)("div",{className:(0,d.A)("max-h-0 overflow-hidden p-0 text-xs","transition-[max-height] duration-300 ease-in-out","group-hover:max-h-8 group-hover:overflow-visible"),style:{"--bottom-override":0},onClick:e=>e.stopPropagation(),children:(0,a.jsxs)("div",{className:"flex justify-end space-x-3 p-2",dir:"ltr",children:[n.note&&(0,a.jsx)("button",{className:(0,d.A)("btn btn-ghost content settings-content hover:bg-transparent","flex h-4 min-h-4 items-end p-0"),onClick:(e=>{x(!0),b(e)}).bind(null,n),children:(0,a.jsx)("div",{className:(0,d.A)("align-bottom text-blue-500","transition duration-300 ease-in-out","content font-size-sm","opacity-0 group-hover:opacity-100","hover:text-blue-600"),children:l("Edit")})}),(0,a.jsx)("button",{className:(0,d.A)("btn btn-ghost content settings-content hover:bg-transparent","flex h-4 min-h-4 items-end p-0"),onClick:(e=>{if(!t)return;let n=u(t);if(!n)return;let{booknotes:a=[]}=n;a.forEach(n=>{n.id===e.id&&(n.deletedAt=Date.now(),g(t.split("-")[0]).forEach(e=>null==e?void 0:e.addAnnotation(n,!0)))});let l=m(t,a);l&&h(r,t,l,c)}).bind(null,n),children:(0,a.jsx)("div",{className:(0,d.A)("align-bottom text-red-500","transition duration-300 ease-in-out","content font-size-sm","opacity-0 group-hover:opacity-100","hover:text-red-600"),children:l("Delete")})})]})})]})},eA=e=>{let{type:t,bookKey:n,toc:l}=e,{getConfig:s}=(0,w.I)(),{booknotes:i=[]}=s(n),r=i.filter(e=>e.type===t&&!e.deletedAt),o={};for(let e of r){let t=g(null!=l?l:[],e.cfi),n=(null==t?void 0:t.href)||"",a=(null==t?void 0:t.label)||"",s=(null==t?void 0:t.id)||0;o[n]||(o[n]={id:s,href:n,label:a,booknotes:[]}),o[n].booknotes.push(e)}Object.values(o).forEach(e=>{e.booknotes.sort((e,t)=>eN.compare(e.cfi,t.cfi))});let c=Object.values(o).sort((e,t)=>e.id-t.id);return(0,a.jsx)("div",{className:"rounded pt-2",children:(0,a.jsx)("ul",{role:"tree",className:"px-2",children:c.map(e=>(0,a.jsxs)("li",{className:"p-2",children:[(0,a.jsx)("h3",{className:"content font-size-base line-clamp-1 font-normal",children:e.label}),(0,a.jsx)("ul",{children:e.booknotes.map((e,t)=>(0,a.jsx)(eC,{bookKey:n,item:e},"".concat(t,"-").concat(e.cfi)))})]},e.href))})})};var eE=n(74514),eT=n(23511);let eL=e=>{let{activeTab:t,onTabChange:n}=e,l=(0,i.B)();return(0,a.jsxs)("div",{className:(0,d.A)("bottom-tab border-base-300/50 bg-base-200 relative flex w-full border-t"),dir:"ltr",children:[(0,a.jsx)("div",{className:(0,d.A)("bg-base-300 absolute bottom-1.5 start-1 h-[calc(100%-12px)] w-[calc(33.3%-8px)] rounded-lg","transform transition-transform duration-300","toc"===t&&"translate-x-0","annotations"===t&&"translate-x-[calc(100%+8px)]","bookmarks"===t&&"translate-x-[calc(200%+16px)]")}),["toc","annotations","bookmarks"].map(e=>(0,a.jsx)("div",{className:"lg:tooltip lg:tooltip-top z-50 m-1.5 flex-1 cursor-pointer rounded-md p-2","data-tip":"toc"===e?l("TOC"):"annotations"===e?l("Annotate"):l("Bookmark"),children:(0,a.jsx)("div",{className:(0,d.A)("flex h-6 items-center"),onClick:()=>n(e),children:"toc"===e?(0,a.jsx)(eE.Od7,{className:"mx-auto"}):"annotations"===e?(0,a.jsx)(eT.R5w,{className:"mx-auto"}):(0,a.jsx)(el.IEU,{className:"mx-auto"})})},e))]})},eM=e=>{var t,n,i;let{bookDoc:r,sideBarBookKey:o}=e,{appService:c}=(0,s.D)(),u=(0,l.useRef)(null),{getConfig:h,setConfig:m}=(0,w.I)(),f=h(o),[p,g]=(0,l.useState)((null==f||null==(t=f.viewSettings)?void 0:t.sideBarTab)||"toc"),[b,x]=(0,l.useState)(!1),[v,y]=(0,l.useState)(p);return(0,l.useEffect)(()=>{let e,t=u.current;if(!t)return;let n=()=>{t.classList.remove("hidden-scrollbar")},a=()=>{t.classList.add("hidden-scrollbar")};a();let l=()=>{n(),clearTimeout(e),e=setTimeout(a,2e3)};return t.addEventListener("scroll",l),()=>{t.removeEventListener("scroll",l),clearTimeout(e)}},[]),(0,l.useEffect)(()=>{o&&g(h(o).viewSettings.sideBarTab)},[o]),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:(0,d.A)("sidebar-content flex h-full min-h-0 flex-grow flex-col shadow-inner","font-sans text-base font-normal sm:text-sm"),children:(0,a.jsxs)("div",{ref:u,className:(0,d.A)("scroll-container min-h-0 flex-1 overflow-y-auto transition-opacity duration-300 ease-in-out",{"opacity-0":b,"opacity-100":!b}),children:["toc"===v&&r.toc&&(0,a.jsx)(ej,{toc:r.toc,bookKey:o}),"annotations"===v&&(0,a.jsx)(eA,{type:"annotation",toc:null!=(n=r.toc)?n:[],bookKey:o}),"bookmarks"===v&&(0,a.jsx)(eA,{type:"bookmark",toc:null!=(i=r.toc)?i:[],bookKey:o})]})}),(0,a.jsx)("div",{className:(0,d.A)("flex-shrink-0",(null==c?void 0:c.hasSafeAreaInset)&&"pb-[calc(env(safe-area-inset-bottom)/2)]"),children:(0,a.jsx)(eL,{activeTab:p,onTabChange:e=>{x(!0);let t=setTimeout(()=>{x(!1),y(e),m(o,n),clearTimeout(t)},300);g(e);let n=h(o);n.viewSettings.sideBarTab=e}})})]})},eI=e=>{let{book:t}=e,{coverImageUrl:n,title:l,author:s}=t,r=(0,i.B)(),{isDarkMode:o}=(0,h.C)(),c=(0,es.D)(18);return(0,a.jsxs)("div",{className:"flex h-20 w-full items-center",children:[(0,a.jsx)(eo.default,{src:n,alt:r("Book Cover"),width:56,height:80,className:(0,d.A)("me-4 aspect-auto max-h-16 w-[15%] max-w-12 rounded-sm object-cover shadow-md",o?"mix-blend-screen":"mix-blend-multiply"),onError:e=>{e.target.style.display="none"}}),(0,a.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,a.jsx)("h4",{className:"line-clamp-2 w-[90%] text-sm font-semibold",children:(0,j.Ef)(l)}),(0,a.jsx)("p",{className:"truncate text-xs opacity-75",children:(0,j.kY)(s)})]}),(0,a.jsx)("button",{className:"btn btn-ghost hover:bg-base-300 h-6 min-h-6 w-6 rounded-full p-0 transition-colors","aria-label":r("More Info"),children:(0,a.jsx)(el.k4P,{size:c,className:"fill-base-content",onClick:()=>{E.I.dispatchSync("show-book-details",t)}})})]})},eB=(e,t)=>{let{settings:n}=(0,o.C)(),{sideBarWidth:a,isSideBarVisible:s,isSideBarPinned:i,setSideBarWidth:r,setSideBarVisible:c,setSideBarPin:d,toggleSideBar:u,toggleSideBarPin:h}=k();return(0,l.useEffect)(()=>{r(e),d(t),c(t)},[]),{sideBarWidth:a,isSideBarPinned:i,isSideBarVisible:s,handleSideBarResize:e=>{r(e),n.globalReadSettings.sideBarWidth=e},handleSideBarTogglePin:()=>{h(),n.globalReadSettings.isSideBarPinned=!i,i&&s&&c(!1)},setSideBarVisible:c,toggleSideBar:u}};var eR=n(17669);let eP=e=>{let{label:t,isActive:n,onClick:l}=e;return(0,a.jsx)("button",{className:"hover:bg-base-300 flex w-full items-center justify-between rounded-md p-2",onClick:l,children:(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("span",{style:{minWidth:"".concat((0,es.n)(),"px")},children:n&&(0,a.jsx)(el.g9_,{className:"text-base-content"})}),(0,a.jsx)("span",{className:"ml-2",children:t})]})})},e_=e=>{let{searchConfig:t,menuClassName:n,onSearchConfigChanged:l,setIsDropdownOpen:s}=e,r=(0,i.B)(),o=(e,n)=>{l({...t,[e]:n}),null==s||s(!1)};return(0,a.jsxs)("div",{tabIndex:0,className:(0,d.A)("book-menu dropdown-content dropdown-center border-base-200 z-20 w-56 border shadow-2xl",n),children:[(0,a.jsx)(eP,{label:r("Book"),isActive:"book"===t.scope,onClick:()=>o("scope","book")}),(0,a.jsx)(eP,{label:r("Chapter"),isActive:"section"===t.scope,onClick:()=>o("scope","section")}),(0,a.jsx)("hr",{className:"border-base-200 my-1"}),(0,a.jsx)(eP,{label:r("Match Case"),isActive:t.matchCase,onClick:()=>o("matchCase",!t.matchCase)}),(0,a.jsx)(eP,{label:r("Match Whole Words"),isActive:t.matchWholeWords,onClick:()=>o("matchWholeWords",!t.matchWholeWords)}),(0,a.jsx)(eP,{label:r("Match Diacritics"),isActive:t.matchDiacritics,onClick:()=>o("matchDiacritics",!t.matchDiacritics)})]})},eD=e=>{var t;let{isVisible:n,bookKey:r,searchTerm:c,onSearchResultChange:u}=e,h=(0,i.B)(),{envConfig:m}=(0,s.D)(),{settings:f}=(0,o.C)(),{getBookData:p}=(0,w.I)(),{getConfig:g,saveConfig:b}=(0,w.I)(),{getView:x,getProgress:v}=N(),[y,j]=(0,l.useState)(c),k=(0,l.useRef)(null),S=x(r),C=g(r),A=p(r),E=v(r),T=(null==(t=A.book)?void 0:t.primaryLanguage)||"en",L=C.searchConfig,M=(0,l.useRef)(""),I=(0,l.useRef)(!1),B=(0,l.useRef)(null),R=(0,es.D)(12),P=(0,es.D)(16);(0,l.useEffect)(()=>{D(y)},[r]),(0,l.useEffect)(()=>{j(c),D(c)},[c]),(0,l.useEffect)(()=>{n&&k.current&&k.current.focus()},[n]),(0,l.useEffect)(()=>{let e=e=>{"Escape"===e.key&&k.current&&k.current.blur()};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e),B.current&&clearTimeout(B.current)}},[]);let _=e=>{let t=(0,ep.UT)(e)?1:2;return e.length>=t},D=e=>{_(e)?V(e):F()},z=function(){let{withRT:e=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t=>{if(t.nodeType===Node.ELEMENT_NODE){let n=t.tagName.toLowerCase();return"script"!==n&&"style"!==n&&(e||"rt"!==n)?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_REJECT}return NodeFilter.FILTER_ACCEPT}},V=async e=>{console.log("searching for:",e),I.current=!0;let{section:t}=E,n="section"===L.scope?t.current:void 0,a=await S.search({...L,index:n,query:e,acceptNode:z({withRT:!T.startsWith("ja")})}),l=[];for await(let t of a)"string"==typeof t?"done"===t&&(u([...l]),I.current=!1,console.log("search done"),M.current!==e&&_(M.current)&&V(M.current)):t.progress||(l.push(t),u([...l]))},F=()=>{u([]),null==S||S.clearSearch()};return(0,a.jsx)("div",{className:"relative p-2",children:(0,a.jsxs)("div",{className:"bg-base-100 flex h-8 items-center rounded-lg",children:[(0,a.jsx)("div",{className:"pl-3",children:(0,a.jsx)(eR.KSO,{size:P,className:"text-gray-500"})}),(0,a.jsx)("input",{ref:k,type:"text",value:y,spellCheck:!1,onChange:e=>{let t=e.target.value;j(t),B.current&&clearTimeout(B.current),B.current=setTimeout(()=>{I.current?M.current=t:D(t)},500)},placeholder:h("Search..."),className:"w-full bg-transparent p-2 font-sans text-sm font-light focus:outline-none"}),(0,a.jsx)("div",{className:"bg-base-300 flex h-8 w-8 items-center rounded-r-lg",children:(0,a.jsx)(er.A,{className:(0,d.A)(window.innerWidth<640&&"dropdown-end","dropdown-bottom flex justify-center"),menuClassName:window.innerWidth<640?"no-triangle mt-1":"dropdown-center mt-3",buttonClassName:"btn btn-ghost h-8 min-h-8 w-8 p-0 rounded-none rounded-r-lg",toggleButton:(0,a.jsx)(eR.Vr3,{size:R,className:"text-gray-500"}),children:(0,a.jsx)(e_,{searchConfig:L,onSearchConfigChanged:e=>{C.searchConfig=e,b(m,r,C,f),D(y)}})})})]})})},ez=e=>{let{bookKey:t,cfi:n,excerpt:l,onSelectResult:s}=e,{getProgress:i}=N(),{isCurrent:r,viewRef:o}=eS(n,i(t));return(0,a.jsx)("li",{ref:o,className:(0,d.A)("my-2 cursor-pointer rounded-lg p-2 text-sm",r?"bg-base-300 hover:bg-gray-300/70":"hover:bg-base-300 bg-base-100"),onClick:()=>s(n),children:(0,a.jsxs)("div",{className:"line-clamp-3",children:[(0,a.jsx)("span",{className:"",children:l.pre}),(0,a.jsx)("span",{className:"font-bold text-red-500",children:l.match}),(0,a.jsx)("span",{className:"",children:l.post})]})})},eV=e=>{let{bookKey:t,results:n,onSelectResult:l}=e;return(0,a.jsx)("div",{className:"search-results overflow-y-auto p-2 font-sans text-sm font-light",children:(0,a.jsx)("ul",{className:"px-2",children:n.map((e,n)=>"subitems"in e?(0,a.jsxs)("ul",{children:[(0,a.jsx)("h3",{className:"line-clamp-1 font-normal",children:e.label}),(0,a.jsx)("ul",{children:e.subitems.map((e,n)=>(0,a.jsx)(ez,{bookKey:t,cfi:e.cfi,excerpt:e.excerpt,onSelectResult:l},"".concat(n,"-").concat(e.cfi)))})]},"".concat(n,"-").concat(e.label)):(0,a.jsx)(ez,{bookKey:t,cfi:e.cfi,excerpt:e.excerpt,onSelectResult:l},"".concat(n,"-").concat(e.cfi)))})})},eF=e=>{let{onGoToLibrary:t}=e,{appService:n}=(0,s.D)(),{updateAppTheme:i}=(0,h.C)(),{settings:r}=(0,o.C)(),{sideBarBookKey:c}=k(),{getBookData:u}=(0,w.I)(),{getView:m,getViewSettings:f}=N(),[p,g]=(0,l.useState)(!1),[b,x]=(0,l.useState)(null),[v,y]=(0,l.useState)(""),S=window.innerWidth<640,{sideBarWidth:C,isSideBarPinned:A,isSideBarVisible:T,setSideBarVisible:L,handleSideBarResize:M,handleSideBarTogglePin:I}=eB(r.globalReadSettings.sideBarWidth,!S&&r.globalReadSettings.isSideBarPinned),B=async e=>{let{term:t}=e.detail;L(!0),g(!0),y(t)},R=async()=>{let e=document.querySelector(".sidebar-pin-btn");e&&"none"!==window.getComputedStyle(e).display||L(!1)};(0,l.useEffect)(()=>{T?i("base-200"):i("base-100")},[T]),(0,l.useEffect)(()=>(E.I.on("search",B),E.I.on("navigate",R),()=>{E.I.off("search",B),E.I.off("navigate",R)}),[]);let{handleDragStart:P}=(0,et.i)(e=>{if(!S)return;let t=e.clientY/window.innerHeight,n=Math.max(0,Math.min(1,t)),a=document.querySelector(".sidebar-container"),l=document.querySelector(".overlay");a&&l&&(a.style.top="".concat(100*n,"%"),l.style.opacity="".concat(1-t))},e=>{let t=document.querySelector(".sidebar-container"),a=document.querySelector(".overlay");if(t&&a)if(e.velocity>.5||e.velocity>=0&&e.clientY>=.5*window.innerHeight){let l=.15/Math.max(e.velocity,.5);t.style.transition="top ".concat(l,"s ease-out"),t.style.top="100%",a.style.transition="opacity ".concat(l,"s ease-out"),a.style.opacity="0",setTimeout(()=>L(!1),300),(null==n?void 0:n.hasHaptics)&&(0,ee._q)("medium")}else t.style.transition="top 0.3s ease-out",t.style.top="0%",a.style.transition="opacity 0.3s ease-out",a.style.opacity="0.8",(null==n?void 0:n.hasHaptics)&&(0,ee._q)("medium")}),{handleDragStart:_}=(0,et.i)(e=>{let t=Math.max(.05,Math.min(.45,e.clientX/window.innerWidth));M("".concat(Math.round(1e4*t)/100,"%"))}),D=()=>{if(g(e=>!e),p){var e;x(null),y(""),null==(e=m(c))||e.clearSearch()}};if((0,U.A)({onToggleSearchBar:D},[c]),!c)return null;let z=f(c),V=u(c);if(!V||!V.book||!V.bookDoc)return null;let{book:F,bookDoc:W}=V,O=(0,j.jk)(W.metadata.language);return T?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{dir:(null==z?void 0:z.rtl)&&"rtl"===O?"rtl":"ltr",style:{width:"".concat(C),maxWidth:"".concat(45,"%"),position:A?"relative":"absolute"},className:"jsx-d9775a1d85a5e0e "+((0,d.A)("sidebar-container bg-base-200 z-20 flex min-w-60 select-none flex-col",(null==n?void 0:n.isIOSApp)?"h-[100vh]":"h-full",(null==n?void 0:n.hasSafeAreaInset)&&"pt-[env(safe-area-inset-top)]",(null==n?void 0:n.hasRoundedWindow)&&"rounded-window-top-left rounded-window-bottom-left",!A&&"shadow-2xl")||""),children:[(0,a.jsx)($(),{id:"d9775a1d85a5e0e",children:"@media(max-width:640px){.sidebar-container.jsx-d9775a1d85a5e0e{width:100%;min-width:100%;-webkit-border-top-left-radius:16px;-moz-border-radius-topleft:16px;border-top-left-radius:16px;-webkit-border-top-right-radius:16px;-moz-border-radius-topright:16px;border-top-right-radius:16px}.sidebar-container.open.jsx-d9775a1d85a5e0e{top:0%}.overlay.jsx-d9775a1d85a5e0e{-webkit-transition:opacity.3s ease-in-out;-moz-transition:opacity.3s ease-in-out;-o-transition:opacity.3s ease-in-out;transition:opacity.3s ease-in-out}}"}),(0,a.jsxs)("div",{className:"jsx-d9775a1d85a5e0e flex-shrink-0",children:[S&&(0,a.jsx)("div",{onMouseDown:P,onTouchStart:P,className:"jsx-d9775a1d85a5e0e drag-handle flex h-10 w-full cursor-row-resize items-center justify-center",children:(0,a.jsx)("div",{className:"jsx-d9775a1d85a5e0e bg-base-content/50 h-1 w-10 rounded-full"})}),(0,a.jsx)(eu,{isPinned:A,isSearchBarVisible:p,onGoToLibrary:t,onClose:()=>L(!1),onTogglePin:I,onToggleSearchBar:D}),(0,a.jsx)("div",{className:"jsx-d9775a1d85a5e0e "+((0,d.A)("search-bar",{"search-bar-visible":p})||""),children:(0,a.jsx)(eD,{isVisible:p,bookKey:c,searchTerm:v,onSearchResultChange:x})}),(0,a.jsx)("div",{className:"jsx-d9775a1d85a5e0e border-base-300/50 border-b px-3",children:(0,a.jsx)(eI,{book:F})})]}),p&&b?(0,a.jsx)(eV,{bookKey:c,results:b,onSelectResult:e=>{var t;R(),null==(t=m(c))||t.goTo(e)}}):(0,a.jsx)(eM,{bookDoc:W,sideBarBookKey:c}),(0,a.jsx)("div",{onMouseDown:_,className:"jsx-d9775a1d85a5e0e drag-bar absolute right-0 top-0 h-full w-0.5 cursor-col-resize"})]}),!A&&(0,a.jsx)("div",{className:"overlay fixed inset-0 z-10 bg-black/50 sm:bg-black/20",onClick:()=>{L(!1)}})]}):null};var eW=n(1183);let eO=e=>{let{isPinned:t,isSearchBarVisible:n,handleClose:l,handleTogglePin:s,handleToggleSearchBar:r}=e,o=(0,i.B)(),c=(0,es.D)(14);return(0,a.jsxs)("div",{className:"notebook-header relative flex h-11 items-center px-3",dir:"ltr",children:[(0,a.jsxs)("div",{className:"absolute inset-0 z-[-1] flex items-center justify-center space-x-2",children:[(0,a.jsx)(eW.yVo,{}),(0,a.jsx)("div",{className:"notebook-title hidden text-sm font-medium sm:flex",children:o("Notebook")})]}),(0,a.jsxs)("div",{className:"flex w-full items-center gap-x-4",children:[(0,a.jsx)("button",{onClick:s,className:(0,d.A)("btn btn-ghost btn-circle hidden h-6 min-h-6 w-6 sm:flex",t?"bg-base-300":"bg-base-300/65"),children:t?(0,a.jsx)(el.RR4,{size:c}):(0,a.jsx)(el.nDj,{size:c})}),(0,a.jsx)("button",{onClick:l,className:"btn btn-ghost btn-circle flex h-6 min-h-6 w-6 hover:bg-transparent sm:hidden",children:(0,a.jsx)(el.VR3,{})})]}),(0,a.jsx)("div",{className:"flex items-center justify-end gap-x-4",children:(0,a.jsx)("button",{onClick:r,className:(0,d.A)("btn btn-ghost h-8 min-h-8 w-8 p-0",n&&"bg-base-300"),children:(0,a.jsx)(ea.CKj,{})})})]})};var eH=n(45375);let eK=e=>{let{onSave:t,onEdit:n}=e,s=(0,i.B)(),{notebookNewAnnotation:r,notebookEditAnnotation:o,setNotebookNewAnnotation:c,setNotebookEditAnnotation:u,saveNotebookAnnotationDraft:h,getNotebookAnnotationDraft:m}=S(),f=(0,l.useRef)(null),[p,g]=l.useState(""),b=(0,es.D)(3);(0,l.useEffect)(()=>{f.current&&f.current.focus()},[f]),(0,l.useEffect)(()=>{if(o)g(o.note),f.current&&(f.current.value=o.note,f.current.focus(),x());else if(r){let e=v();if(e){let t=m((0,eH.Pr)(e))||"";g(t),f.current&&(f.current.value=t,f.current.focus(),x())}}},[r,o]);let x=()=>{f.current&&(f.current.style.height="auto",f.current.style.height="".concat(f.current.scrollHeight,"px"))},v=()=>(null==o?void 0:o.text)||(null==r?void 0:r.text)||"",w=()=>{f.current&&r?t(r,f.current.value):f.current&&o&&(o.note=f.current.value,n(o))};return(0,U.A)({onSaveNote:()=>{f.current&&f.current.value&&w()},onCloseNote:()=>{r&&c(null),o&&u(null)}}),(0,a.jsxs)("div",{className:"content note-editor-container bg-base-100 mt-2 rounded-md p-2",children:[(0,a.jsx)("div",{className:"flex w-full justify-between space-x-2",children:(0,a.jsx)("div",{className:"relative w-full",children:(0,a.jsx)("textarea",{className:(0,d.A)("note-editor textarea textarea-ghost min-h-[1em] resize-none !outline-none","inset-0 w-full rounded-none border-0 bg-transparent p-0","content font-size-sm"),dir:"auto",ref:f,value:p,rows:1,spellCheck:!1,onChange:e=>{x(),g(e.currentTarget.value)},onBlur:()=>{if(f.current&&f.current.value){let e=v();e&&h((0,eH.Pr)(e),f.current.value)}},placeholder:s("Add your notes here...")})})}),(0,a.jsxs)("div",{className:"flex items-center pt-2",children:[(0,a.jsx)("div",{className:"me-2 mt-0.5 min-h-full self-stretch rounded-xl bg-gray-300",style:{minWidth:"".concat(b,"px")}}),(0,a.jsx)("div",{className:"content font-size-sm line-clamp-3",children:(0,a.jsx)("span",{className:"content font-size-xs text-gray-500",children:v()})})]}),(0,a.jsx)("div",{className:"flex justify-end p-2",dir:"ltr",children:(0,a.jsx)("button",{className:(0,d.A)("content btn btn-ghost font-size-sm hover:bg-transparent","flex h-[1.3em] min-h-[1.3em] items-end p-0",f.current&&f.current.value?"":"btn-disabled !bg-opacity-0"),onClick:w,children:(0,a.jsx)("div",{className:"font-size-sm pr-1 align-bottom text-blue-500",children:s("Save")})})})]})},eU=e=>{let{isVisible:t,bookKey:n,searchTerm:s,onSearchResultChange:r}=e,o=(0,i.B)(),{getConfig:c}=(0,w.I)(),[d,u]=(0,l.useState)(s),h=(0,l.useRef)(null),m=(0,l.useRef)(null),f=(0,es.D)(16),p=(0,es.D)(12);(0,l.useEffect)(()=>{b(d)},[n]),(0,l.useEffect)(()=>{u(s),b(s)},[s]),(0,l.useEffect)(()=>{t&&h.current&&h.current.focus()},[t]),(0,l.useEffect)(()=>{let e=e=>{"Escape"===e.key&&h.current&&h.current.blur()};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e),m.current&&clearTimeout(m.current)}},[]);let g=(e,t)=>{if(!t.trim())return[];let n=t.toLowerCase();return e.filter(e=>{var t,a;let l=(null==(t=e.text)?void 0:t.toLowerCase().includes(n))||!1,s=(null==(a=e.note)?void 0:a.toLowerCase().includes(n))||!1;return l||s})},b=e=>{e.trim().length>=1?x(e):v()},x=e=>{let t=c(n);if(!t)return void v();let{booknotes:a=[]}=t;r(g(a.filter(e=>!e.deletedAt),e))},v=()=>{r(null)};return(0,a.jsx)("div",{className:"relative px-3 py-2",children:(0,a.jsxs)("div",{className:"bg-base-100 flex h-8 items-center rounded-lg",children:[(0,a.jsx)("div",{className:"pl-3",children:(0,a.jsx)(eR.KSO,{size:f,className:"text-gray-500"})}),(0,a.jsx)("input",{ref:h,type:"text",value:d,spellCheck:!1,onChange:e=>{let t=e.target.value;u(t),m.current&&clearTimeout(m.current),m.current=setTimeout(()=>{b(t)},300)},placeholder:o("Search notes and excerpts..."),className:"w-full bg-transparent p-2 font-sans text-sm font-light focus:outline-none"}),d&&(0,a.jsx)("div",{className:"bg-base-300 flex h-8 w-8 items-center rounded-r-lg",children:(0,a.jsx)("button",{onClick:()=>{u(""),b(""),h.current&&h.current.focus()},className:"btn btn-ghost h-8 min-h-8 w-8 rounded-none rounded-r-lg p-0",children:(0,a.jsx)(eR.QCr,{size:p,className:"text-gray-500"})})})]})})},eY=e=>{let{}=e,t=(0,i.B)(),{updateAppTheme:n}=(0,h.C)(),{envConfig:r,appService:c}=(0,s.D)(),{settings:u}=(0,o.C)(),{sideBarBookKey:m}=k(),{notebookWidth:f,isNotebookVisible:p,isNotebookPinned:g}=S(),{notebookNewAnnotation:b,notebookEditAnnotation:x,setNotebookPin:v}=S(),{getBookData:y,getConfig:C,saveConfig:A,updateBooknotes:T}=(0,w.I)(),{getView:L,getViewSettings:M}=N(),{setNotebookWidth:I,setNotebookVisible:B,toggleNotebookPin:R}=S(),{setNotebookNewAnnotation:P,setNotebookEditAnnotation:_}=S(),[D,z]=(0,l.useState)(!1),[V,W]=(0,l.useState)(null),[O,H]=(0,l.useState)(""),K=async()=>{let e=document.querySelector(".sidebar-pin-btn");e&&"none"!==window.getComputedStyle(e).display||B(!1)};(0,l.useEffect)(()=>{p?n("base-200"):n("base-100")},[p]),(0,l.useEffect)(()=>(I(u.globalReadSettings.notebookWidth),v(u.globalReadSettings.isNotebookPinned),B(u.globalReadSettings.isNotebookPinned),E.I.on("navigate",K),()=>{E.I.off("navigate",K)}),[]);let U=e=>{I(e),u.globalReadSettings.notebookWidth=e},Y=(e,t)=>{if(!m)return;let{booknotes:n=[]}=C(m),a=n.findIndex(t=>t.id===e.id);if(-1===a)return;t?e.deletedAt=Date.now():e.updatedAt=Date.now(),n[a]=e;let l=T(m,n);l&&A(r,m,l,u),_(null)},{handleDragStart:G}=(0,et.i)(e=>{let t=Math.max(.15,Math.min(.45,1-e.clientX/window.innerWidth));U("".concat(Math.round(1e4*t)/100,"%"))}),{booknotes:X=[]}=C(m)||{},q=X.filter(e=>"annotation"===e.type&&e.note&&!e.deletedAt).sort((e,t)=>t.createdAt-e.createdAt),J=X.filter(e=>"excerpt"===e.type&&e.text&&!e.deletedAt).sort((e,t)=>e.createdAt-t.createdAt),Z=(0,l.useMemo)(()=>D&&V?V.filter(e=>"annotation"===e.type&&e.note&&!e.deletedAt):q,[q,V,D]),Q=(0,l.useMemo)(()=>D&&V?V.filter(e=>"excerpt"===e.type&&e.text&&!e.deletedAt):J,[J,V,D]);if(!m)return null;let ee=y(m),en=M(m);if(!ee||!ee.bookDoc)return null;let{bookDoc:ea}=ee,el=(0,j.jk)(ea.metadata.language),es=Z.length>0||Q.length>0,ei=q.length>0||J.length>0;return p?(0,a.jsxs)(a.Fragment,{children:[!g&&(0,a.jsx)("div",{className:"overlay fixed inset-0 z-10 bg-black/20",onClick:e=>{e.preventDefault(),e.stopPropagation(),B(!1),P(null),_(null)}}),(0,a.jsxs)("div",{dir:(null==en?void 0:en.rtl)&&"rtl"===el?"rtl":"ltr",style:{width:"".concat(f),maxWidth:"".concat(45,"%"),position:g?"relative":"absolute"},className:"jsx-a7d8f087f9a680d9 "+((0,d.A)("notebook-container bg-base-200 right-0 z-20 flex min-w-60 select-none flex-col","font-sans text-base font-normal sm:text-sm",(null==c?void 0:c.isIOSApp)?"h-[100vh]":"h-full",(null==c?void 0:c.hasSafeAreaInset)&&"pt-[env(safe-area-inset-top)]",(null==c?void 0:c.hasRoundedWindow)&&"rounded-window-top-right rounded-window-bottom-right",!g&&"shadow-2xl")||""),children:[(0,a.jsx)($(),{id:"a7d8f087f9a680d9",children:"@media(max-width:640px){.notebook-container.jsx-a7d8f087f9a680d9{width:100%;min-width:100%}}"}),(0,a.jsx)("div",{onMouseDown:G,className:"jsx-a7d8f087f9a680d9 drag-bar absolute left-0 top-0 h-full w-0.5 cursor-col-resize"}),(0,a.jsxs)("div",{className:"jsx-a7d8f087f9a680d9 flex-shrink-0",children:[(0,a.jsx)(eO,{isPinned:g,isSearchBarVisible:D,handleClose:()=>B(!1),handleTogglePin:()=>{R(),u.globalReadSettings.isNotebookPinned=!g},handleToggleSearchBar:()=>{z(e=>!e),D&&(W(null),H(""))}}),(0,a.jsx)("div",{className:"jsx-a7d8f087f9a680d9 "+((0,d.A)("search-bar",{"search-bar-visible":D})||""),children:(0,a.jsx)(eU,{isVisible:D,bookKey:m,searchTerm:O,onSearchResultChange:W})})]}),(0,a.jsxs)("div",{className:"jsx-a7d8f087f9a680d9 flex-grow overflow-y-auto px-3",children:[D&&V&&!es&&ei&&(0,a.jsx)("div",{className:"jsx-a7d8f087f9a680d9 flex h-32 items-center justify-center text-gray-500",children:(0,a.jsx)("p",{className:"jsx-a7d8f087f9a680d9 font-size-sm text-center",children:t("No notes match your search")})}),(0,a.jsx)("div",{dir:"ltr",className:"jsx-a7d8f087f9a680d9",children:Q.length>0&&(0,a.jsxs)("p",{className:"jsx-a7d8f087f9a680d9 content font-size-base",children:[t("Excerpts"),D&&V&&(0,a.jsxs)("span",{className:"jsx-a7d8f087f9a680d9 font-size-xs ml-2 text-gray-500",children:["(",Q.length,")"]})]})}),(0,a.jsx)("ul",{className:"jsx-a7d8f087f9a680d9 ",children:Q.map((e,n)=>(0,a.jsx)("li",{className:"jsx-a7d8f087f9a680d9 my-2",children:(0,a.jsxs)("div",{tabIndex:0,className:"jsx-a7d8f087f9a680d9 collapse-arrow border-base-300 bg-base-100 collapse border",children:[(0,a.jsx)("div",{style:{"--top-override":"1.25rem","--end-override":"0.7rem"},className:"jsx-a7d8f087f9a680d9 "+((0,d.A)("collapse-title pe-8 text-sm font-medium","h-[2.5rem] min-h-[2.5rem] p-[0.6rem]")||""),children:(0,a.jsx)("p",{className:"jsx-a7d8f087f9a680d9 line-clamp-1",children:e.text||"Excerpt ".concat(n+1)})}),(0,a.jsxs)("div",{className:"jsx-a7d8f087f9a680d9 collapse-content font-size-xs select-text px-3 pb-0",children:[(0,a.jsx)("p",{className:"jsx-a7d8f087f9a680d9 hyphens-auto text-justify",children:e.text}),(0,a.jsx)("div",{dir:"ltr",className:"jsx-a7d8f087f9a680d9 flex justify-end",children:(0,a.jsx)("div",{onClick:Y.bind(null,e,!0),className:"jsx-a7d8f087f9a680d9 font-size-xs cursor-pointer align-bottom text-red-500 hover:text-red-600",children:t("Delete")})})]})]})},"".concat(n,"-").concat(e.id)))}),(0,a.jsx)("div",{dir:"ltr",className:"jsx-a7d8f087f9a680d9",children:(b||Z.length>0)&&(0,a.jsxs)("p",{className:"jsx-a7d8f087f9a680d9 content font-size-base",children:[t("Notes"),D&&V&&Z.length>0&&(0,a.jsxs)("span",{className:"jsx-a7d8f087f9a680d9 font-size-xs ml-2 text-gray-500",children:["(",Z.length,")"]})]})}),(b||x)&&!D&&(0,a.jsx)(eK,{onSave:(e,t)=>{if(!m)return;let n=L(m),a=C(m),l=null==n?void 0:n.getCFI(e.index,e.range);if(!l)return;let{booknotes:s=[]}=a,i={id:(0,F.NF)(),type:"annotation",cfi:l,note:t,text:e.text,createdAt:Date.now(),updatedAt:Date.now()};s.push(i);let o=T(m,s);o&&A(r,m,o,u),P(null)},onEdit:e=>Y(e,!1)}),(0,a.jsx)("ul",{className:"jsx-a7d8f087f9a680d9",children:Z.map((e,t)=>(0,a.jsx)(eC,{bookKey:m,item:e},"".concat(t,"-").concat(e.cfi)))})]})]})]}):null},eG=e=>{let t=e.addAnnotation.bind(e);return e.addAnnotation=function(e){let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return t({value:e.cfi,...e},n)},e};var eX=n(40078);let eq=(e,t,n)=>{let{hoveredBookKey:a}=N(),s=(0,eX.s)(n,500),i=(0,eX.s)(t,100),r=n=>{n instanceof MessageEvent?n.data&&n.data.bookKey===e&&("iframe-wheel"===n.data.type&&s("mouse",-n.data.deltaY,0),"iframe-wheel"===n.data.type?i(n):t(n)):"wheel"===n.type?s("mouse",-n.deltaY,0):t(n)};return(0,l.useEffect)(()=>(window.addEventListener("message",r),()=>{window.removeEventListener("message",r)}),[e,a]),{onClick:t,onWheel:r}},eJ=(e,t)=>{let{hoveredBookKey:n,setHoveredBookKey:a,getViewSettings:s}=N(),i=null,r=null,o=e=>{r=null;let t=e.targetTouches[0];t&&(i=t)},c=t=>{if(!i)return;let l=t.targetTouches[0];if(l&&(r=l),n&&r){let t=s(e),n=r.screenY-i.screenY,l=r.screenX-i.screenX;t.scrolled||t.vertical?a(null):Math.abs(l)>Math.abs(n)&&Math.abs(l)>10&&a(null)}},d=l=>{if(!i)return;let o=l.targetTouches[0];o&&(r=o);let c=window.innerWidth;if(r){let l=s(e),o=r.screenY-i.screenY,d=r.screenX-i.screenX;o<-10&&Math.abs(o)>Math.abs(d)&&Math.abs(d)<.3*c?l.scrolled||l.vertical||a(n?null:e):n&&a(null),t("touch",o,30)}i=null,r=null},u=t=>{t.data&&t.data.bookKey===e&&("iframe-touchstart"===t.data.type?o(t.data):"iframe-touchmove"===t.data.type?c(t.data):"iframe-touchend"===t.data.type&&d(t.data))};return(0,l.useEffect)(()=>(window.addEventListener("message",u),()=>{window.removeEventListener("message",u)}),[n]),{onTouchStart:o,onTouchMove:c,onTouchEnd:d}},eZ=(e,t)=>{let n=null==t?void 0:t.onLoad,a=null==t?void 0:t.onRelocate,s=null==t?void 0:t.onLinkClick,i=null==t?void 0:t.onRendererRelocate,r=null==t?void 0:t.onDrawAnnotation,o=null==t?void 0:t.onShowAnnotation;(0,l.useEffect)(()=>{if(e)return n&&e.addEventListener("load",n),a&&e.addEventListener("relocate",a),s&&e.addEventListener("link",s),i&&e.renderer.addEventListener("relocate",i),r&&e.addEventListener("draw-annotation",r),o&&e.addEventListener("show-annotation",o),()=>{n&&e.removeEventListener("load",n),a&&e.removeEventListener("relocate",a),s&&e.removeEventListener("link",s),i&&e.renderer.removeEventListener("relocate",i),r&&e.removeEventListener("draw-annotation",r),o&&e.removeEventListener("show-annotation",o)}},[e])};var eQ=n(46450),e$=n(56945),e0=n(72997);let e1=e=>{let t=(0,i.B)(),{getConfig:n,setConfig:a}=(0,w.I)(),{getView:s,getProgress:r}=N(),{settings:c}=(0,o.C)(),{syncedConfigs:d,syncConfigs:u}=(0,e$.p)(e),{user:h}=(0,eQ.A)(),m=s(e),p=n(e),g=r(e),b=(0,l.useRef)(!1),x=(0,l.useRef)(!1),v=(e,t)=>{if(!t||!h)return;let n=e.split("-")[0],a={bookHash:n,...t},l=JSON.parse((0,e0.Lg)(a,c.globalViewSettings,O.e3));delete l.booknotes,u([l],n,"push")},y=e=>{h&&u([],e.split("-")[0],"pull")},j=()=>{if(b.current){let t=n(e);t&&t.progress&&t.progress[0]>0&&v(e,t)}else y(e)},k=t=>{let{bookKey:n}=t.detail;n===e&&j()};(0,l.useEffect)(()=>(E.I.on("sync-book-progress",k),()=>{E.I.off("sync-book-progress",k)}),[e]);let S=(0,l.useCallback)((0,eX.s)(()=>{j()},1e3*O.Uy),[]);(0,l.useEffect)(()=>{(null==g?void 0:g.location)&&h&&S()},[g]),(0,l.useEffect)(()=>{g&&!x.current&&(x.current=!0,y(e))},[g]),(0,l.useEffect)(()=>{if(!b.current&&d){b.current=!0;let n=d.filter(t=>t.bookHash===e.split("-")[0])[0];if(n){let l=null==p?void 0:p.location,s=n.location;a(e,n),s&&l&&0>f.HY.compare(l,s)&&m&&(m.goTo(s),E.I.dispatch("hint",{bookKey:e,message:t("Reading Progress Synced")}))}}},[d])};var e2=n(25289);let e8=e=>{let{envConfig:t}=(0,s.D)(),{getConfig:n,saveConfig:a}=(0,w.I)(),{getProgress:i}=N(),r=i(e),c=(0,l.useCallback)((0,e2.n)(async()=>{let l=n(e),s=o.C.getState().settings;await a(t,e,l,s)},1e4),[]);(0,l.useEffect)(()=>{c()},[r,e])},e3=e=>{let{getViewSettings:t}=N(),n=t(e),[a,s]=(0,l.useState)(null);(0,l.useEffect)(()=>{if(!n)return;a&&a.remove();let t=n.userStylesheet||"",l=document.createElement("style");return l.textContent=t.replace("foliate-view","#foliate-view-".concat(e)),document.head.appendChild(l),s(l),()=>{l.remove()}},[n])},e5=!O.bF||!["android","ios"].includes((0,F.Ox)()),e6=0,e4=null,e9=(e,t)=>{["Backspace","ArrowDown","ArrowUp"].includes(t.key)&&t.preventDefault(),window.postMessage({type:"iframe-keydown",bookKey:e,key:t.key,code:t.code,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,altKey:t.altKey,metaKey:t.metaKey},"*")},e7=(e,t)=>{e4=setTimeout(()=>{e4=null},O.dU),window.postMessage({type:"iframe-mousedown",bookKey:e,button:t.button,screenX:t.screenX,screenY:t.screenY,clientX:t.clientX,clientY:t.clientY,offsetX:t.offsetX,offsetY:t.offsetY},"*")},te=(e,t)=>{[3,4].includes(t.button)&&t.preventDefault(),window.postMessage({type:"iframe-mouseup",bookKey:e,button:t.button,screenX:t.screenX,screenY:t.screenY,clientX:t.clientX,clientY:t.clientY,offsetX:t.offsetX,offsetY:t.offsetY},"*")},tt=(e,t)=>{window.postMessage({type:"iframe-wheel",bookKey:e,deltaMode:t.deltaMode,deltaX:t.deltaX,deltaY:t.deltaY,deltaZ:t.deltaZ,screenX:t.screenX,screenY:t.screenY,clientX:t.clientX,clientY:t.clientY,offsetX:t.offsetX,offsetY:t.offsetY},"*")},tn=(e,t)=>{let n=Date.now();if(e5&&n-e6<O.wI){e6=n,window.postMessage({type:"iframe-double-click",bookKey:e,screenX:t.screenX,screenY:t.screenY,clientX:t.clientX,clientY:t.clientY,offsetX:t.offsetX,offsetY:t.offsetY},"*");return}e6=n;let a=()=>{let n=t.target;for(;n;){if(["sup","a","audio","video"].includes(n.tagName.toLowerCase()))return;if(n.classList.contains("js_readerFooterNote")||n.classList.contains("zhangyue-footnote"))return void E.I.dispatch("footnote-popup",{bookKey:e,element:n,footnote:n.getAttribute("data-wr-footernote")||n.getAttribute("zy-footnote")||""});n=n.parentElement}e4&&window.postMessage({type:"iframe-single-click",bookKey:e,screenX:t.screenX,screenY:t.screenY,clientX:t.clientX,clientY:t.clientY,offsetX:t.offsetX,offsetY:t.offsetY},"*")};e5?setTimeout(()=>{Date.now()-e6>=O.wI&&a()},O.wI):a()},ta=(e,t,n)=>{let a=t.targetTouches[0],l=[];a&&l.push({clientX:a.clientX,clientY:a.clientY,screenX:a.screenX,screenY:a.screenY}),window.postMessage({type:n,bookKey:e,targetTouches:l},"*")},tl=(e,t)=>{ta(e,t,"iframe-touchstart")},ts=(e,t)=>{ta(e,t,"iframe-touchmove")},ti=(e,t)=>{ta(e,t,"iframe-touchend")};var tr=n(64067),to=n(91225);let tc={"“":"﹃","”":"﹄","‘":"﹁","’":"﹂"},td=[{name:"punctuation",transform:async e=>{if(!0!==e.viewSettings.vertical)return e.content;let t=e.content;for(let[n,a]of Object.entries(tc))t=e.reversePunctuationTransform?t.replace(RegExp(a,"g"),n):t.replace(RegExp(n,"g"),a);return t}},{name:"footnote",transform:async e=>{let t=e.content;return t.replace(/<aside\s+epub:type\s*=\s*["'](footnote|endnote|note|rearnote)["']([^>]*)>/gi,'<aside class="epubtype-footnote" epub:type="$1"$2>')}}],tu=async e=>{let t=e.content;for(let n of e.transformers.map(e=>td.find(t=>t.name===e)).filter(e=>!!e))try{t=await n.transform({...e,content:t})}catch(e){console.warn("Error in transformer ".concat(n.name,":"),e)}return t},th=e=>{let{bookKey:t,bookDoc:i,config:r}=e,{appService:o}=(0,s.D)(),c=(0,l.useRef)(null),d=(0,l.useRef)(null),u=(0,l.useRef)(!1),{getView:m,setView:p,setProgress:g}=N(),{getViewSettings:b,setViewSettings:x}=N(),{getParallels:v}=H(),{getBookData:y}=(0,w.I)(),{themeCode:k,isDarkMode:S}=(0,h.C)(),[C,A]=(0,l.useState)("");(0,l.useEffect)(()=>{let e=setTimeout(()=>A(""),2e3);return()=>clearTimeout(e)},[C]),e3(t),e1(t),e8(t),eg(t,d.current);let E=e=>{let{width:n,height:a}=e;return e=>{let{detail:l}=e;l.data=Promise.resolve(l.data).then(e=>{let s=b(t);return s&&"text/css"===l.type?(0,Y.Jp)(s,n,a,e):s&&"application/xhtml+xml"===l.type?Promise.resolve(tu({bookKey:t,viewSettings:s,content:e,transformers:["punctuation","footnote"]})):e}).catch(e=>(console.error(Error("Failed to load ".concat(l.name),{cause:e})),""))}},{handlePageFlip:T,handleContinuousScroll:L}=X(t,d,c),M=eq(t,T,L),R=eJ(t,L);return eZ(d.current,{onLoad:e=>{let n=e.detail;if(console.log("doc index loaded:",n.index),n.doc){var a,l;let e=(null==(a=d.current)?void 0:a.renderer.setStyles)&&(0,f.u6)(n.doc),s=b(t),i=y(t);s.vertical=(null==e?void 0:e.vertical)||s.writingMode.includes("vertical")||!1,s.rtl=(null==e?void 0:e.rtl)||"rtl"===(0,to.A)()||s.writingMode.includes("rl")||!1,x(t,{...s}),(0,I.D)(n.doc,(0,ep.zp)(null==(l=i.book)?void 0:l.primaryLanguage)),n.doc.isEventListenersAdded||(n.doc.isEventListenersAdded=!0,n.doc.addEventListener("keydown",e9.bind(null,t)),n.doc.addEventListener("mousedown",e7.bind(null,t)),n.doc.addEventListener("mouseup",te.bind(null,t)),n.doc.addEventListener("click",tn.bind(null,t)),n.doc.addEventListener("wheel",tt.bind(null,t)),n.doc.addEventListener("touchstart",tl.bind(null,t)),n.doc.addEventListener("touchmove",ts.bind(null,t)),n.doc.addEventListener("touchend",ti.bind(null,t)))}},onRelocate:e=>{let n=e.detail;g(t,n.cfi,n.tocItem,n.section,n.location,n.time,n.range)},onRendererRelocate:e=>{let n=e.detail;if("scroll"!==n.reason&&"page"!==n.reason)return;let a=v(t);a&&a.size>0&&a.forEach(e=>{if(e!==t){var a,l;let t=null==(a=m(e))?void 0:a.renderer;t&&(null==(l=t.goTo)||l.call(t,{index:n.index,anchor:n.fraction}))}})}}),(0,l.useEffect)(()=>{if(d.current&&d.current.renderer){var e,n;let a=b(t);null==(e=(n=d.current.renderer).setStyles)||e.call(n,(0,Y.$f)(a))}},[k,S]),(0,l.useEffect)(()=>{u.current||(u.current=!0,(async()=>{var e,a,l,s,u;console.log("Opening book",t),await n.e(9622).then(n.bind(n,99622));let h=eG(document.createElement("foliate-view"));h.id="foliate-view-".concat(t),document.body.append(h),null==(e=c.current)||e.appendChild(h);let m=null==(a=c.current)?void 0:a.getBoundingClientRect(),f=(null==m?void 0:m.width)||window.innerWidth,g=(null==m?void 0:m.height)||window.innerHeight,x=b(t),v=x.writingMode;if(v){let e=(0,j.is)(v),t=(0,j.jk)(i.metadata.language);"auto"!==e?i.dir=e:"auto"!==t&&(i.dir=t)}await h.open(i),d.current=h,p(t,h);let{book:w}=h;null==(l=w.transformTarget)||l.addEventListener("data",E({width:f,height:g})),null==(s=(u=h.renderer).setStyles)||s.call(u,(0,Y.$f)(x));let y=x.scrolled,N=x.showHeader,k=x.showFooter,S=!N&&!k,C=S?x.compactMarginPx:x.marginPx,A=S?x.compactGapPercent:x.gapPercent,T=x.animated,L=x.maxColumnCount,M=(0,tr.Jt)(x),I=x.maxBlockSize,R=x.screenOrientation;(null==o?void 0:o.isMobileApp)&&await (0,B.ot)({orientation:R}),T?h.renderer.setAttribute("animated",""):h.renderer.removeAttribute("animated"),h.renderer.setAttribute("flow",y?"scrolled":"paginated"),h.renderer.setAttribute("margin","".concat(C,"px")),h.renderer.setAttribute("gap","".concat(A,"%")),h.renderer.setAttribute("max-column-count",L),h.renderer.setAttribute("max-inline-size","".concat(M,"px")),h.renderer.setAttribute("max-block-size","".concat(I,"px"));let P=r.location;P?await h.init({lastLocation:P}):await h.goToFraction(0)})())},[]),(0,a.jsx)(a.Fragment,{children:(0,a.jsx)("div",{ref:c,className:"foliate-viewer h-[100%] w-[100%]",...M,...R})})},tm=(e,t)=>e<=1?{columns:"1fr",rows:"1fr"}:2===e?t<1?{columns:"1fr",rows:"1fr 1fr"}:{columns:"1fr 1fr",rows:"1fr"}:3===e||4===e?{columns:"1fr 1fr",rows:"1fr 1fr"}:{columns:"1fr 1fr 1fr",rows:"1fr 1fr 1fr"},tf=e=>{let{section:t,showDoubleBorder:n,isScrolled:l,isVertical:s,horizontalGap:i,verticalMargin:r}=e;return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:(0,d.A)("absolute left-0 right-0 top-0 z-10 h-[env(safe-area-inset-top)]",l&&!s&&"bg-base-100")}),(0,a.jsx)("div",{className:(0,d.A)("sectioninfo absolute flex items-center overflow-hidden","mt-[env(safe-area-inset-top)]",s?"writing-vertical-rl max-h-[85%]":"top-0 h-[44px]",l&&!s&&"bg-base-100"),style:s?{top:"".concat(1.5*r,"px"),left:"calc(100% - ".concat(i,"%)"),width:n?"32px":"".concat(i,"%"),height:"calc(100% - ".concat(2*r,"px)")}:{insetInlineStart:"".concat(i,"%"),width:"calc(100% - ".concat(2*i,"%)")},children:(0,a.jsx)("h2",{className:(0,d.A)("text-neutral-content text-center font-sans text-xs font-light",s?"":"line-clamp-1"),children:t||""})})]})};var tp=n(77553),tg=n(20856);let tb=e=>{let{icon:t,onClick:n,disabled:l=!1,tooltip:i,tooltipDirection:r="top",className:o}=e,{appService:c}=(0,s.D)();return(0,a.jsx)("div",{className:(0,d.A)("lg:tooltip z-50 h-8 min-h-8 w-8",i&&"lg:tooltip-".concat(r),{"tooltip-hidden":!i}),"data-tip":i,children:(0,a.jsx)("button",{className:(0,d.A)("btn btn-ghost h-8 min-h-8 w-8 p-0",(null==c?void 0:c.isMobileApp)&&"hover:bg-transparent",l&&"btn-disabled !bg-transparent opacity-50",o),onClick:l?void 0:n,disabled:l,children:t})})},tx=e=>{let{bookKey:t}=e,n=(0,i.B)(),{sideBarBookKey:l,isSideBarVisible:s,setSideBarBookKey:r,toggleSideBar:o}=k(),{setHoveredBookKey:c}=N();return(0,a.jsx)(tb,{icon:l===t&&s?(0,a.jsx)(tg.NJu,{className:"text-base-content"}):(0,a.jsx)(tg.ZXb,{className:"text-base-content"}),onClick:()=>{l===t?o():(r(t),s||o()),c("")},tooltip:n("Sidebar"),tooltipDirection:"bottom"})},tv=e=>{let{bookKey:t}=e,n=(0,i.B)(),{envConfig:r}=(0,s.D)(),{settings:c}=(0,o.C)(),{getConfig:d,saveConfig:u,getBookData:h,updateBooknotes:m}=(0,w.I)(),{getProgress:f,setBookmarkRibbonVisibility:p}=N(),g=d(t),b=f(t),x=h(t),[v,y]=(0,l.useState)(!1);return(0,l.useEffect)(()=>{let{booknotes:e=[]}=g||{},{location:n}=b||{};if(!n)return;let a=eN.collapse(n),l=eN.collapse(n,!0),s=e.filter(e=>"bookmark"===e.type&&!e.deletedAt).some(e=>eN.compare(a,e.cfi)*eN.compare(l,e.cfi)<=0);y(s),p(t,s)},[g,b]),(0,a.jsx)(tb,{icon:v?(0,a.jsx)(el.cgZ,{className:"text-base-content"}):(0,a.jsx)(el.DTu,{className:"text-base-content"}),onClick:()=>{let{booknotes:e=[]}=g,{location:n,range:a}=b;if(n)if(v){y(!1);let a=eN.collapse(n),l=eN.collapse(n,!0);e.forEach(e=>{"bookmark"===e.type&&eN.compare(a,e.cfi)*eN.compare(l,e.cfi)<=0&&(e.deletedAt=Date.now())});let s=m(t,e);s&&u(r,t,s,c)}else{var l;y(!0);let s=(null==a||null==(l=a.startContainer.textContent)?void 0:l.slice(0,128))||"",i=128===s.length?s+"...":s,o={id:(0,F.NF)(),type:"bookmark",cfi:n,text:i||"".concat((0,j.p$)(x.book,b)),note:"",createdAt:Date.now(),updatedAt:Date.now()},d=e.find(e=>"bookmark"===e.type&&e.cfi===n);d?(d.deletedAt=null,d.updatedAt=Date.now(),d.text=o.text):e.push(o);let h=m(t,e);h&&u(r,t,h,c)}},tooltip:n("Bookmark"),tooltipDirection:"bottom"})},tw=e=>{let{bookKey:t}=e,n=(0,i.B)(),{appService:l}=(0,s.D)(),{setHoveredBookKey:r}=N(),{sideBarBookKey:o,setSideBarBookKey:c}=k(),{isNotebookVisible:d,toggleNotebook:u}=S(),h=(0,es.D)(16);return(0,a.jsx)(tb,{icon:(0,a.jsx)(eW.yVo,{size:h,className:"text-base-content"}),onClick:()=>{(null==l?void 0:l.isMobile)&&r(""),o===t?u():(c(t),d||u())},tooltip:n("Notebook"),tooltipDirection:"bottom"})};var ty=n(69273);let tj=()=>{let e=(0,i.B)(),{setHoveredBookKey:t}=N(),{isFontLayoutSettingsDialogOpen:n,setFontLayoutSettingsDialogOpen:l}=(0,o.C)();return(0,a.jsx)(tb,{icon:(0,a.jsx)(ty.Oui,{className:"text-base-content"}),onClick:()=>{t(""),l(!n)},tooltip:e("Font & Layout"),tooltipDirection:"bottom"})},tN=async function(e,t,n,a){let l=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=!(arguments.length>5)||void 0===arguments[5]||arguments[5],{settings:i,isFontLayoutSettingsGlobal:r,setSettings:c,saveSettings:d}=o.C.getState(),{getView:u,getViewSettings:h,setViewSettings:m}=N.getState(),{getConfig:f,saveConfig:p}=w.I.getState(),g=h(t),b=f(t);if(g[n]!==a&&(g[n]=a,s)){var x,v;let e=u(t);null==e||null==(x=(v=e.renderer).setStyles)||x.call(v,(0,Y.$f)(g))}m(t,g),r&&!l&&(i.globalViewSettings[n]=a,c(i)),await p(e,t,b,i),await d(e,i)},tk=e=>{var t,n;let{bookKey:r}=e,o=(0,i.B)(),{envConfig:c,appService:d}=(0,s.D)(),{getBookData:u}=(0,w.I)(),{getViewSettings:h,setViewSettings:m,setHoveredBookKey:f}=N(),p=u(r),g=h(r),[b,x]=(0,l.useState)(g.translationEnabled),v=null==p||null==(t=p.book)?void 0:t.primaryLanguage,y=g.translateTargetLang;return(0,l.useEffect)(()=>{b!==g.translationEnabled&&((null==d?void 0:d.isMobile)&&f(""),tN(c,r,"translationEnabled",b,!0,!1),g.translationEnabled=b,m(r,{...g}))},[b]),(0,a.jsx)(tb,{icon:(0,a.jsx)(ty.KgB,{className:b?"text-blue-500":"text-base-content"}),disabled:!p||(null==(n=p.book)?void 0:n.format)==="PDF"||(0,ep.R1)(v,y)||!y&&(0,ep.R1)(v,(0,F.JK)()),onClick:()=>x(!b),tooltip:o(b?"Disable Translation":"Enable Translation"),tooltipDirection:"bottom"})};var tS=n(35785);let tC=e=>{let{bookKey:t,setIsDropdownOpen:n,onSetSettingsDialogOpen:r}=e,o=(0,i.B)(),c=(0,D.useRouter)(),{user:u}=(0,eQ.A)(),{envConfig:m,appService:f}=(0,s.D)(),{getConfig:p}=(0,w.I)(),{getView:g,getViewSettings:b,setViewSettings:x}=N(),v=p(t),y=b(t),{themeMode:j,isDarkMode:k,setThemeMode:S}=(0,h.C)(),[C,A]=(0,l.useState)(y.scrolled),[T,L]=(0,l.useState)(y.zoomLevel),[M,I]=(0,l.useState)(y.invertImgColorInDark);(0,l.useEffect)(()=>{var e,n,a,l,s;C!==y.scrolled&&(y.scrolled=C,null==(e=g(t))||e.renderer.setAttribute("flow",C?"scrolled":"paginated"),null==(n=g(t))||n.renderer.setAttribute("max-inline-size","".concat((0,tr.Jt)(y),"px")),null==(l=g(t))||null==(a=(s=l.renderer).setStyles)||a.call(s,(0,Y.$f)(y)),x(t,y))},[C]),(0,l.useEffect)(()=>{tN(m,t,"zoomLevel",T,!0,!0)},[T]),(0,l.useEffect)(()=>{M!==y.invertImgColorInDark&&tN(m,t,"invertImgColorInDark",M,!0,!0)},[M]);let B=Math.max((null==v?void 0:v.lastSyncedAtConfig)||0,(null==v?void 0:v.lastSyncedAtNotes)||0);return(0,a.jsxs)("div",{tabIndex:0,className:"view-menu dropdown-content bgcolor-base-200 dropdown-right no-triangle border-base-200 z-20 mt-1 border shadow-2xl",children:[(0,a.jsxs)("div",{className:(0,d.A)("flex items-center justify-between rounded-md"),children:[(0,a.jsx)("button",{onClick:()=>L(e=>Math.max(e-O.bL,O.cA)),className:(0,d.A)("hover:bg-base-300 text-base-content rounded-full p-2",T<=O.cA&&"btn-disabled text-gray-400"),children:(0,a.jsx)(el.f5Z,{})}),(0,a.jsxs)("button",{className:(0,d.A)("hover:bg-base-300 text-base-content h-8 min-h-8 w-[50%] rounded-md p-1 text-center"),onClick:()=>L(100),children:[T,"%"]}),(0,a.jsx)("button",{onClick:()=>L(e=>Math.min(e+O.bL,O.ec)),className:(0,d.A)("hover:bg-base-300 text-base-content rounded-full p-2",T>=O.ec&&"btn-disabled text-gray-400"),children:(0,a.jsx)(el.gff,{})})]}),(0,a.jsx)("hr",{className:"border-base-300 my-1"}),(0,a.jsx)(ec.A,{label:o("Font & Layout"),shortcut:"Shift+F",onClick:()=>{null==n||n(!1),r(!0)}}),(0,a.jsx)(ec.A,{label:o("Scrolled Mode"),shortcut:"Shift+J",Icon:C?el.g9_:void 0,onClick:()=>A(!C)}),(0,a.jsx)("hr",{className:"border-base-300 my-1"}),(0,a.jsx)(ec.A,{label:u?B?o("Synced at {{time}}",{time:new Date(B).toLocaleString()}):o("Never synced"):o("Sign in to Sync"),Icon:u?el.Jtm:el.OdU,onClick:()=>{u?E.I.dispatch("sync-book-progress",{bookKey:t}):((0,W.OO)(c),null==n||n(!1))}}),(0,a.jsx)("hr",{className:"border-base-300 my-1"}),(null==f?void 0:f.hasWindow)&&(0,a.jsx)(ec.A,{label:o("Fullscreen"),onClick:()=>{(0,V.tP)(),null==n||n(!1)}}),(0,a.jsx)(ec.A,{label:o("dark"===j?"Dark Mode":"light"===j?"Light Mode":"Auto Mode"),Icon:"dark"===j?tS.vVA:"light"===j?tS.q9U:tg.eV8,onClick:()=>{S("auto"===j?"light":"light"===j?"dark":"auto")}}),(0,a.jsx)(ec.A,{label:o("Invert Image In Dark Mode"),disabled:!k,Icon:M?el.g9_:void 0,onClick:()=>I(!M)})]})},tA=e=>{let{bookKey:t,bookTitle:n,isTopLeft:i,isHoveredAnim:r,onCloseBook:o,onSetSettingsDialogOpen:c}=e,{appService:u}=(0,s.D)(),m=(0,l.useRef)(null),{isTrafficLightVisible:f,setTrafficLightVisibility:p,initializeTrafficLightStore:g,initializeTrafficLightListeners:b,cleanupTrafficLightListeners:x}=(0,ei.w)(),[v,w]=(0,l.useState)(!1),{bookKeys:y,hoveredBookKey:j,setHoveredBookKey:S}=N(),{systemUIVisible:C,statusBarHeight:A}=(0,h.C)(),{isSideBarVisible:E}=k(),T=(0,es.D)(16);(0,l.useEffect)(()=>{if(null==u?void 0:u.hasTrafficLight)return g(u),b(),p(!0),()=>{x()}},[]),(0,l.useEffect)(()=>{(null==u?void 0:u.hasTrafficLight)&&p(E)},[E]);let L=j===t||v;return(0,a.jsxs)("div",{className:(0,d.A)("bg-base-100 absolute top-0 w-full",(null==u?void 0:u.hasSafeAreaInset)&&"pt-[env(safe-area-inset-top)]"),children:[(0,a.jsx)("div",{className:(0,d.A)("absolute top-0 z-10 hidden h-11 w-full sm:flex"),onMouseEnter:()=>!(null==u?void 0:u.isMobile)&&S(t),onTouchStart:()=>!(null==u?void 0:u.isMobile)&&S(t)}),(0,a.jsx)("div",{className:(0,d.A)("bg-base-100 absolute left-0 right-0 top-0 z-10 h-[env(safe-area-inset-top)]",L?"visible":"hidden"),style:{height:C?"max(env(safe-area-inset-top), ".concat(A,"px)"):""}}),(0,a.jsxs)("div",{ref:m,className:(0,d.A)("header-bar bg-base-100 absolute top-0 z-10 flex h-11 w-full items-center pr-4","shadow-xs transition-[opacity,margin-top] duration-300",f&&i&&!E?"pl-16":"pl-4",(null==u?void 0:u.hasRoundedWindow)&&"rounded-window-top-right",!E&&(null==u?void 0:u.hasRoundedWindow)&&"rounded-window-top-left",r&&"hover-bar-anim",L?"pointer-events-auto visible":"pointer-events-none opacity-0",v&&"header-bar-pinned"),style:{marginTop:C?"max(env(safe-area-inset-top), ".concat(A,"px)"):"env(safe-area-inset-top)"},onMouseLeave:()=>!(null==u?void 0:u.isMobile)&&S(""),children:[(0,a.jsxs)("div",{className:"sidebar-bookmark-toggler z-20 flex h-full items-center gap-x-4",children:[(0,a.jsx)("div",{className:"hidden sm:flex",children:(0,a.jsx)(tx,{bookKey:t})}),(0,a.jsx)(tv,{bookKey:t}),(0,a.jsx)(tk,{bookKey:t})]}),(0,a.jsx)("div",{className:"header-title z-15 bg-base-100 pointer-events-none absolute inset-0 hidden items-center justify-center sm:flex",children:(0,a.jsx)("h2",{className:"line-clamp-1 max-w-[50%] text-center text-xs font-semibold",children:n})}),(0,a.jsxs)("div",{className:"bg-base-100 z-20 ml-auto flex h-full items-center space-x-4",children:[(0,a.jsx)(tj,{}),(0,a.jsx)(tw,{bookKey:t}),(0,a.jsx)(er.A,{className:"exclude-title-bar-mousedown dropdown-bottom dropdown-end",buttonClassName:"btn btn-ghost h-8 min-h-8 w-8 p-0",toggleButton:(0,a.jsx)(eT.Pwf,{size:T}),onToggle:e=>{w(e),e||S("")},children:(0,a.jsx)(tC,{bookKey:t,onSetSettingsDialogOpen:c})}),(0,a.jsx)(tp.A,{className:"window-buttons flex h-full items-center",headerRef:m,showMinimize:1==y.length&&!f&&(null==u?void 0:u.appPlatform)!=="web",showMaximize:1==y.length&&!f&&(null==u?void 0:u.appPlatform)!=="web",onClose:()=>{S(null),o(t)}})]})]})]})};var tE=n(1585),tT=n(91088);let tL=e=>{let{min:t=0,max:n=100,step:s=1,initialValue:i=50,heightPx:r=40,minLabel:o="",maxLabel:c="",bubbleElement:d,bubbleLabel:u="",className:h="",minClassName:m="",maxClassName:f="",bubbleClassName:p="",onChange:g}=e,[b,x]=(0,l.useState)(i),[v,w]=(0,l.useState)(!1),y=(0,l.useRef)(null);(0,l.useEffect)(()=>{let e=y.current;for(;e;){if("rtl"===e.getAttribute("dir")){w(!0);break}e=e.parentElement}},[]),(0,l.useEffect)(()=>{x(i)},[i]);let j=(b-t)/(n-t)*100;return(0,a.jsx)("div",{ref:y,className:"slider bg-base-200 mx-auto w-full rounded-xl ".concat(h),dir:v?"rtl":void 0,children:(0,a.jsxs)("div",{className:"relative",style:{height:"".concat(r,"px")},children:[(0,a.jsx)("div",{className:"bg-base-300/40 absolute h-full w-full rounded-full"}),(0,a.jsx)("div",{className:"bg-base-300 absolute h-full rounded-full",style:{width:j>0?"max(calc(".concat(j,"% + ").concat(r/2,"px), ").concat(r,"px)"):"0px",[v?"right":"left"]:0}}),(0,a.jsxs)("div",{className:"absolute inset-0 flex items-center justify-between px-4 text-sm",children:[(0,a.jsx)("span",{className:"ml-2 ".concat(m),children:o}),(0,a.jsx)("span",{className:"mr-2 ".concat(f),children:c})]}),(0,a.jsx)("div",{className:"pointer-events-none absolute top-0 z-10",style:{[v?"right":"left"]:"max(".concat(r/2,"px, calc(").concat(j,"%))"),transform:v?"translateX(calc(50%))":"translateX(calc(-50%))",height:"100%"},children:(0,a.jsx)("div",{className:"bg-base-200 flex h-full items-center justify-center rounded-full text-xs shadow-md ".concat(p),style:{width:"".concat(r,"px")},children:d||u})}),(0,a.jsx)("input",{type:"range",min:t,max:n,step:s,value:b,className:"absolute inset-0 h-full w-full cursor-pointer opacity-0",onChange:e=>{let t=parseInt(e.target.value,10);x(t),g&&g(t)}})]})})},tM=e=>{var t,n,r,o,c;let{bookKey:u,bookFormat:h,section:m,pageinfo:f,isHoveredAnim:p}=e,g=(0,i.B)(),{envConfig:b,appService:x}=(0,s.D)(),{hoveredBookKey:v,setHoveredBookKey:w}=N(),{getView:y,getViewState:j,getProgress:S,getViewSettings:C}=N(),{isSideBarVisible:A,setSideBarVisible:T}=k(),[L,M]=l.useState(""),I=(0,es.D)(28),B=(0,es.D)(23),R=(0,es.D)(18),P=(0,es.D)(20),_=y(u),D=S(u),z=C(u),V=j(u),F=e=>{null==_||_.goToFraction(e/100)},W=()=>{G(_,z,"left")},O=()=>{G(_,z,"right")},H=()=>{(null==_?void 0:_.renderer.prevSection)&&(null==_||_.renderer.prevSection())},K=()=>{(null==_?void 0:_.renderer.nextSection)&&(null==_||_.renderer.nextSection())},U=()=>{null==_||_.history.back()},Y=()=>{null==_||_.history.forward()},X=async()=>{_&&D&&(E.I.dispatchSync("tts-is-speaking")?E.I.dispatch("tts-stop",{bookKey:u}):E.I.dispatch("tts-speak",{bookKey:u}))},q=e=>{M(L===e?"":e),"tts"===e?(w(""),X()):"toc"===e?(w(""),z&&(z.sideBarTab="toc"),T(!0)):"note"===e&&(w(""),T(!0),z&&(z.sideBarTab="annotations"))};(0,l.useEffect)(()=>{v!==u&&M("")},[v,u]);let J=v===u,Z=null==V?void 0:V.ttsEnabled,Q="PDF"===h?m:f,$=!!Q,ee=$&&(null==Q?void 0:Q.total)>0&&(Q.current+1)/Q.total||0;return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:(0,d.A)("absolute bottom-0 left-0 z-10 hidden w-full sm:flex sm:h-[52px]",(null==z?void 0:z.vertical)&&(null==z?void 0:z.scrolled)&&"sm:!bottom-3 sm:!h-7"),onMouseEnter:()=>!(null==x?void 0:x.isMobile)&&w(u),onTouchStart:()=>!(null==x?void 0:x.isMobile)&&w(u)}),(0,a.jsxs)("div",{className:(0,d.A)("footer-bar shadow-xs absolute bottom-0 z-50 flex w-full flex-col","sm:h-[52px] sm:justify-center","sm:bg-base-100 border-base-300/50 border-t sm:border-none","transition-[opacity,transform] duration-300",(null==x?void 0:x.hasRoundedWindow)&&"rounded-window-bottom-right",!A&&(null==x?void 0:x.hasRoundedWindow)&&"rounded-window-bottom-left",p&&"hover-bar-anim",(null==z?void 0:z.vertical)&&(null==z?void 0:z.scrolled)&&"sm:!bottom-3 sm:!h-7",J?"pointer-events-auto translate-y-0 opacity-100":"pointer-events-none translate-y-full opacity-0 sm:translate-y-0"),dir:(null==z?void 0:z.rtl)?"rtl":"ltr",onMouseLeave:()=>window.innerWidth>=640&&w(""),"aria-hidden":!J,children:[(0,a.jsxs)("div",{className:(0,d.A)("bg-base-200 absolute bottom-16 flex w-full flex-col items-center gap-y-8 px-4 transition-all sm:hidden","progress"===L?"pointer-events-auto translate-y-0 pb-4 pt-8 ease-out":"pointer-events-none invisible translate-y-full overflow-hidden pb-0 pt-0 ease-in"),style:{bottom:(null==x?void 0:x.hasSafeAreaInset)?"calc(env(safe-area-inset-bottom) + 64px)":"64px"},children:[(0,a.jsx)("div",{className:"flex w-full items-center justify-between gap-x-6",children:(0,a.jsx)(tL,{heightPx:I,bubbleLabel:"".concat(Math.round(100*ee),"%"),initialValue:$?100*ee:0,onChange:e=>F(e)})}),(0,a.jsxs)("div",{className:"flex w-full items-center justify-between gap-x-6",children:[(0,a.jsx)(tb,{icon:(null==z?void 0:z.rtl)?(0,a.jsx)(ty.AkA,{}):(0,a.jsx)(ty.Xc9,{}),onClick:(null==z?void 0:z.rtl)?K:H,tooltip:g((null==z?void 0:z.rtl)?"Next Section":"Previous Section")}),(0,a.jsx)(tb,{icon:(null==z?void 0:z.rtl)?(0,a.jsx)(ty.ye6,{}):(0,a.jsx)(ty.vMW,{}),onClick:(null==z?void 0:z.rtl)?O:W,tooltip:g((null==z?void 0:z.rtl)?"Next Page":"Previous Page")}),(0,a.jsx)(tb,{icon:(null==z?void 0:z.rtl)?(0,a.jsx)(ty.EaJ,{}):(0,a.jsx)(ty.cWs,{}),onClick:U,tooltip:g("Go Back"),disabled:!(null==_?void 0:_.history.canGoBack)}),(0,a.jsx)(tb,{icon:(null==z?void 0:z.rtl)?(0,a.jsx)(ty.cWs,{}):(0,a.jsx)(ty.EaJ,{}),onClick:Y,tooltip:g("Go Forward"),disabled:!(null==_?void 0:_.history.canGoForward)}),(0,a.jsx)(tb,{icon:(null==z?void 0:z.rtl)?(0,a.jsx)(ty.vMW,{}):(0,a.jsx)(ty.ye6,{}),onClick:(null==z?void 0:z.rtl)?W:O,tooltip:g((null==z?void 0:z.rtl)?"Previous Page":"Next Page")}),(0,a.jsx)(tb,{icon:(null==z?void 0:z.rtl)?(0,a.jsx)(ty.Xc9,{}):(0,a.jsx)(ty.AkA,{}),onClick:(null==z?void 0:z.rtl)?H:K,tooltip:g((null==z?void 0:z.rtl)?"Previous Section":"Next Section")})]})]}),(0,a.jsxs)("div",{className:(0,d.A)("bg-base-200 absolute flex w-full flex-col items-center gap-y-8 px-4 transition-all sm:hidden","font"===L?"pointer-events-auto translate-y-0 pb-4 pt-8 ease-out":"pointer-events-none invisible translate-y-full overflow-hidden pb-0 pt-0 ease-in"),style:{bottom:(null==x?void 0:x.hasSafeAreaInset)?"calc(env(safe-area-inset-bottom) + 64px)":"64px"},children:[(0,a.jsx)(tL,{initialValue:null!=(t=null==z?void 0:z.defaultFontSize)?t:16,bubbleLabel:"".concat(null!=(n=null==z?void 0:z.defaultFontSize)?n:16),minLabel:"A",maxLabel:"A",minClassName:"text-xs",maxClassName:"text-base",onChange:e=>{tN(b,u,"defaultFontSize",e)},min:8,max:30}),(0,a.jsxs)("div",{className:"flex w-full items-center justify-between gap-x-6",children:[(0,a.jsx)(tL,{initialValue:((null!=(r=null==z?void 0:z.marginPx)?r:44)/88+(null!=(o=null==z?void 0:z.gapPercent)?o:5)/10)*50,bubbleElement:(0,a.jsx)(tg.sQu,{size:P}),minLabel:g("Small"),maxLabel:g("Large"),step:10,onChange:e=>{let t=Math.round(e/100*88),n=Math.round(e/100*10);tN(b,u,"marginPx",t,!1,!1),tN(b,u,"gapPercent",n,!1,!1),null==_||_.renderer.setAttribute("margin","".concat(t,"px")),null==_||_.renderer.setAttribute("gap","".concat(n,"%")),(null==z?void 0:z.scrolled)&&(null==_||_.renderer.setAttribute("flow","scrolled"))}}),(0,a.jsx)(tL,{initialValue:(null!=(c=null==z?void 0:z.lineHeight)?c:1.6)*10,bubbleElement:(0,a.jsx)(tT.ab_,{size:P}),minLabel:g("Small"),maxLabel:g("Large"),min:8,max:24,onChange:e=>{tN(b,u,"lineHeight",e/10)}})]})]}),(0,a.jsxs)("div",{className:(0,d.A)("bg-base-200 z-50 mt-auto flex w-full justify-between px-8 py-4 sm:hidden",(null==x?void 0:x.hasSafeAreaInset)&&"pb-[calc(env(safe-area-inset-bottom)+16px)]"),children:[(0,a.jsx)(tb,{icon:(0,a.jsx)(eE.Od7,{size:B,className:""}),onClick:()=>q("toc")}),(0,a.jsx)(tb,{icon:(0,a.jsx)(eT.R5w,{className:""}),onClick:()=>q("note")}),(0,a.jsx)(tb,{icon:(0,a.jsx)(tT.ax0,{className:(0,d.A)("progress"===L&&"text-blue-500")}),onClick:()=>q("progress")}),(0,a.jsx)(tb,{icon:(0,a.jsx)(ty.b5M,{size:R,className:(0,d.A)("font"===L&&"text-blue-500")}),onClick:()=>q("font")}),(0,a.jsx)(tb,{icon:(0,a.jsx)(el.xs_,{className:Z?"text-blue-500":""}),onClick:()=>q("tts")})]}),(0,a.jsxs)("div",{className:"hidden w-full items-center gap-x-4 px-4 sm:flex",children:[(0,a.jsx)(tb,{icon:(null==z?void 0:z.rtl)?(0,a.jsx)(ty.AkA,{}):(0,a.jsx)(ty.Xc9,{}),onClick:(null==z?void 0:z.rtl)?K:H,tooltip:g((null==z?void 0:z.rtl)?"Next Section":"Previous Section")}),(0,a.jsx)(tb,{icon:(null==z?void 0:z.rtl)?(0,a.jsx)(ty.ye6,{}):(0,a.jsx)(ty.vMW,{}),onClick:(null==z?void 0:z.rtl)?O:W,tooltip:g((null==z?void 0:z.rtl)?"Next Page":"Previous Page")}),(0,a.jsx)(tb,{icon:(null==z?void 0:z.rtl)?(0,a.jsx)(ty.EaJ,{}):(0,a.jsx)(ty.cWs,{}),onClick:U,tooltip:g("Go Back"),disabled:!(null==_?void 0:_.history.canGoBack)}),(0,a.jsx)(tb,{icon:(null==z?void 0:z.rtl)?(0,a.jsx)(ty.cWs,{}):(0,a.jsx)(ty.EaJ,{}),onClick:Y,tooltip:g("Go Forward"),disabled:!(null==_?void 0:_.history.canGoForward)}),(0,a.jsx)("span",{className:"mx-2 text-center text-sm",children:$?"".concat(Math.round(100*ee),"%"):""}),(0,a.jsx)("input",{type:"range",className:"text-base-content mx-2 w-full",min:0,max:100,value:$?100*ee:0,onChange:e=>F(parseInt(e.target.value,10))}),(0,a.jsx)(tb,{icon:(0,a.jsx)(tE.tLl,{className:Z?"text-blue-500":""}),onClick:X,tooltip:g("Speak")}),(0,a.jsx)(tb,{icon:(null==z?void 0:z.rtl)?(0,a.jsx)(ty.vMW,{}):(0,a.jsx)(ty.ye6,{}),onClick:(null==z?void 0:z.rtl)?W:O,tooltip:g((null==z?void 0:z.rtl)?"Previous Page":"Next Page")}),(0,a.jsx)(tb,{icon:(null==z?void 0:z.rtl)?(0,a.jsx)(ty.Xc9,{}):(0,a.jsx)(ty.AkA,{}),onClick:(null==z?void 0:z.rtl)?H:K,tooltip:g((null==z?void 0:z.rtl)?"Previous Section":"Next Section")})]})]})]})},tI=e=>{let{bookKey:t,bookFormat:n,section:l,pageinfo:r,timeinfo:o,horizontalGap:c,verticalMargin:u}=e,h=(0,i.B)(),{appService:m}=(0,s.D)(),{getViewSettings:f}=N(),p=f(t),g=p.vertical&&p.doubleBorder,b=p.scrolled,x=p.vertical,v=["PDF","CBZ"].includes(n)?l?x?"".concat(l.current+1," \xb7 ").concat(l.total):"".concat(l.current+1," / ").concat(l.total):"":r?h(x?"{{currentPage}} \xb7 {{totalPage}}":"Loc. {{currentPage}} / {{totalPage}}",{currentPage:r.current+1,totalPage:r.total}):"",w=o?h("{{time}} min left in chapter",{time:Math.round(o.section)}):"";return(0,a.jsxs)("div",{className:(0,d.A)("pageinfo absolute bottom-0 flex items-center justify-between","text-neutral-content font-sans text-xs font-extralight",x?"writing-vertical-rl":"h-12 w-full",b&&!x&&"bg-base-100"),style:x?{bottom:"".concat(1.5*u,"px"),left:g?"calc(".concat(c,"% - 32px)"):0,width:g?"32px":"".concat(c,"%"),height:"calc(100% - ".concat(3*u,"px)")}:{paddingInlineStart:"".concat(c,"%"),paddingInlineEnd:"".concat(c,"%"),paddingBottom:(null==m?void 0:m.hasSafeAreaInset)?"calc(env(safe-area-inset-bottom)*0.67)":0},children:[p.showRemainingTime&&(0,a.jsx)("span",{className:"text-start",children:w}),p.showPageNumber&&(0,a.jsx)("span",{className:"ms-auto text-end",children:v})]})},tB=e=>{let{}=e;return(0,a.jsx)("div",{className:(0,d.A)("fixed inset-0 z-10 flex w-8 justify-center sm:w-6","h-[calc(env(safe-area-inset-top)+44px)]"),children:(0,a.jsx)("svg",{width:"100%",height:"100%",preserveAspectRatio:"none",viewBox:"0 0 100 100",xmlns:"http://www.w3.org/2000/svg",shapeRendering:"geometricPrecision",imageRendering:"optimizeQuality",children:(0,a.jsx)("polygon",{fill:"#F44336",points:"100 100, 50 78, 0 100, 0 0, 100 0"})})})};var tR=n(97574),tP=n(1768),t_=n(90863);let tD=e=>{let{className:t,label:n,value:s,onChange:i,min:r,max:o,step:c,disabled:u}=e,[h,m]=(0,l.useState)(s),f=c||1;return(0,l.useEffect)(()=>{m(s)},[s]),(0,a.jsxs)("div",{className:(0,d.A)("config-item",t),children:[(0,a.jsx)("span",{className:"text-base-content",children:n}),(0,a.jsxs)("div",{className:"text-base-content flex items-center gap-2",children:[(0,a.jsx)("input",{type:"text",inputMode:"decimal",value:h,onChange:e=>{let t=e.target.value;if(""===t||/^[1-9]\d*\.?\d*$|^0?\.?\d*$/.test(t)){let e=""===t?0:parseFloat(t);m(e),isNaN(e)||i(Math.max(r,Math.min(o,Math.round(10*e)/10)))}},onBlur:()=>{let e=Math.max(r,Math.min(o,h));m(e),i(e)},className:"input input-ghost settings-content text-base-content w-20 max-w-xs rounded border-0 bg-transparent px-3 py-1 text-right !outline-none",onFocus:e=>e.target.select()}),(0,a.jsx)("button",{onClick:()=>{let e=Math.round(10*Math.max(r,h-f))/10;m(e),i(e)},className:"btn btn-circle btn-sm ".concat(s<=r||u?"btn-disabled !bg-opacity-5":""),children:(0,a.jsx)(ea.QLg,{className:"h-4 w-4"})}),(0,a.jsx)("button",{onClick:()=>{let e=Math.round(10*Math.min(o,h+f))/10;m(e),i(e)},className:"btn btn-circle btn-sm ".concat(s>=o||u?"btn-disabled !bg-opacity-5":""),children:(0,a.jsx)(ea.GGD,{className:"h-4 w-4"})})]})]})},tz=e=>{var t;let{family:n,selected:l,options:r,moreOptions:o,onSelect:c,onGetFontFamily:u}=e,h=(0,i.B)(),{appService:m}=(0,s.D)(),f=(0,es.D)(16),p=[...r,...null!=o?o:[]],g=null!=(t=p.find(e=>e.option===l))?t:p[0];return(0,a.jsxs)("div",{className:"dropdown dropdown-top",children:[(0,a.jsx)("button",{tabIndex:0,className:"btn btn-sm flex items-center px-[10px] font-normal normal-case sm:px-[20px]",onClick:e=>e.currentTarget.focus(),children:(0,a.jsxs)("div",{className:"flex items-center gap-x-1",children:[(0,a.jsx)("span",{className:"text-ellipsis",style:{fontFamily:u(g.option,null!=n?n:"")},children:g.label}),(0,a.jsx)(ea.wAb,{size:f})]})}),(0,a.jsxs)("ul",{tabIndex:0,className:(0,d.A)("dropdown-content bgcolor-base-200 no-triangle menu rounded-box absolute z-[1] mt-4 shadow","!sm:px-2 right-[-32px] w-[46vw] !px-1 sm:right-0 sm:w-44",(null==o?void 0:o.length)?"":"inline max-h-80 overflow-y-scroll"),children:[r.map(e=>{let{option:t,label:s}=e;return(0,a.jsx)("li",{onClick:()=>c(t),children:(0,a.jsxs)("div",{className:"flex w-full items-center overflow-hidden px-0 text-sm",children:[(0,a.jsx)("span",{style:{minWidth:"".concat(f,"px")},children:l===t&&(0,a.jsx)(el.g9_,{className:"text-base-content",size:f})}),(0,a.jsx)("span",{style:{fontFamily:u(t,null!=n?n:"")},children:s||t})]})},t)}),o&&o.length>0&&(0,a.jsxs)("li",{className:"dropdown dropdown-left dropdown-top",children:[(0,a.jsxs)("div",{className:"flex items-center px-0 text-sm",children:[(0,a.jsx)("span",{style:{minWidth:"".concat(f,"px")},children:(0,a.jsx)(ea.irw,{size:f})}),(0,a.jsx)("span",{children:h("System Fonts")})]}),(0,a.jsx)("ul",{tabIndex:0,className:(0,d.A)("dropdown-content bgcolor-base-200 menu rounded-box relative z-[1] shadow","!sm:px-2 !mr-4 mb-[-46px] inline max-h-80 w-[46vw] overflow-y-scroll !px-1 sm:w-[200px]"),children:o.map((e,t)=>(0,a.jsx)("li",{onClick:()=>c(e.option),children:(0,a.jsxs)("div",{className:"flex w-full items-center overflow-hidden px-0 text-sm",children:[(0,a.jsx)("span",{style:{minWidth:"".concat(f,"px")},children:l===e.option&&(0,a.jsx)(el.g9_,{className:"text-base-content",size:f})}),(0,a.jsx)("span",{style:(null==m?void 0:m.isLinuxApp)?{}:{fontFamily:u(e.option,null!=n?n:"")},children:e.label||e.option})]})},"".concat(t,"-").concat(e.option)))})]})]})]})},tV=e=>Array.from(new Set([...e,...O.az,...O.Yk])).filter(e=>O._1.test(e)||O.EZ.test(e)).filter(e=>!O.GT.test(e)).sort((e,t)=>e.localeCompare(t)),tF=e=>/emoji|icons|symbol|dingbats|ornaments|webdings|wingdings|miuiex/i.test(e),tW=(e,t)=>"'".concat(e,"', ").concat(t),tO=e=>!["android","linux"].includes((0,F.Ox)())||!O.O9.includes(e),tH=e=>{var t;let{className:n,family:l,label:s,options:r,moreOptions:o,selected:c,onSelect:u}=e,h=(0,i.B)();return(0,a.jsxs)("div",{className:(0,d.A)("config-item",n),children:[(0,a.jsx)("span",{className:"min-w-10",children:s}),(0,a.jsx)(tz,{family:l,options:r.map(e=>({option:e,label:h(e)})),moreOptions:null!=(t=null==o?void 0:o.map(e=>({option:e,label:e})))?t:[],selected:c,onSelect:u,onGetFontFamily:tW})]})},tK=e=>{let{bookKey:t}=e,n=(0,i.B)(),{envConfig:r}=(0,s.D)(),{getView:o,getViewSettings:c}=N(),d=c(t),u=o(t),h=[{option:"Serif",label:n("Serif Font")},{option:"Sans-serif",label:n("Sans-Serif Font")}],m=(0,F.Ox)(),f=[];switch(m){case"macos":f=O.pP;break;case"windows":f=O.Z$;break;case"linux":f=O.g9;break;case"ios":f=O.ZH;break;case"android":f=O.TJ}let[p,g]=(0,l.useState)(f),[b,x]=(0,l.useState)(d.defaultFontSize),[v,w]=(0,l.useState)(d.minimumFontSize),[y,j]=(0,l.useState)(d.overrideFont),[k,S]=(0,l.useState)(d.defaultFont),[C,A]=(0,l.useState)(d.defaultCJKFont),[E,T]=(0,l.useState)(d.serifFont),[M,I]=(0,l.useState)(d.sansSerifFont),[R,P]=(0,l.useState)(d.monospaceFont),[_,D]=(0,l.useState)(d.fontWeight),[z,V]=(0,l.useState)(()=>tV(p));return(0,l.useEffect)(()=>{V(e=>{let t=tV(p);return e.length!==t.length?t:e})},[p]),(0,l.useEffect)(()=>{(0,L.uO)()&&(0,B.S$)().then(e=>{if(e.error||0===Object.keys(e.fonts).length)return void console.error("Failed to get system fonts list:",e.error);let t=[];Object.entries(e.fonts).forEach(n=>{let[a,l]=n;!a||tF(a)||(1===Object.entries(e.fonts).filter(e=>{let[t,n]=e;return n===l}).length?t.push(l):t.push(a))}),g([...new Set(t)].sort((e,t)=>e.localeCompare(t)))})},[]),(0,l.useEffect)(()=>{tN(r,t,"defaultFont",k)},[k]),(0,l.useEffect)(()=>{tN(r,t,"defaultCJKFont",C)},[C]),(0,l.useEffect)(()=>{tN(r,t,"defaultFontSize",b)},[b]),(0,l.useEffect)(()=>{tN(r,t,"minimumFontSize",v)},[v]),(0,l.useEffect)(()=>{tN(r,t,"fontWeight",_)},[_]),(0,l.useEffect)(()=>{tN(r,t,"serifFont",E)},[E]),(0,l.useEffect)(()=>{tN(r,t,"sansSerifFont",M)},[M]),(0,l.useEffect)(()=>{tN(r,t,"monospaceFont",R)},[R]),(0,l.useEffect)(()=>{tN(r,t,"overrideFont",y)},[y]),(0,a.jsxs)("div",{className:"my-4 w-full space-y-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h2",{className:"",children:n("Override Book Font")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:y,onChange:()=>j(!y)})]}),(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsx)("h2",{className:"mb-2 font-medium",children:n("Font Size")}),(0,a.jsx)("div",{className:"card border-base-200 border shadow",children:(0,a.jsxs)("div",{className:"divide-base-200 divide-y",children:[(0,a.jsx)(tD,{label:n("Default Font Size"),value:b,onChange:x,min:v,max:120}),(0,a.jsx)(tD,{label:n("Minimum Font Size"),value:v,onChange:w,min:1,max:120})]})})]}),(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsx)("h2",{className:"mb-2 font-medium",children:n("Font Weight")}),(0,a.jsx)("div",{className:"card border-base-200 border shadow",children:(0,a.jsx)("div",{className:"divide-base-200 divide-y",children:(0,a.jsx)(tD,{label:n("Font Weight"),value:_,onChange:D,min:100,max:900,step:100})})})]}),(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsx)("h2",{className:"mb-2 font-medium",children:n("Font Family")}),(0,a.jsx)("div",{className:"card border-base-200 border shadow",children:(0,a.jsxs)("div",{className:"divide-base-200 divide-y",children:[(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:n("Default Font")}),(0,a.jsx)(tz,{options:h,selected:k,onSelect:S,onGetFontFamily:e=>{switch(e){case"Serif":return"'".concat(E,"', serif");case"Sans-serif":return"'".concat(M,"', sans-serif");case"Monospace":return"'".concat(R,"', monospace");default:return""}}})]}),((0,F.ii)()||(null==u?void 0:u.language.isCJK))&&(0,a.jsx)(tH,{className:"config-item-top",family:"serif",label:n("CJK Font"),options:z,selected:C,onSelect:A})]})})]}),(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsx)("h2",{className:"mb-2 font-medium",children:n("Font Face")}),(0,a.jsx)("div",{className:"card border-base-200 border shadow",children:(0,a.jsxs)("div",{className:"divide-base-200 divide-y",children:[(0,a.jsx)(tH,{className:"config-item-top",family:"serif",label:n("Serif Font"),options:[...O.H0.filter(tO),...O.az],moreOptions:p,selected:E,onSelect:T}),(0,a.jsx)(tH,{family:"sans-serif",label:n("Sans-Serif Font"),options:[...O.Z4.filter(tO),...O.Yk],moreOptions:p,selected:M,onSelect:I}),(0,a.jsx)(tH,{className:"config-item-bottom",family:"monospace",label:n("Monospace Font"),options:O.nh,moreOptions:p,selected:R,onSelect:P})]})})]})]})},tU=e=>{var t,n;let{bookKey:r}=e,o=(0,i.B)(),{envConfig:c}=(0,s.D)(),{getView:d,getViewSettings:u,setViewSettings:h}=N(),{getBookData:m}=(0,w.I)(),f=d(r),p=m(r),g=u(r),[b,x]=(0,l.useState)(g.paragraphMargin),[v,y]=(0,l.useState)(g.lineHeight),[k,S]=(0,l.useState)(g.wordSpacing),[C,A]=(0,l.useState)(g.letterSpacing),[E,T]=(0,l.useState)(g.textIndent),[L,M]=(0,l.useState)(g.fullJustification),[I,B]=(0,l.useState)(g.hyphenation),[R,P]=(0,l.useState)(g.marginPx),[_,D]=(0,l.useState)(g.gapPercent),[z,V]=(0,l.useState)(g.compactMarginPx),[W,H]=(0,l.useState)(g.compactGapPercent),[K,U]=(0,l.useState)(g.maxColumnCount),[G,X]=(0,l.useState)(g.maxInlineSize),[q,J]=(0,l.useState)(g.maxBlockSize),[Z,Q]=(0,l.useState)(g.writingMode),[$,ee]=(0,l.useState)(g.overrideLayout),[et,en]=(0,l.useState)(g.doubleBorder),[ea,es]=(0,l.useState)(g.borderColor),[ei,er]=(0,l.useState)(g.showHeader),[eo,ec]=(0,l.useState)(g.showFooter),[ed,eu]=(0,l.useState)(g.showBarsOnScroll),[eh,em]=(0,l.useState)(g.showRemainingTime),[ef,ep]=(0,l.useState)(g.showPageNumber);(0,l.useEffect)(()=>{tN(c,r,"paragraphMargin",b)},[b]),(0,l.useEffect)(()=>{tN(c,r,"lineHeight",v)},[v]),(0,l.useEffect)(()=>{tN(c,r,"wordSpacing",k)},[k]),(0,l.useEffect)(()=>{tN(c,r,"letterSpacing",C)},[C]),(0,l.useEffect)(()=>{tN(c,r,"textIndent",E)},[E]),(0,l.useEffect)(()=>{tN(c,r,"fullJustification",L)},[L]),(0,l.useEffect)(()=>{tN(c,r,"hyphenation",I)},[I]),(0,l.useEffect)(()=>{R!==g.marginPx&&(tN(c,r,"marginPx",R,!1,!1),null==f||f.renderer.setAttribute("margin","".concat(R,"px")))},[R]),(0,l.useEffect)(()=>{z!==g.compactMarginPx&&(tN(c,r,"compactMarginPx",z,!1,!1),null==f||f.renderer.setAttribute("margin","".concat(z,"px")))},[z]),(0,l.useEffect)(()=>{_!==g.gapPercent&&(tN(c,r,"gapPercent",_,!1,!1),null==f||f.renderer.setAttribute("gap","".concat(_,"%")),g.scrolled&&(null==f||f.renderer.setAttribute("flow","scrolled")))},[_]),(0,l.useEffect)(()=>{W!==g.compactGapPercent&&(tN(c,r,"compactGapPercent",W,!1,!1),null==f||f.renderer.setAttribute("gap","".concat(W,"%")),g.scrolled&&(null==f||f.renderer.setAttribute("flow","scrolled")))},[W]),(0,l.useEffect)(()=>{K!==g.maxColumnCount&&(tN(c,r,"maxColumnCount",K,!1,!1),null==f||f.renderer.setAttribute("max-column-count",K),null==f||f.renderer.setAttribute("max-inline-size","".concat((0,tr.Jt)(g),"px")))},[K]),(0,l.useEffect)(()=>{G!==g.maxInlineSize&&(tN(c,r,"maxInlineSize",G,!1,!1),null==f||f.renderer.setAttribute("max-inline-size","".concat((0,tr.Jt)(g),"px")))},[G]),(0,l.useEffect)(()=>{q!==g.maxBlockSize&&(tN(c,r,"maxBlockSize",q,!1,!1),null==f||f.renderer.setAttribute("max-block-size","".concat(q,"px")))},[q]),(0,l.useEffect)(()=>{if(Z===g.writingMode)return;let e=g.writingMode;if(Z.includes("vertical")?g.vertical=!0:g.vertical=!1,tN(c,r,"writingMode",Z,!0),f){var t,n;null==(t=(n=f.renderer).setStyles)||t.call(n,(0,Y.$f)(g)),f.book.dir=(0,j.is)(Z)}e!==Z&&(["horizontal-rl","vertical-rl"].includes(Z)||["horizontal-rl","vertical-rl"].includes(e))&&setTimeout(()=>window.location.reload(),100)},[Z]),(0,l.useEffect)(()=>{$!==g.overrideLayout&&tN(c,r,"overrideLayout",$)},[$]),(0,l.useEffect)(()=>{et!==g.doubleBorder&&(et&&g.vertical&&(g.gapPercent=Math.max(g.gapPercent,Math.ceil(4800/window.innerWidth)),D(g.gapPercent),h(r,g)),tN(c,r,"doubleBorder",et,!1,!1))},[et]),(0,l.useEffect)(()=>{tN(c,r,"borderColor",ea,!1,!1)},[ea]),(0,l.useEffect)(()=>{tN(c,r,"showBarsOnScroll",ed,!1,!1)},[ed]),(0,l.useEffect)(()=>{tN(c,r,"showRemainingTime",eh,!1,!1)},[eh]),(0,l.useEffect)(()=>{tN(c,r,"showPageNumber",ef,!1,!1)},[ef]);let eg=()=>{let e=!ei&&!eo,t=e?g.compactMarginPx:g.marginPx,n=e?g.compactGapPercent:g.gapPercent;null==f||f.renderer.setAttribute("margin","".concat(t,"px")),null==f||f.renderer.setAttribute("gap","".concat(n,"%")),g.scrolled&&(null==f||f.renderer.setAttribute("flow","scrolled"))};(0,l.useEffect)(()=>{ei!==g.showHeader&&(ei&&!g.vertical?(g.marginPx=Math.max(g.marginPx,44),P(g.marginPx),h(r,g)):ei&&g.vertical&&(g.gapPercent=Math.max(g.gapPercent,Math.ceil(4800/window.innerWidth)),D(g.gapPercent),h(r,g)),tN(c,r,"showHeader",ei,!1,!1),eg())},[ei]),(0,l.useEffect)(()=>{eo!==g.showFooter&&(eo&&!g.vertical?(g.marginPx=Math.max(g.marginPx,44),P(g.marginPx),h(r,g)):eo&&g.vertical&&(g.gapPercent=Math.max(g.gapPercent,Math.ceil(4800/window.innerWidth)),D(g.gapPercent),h(r,g)),tN(c,r,"showFooter",eo,!1,!1),eg())},[eo]);let eb=(0,j.fM)(null==(n=p.bookDoc)||null==(t=n.metadata)?void 0:t.language),ex=O.tr.includes(eb)||(0,F.ii)();return(0,a.jsxs)("div",{className:"my-4 w-full space-y-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h2",{className:"",children:o("Override Book Layout")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:$,onChange:()=>ee(!$)})]}),ex&&(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h2",{className:"font-medium",children:o("Writing Mode")}),(0,a.jsxs)("div",{className:"flex gap-4",children:[(0,a.jsx)("div",{className:"lg:tooltip lg:tooltip-bottom","data-tip":o("Default"),children:(0,a.jsx)("button",{className:"btn btn-ghost btn-circle btn-sm ".concat("auto"===Z?"btn-active bg-base-300":""),onClick:()=>Q("auto"),children:(0,a.jsx)(el.ObO,{})})}),(0,a.jsx)("div",{className:"lg:tooltip lg:tooltip-bottom","data-tip":o("Horizontal Direction"),children:(0,a.jsx)("button",{className:"btn btn-ghost btn-circle btn-sm ".concat("horizontal-tb"===Z?"btn-active bg-base-300":""),onClick:()=>Q("horizontal-tb"),children:(0,a.jsx)(el.P9_,{})})}),(0,a.jsx)("div",{className:"lg:tooltip lg:tooltip-bottom","data-tip":o("Vertical Direction"),children:(0,a.jsx)("button",{className:"btn btn-ghost btn-circle btn-sm ".concat("vertical-rl"===Z?"btn-active bg-base-300":""),onClick:()=>Q("vertical-rl"),children:(0,a.jsx)(el.mRX,{})})}),(0,a.jsx)("div",{className:"lg:tooltip lg:tooltip-bottom","data-tip":o("RTL Direction"),children:(0,a.jsx)("button",{className:"btn btn-ghost btn-circle btn-sm ".concat("horizontal-rl"===Z?"btn-active bg-base-300":""),onClick:()=>Q("horizontal-rl"),children:(0,a.jsx)(tg.jvX,{})})})]})]}),g.vertical&&(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsx)("h2",{className:"mb-2 font-medium",children:o("Border Frame")}),(0,a.jsx)("div",{className:"card bg-base-100 border-base-200 border shadow",children:(0,a.jsxs)("div",{className:"divide-base-200 divide-y",children:[(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:o("Double Border")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:et,onChange:()=>en(!et)})]}),(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:o("Border Color")}),(0,a.jsxs)("div",{className:"flex gap-4",children:[(0,a.jsx)("button",{className:"btn btn-circle btn-sm bg-red-300 hover:bg-red-500 ".concat("red"===ea?"btn-active !bg-red-500":""),onClick:()=>es("red")}),(0,a.jsx)("button",{className:"btn btn-circle btn-sm bg-black/50 hover:bg-black ".concat("black"===ea?"btn-active !bg-black":""),onClick:()=>es("black")})]})]})]})})]}),(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsx)("h2",{className:"mb-2 font-medium",children:o("Paragraph")}),(0,a.jsx)("div",{className:"card bg-base-100 border-base-200 border shadow",children:(0,a.jsxs)("div",{className:"divide-base-200 divide-y",children:[(0,a.jsx)(tD,{label:o("Paragraph Margin"),value:b,onChange:x,min:0,max:4,step:.2}),(0,a.jsx)(tD,{label:o("Line Spacing"),value:v,onChange:y,min:1,max:3,step:.1}),"zh"!==eb&&(0,a.jsx)(tD,{label:o("Word Spacing"),value:k,onChange:S,min:-4,max:8,step:.5}),(0,a.jsx)(tD,{label:o("Letter Spacing"),value:C,onChange:A,min:-2,max:4,step:.5}),(0,a.jsx)(tD,{label:o("Text Indent"),value:E,onChange:T,min:-2,max:4,step:1}),(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:o("Full Justification")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:L,onChange:()=>M(!L)})]}),(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:o("Hyphenation")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:I,onChange:()=>B(!I)})]})]})})]}),(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsx)("h2",{className:"mb-2 font-medium",children:o("Page")}),(0,a.jsx)("div",{className:"card bg-base-100 border-base-200 border shadow",children:(0,a.jsxs)("div",{className:"divide-base-200 divide-y",children:[(0,a.jsx)(tD,{label:o("Vertical Margins (px)"),value:eo||ei?R:z,onChange:eo||ei?P:V,min:!g.vertical&&(eo||ei)?44:0,max:88,step:4}),(0,a.jsx)(tD,{label:o("Horizontal Margins (%)"),value:eo||ei?_:W,onChange:eo||ei?D:H,min:g.vertical&&(eo||ei)?Math.ceil(4800/window.innerWidth):0,max:30}),(0,a.jsx)(tD,{label:o("Maximum Number of Columns"),value:K,onChange:U,min:1,max:4}),(0,a.jsx)(tD,{label:o(g.vertical?"Maximum Column Height":"Maximum Column Width"),value:G,onChange:X,disabled:1===K||g.scrolled,min:400,max:9999,step:100}),(0,a.jsx)(tD,{label:o(g.vertical?"Maximum Column Width":"Maximum Column Height"),value:q,onChange:J,disabled:1===K||g.scrolled,min:400,max:9999,step:100})]})})]}),(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsx)("h2",{className:"mb-2 font-medium",children:o("Header & Footer")}),(0,a.jsx)("div",{className:"card bg-base-100 border-base-200 border shadow",children:(0,a.jsxs)("div",{className:"divide-base-200 divide-y",children:[(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:o("Show Header")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:ei,onChange:()=>er(!ei)})]}),(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:o("Show Footer")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:eo,onChange:()=>ec(!eo)})]}),(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:o("Show Remaining Time")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:eh,disabled:!eo,onChange:()=>em(!eh)})]}),(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:o("Show Page Number")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:ef,disabled:!eo,onChange:()=>ep(!ef)})]}),(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:o("Apply also in Scrolled Mode")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:ed,onChange:()=>eu(!ed)})]})]})})]})]})};var tY=n(12904),tG=n(71997),tX=n(29404);let tq=e=>{let{label:t,value:n,onChange:s}=e,[i,r]=(0,l.useState)(!1),o=(0,l.useRef)(null);return(0,l.useEffect)(()=>{function e(e){o.current&&!o.current.contains(e.target)&&r(!1)}return i?document.addEventListener("mousedown",e):document.removeEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[i]),(0,a.jsxs)("div",{className:"mb-3",children:[(0,a.jsx)("label",{className:"mb-1 block text-sm font-medium",children:t}),(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("div",{className:"border-base-200 relative mr-2 flex h-7 w-8 cursor-pointer items-center justify-center overflow-hidden rounded border",style:{backgroundColor:n},onClick:()=>r(!i)}),(0,a.jsx)("input",{type:"text",value:n,spellCheck:!1,onChange:e=>s(e.target.value),className:"bg-base-100 text-base-content border-base-200 min-w-4 max-w-36 flex-1 rounded border p-1 font-mono text-sm"})]}),i&&(0,a.jsx)("div",{ref:o,className:"relative z-50 mt-2",children:(0,a.jsx)("div",{className:"absolute",children:(0,a.jsx)(tX.Xq,{width:"100%",color:n,onChange:e=>{s(e.hex)},disableAlpha:!0})})})]})},tJ=e=>{let{customTheme:t,onSave:n,onDelete:s,onCancel:r}=e,c=(0,i.B)(),{settings:u}=(0,o.C)(),h=O._C[Math.floor(Math.random()*O._C.length)],[m,f]=(0,l.useState)((null==t?void 0:t.colors.light.fg)||h.light.fg),[p,g]=(0,l.useState)((null==t?void 0:t.colors.light.bg)||h.light.bg),[b,x]=(0,l.useState)((null==t?void 0:t.colors.light.primary)||h.light.primary),[v,w]=(0,l.useState)((null==t?void 0:t.colors.dark.fg)||h.dark.fg),[y,j]=(0,l.useState)((null==t?void 0:t.colors.dark.bg)||h.dark.bg),[N,k]=(0,l.useState)((null==t?void 0:t.colors.dark.primary)||h.dark.primary),[S,C]=(0,l.useState)((null==t?void 0:t.label)||c("Custom")),A=e=>{let{textColor:t,backgroundColor:n,primaryColor:l,label:s}=e;return(0,a.jsxs)("div",{className:"mb-2 mt-4",children:[(0,a.jsx)("label",{className:"mb-1 block text-sm font-medium",children:s}),(0,a.jsx)("div",{className:"border-base-300 overflow-hidden rounded border p-2",style:{backgroundColor:n,color:t},children:(0,a.jsxs)("p",{className:"mb-2 whitespace-pre-line text-xs",children:[c("All the world's a stage,\nAnd all the men and women merely players;\nThey have their exits and their entrances,\nAnd one man in his time plays many parts,\nHis acts being seven ages.\n\n— William Shakespeare"),"\n\n",(0,a.jsx)("span",{className:"mt-4 cursor-pointer italic",style:{color:l},children:c("(from 'As You Like It', Act II)")})]})})]})},E=()=>({name:(0,eH.Pr)(S),label:S,colors:{light:{fg:m,bg:p,primary:b},dark:{fg:v,bg:y,primary:N}}});return(0,a.jsxs)("div",{className:"mt-6 rounded-lg",children:[(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsxs)("div",{className:"mb-4 flex items-center justify-between",children:[(0,a.jsx)("label",{className:"font-medium",children:c("Custom Theme")}),(0,a.jsxs)("div",{className:"flex w-[calc(50%-12px)] justify-between",children:[(0,a.jsx)("button",{className:"btn btn-ghost btn-sm text-base-content px-2",onClick:()=>n(E()),children:c("Save")}),u.globalReadSettings.customThemes.find(e=>e.name===(0,eH.Pr)(S))&&(0,a.jsx)("button",{className:(0,d.A)("btn btn-ghost btn-sm px-2"),onClick:()=>s(E()),children:c("Delete")}),(0,a.jsx)("button",{className:"btn btn-ghost btn-sm px-2",onClick:r,children:c("Cancel")})]})]}),(0,a.jsxs)("div",{className:"mb-4 flex items-center justify-between",children:[(0,a.jsx)("label",{className:"font-medium",children:c("Theme Name")}),(0,a.jsx)("input",{type:"text",value:S,onChange:e=>C(e.target.value),className:"bg-base-100 text-base-content border-base-200 w-[calc(50%-12px)] rounded border p-2 text-sm"})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-6",children:[(0,a.jsxs)("div",{className:"bg-base-200 rounded-lg p-3",children:[(0,a.jsx)("h3",{className:"mb-3 text-center font-medium",children:c("Light Mode")}),(0,a.jsx)(tq,{label:c("Text Color"),value:m,onChange:f}),(0,a.jsx)(tq,{label:c("Background Color"),value:p,onChange:g}),(0,a.jsx)(tq,{label:c("Link Color"),value:b,onChange:x}),(0,a.jsx)(A,{textColor:m,backgroundColor:p,primaryColor:b,label:c("Preview")})]}),(0,a.jsxs)("div",{className:"bg-base-300 rounded-lg p-3",children:[(0,a.jsx)("h3",{className:"mb-3 text-center font-medium",children:c("Dark Mode")}),(0,a.jsx)(tq,{label:c("Text Color"),value:v,onChange:w}),(0,a.jsx)(tq,{label:c("Background Color"),value:y,onChange:j}),(0,a.jsx)(tq,{label:c("Link Color"),value:N,onChange:k}),(0,a.jsx)(A,{textColor:v,backgroundColor:y,primaryColor:N,label:c("Preview")})]})]})]})},tZ=e=>{let{bookKey:t}=e,n=(0,i.B)(),{themeMode:r,themeColor:c,isDarkMode:d,setThemeMode:u,setThemeColor:m,saveCustomTheme:f}=(0,h.C)(),{envConfig:p}=(0,s.D)(),{settings:g,setSettings:b}=(0,o.C)(),{getViewSettings:x}=N(),v=x(t),[w,y]=(0,l.useState)(v.invertImgColorInDark),j=(0,es.D)(16),k=(0,es.D)(24),[S,C]=(0,l.useState)(null),[A,E]=(0,l.useState)([]),[T,L]=(0,l.useState)(!1),[M,I]=(0,l.useState)(v.overrideColor);(0,l.useEffect)(()=>{w!==v.invertImgColorInDark&&tN(p,t,"invertImgColorInDark",w)},[w]),(0,l.useEffect)(()=>{M!==v.overrideColor&&tN(p,t,"overrideColor",M)},[M]),(0,l.useEffect)(()=>{var e;E((null!=(e=g.globalReadSettings.customThemes)?e:[]).map(e=>({name:e.name,label:e.label,colors:{light:(0,tG.PF)(e.colors.light),dark:(0,tG.n1)(e.colors.dark)},isCustomizale:!0})))},[g]);let B=e=>{let t=g.globalReadSettings.customThemes.find(t=>t.name===e);t&&(C(t),L(!0))};return(0,a.jsx)("div",{className:"my-4 w-full space-y-6",children:T?(0,a.jsx)(tJ,{customTheme:S,onSave:e=>{(0,tG.PL)(e),f(p,g,e),b({...g}),m(e.name),L(!1)},onDelete:e=>{f(p,g,e,!0),b({...g}),m("default"),L(!1)},onCancel:()=>L(!1)}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h2",{className:"font-medium",children:n("Theme Mode")}),(0,a.jsxs)("div",{className:"flex gap-4",children:[(0,a.jsx)("div",{className:"lg:tooltip lg:tooltip-bottom","data-tip":n("Auto Mode"),children:(0,a.jsx)("button",{className:"btn btn-ghost btn-circle btn-sm ".concat("auto"===r?"btn-active bg-base-300":""),onClick:()=>u("auto"),children:(0,a.jsx)(tg.eV8,{})})}),(0,a.jsx)("div",{className:"lg:tooltip lg:tooltip-bottom","data-tip":n("Light Mode"),children:(0,a.jsx)("button",{className:"btn btn-ghost btn-circle btn-sm ".concat("light"===r?"btn-active bg-base-300":""),onClick:()=>u("light"),children:(0,a.jsx)(el.hGG,{})})}),(0,a.jsx)("div",{className:"lg:tooltip lg:tooltip-bottom","data-tip":n("Dark Mode"),children:(0,a.jsx)("button",{className:"btn btn-ghost btn-circle btn-sm ".concat("dark"===r?"btn-active bg-base-300":""),onClick:()=>u("dark"),children:(0,a.jsx)(el.NmZ,{})})})]})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h2",{className:"font-medium",children:n("Invert Image In Dark Mode")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:w,disabled:!d,onChange:()=>y(!w)})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h2",{className:"",children:n("Override Book Color")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:M,onChange:()=>I(!M)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"mb-2 font-medium",children:n("Theme Color")}),(0,a.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[tG.Zj.concat(A).map(e=>{let{name:t,label:l,colors:s,isCustomizale:i}=e;return(0,a.jsxs)("label",{className:"relative flex cursor-pointer flex-col items-center justify-center rounded-lg p-4 shadow-md ".concat(c===t?"ring-2 ring-indigo-500 ring-offset-2":""),style:{backgroundColor:d?s.dark["base-100"]:s.light["base-100"],color:d?s.dark["base-content"]:s.light["base-content"]},children:[(0,a.jsx)("input",{type:"radio",name:"theme",value:t,checked:c===t,onChange:()=>m(t),className:"hidden"}),c===t?(0,a.jsx)(el.EVU,{size:k}):(0,a.jsx)(el.d03,{size:k}),(0,a.jsx)("span",{children:n(l)}),i&&c===t&&(0,a.jsx)("button",{onClick:()=>B(t),children:(0,a.jsx)(tY._e3,{size:j,className:"absolute right-2 top-2"})})]},t)}),(0,a.jsxs)("label",{className:"relative flex cursor-pointer flex-col items-center justify-center rounded-lg border border-dashed p-4 shadow-md",onClick:()=>L(!0),children:[(0,a.jsx)(eT.enO,{size:k}),(0,a.jsx)("span",{children:n("Custom")})]})]})]})]})})};var tQ=n(64466);let t$=e=>{let{toggleDropdown:t}=e,n=(0,i.B)(),l=(0,es.n)(),{isFontLayoutSettingsGlobal:s,setFontLayoutSettingsGlobal:r}=(0,o.C)();return(0,a.jsx)("div",{tabIndex:0,className:(0,d.A)("dropdown-content dropdown-right no-triangle border-base-200 z-20 mt-1 border shadow-2xl","text-base sm:text-sm"),children:(0,a.jsx)("button",{className:"hover:bg-base-200 text-base-content flex w-full items-center justify-between rounded-md p-1",onClick:()=>{r(!s),null==t||t()},children:(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("span",{style:{minWidth:"".concat(l,"px")},children:s&&(0,a.jsx)(el.g9_,{className:"text-base-content"})}),(0,a.jsx)("div",{className:"lg:tooltip","data-tip":n(s?"Apply to All Books":"Apply to This Book"),children:(0,a.jsx)("span",{className:"ml-2 whitespace-nowrap",children:n("Global Settings")})})]})})})},t0=e=>{var t;let{bookKey:n}=e,r=(0,i.B)(),{envConfig:o,appService:c}=(0,s.D)(),{getView:d,getViewSettings:u}=N(),{getBookData:h}=(0,w.I)(),{acquireVolumeKeyInterception:m,releaseVolumeKeyInterception:f}=(0,C.A)(),p=h(n),g=u(n),[b,x]=(0,l.useState)(g.scrolled),[v,y]=(0,l.useState)(g.continuousScroll),[j,k]=(0,l.useState)(g.scrollingOverlap),[S,A]=(0,l.useState)(g.volumeKeysToFlip),[E,T]=(0,l.useState)(g.disableClick),[L,M]=(0,l.useState)(g.swapClickArea),[I,B]=(0,l.useState)(g.animated),[R,P]=(0,l.useState)(g.allowScript);return(0,l.useEffect)(()=>{var e,t,a,l,s;b!==g.scrolled&&(tN(o,n,"scrolled",b),null==(e=d(n))||e.renderer.setAttribute("flow",b?"scrolled":"paginated"),null==(t=d(n))||t.renderer.setAttribute("max-inline-size","".concat((0,tr.Jt)(g),"px")),null==(l=d(n))||null==(a=(s=l.renderer).setStyles)||a.call(s,(0,Y.$f)(g)))},[b]),(0,l.useEffect)(()=>{tN(o,n,"continuousScroll",v,!1,!1)},[v]),(0,l.useEffect)(()=>{j!==g.scrollingOverlap&&tN(o,n,"scrollingOverlap",j,!1,!1)},[j]),(0,l.useEffect)(()=>{tN(o,n,"volumeKeysToFlip",S,!1,!1),(null==c?void 0:c.isMobileApp)&&(S?m():f())},[S]),(0,l.useEffect)(()=>{tN(o,n,"disableClick",E,!1,!1)},[E]),(0,l.useEffect)(()=>{tN(o,n,"swapClickArea",L,!1,!1)},[L]),(0,l.useEffect)(()=>{var e,t;tN(o,n,"animated",I,!1,!1),I?null==(e=d(n))||e.renderer.setAttribute("animated",""):null==(t=d(n))||t.renderer.removeAttribute("animated")},[I]),(0,l.useEffect)(()=>{g.allowScript!==R&&(tN(o,n,"allowScript",R,!0,!1),setTimeout(()=>window.location.reload(),100))},[R]),(0,a.jsxs)("div",{className:"my-4 w-full space-y-6",children:[(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsx)("h2",{className:"mb-2 font-medium",children:r("Scroll")}),(0,a.jsx)("div",{className:"card border-base-200 bg-base-100 border shadow",children:(0,a.jsxs)("div",{className:"divide-base-200 divide-y",children:[(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:r("Scrolled Mode")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:b,onChange:()=>x(!b)})]}),(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:r("Continuous Scroll")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:v,onChange:()=>y(!v)})]}),(0,a.jsx)(tD,{label:r("Overlap Pixels"),value:j,onChange:k,disabled:!g.scrolled,min:0,max:200,step:10})]})})]}),(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsx)("h2",{className:"mb-2 font-medium",children:r("Click")}),(0,a.jsx)("div",{className:"card border-base-200 bg-base-100 border shadow",children:(0,a.jsxs)("div",{className:"divide-base-200",children:[(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:r("Clicks for Page Flip")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:!E,onChange:()=>T(!E)})]}),(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:r("Swap Clicks Area")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:L,disabled:E,onChange:()=>M(!L)})]}),(null==c?void 0:c.isMobileApp)&&(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:r("Volume Keys for Page Flip")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:S,onChange:()=>A(!S)})]})]})})]}),(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsx)("h2",{className:"mb-2 font-medium",children:r("Animation")}),(0,a.jsx)("div",{className:"card border-base-200 bg-base-100 border shadow",children:(0,a.jsx)("div",{className:"divide-base-200 divide-y",children:(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:r("Paging Animation")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:I,onChange:()=>B(!I)})]})})})]}),(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsx)("h2",{className:"mb-2 font-medium",children:r("Security")}),(0,a.jsx)("div",{className:"card border-base-200 bg-base-100 border shadow",children:(0,a.jsx)("div",{className:"divide-base-200 divide-y",children:(0,a.jsxs)("div",{className:"config-item !h-16",children:[(0,a.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,a.jsx)("span",{className:"",children:r("Allow JavaScript")}),(0,a.jsx)("span",{className:"text-xs",children:r("Enable only if you trust the file.")})]}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:R,disabled:(null==(t=p.book)?void 0:t.format)!=="EPUB",onChange:()=>P(!R)})]})})})]})]})};var t1=n(63529),t2=n(4177);function t8(e){let{value:t,onChange:n,options:l,className:s,disabled:i=!1}=e;return(0,a.jsx)("select",{value:t,onChange:n,className:(0,d.A)("select h-8 min-h-8 rounded-md border-none text-end text-sm","focus:outline-none focus:ring-0",s),disabled:i,style:{textAlignLast:"end"},children:l.map(e=>{let{value:t,label:n}=e;return(0,a.jsx)("option",{value:t,children:n},t)})})}let t3=e=>{let{bookKey:t}=e,n=(0,i.B)(),{token:r}=(0,eQ.A)(),{envConfig:o}=(0,s.D)(),{getViewSettings:c,setViewSettings:u}=N(),h=c(t),[m,f]=(0,l.useState)(h.translationEnabled),[p,g]=(0,l.useState)(h.translationProvider),[b,x]=(0,l.useState)(h.translateTargetLang),v=()=>{let e=Object.entries(O.hQ).map(e=>{let[t,n]=e;return{value:t,label:n}});return e.sort((e,t)=>e.label.localeCompare(t.label)),e.unshift({value:"",label:n("System Language")}),e},w=()=>(0,t2.EC)().map(e=>{let t=e.label;return e.authRequired&&!r?t="".concat(t," (").concat(n("Login Required"),")"):e.quotaExceeded&&(t="".concat(t," (").concat(n("Quota Exceeded"),")")),{value:e.name,label:t}});return(0,l.useEffect)(()=>{m!==h.translationEnabled&&(tN(o,t,"translationEnabled",m,!0,!1),h.translationEnabled=m,u(t,{...h}))},[m]),(0,a.jsxs)("div",{className:(0,d.A)("my-4 w-full space-y-6"),children:[(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsx)("h2",{className:"mb-2 font-medium",children:n("Language")}),(0,a.jsx)("div",{className:"card border-base-200 bg-base-100 border shadow",children:(0,a.jsx)("div",{className:"divide-base-200 divide-y",children:(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:n("Interface Language")}),(0,a.jsx)(t8,{value:(()=>{let e=h.uiLanguage;return{value:e,label:""===e?n("Auto"):O.hQ[e]}})().value,onChange:e=>{let n=e.target.value;tN(o,t,"uiLanguage",n,!1,!1),t1.Ay.changeLanguage(n||navigator.language)},options:v()})]})})})]}),(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsx)("h2",{className:"mb-2 font-medium",children:n("Translation")}),(0,a.jsx)("div",{className:"card border-base-200 bg-base-100 border shadow",children:(0,a.jsxs)("div",{className:"divide-base-200",children:[(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:n("Enable Translation")}),(0,a.jsx)("input",{type:"checkbox",className:"toggle",checked:m,onChange:()=>f(!m)})]}),(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:n("Translation Service")}),(0,a.jsx)(t8,{value:(()=>{var e;let t=w(),n=(0,t2.EC)().filter(e=>(!e.authRequired||!!r)&&!e.quotaExceeded),a=n.find(e=>e.name===p)?p:null==(e=n[0])?void 0:e.name;return t.find(e=>e.value===a)||t[0]})().value,onChange:e=>{let n=e.target.value;g(n),tN(o,t,"translationProvider",n,!1,!1),h.translationProvider=n,u(t,{...h})},options:w(),disabled:!m})]}),(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:n("Translate To")}),(0,a.jsx)(t8,{value:(()=>{let e=v();return e.find(e=>e.value===b)||e[0]})().value,onChange:e=>{let n=e.target.value;x(n),tN(o,t,"translateTargetLang",n,!1,!1),h.translateTargetLang=n,u(t,{...h})},options:v(),disabled:!m})]})]})})]})]})};var t5=n(44653),t6=n.n(t5);let t4=e=>{e=e.replace(/\/\*[\s\S]*?\*\//g,"").trim();let t=/^[\s\n]*[-\w]+\s*:\s*[^;]+;?$/;if(!e)return{isValid:!1,error:"Empty CSS"};if((e.match(/{/g)||[]).length!==(e.match(/}/g)||[]).length)return{isValid:!1,error:"Unbalanced curly braces"};for(let n of e.split("}").map(e=>e.trim()).filter(Boolean)){let e=n.split("{").map(e=>e.trim());if(2!==e.length)return{isValid:!1,error:"Invalid CSS structure"};let[a,l]=e;if(!a)return{isValid:!1,error:"Missing selector"};if(!l)return{isValid:!1,error:"Missing declarations for selector: ".concat(a)};let s=l.split(";").map(e=>e.trim()).filter(Boolean);if(0===s.length)return{isValid:!1,error:"No valid properties for selector: ".concat(a)};for(let e of s){if(!e.includes(":"))return{isValid:!1,error:"Missing property or value: ".concat(e)};let[n,a]=e.split(":").map(e=>e.trim());if(!n)return{isValid:!1,error:"Missing property name: ".concat(e)};if(!a)return{isValid:!1,error:"Missing property value: ".concat(e)};if(!t.test(e.endsWith(";")?e:e+";"))return{isValid:!1,error:"Invalid property: ".concat(e)}}}return{isValid:!0,error:null}},t9=e=>{let{bookKey:t}=e,n=(0,i.B)(),{envConfig:r,appService:c}=(0,s.D)(),{settings:u,isFontLayoutSettingsGlobal:h,setSettings:m}=(0,o.C)(),{getView:f,getViewSettings:p,setViewSettings:g}=N(),b=p(t),[x,v]=(0,l.useState)(b.userStylesheet),[w,y]=(0,l.useState)(!0),[j,k]=(0,l.useState)(b.screenOrientation),[S,C]=(0,l.useState)(null),[A,E]=(0,l.useState)(!1),T=(0,l.useRef)(null),L=e=>{e.stopPropagation(),e.nativeEvent.stopImmediatePropagation()};return(0,l.useEffect)(()=>{tN(r,t,"screenOrientation",j,!1,!1),(null==c?void 0:c.isMobileApp)&&(0,B.ot)({orientation:j})},[j]),(0,a.jsxs)("div",{className:(0,d.A)("my-4 w-full space-y-6",A&&"h-[50%] overflow-y-auto pb-[200px]"),children:[(null==c?void 0:c.isMobileApp)&&(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsx)("h2",{className:"mb-2 font-medium",children:n("Screen")}),(0,a.jsx)("div",{className:"card border-base-200 bg-base-100 border shadow",children:(0,a.jsx)("div",{className:"divide-base-200 divide-y",children:(0,a.jsxs)("div",{className:"config-item",children:[(0,a.jsx)("span",{className:"",children:n("Orientation")}),(0,a.jsxs)("div",{className:"flex gap-4",children:[(0,a.jsx)("div",{className:"lg:tooltip lg:tooltip-bottom","data-tip":n("Auto"),children:(0,a.jsx)("button",{className:"btn btn-ghost btn-circle btn-sm ".concat("auto"===j?"btn-active bg-base-300":""),onClick:()=>k("auto"),children:(0,a.jsx)(el.Q7t,{})})}),(0,a.jsx)("div",{className:"lg:tooltip lg:tooltip-bottom","data-tip":n("Portrait"),children:(0,a.jsx)("button",{className:"btn btn-ghost btn-circle btn-sm ".concat("portrait"===j?"btn-active bg-base-300":""),onClick:()=>k("portrait"),children:(0,a.jsx)(t_.scQ,{})})}),(0,a.jsx)("div",{className:"lg:tooltip lg:tooltip-bottom","data-tip":n("Landscape"),children:(0,a.jsx)("button",{className:"btn btn-ghost btn-circle btn-sm ".concat("landscape"===j?"btn-active bg-base-300":""),onClick:()=>k("landscape"),children:(0,a.jsx)(t_.KXi,{})})})]})]})})})]}),(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsx)("h2",{className:"mb-2 font-medium",children:n("Custom CSS")}),(0,a.jsx)("div",{className:"card border-base-200 bg-base-100 border shadow ".concat(S?"border-red-500":""),children:(0,a.jsxs)("div",{className:"relative p-1",children:[(0,a.jsx)("textarea",{ref:T,className:(0,d.A)("textarea textarea-ghost h-48 w-full border-0 p-3 text-base !outline-none sm:text-sm","placeholder:text-base-content/70"),placeholder:n("Enter your custom CSS here..."),spellCheck:"false",value:x,onFocus:()=>{(null==c?void 0:c.isAndroidApp)&&E(!0),setTimeout(()=>{var e;null==(e=T.current)||e.scrollIntoView({behavior:"instant",block:"center"})},300)},onBlur:()=>{(null==c?void 0:c.isAndroidApp)&&setTimeout(()=>{E(!1)},100)},onInput:L,onKeyDown:L,onKeyUp:L,onChange:e=>{let t=e.target.value;v(t),y(!1);try{let{isValid:e,error:n}=t4(t);if(t&&!e)throw Error(n||"Invalid CSS");C(null)}catch(e){e instanceof Error?C(e.message):C("Invalid CSS: Please check your input."),console.log("CSS Error:",e)}}}),(0,a.jsx)("button",{className:(0,d.A)("btn btn-ghost bg-base-200 absolute bottom-2 right-4 h-8 min-h-8 px-4 py-2",w?"hidden":"",S?"btn-disabled":""),onClick:()=>{var e,n,a;let l=t6()(x,{indent:"  ",openbrace:"end-of-line",autosemicolon:!0});v(l),y(!0),b.userStylesheet=l,g(t,{...b}),h&&(u.globalViewSettings.userStylesheet=l,m(u)),null==(n=f(t))||null==(e=(a=n.renderer).setStyles)||e.call(a,(0,Y.$f)(b))},disabled:!!S,children:n("Apply")})]})}),S&&(0,a.jsx)("p",{className:"mt-1 text-sm text-red-500",children:S})]})]})},t7=e=>{var t;let{bookKey:n}=e,r=(0,i.B)(),{appService:c}=(0,s.D)(),[u]=(0,l.useState)(()=>"rtl"===(0,to.A)()),h=(0,l.useRef)(null),[m,f]=(0,l.useState)(!1),{setFontLayoutSettingsDialogOpen:p}=(0,o.C)(),g=[{tab:"Font",icon:ty.Oui,label:r("Font")},{tab:"Layout",icon:ty.oeo,label:r("Layout")},{tab:"Color",icon:tR.YK8,label:r("Color")},{tab:"Control",icon:tP.Gqw,label:r("Behavior")},{tab:"Language",icon:ty.avg,label:r("Language")},{tab:"Custom",icon:t_.pD3,label:r("Custom")}],[b,x]=(0,l.useState)(()=>{let e=localStorage.getItem("lastConfigPanel");return e&&g.some(t=>t.tab===e)?e:"Font"}),v=e=>{x(e),localStorage.setItem("lastConfigPanel",e)},w=()=>{p(!1)};return(0,l.useEffect)(()=>{let e=h.current;if(!e)return;let t=()=>{let t=(e.clientWidth-64)*.22;f(!Array.from(e.querySelectorAll("button")).some(e=>{let n=e.querySelector("span"),a=(null==n?void 0:n.textContent)||"",l=e.cloneNode(!0);l.style.position="absolute",l.style.visibility="hidden",l.style.width="auto";let s=l.querySelector("span");s&&(s.classList.remove("hidden"),s.textContent=a),document.body.appendChild(l);let i=l.scrollWidth;return document.body.removeChild(l),i>t}))};t();let n=new ResizeObserver(t);n.observe(e);let a=new MutationObserver(t);return a.observe(e,{subtree:!0,characterData:!0}),()=>{n.disconnect(),a.disconnect()}},[]),(0,a.jsxs)(tQ.A,{isOpen:!0,onClose:w,className:"modal-open",boxClassName:(0,d.A)("sm:min-w-[520px]",(null==c?void 0:c.isMobile)&&"sm:max-w-[90%] sm:w-3/4"),snapHeight:(null==c?void 0:c.isMobile)?.7:void 0,header:(0,a.jsxs)("div",{className:"flex w-full flex-col items-center",children:[(0,a.jsx)("div",{className:"tab-title flex pb-2 text-base font-semibold sm:hidden",children:(null==(t=g.find(e=>e.tab===b))?void 0:t.label)||""}),(0,a.jsxs)("div",{className:"flex w-full flex-row items-center justify-between",children:[(0,a.jsx)("button",{tabIndex:-1,onClick:w,className:"btn btn-ghost btn-circle flex h-8 min-h-8 w-8 hover:bg-transparent focus:outline-none sm:hidden",children:u?(0,a.jsx)(el.ree,{}):(0,a.jsx)(el.VR3,{})}),(0,a.jsx)("div",{ref:h,className:(0,d.A)("dialog-tabs ms-1 flex h-10 w-full items-center gap-1 sm:ms-0"),children:g.map(e=>{let{tab:t,icon:n,label:l}=e;return(0,a.jsxs)("button",{"data-tab":t,className:(0,d.A)("btn btn-ghost text-base-content btn-sm gap-1 px-2",b===t?"btn-active":""),onClick:()=>v(t),children:[(0,a.jsx)(n,{className:"mr-0"}),(0,a.jsx)("span",{className:(0,d.A)(window.innerWidth<640&&"hidden",!(m||b===t)&&"hidden"),children:l})]},t)})}),(0,a.jsxs)("div",{className:"flex h-full items-center justify-end gap-x-2",children:[(0,a.jsx)(er.A,{className:"dropdown-bottom dropdown-end",buttonClassName:"btn btn-ghost h-8 min-h-8 w-8 p-0 flex items-center justify-center",toggleButton:(0,a.jsx)(eT.Pwf,{}),children:(0,a.jsx)(t$,{})}),(0,a.jsx)("button",{onClick:w,className:"bg-base-300/65 btn btn-ghost btn-circle hidden h-6 min-h-6 w-6 p-0 sm:flex",children:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{fill:"currentColor",d:"M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"})})})]})]})]}),children:["Font"===b&&(0,a.jsx)(tK,{bookKey:n}),"Layout"===b&&(0,a.jsx)(tU,{bookKey:n}),"Color"===b&&(0,a.jsx)(tZ,{bookKey:n}),"Control"===b&&(0,a.jsx)(t0,{bookKey:n}),"Language"===b&&(0,a.jsx)(t3,{bookKey:n}),"Custom"===b&&(0,a.jsx)(t9,{bookKey:n})]})};var ne=n(90579),nt=n(35913);let nn=e=>{let{user:t}=(0,eQ.A)(),{syncedNotes:n,syncNotes:a,lastSyncedAtNotes:s}=(0,e$.p)(e),{getConfig:i,setConfig:r}=(0,w.I)(),o=i(e),c=e.split("-")[0],d=()=>{var n;let a=i(e);if(!(null==a?void 0:a.location)||!t)return[];let l=(null!=(n=a.booknotes)?n:[]).filter(e=>{var t;return s<e.updatedAt||s<(null!=(t=e.deletedAt)?t:0)});return l.forEach(e=>{e.bookHash=c}),l},u=(0,l.useCallback)((0,eX.s)(()=>{a(d(),c,"both")},1e3*O.u1),[s]);(0,l.useEffect)(()=>{(null==o?void 0:o.location)&&t&&u()},[o]),(0,l.useEffect)(()=>{if((null==n?void 0:n.length)&&o){var t;let a=n.filter(e=>e.bookHash===c);if(!a.length)return;let l=[...(null!=(t=o.booknotes)?t:[]).filter(e=>!a.some(t=>t.id===e.id)),...a.map(t=>{var n,a,l;let s=i(e),r=(null!=(n=null==s?void 0:s.booknotes)?n:[]).find(e=>e.id===t.id);return r?r.updatedAt<t.updatedAt||(null!=(a=r.deletedAt)?a:0)<(null!=(l=t.deletedAt)?l:0)?{...r,...t}:{...t,...r}:t})];r(e,{booknotes:l})}},[n])},na=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,l=n*t.left+e.left,s=n*t.right+e.left;return{left:l,right:s,top:a*t.top+e.top,bottom:a*t.bottom+e.top}},nl=e=>{let{x:t,y:n}=e;return t>0&&n>0&&t<window.innerWidth&&n<window.innerHeight},ns=e=>{let t;for(t=e&&"object"==typeof e&&("tagName"in e)?e:e&&"object"==typeof e&&("collapse"in e)?e.commonAncestorContainer:e;t;){if(t.nodeType===Node.DOCUMENT_NODE){let e=t;if(e.defaultView&&e.defaultView.frameElement)return e.defaultView.frameElement}t=t.parentNode}return null},ni=(e,t,n)=>({x:Math.max(n,Math.min(e.x,t.right-n)),y:Math.max(n,Math.min(e.y,t.bottom-n))}),nr=function(e,t,n){var a,l,s,i;let r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=ns(e),c=(o?getComputedStyle(o).transform:"").match(/matrix\((.+)\)/),[d,,,u]=null!=(s=null==c||null==(l=c[1])||null==(a=l.split(/\s*,\s*/))?void 0:a.map(e=>parseFloat(e)))?s:[],h=null!=(i=null==o?void 0:o.getBoundingClientRect())?i:{top:0,left:0},m=Array.from(e.getClientRects()),f=na(h,m[0],d,u),p=na(h,m.at(-1),d,u);if(r){let e=f.left-t.left>t.right-f.right?"left":"right",a={point:ni({x:"left"===e?f.left-t.left-6:f.right-t.left+6,y:(f.top+f.bottom)/2-t.top},t,n),dir:e};return nl(a.point)?a:{point:{x:0,y:0},dir:e}}let g={point:{x:(f.left+f.right)/2-t.left,y:f.top-t.top-12},dir:"up"},b={point:{x:(p.left+p.right)/2-t.left,y:p.bottom-t.top+6},dir:"down"},x=nl(g.point),v=nl(b.point);return x||v?x?v?g.point.y>window.innerHeight-b.point.y?g:b:g:b:{point:{x:0,y:0}}},no=(e,t,n,a,l)=>{let s={x:0,y:0};return"up"===e.dir?(s.x=e.point.x-n/2,s.y=e.point.y-a):"down"===e.dir?(s.x=e.point.x-n/2,s.y=e.point.y+6):"left"===e.dir?(s.x=e.point.x-n,s.y=e.point.y-a/2):"right"===e.dir&&(s.x=e.point.x+6,s.y=e.point.y-a/2),s.x<l&&(s.x=l),s.y<l&&(s.y=l),s.x+n>t.right-t.left-l&&(s.x=t.right-t.left-l-n),s.y+a>t.bottom-t.top-l&&(s.y=t.bottom-t.top-l-a),{point:s,dir:e.dir}},nc=function(e){let t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],a=e.cloneRange().cloneContents(),l=document.createTreeWalker(a,NodeFilter.SHOW_TEXT,{acceptNode:e=>{let t=e.parentElement;return n.includes((null==t?void 0:t.tagName.toLowerCase())||"")?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}}),s="";for(;t=l.nextNode();){var i;s+=null!=(i=t.nodeValue)?i:""}return s},nd=(e,t,n)=>{var a;let{appService:i}=(0,s.D)(),{getBookData:r}=(0,w.I)(),{getView:o,getViewSettings:c}=N(),d=o(e),u=(null==(a=r(e).book)?void 0:a.primaryLanguage)||"en",h=(0,F.Ox)(),m=(0,l.useRef)(!1),f=(0,l.useRef)(!1),p=(0,l.useRef)(!1),g=(0,l.useRef)(!1),b=(0,l.useRef)(null),[x,v]=(0,l.useState)(!1),y=e=>e&&e.toString().trim().length>0&&e.rangeCount>0,j={bookKey:e,viewSettings:c(e),content:"",transformers:["punctuation"],reversePunctuationTransform:!0},k=async e=>(j.content=nc(e,u.startsWith("ja")?["rt"]:[]),await tu(j)),S=async function(n,a){let l=arguments.length>2&&void 0!==arguments[2]&&arguments[2];p.current=!0,v(!0);let s=n.getRangeAt(0);l&&(n.removeAllRanges(),n.addRange(s)),t({key:e,text:await k(s),range:s,index:a})},C=async(n,a)=>{p.current=!0,v(!0);let l=n.getRangeAt(0);setTimeout(()=>{n.removeAllRanges(),setTimeout(async()=>{p.current&&(n.addRange(l),t({key:e,text:await k(l),range:l,index:a}))},40)},0)};return(0,l.useEffect)(()=>{if(p.current&&!b.current){var e;b.current=(null==d||null==(e=d.renderer)?void 0:e.start)||null}else p.current||(b.current=null)},[x]),(0,l.useEffect)(()=>{let e=()=>f.current?(f.current=!1,!0):p.current?(n(),p.current=!1,v(!1),null==d||d.deselect(),!0):!!m.current&&(n(),!0);return E.I.onSync("iframe-single-click",e),()=>{E.I.offSync("iframe-single-click",e)}},[]),{handleScroll:()=>{var t;let n=c(e);(null==i?void 0:i.isAndroidApp)&&!(null==n?void 0:n.scrolled)&&(null==d||null==(t=d.renderer)?void 0:t.containerPosition)&&b.current&&(console.warn("Keep container position",b.current),d.renderer.containerPosition=b.current)},handleTouchStart:()=>{g.current=!0},handleTouchEnd:()=>{g.current=!1},handlePointerup:(e,t)=>{let n=e.getSelection();y(n)&&("ios"===h?C(n,t):S(n,t,!0))},handleSelectionchange:(e,t)=>{let a=e.getSelection();if("ios"!==h){if(!y(a)){f.current||(n(),p.current=!1,v(!1)),m.current&&(f.current=!1);return}g.current&&"android"===h&&S(a,t,!1),f.current=!0}},handleShowPopup:e=>{setTimeout(()=>{e&&!m.current&&(f.current=!1),m.current=e},500*!["android","ios"].includes(h))},handleUpToPopup:()=>{f.current=!0}}},nu=e=>{let{width:t,height:n,minHeight:s,maxHeight:i,position:r,trianglePosition:o,children:c,className:u="",triangleClassName:h="",additionalStyle:m={}}=e,f=(0,l.useRef)(null),[p,g]=(0,l.useState)(r),[b,x]=(0,l.useState)(n||s||0),v=(0,es.D)(10),w=window.innerHeight-2*v;return(null==o?void 0:o.dir)==="up"?w=o.point.y-v:(null==o?void 0:o.dir)==="down"&&(w=window.innerHeight-o.point.y-v),i=Math.min(i||w,w),s&&(s=Math.min(s,w)),(0,l.useEffect)(()=>{if(!f.current)return;let e=new ResizeObserver(e=>{for(let t of e){let e=t.contentRect.height;if(e!==b)return void x(e)}});return e.observe(f.current),()=>{e.disconnect()}},[]),(0,l.useEffect)(()=>{if(!f.current)return;if(!r||!o||"up"!==r.dir)return void g(r);let e=b||f.current.offsetHeight;g({...r,point:{...r.point,y:o.point.y-e}})},[r,o,b]),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{id:"popup-container",ref:f,className:(0,d.A)("bg-base-300 absolute rounded-lg font-sans shadow-xl",u),style:{width:"".concat(t,"px"),height:n?"".concat(n,"px"):"auto",minHeight:s?"".concat(s,"px"):"none",maxHeight:i?"".concat(i,"px"):"none",left:"".concat(p?p.point.x:-999,"px"),top:"".concat(p?p.point.y:-999,"px"),...m},children:c}),(0,a.jsx)("div",{className:"triangle text-base-300 absolute ".concat(h),style:{left:(null==o?void 0:o.dir)==="left"||(null==o?void 0:o.dir)==="right"?"".concat(o.point.x,"px"):"".concat(o?o.point.x:-999,"px"),top:(null==o?void 0:o.dir)==="up"||(null==o?void 0:o.dir)==="down"?"".concat(o.point.y,"px"):"".concat(o?o.point.y:-999,"px"),borderLeft:(null==o?void 0:o.dir)==="right"?"none":(null==o?void 0:o.dir)==="left"?"6px solid":"6px solid transparent",borderRight:(null==o?void 0:o.dir)==="left"?"none":(null==o?void 0:o.dir)==="right"?"6px solid":"6px solid transparent",borderTop:(null==o?void 0:o.dir)==="down"?"none":(null==o?void 0:o.dir)==="up"?"6px solid":"6px solid transparent",borderBottom:(null==o?void 0:o.dir)==="up"?"none":(null==o?void 0:o.dir)==="down"?"6px solid":"6px solid transparent",transform:(null==o?void 0:o.dir)==="left"||(null==o?void 0:o.dir)==="right"?"translateY(-50%)":"translateX(-50%)"}})]})},nh=e=>{let{showTooltip:t,tooltipText:n,Icon:s,onClick:i}=e,[r,o]=(0,l.useState)(!1);return(0,a.jsx)("div",{className:"lg:tooltip lg:tooltip-bottom","data-tip":!r&&t?n:null,children:(0,a.jsx)("button",{onClick:()=>{o(!0),i()},className:"flex h-8 min-h-8 w-8 items-center justify-center p-0",children:(0,a.jsx)(s,{})})})},nm=["highlight","underline","squiggly"],nf=["red","violet","blue","green","yellow"],np=e=>{let{style:t,isVertical:n,selectedStyle:s,selectedColor:i,onHandleHighlight:r}=e,{settings:c,setSettings:u}=(0,o.C)(),h=c.globalReadSettings,[m,f]=l.useState(s),[p,g]=l.useState(i),b=(0,es.D)(16),x=(0,es.D)(18),v=(0,es.D)(28),w=e=>{h.highlightStyle=e,u(c),f(e),g(h.highlightStyles[e]),r(!0)},y=e=>{h.highlightStyle=m,h.highlightStyles[m]=e,u(c),g(e),r(!0)};return(0,a.jsxs)("div",{className:(0,d.A)("highlight-options absolute flex items-center justify-between",n?"flex-col":"flex-row"),style:t,children:[(0,a.jsx)("div",{className:(0,d.A)("flex gap-2",n?"flex-col":"flex-row"),style:n?{width:v}:{height:v},children:nm.map(e=>(0,a.jsx)("button",{onClick:()=>w(e),className:"flex items-center justify-center rounded-full bg-gray-700 p-0",style:{width:v,height:v,minHeight:v},children:(0,a.jsx)("div",{style:{width:b,height:"squiggly"===e?x:b},className:(0,d.A)("w-4 p-0 text-center leading-none","highlight"===e&&("highlight"===m?"bg-".concat(p,"-400"):"bg-gray-300"),("underline"===e||"squiggly"===e)&&"text-gray-300 underline decoration-2","underline"===e&&("underline"===m?"decoration-".concat(p,"-400"):"decoration-gray-300"),"squiggly"===e&&("squiggly"===m?"decoration-wavy decoration-".concat(p,"-400"):"decoration-gray-300 decoration-wavy")),children:"A"})},e))}),(0,a.jsx)("div",{className:(0,d.A)("flex items-center justify-center gap-2 rounded-3xl bg-gray-700",n?"flex-col py-2":"flex-row px-2"),style:n?{width:v}:{height:v},children:nf.map(e=>(0,a.jsx)("button",{onClick:()=>y(e),style:{width:b,height:b},className:(0,d.A)("rounded-full p-0",p!==e&&"bg-".concat(e,"-400")),children:p===e&&(0,a.jsx)(eR.A7C,{size:b,className:(0,d.A)("fill-".concat(e,"-400"))})},e))})]})},ng=e=>{let{dir:t,isVertical:n,buttons:l,position:s,trianglePosition:i,highlightOptionsVisible:r,selectedStyle:o,selectedColor:c,popupWidth:u,popupHeight:h,onHighlight:m}=e,f=(0,es.D)(28),p=(0,es.D)(16);return(0,a.jsxs)("div",{dir:t,children:[(0,a.jsx)(nu,{width:n?h:u,height:n?u:h,position:s,trianglePosition:i,className:"selection-popup bg-gray-600 text-white",triangleClassName:"text-gray-600",children:(0,a.jsx)("div",{className:(0,d.A)("selection-buttons flex items-center justify-between p-2",n?"flex-col":"flex-row"),style:{height:n?u:h},children:l.map((e,t)=>(0,a.jsx)(nh,{showTooltip:!r,tooltipText:e.tooltipText,Icon:e.Icon,onClick:e.onClick},t))})}),r&&(0,a.jsx)(np,{isVertical:n,style:{width:"".concat(n?h:u,"px"),height:"".concat(n?u:h,"px"),...n?{left:"".concat(s.point.x+(f+p)*("left"===i.dir?-1:1),"px"),top:"".concat(s.point.y,"px")}:{left:"".concat(s.point.x,"px"),top:"".concat(s.point.y+(f+p)*("up"===i.dir?-1:1),"px")}},selectedStyle:o,selectedColor:c,onHandleHighlight:m})]})},nb=e=>{let{word:t,lang:n,position:s,trianglePosition:i,popupWidth:r,popupHeight:o}=e,[c,d]=(0,l.useState)(t),u=(0,l.useRef)(!1),h=e=>{let t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll('a[rel="mw:WikiLink"]').forEach(e=>{let t=e.getAttribute("title");t&&(e.addEventListener("click",e=>{e.preventDefault(),d(t),u.current=!1}),e.className="text-primary underline cursor-pointer")}),Array.from(t.childNodes)};return(0,l.useEffect)(()=>{if(u.current)return;u.current=!0;let e=document.querySelector("main"),t=document.querySelector("footer");(async(n,a)=>{e.innerHTML="",t.dataset.state="loading";try{let l=await fetch("https://en.wiktionary.org/api/rest_v1/page/definition/".concat(n));if(!l.ok)throw Error("Failed to fetch definitions");let s=await l.json(),i=a?s[a]||s.en:s[Object.keys(s)[0]];if(!i||0===i.length)throw Error("No results found");let r=document.createElement("hgroup"),o=document.createElement("h1");o.innerText=n,o.className="text-lg font-bold";let c=document.createElement("p");c.innerText=i[0].language,c.className="text-sm italic opacity-75",r.append(o,c),e.append(r),i.forEach(t=>{let{partOfSpeech:n,definitions:a}=t,l=document.createElement("h2");l.innerText=n,l.className="text-base font-semibold mt-4";let s=document.createElement("ol");s.className="pl-8 list-decimal",a.forEach(e=>{let{definition:t,examples:n}=e;if(!t)return;let a=document.createElement("li"),l=h(t);if(a.append(...l),n){let e=document.createElement("ul");e.className="pl-8 list-disc text-sm italic opacity-75",n.forEach(t=>{let n=document.createElement("li");n.innerHTML=t,e.appendChild(n)}),a.appendChild(e)}s.appendChild(a)}),e.appendChild(l),e.appendChild(s)}),t.dataset.state="loaded"}catch(i){console.error(i),t.dataset.state="error";let a=document.createElement("div");a.className="flex flex-col items-center justify-center w-full h-full text-center absolute inset-0";let l=document.createElement("h1");l.innerText="Error",l.className="text-lg font-bold";let s=document.createElement("p");s.innerHTML='Unable to load the word. Try searching directly on <a href="https://en.wiktionary.org/w/index.php?search='.concat(encodeURIComponent(n),'" target="_blank" rel="noopener noreferrer" class="text-primary underline">Wiktionary</a>.'),a.append(l,s),e.append(a)}})(c,"string"==typeof n?n:null==n?void 0:n[0])},[c,n]),(0,a.jsx)("div",{children:(0,a.jsx)(nu,{trianglePosition:i,width:r,height:o,position:s,className:"select-text",children:(0,a.jsxs)("div",{className:"flex h-full flex-col",children:[(0,a.jsx)("main",{className:"flex-grow overflow-y-auto p-4 font-sans"}),(0,a.jsx)("footer",{className:"mt-auto hidden data-[state=loaded]:block data-[state=error]:hidden data-[state=loading]:hidden",children:(0,a.jsx)("div",{className:"flex items-center px-4 py-2 text-sm opacity-60",children:"Source: Wiktionary (CC BY-SA)"})})]})})})},nx=e=>{let{text:t,lang:n,position:s,trianglePosition:i,popupWidth:r,popupHeight:o}=e,c=(0,l.useRef)(!1);return(0,l.useEffect)(()=>{if(c.current)return;c.current=!0;let e=document.querySelector("main"),a=document.querySelector("footer"),l=async(t,n)=>{e.innerHTML="",a.dataset.state="loading";try{let l=await fetch("https://".concat(n,".wikipedia.org/api/rest_v1/page/summary/").concat(encodeURIComponent(t)));if(!l.ok)throw Error("Failed to fetch Wikipedia summary");let s=await l.json(),i=document.createElement("hgroup");i.style.color="white",i.style.backgroundPosition="center center",i.style.backgroundSize="cover",i.style.backgroundColor="rgba(0, 0, 0, .4)",i.style.backgroundBlendMode="darken",i.style.borderRadius="6px",i.style.padding="12px",i.style.marginBottom="12px",i.style.minHeight="100px";let r=document.createElement("h1");if(r.innerHTML=s.titles.display,r.className="text-lg font-bold",i.append(r),s.description){let e=document.createElement("p");e.innerText=s.description,i.appendChild(e)}s.thumbnail&&(i.style.backgroundImage='url("'.concat(s.thumbnail.source,'")'));let o=document.createElement("div");o.innerHTML=s.extract_html,o.className="p-2 text-sm",o.dir=s.dir,e.append(i,o),a.dataset.state="loaded"}catch(r){console.error(r);let l=document.createElement("div"),s=document.createElement("h1");s.innerText="Error";let i=document.createElement("p");i.innerHTML='Unable to load the article. Try searching directly on <a href="https://'.concat(n,".wikipedia.org/w/index.php?search=").concat(encodeURIComponent(t),'" target="_blank" rel="noopener noreferrer" class="text-primary underline">Wikipedia</a>.'),l.append(s,i),e.appendChild(l),a.dataset.state="error"}},s="string"==typeof n?n:null==n?void 0:n[0];l(t,s?s.split("-")[0]:"en")},[t,n]),(0,a.jsx)("div",{children:(0,a.jsx)(nu,{width:r,height:o,position:s,trianglePosition:i,className:"select-text",children:(0,a.jsxs)("div",{className:"text-base-content flex h-full flex-col pt-2",children:[(0,a.jsx)("main",{className:"flex-grow overflow-y-auto px-2 font-sans"}),(0,a.jsx)("footer",{className:"mt-auto hidden data-[state=loaded]:block data-[state=error]:hidden data-[state=loading]:hidden",children:(0,a.jsx)("div",{className:"flex items-center px-4 py-2 text-sm opacity-60",children:"Source: Wikipedia (CC BY-SA)"})})]})})})},nv=["hi","vi"],nw=(()=>{let e={...O.hQ},t={};for(let[n,a]of Object.entries(e))nv.includes(n)||(t[(0,ep.GV)(n).toUpperCase()]=a);return t})(),ny=e=>{var t;let{text:n,position:s,trianglePosition:r,popupWidth:c,popupHeight:d}=e,u=(0,i.B)(),{token:h}=(0,eQ.A)(),{settings:m,setSettings:f}=(0,o.C)(),[p,g]=(0,l.useState)([]),[b,x]=(0,l.useState)("AUTO"),[v,w]=(0,l.useState)(m.globalReadSettings.translateTargetLang),[y,j]=(0,l.useState)(m.globalReadSettings.translationProvider),[N,k]=(0,l.useState)(null),[S,C]=(0,l.useState)(null),[A,E]=(0,l.useState)(!1),[T,L]=(0,l.useState)(null),{translate:M,translators:I}=(0,em.m)({provider:y,sourceLang:b,targetLang:v});return(0,l.useEffect)(()=>{g(I.map(e=>{let t=e.label;return e.authRequired&&!h?t="".concat(t," (").concat(u("Login Required"),")"):e.quotaExceeded&&(t="".concat(t," (").concat(u("Quota Exceeded"),")")),{name:e.name,label:t}}))},[I]),(0,l.useEffect)(()=>{E(!0),(async()=>{L(null),k(null);try{let e=n.replaceAll("\n","").trim(),t=(await M([e]))[0];if(!t)throw Error("No translation found");k(t)}catch(e){console.error(e),h?L(u("Unable to fetch the translation. Try again later.")):L(u("Unable to fetch the translation. Please log in first and try again."))}finally{E(!1)}})()},[n,h,b,v,y]),(0,a.jsx)("div",{children:(0,a.jsxs)(nu,{trianglePosition:r,width:c,minHeight:d,maxHeight:720,position:s,className:"grid h-full select-text grid-rows-[1fr,auto,1fr] bg-gray-600 text-white",triangleClassName:"text-gray-600",children:[(0,a.jsxs)("div",{className:"overflow-y-auto p-4 font-sans",children:[(0,a.jsxs)("div",{className:"mb-2 flex items-center justify-between",children:[(0,a.jsx)("h1",{className:"text-sm font-normal",children:u("Original Text")}),(0,a.jsx)(t8,{className:"bg-gray-600 text-white/75",value:b,onChange:e=>{x(e.target.value)},options:[{value:"AUTO",label:u("Auto Detect")},...Object.entries(nw).sort((e,t)=>e[1].localeCompare(t[1])).map(e=>{let[t,n]=e,a=S&&"AUTO"===b&&"AUTO"===t?"".concat(nw[S]||S," ")+u("(detected)"):n;return{value:t,label:a}})]})]}),(0,a.jsx)("p",{className:"text-base text-white/90",children:n})]}),(0,a.jsx)("div",{className:"mx-4 flex-shrink-0 border-t border-gray-500/30"}),(0,a.jsxs)("div",{className:"overflow-y-auto px-4 pb-8 pt-4 font-sans",children:[(0,a.jsxs)("div",{className:"mb-2 flex items-center justify-between",children:[(0,a.jsx)("h2",{className:"text-sm font-normal",children:u("Translated Text")}),(0,a.jsx)(t8,{className:"bg-gray-600 text-white/75",value:v,onChange:e=>{m.globalReadSettings.translateTargetLang=e.target.value,f(m),w(e.target.value)},options:Object.entries(nw).sort((e,t)=>e[1].localeCompare(t[1])).map(e=>{let[t,n]=e;return{value:t,label:n}})})]}),A?(0,a.jsx)("p",{className:"text-base italic text-gray-500",children:u("Loading...")}):(0,a.jsx)("div",{children:T?(0,a.jsx)("p",{className:"text-base text-red-600",children:T}):(0,a.jsx)("p",{className:"text-base text-white/90",children:N||u("No translation available.")})})]}),(0,a.jsxs)("div",{className:"absolute bottom-0 flex h-8 w-full items-center justify-between bg-gray-600 px-4",children:[y&&!A&&(0,a.jsx)("div",{className:"text-xs opacity-60",children:T?"":u("Translated by {{provider}}.",{provider:null==(t=p.find(e=>e.name===y))?void 0:t.label})}),(0,a.jsx)("div",{className:"ml-auto",children:(0,a.jsx)(t8,{className:"bg-gray-600 text-white/75",value:y,onChange:e=>{let t=e.target.value,n=(0,t2.EC)().filter(e=>(!e.authRequired||!!h)&&!e.quotaExceeded),a=n.find(e=>e.name===t)||n[0];a&&(m.globalReadSettings.translationProvider=a.name,f(m),j(a.name))},options:p.map(e=>{let{name:t,label:n}=e;return{value:t,label:n}})})})]})]})})},nj=e=>{var t,n;let{bookKey:r}=e,c=(0,i.B)(),{envConfig:d,appService:u}=(0,s.D)(),{settings:h}=(0,o.C)(),{getConfig:m,saveConfig:f,getBookData:p,updateBooknotes:b}=(0,w.I)(),{getProgress:x,getView:v,getViewsById:y,getViewSettings:j}=N(),{setNotebookVisible:k,setNotebookNewAnnotation:C}=S();nn(r);let A=(0,F.Ox)(),T=m(r),L=x(r),M=p(r),I=v(r),B=j(r),[R,P]=(0,l.useState)(null),[_,D]=(0,l.useState)(!1),[z,V]=(0,l.useState)(!1),[W,H]=(0,l.useState)(!1),[K,U]=(0,l.useState)(!1),[Y,G]=(0,l.useState)(),[X,q]=(0,l.useState)(),[J,Z]=(0,l.useState)(),[Q,$]=(0,l.useState)(),[ee,et]=(0,l.useState)(!1),[en,el]=(0,l.useState)(h.globalReadSettings.highlightStyle),[ei,er]=(0,l.useState)(h.globalReadSettings.highlightStyles[en]),eo=(0,es.D)(10),ec=window.innerWidth-2*eo,ed=window.innerHeight-2*eo,eu=Math.min(480,ec),eh=Math.min(300,ed),em=Math.min(480,ec),ef=Math.min(265,ed),ep=Math.min((0,es.D)(300),ec),eg=(0,es.D)(44),eb=()=>{P(null),D(!1),V(!1),H(!1),U(!1)},ex=()=>{eb(),null==I||I.deselect()},{handleScroll:ev,handleTouchStart:ew,handleTouchEnd:ey,handlePointerup:ej,handleSelectionchange:ek,handleShowPopup:eS,handleUpToPopup:eC}=nd(r,P,eb);eZ(I,{onLoad:e=>{var t,n,a,l,s,i,r,o;let c=e.detail,{doc:d,index:h}=c;(null==(t=M.book)?void 0:t.format)!=="PDF"&&(null==I||null==(n=I.renderer)||n.addEventListener("scroll",ev),null==(a=c.doc)||a.addEventListener("touchstart",ew),null==(l=c.doc)||l.addEventListener("touchmove",()=>{D(!1)}),null==(s=c.doc)||s.addEventListener("touchend",ey),null==(i=c.doc)||i.addEventListener("pointerup",()=>ej(d,h)),null==(r=c.doc)||r.addEventListener("selectionchange",()=>ek(d,h)),(null==u?void 0:u.isMobile)&&(null==(o=c.doc)||o.addEventListener("contextmenu",e=>(e.preventDefault(),e.stopPropagation(),!1))))},onDrawAnnotation:e=>{let t=j(r),{draw:n,annotation:a,doc:l,range:s}=e.detail,{style:i,color:o}=a,c=o?O.Hj[o]:o;if("highlight"===i)n(nt.u.highlight,{color:c});else if(["underline","squiggly"].includes(i)){let{defaultView:e}=l,a=s.startContainer,r=1===a.nodeType?a:a.parentElement,{writingMode:o,lineHeight:d,fontSize:u}=e.getComputedStyle(r),h=parseFloat(d)||t.lineHeight*t.defaultFontSize,m=parseFloat(u)||t.defaultFontSize,f=t.vertical?(h-m-2)/2:2;n(nt.u[i],{writingMode:o,color:c,padding:f})}},onShowAnnotation:e=>{var t;let{value:n,index:a,range:l}=e.detail,{booknotes:s=[]}=m(r),i=s.filter(e=>"annotation"===e.type&&!e.deletedAt).find(e=>e.cfi===n);if(!i)return;let o={key:r,annotated:!0,text:null!=(t=i.text)?t:"",range:l,index:a};el(i.style),er(i.color),P(o),eC()}}),(0,l.useEffect)(()=>{eS(_||z||W||K)},[_,z,W,K]),(0,l.useEffect)(()=>(E.I.on("export-annotations",eM),()=>{E.I.off("export-annotations",eM)}),[]),(0,l.useEffect)(()=>{if(et(!!(R&&R.annotated)),R&&R.text.trim().length>0){let e=document.querySelector("#gridcell-".concat(r));if(!e)return;let t=e.getBoundingClientRect(),n=nr(R.range,t,eo,B.vertical),a=no(n,t,B.vertical?eg:ep,B.vertical?ep:eg,eo);"down"===a.dir&&"android"===A&&(n.point.y+=0,a.point.y+=0);let l=no(n,t,eu,eh,eo),s=no(n,t,em,ef,eo);0!=n.point.x&&0!=n.point.y&&(q(a),Z(l),$(s),G(n),eA())}},[R,r]),(0,l.useEffect)(()=>{if(!L)return;let{location:e}=L,t=eN.collapse(e),n=eN.collapse(e,!0),{booknotes:a=[]}=T,l=a.filter(e=>!e.deletedAt&&"annotation"===e.type&&e.style&&eN.compare(e.cfi,t)>=0&&0>=eN.compare(e.cfi,n));try{Promise.all(l.map(e=>null==I?void 0:I.addAnnotation(e)))}catch(e){console.error(e)}},[L]);let eA=()=>{D(!0),U(!1),V(!1),H(!1)},eE=function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!R||!R.text)return;et(!0);let{booknotes:t=[]}=T,n=null==I?void 0:I.getCFI(R.index,R.range);if(!n)return;let a=h.globalReadSettings.highlightStyle,l=h.globalReadSettings.highlightStyles[a],s={id:(0,F.NF)(),type:"annotation",cfi:n,style:a,color:l,text:R.text,note:"",createdAt:Date.now(),updatedAt:Date.now()},i=t.findIndex(e=>e.cfi===n&&"annotation"===e.type&&!e.deletedAt),o=y(r.split("-")[0]);-1!==i?(o.forEach(e=>null==e?void 0:e.addAnnotation(s,!0)),e?(s.id=t[i].id,t[i]=s,o.forEach(e=>null==e?void 0:e.addAnnotation(s))):(t[i].deletedAt=Date.now(),D(!1))):(t.push(s),o.forEach(e=>null==e?void 0:e.addAnnotation(s)),P({...R,annotated:!0}));let c=b(r,t);c&&f(d,r,c,h)},eL=async()=>{R&&R.text&&(D(!1),E.I.dispatch("tts-speak",{bookKey:r,range:R.range}))},eM=e=>{var t,n;let{bookKey:a}=e.detail;if(r!==a)return;let{bookDoc:l,book:s}=M;if(!l||!s||!l.toc)return;let{booknotes:i=[]}=m(r),o=i.filter(e=>!e.deletedAt);if(0===o.length)return void E.I.dispatch("toast",{type:"info",message:c("No annotations to export"),className:"whitespace-nowrap",timeout:2e3});let d={};for(let e of o){let t=g(null!=(n=l.toc)?n:[],e.cfi),a=(null==t?void 0:t.href)||"",s=(null==t?void 0:t.label)||"",i=(null==t?void 0:t.id)||0;d[a]||(d[a]={id:i,href:a,label:s,booknotes:[]}),d[a].booknotes.push(e)}Object.values(d).forEach(e=>{e.booknotes.sort((e,t)=>eN.compare(e.cfi,t.cfi))});let h=Object.values(d).sort((e,t)=>e.id-t.id),f=[];for(let e of(f.push("# ".concat(s.title)),f.push("**".concat(c("Author"),"**: ").concat(s.author||"")),f.push(""),f.push("**".concat(c("Exported from Readest"),"**: ").concat(new Date().toISOString().slice(0,10))),f.push(""),f.push("---"),f.push(""),f.push("## ".concat(c("Highlights & Annotations"))),f.push(""),h)){let t=e.label||c("Untitled");for(let n of(f.push("### ".concat(t)),e.booknotes))f.push('> "'.concat(n.text,'"')),n.note&&f.push("**".concat(c("Note"),"**:: ").concat(n.note)),f.push("");f.push("---"),f.push("")}let p=f.join("\n");if(null==(t=navigator.clipboard)||t.writeText(p),E.I.dispatch("toast",{type:"info",message:c("Copied to clipboard"),className:"whitespace-nowrap",timeout:2e3}),null==u?void 0:u.isMobile)return;let b=new Blob([p],{type:"text/markdown;charset=utf-8"}),x=URL.createObjectURL(b),v=document.createElement("a");v.href=x,v.download="".concat(s.title.replace(/\s+/g,"_"),".md"),v.click(),URL.revokeObjectURL(x)},eI=null==R?void 0:R.annotated,eB=[{tooltipText:c("Copy"),Icon:ea.nxz,onClick:()=>{var e;if(!R||!R.text)return;E.I.dispatch("toast",{type:"info",message:c("Copied to notebook"),className:"whitespace-nowrap",timeout:2e3});let{booknotes:t=[]}=T;R&&(null==(e=navigator.clipboard)||e.writeText(R.text));let n=null==I?void 0:I.getCFI(R.index,R.range);if(!n)return;let a={id:(0,F.NF)(),type:"excerpt",cfi:n,text:R.text,note:"",createdAt:Date.now(),updatedAt:Date.now()},l=t.findIndex(e=>e.cfi===n&&"excerpt"===e.type&&!e.deletedAt);-1!==l?t[l]=a:t.push(a);let s=b(r,t);s&&f(d,r,s,h),ex(),(null==u?void 0:u.isMobile)||k(!0)}},{tooltipText:eI?c("Delete Highlight"):c("Highlight"),Icon:eI?ty.WFf:eT.E9d,onClick:eE},{tooltipText:c("Annotate"),Icon:ne.ArI,onClick:()=>{if(!R||!R.text)return;let{sectionHref:e}=L;R.href=e,eE(!0),k(!0),C(R),eb()}},{tooltipText:c("Search"),Icon:ea.CKj,onClick:()=>{R&&R.text&&(D(!1),E.I.dispatch("search",{term:R.text}))}},{tooltipText:c("Dictionary"),Icon:tg.Bh3,onClick:()=>{R&&R.text&&(D(!1),V(!0))}},{tooltipText:c("Wikipedia"),Icon:eR.i86,onClick:()=>{R&&R.text&&(D(!1),H(!0))}},{tooltipText:c("Translate"),Icon:ne.Ifv,onClick:()=>{R&&R.text&&(D(!1),U(!0))}},{tooltipText:c("Speak"),Icon:tE.tLl,onClick:eL}];return(0,a.jsxs)("div",{children:[z&&Y&&J&&(0,a.jsx)(nb,{word:null==R?void 0:R.text,lang:null==(t=M.bookDoc)?void 0:t.metadata.language,position:J,trianglePosition:Y,popupWidth:eu,popupHeight:eh}),W&&Y&&J&&(0,a.jsx)(nx,{text:null==R?void 0:R.text,lang:null==(n=M.bookDoc)?void 0:n.metadata.language,position:J,trianglePosition:Y,popupWidth:eu,popupHeight:eh}),K&&Y&&Q&&(0,a.jsx)(ny,{text:null==R?void 0:R.text,position:Q,trianglePosition:Y,popupWidth:em,popupHeight:ef}),_&&Y&&X&&(0,a.jsx)(ng,{dir:B.rtl?"rtl":"ltr",isVertical:B.vertical,buttons:eB,position:X,trianglePosition:Y,highlightOptionsVisible:ee,selectedStyle:en,selectedColor:ei,popupWidth:ep,popupHeight:eg,onHighlight:eE})]})};var nN=n(19780),nk=n(25842),nS=n(84648);let nC=e=>{var t,n,a,l,s,i,r,o;return new Set([...null!=(r=null==e||null==(n=e.getAttributeNS)||null==(t=n.call(e,"http://www.idpf.org/2007/ops","type"))?void 0:t.split(" "))?r:[],...null!=(o=null==e||null==(i=e.attributes)||null==(s=i.getNamedItem)||null==(l=s.call(i,"epub:type"))||null==(a=l.value)?void 0:a.split(" "))?o:[]])},nA=e=>{var t,n;return new Set(null==e||null==(n=e.getAttribute)||null==(t=n.call(e,"role"))?void 0:t.split(" "))},nE=e=>{if(e.matches("sup"))return!0;let{verticalAlign:t}=getComputedStyle(e);return"super"===t||"top"===t||"text-top"===t||/^\d/.test(t)},nT=["biblioref","glossref","noteref"],nL=["doc-biblioref","doc-glossref","doc-noteref"],nM=e=>{let t=nC(e),n=nA(e);return{yes:nL.some(e=>n.has(e))||nT.some(e=>t.has(e)),maybe:()=>!t.has("backlink")&&!n.has("doc-backlink")&&(nE(e)||1===e.children.length&&nE(e.children[0])||nE(e.parentElement))}},nI=e=>{let t=nC(e),n=nA(e);return n.has("doc-biblioentry")||t.has("biblioentry")?"biblioentry":n.has("definition")||t.has("glossdef")?"definition":n.has("doc-endnote")||t.has("endnote")||t.has("rearnote")?"endnote":n.has("doc-footnote")||t.has("footnote")?"footnote":n.has("note")||t.has("note")?"note":null},nB="a, span, sup, sub, em, strong, i, b, small, big",nR=(e,t)=>{let n=t(e),a=n;for(;n.matches(nB);){let e=n.parentElement;if(!e)break;n=e}if(n===e.body){let e=a.nextElementSibling;if(e&&!e.matches(nB))return e;throw Error("Failed to extract footnote")}return n};var nP=new WeakSet;class n_ extends EventTarget{handle(e,t){let{a:n,href:a,follow:l}=t.detail,{yes:s,maybe:i}=nM(n);return s||l?(t.preventDefault(),Promise.resolve(e.resolveHref(a)).then(t=>(0,nN._)(this,nP,nD).call(this,e,t,a))):this.detectFootnotes&&i()?(t.preventDefault(),Promise.resolve(e.resolveHref(a)).then(t=>{let{index:n,anchor:l}=t;return(0,nN._)(this,nP,nD).call(this,e,{index:n,anchor:e=>nR(e,l)},a)})):void 0}constructor(...e){super(...e),(0,nk._)(this,nP),(0,nS._)(this,"detectFootnotes",!0)}}function nD(e,t,n){let{index:a,anchor:l}=t,s=document.createElement("foliate-view");return new Promise((t,i)=>{s.addEventListener("load",e=>{try{var a;let{doc:i}=e.detail,r=l(i),o=nI(r),c=(null==r||null==(a=r.matches)?void 0:a.call(r,"aside"))&&"footnote"===o;if(r){let e;r.startContainer?e=r:r.matches("li, aside")?(e=i.createRange()).selectNodeContents(r):r.closest("li")?(e=i.createRange()).selectNodeContents(r.closest("li")):(e=i.createRange()).selectNode(r);let t=e.extractContents();i.body.replaceChildren(),i.body.appendChild(t)}this.dispatchEvent(new CustomEvent("render",{detail:{view:s,href:n,type:o,hidden:c,target:r}})),t()}catch(e){i(e)}}),s.open(e).then(()=>this.dispatchEvent(new CustomEvent("before-render",{detail:{view:s}}))).then(()=>s.goTo(a)).catch(i)})}let nz=e=>{let{bookKey:t,bookDoc:n}=e,s=(0,l.useRef)(null),i=(0,l.useRef)(null),[r,o]=(0,l.useState)(),[c,d]=(0,l.useState)(),[u,h]=(0,l.useState)(!1),{getBookData:m}=(0,w.I)(),{getView:f,getViewSettings:p}=N(),g=f(t),b=p(t),x=new n_,[v,y]=(0,l.useState)(null),[j,k]=(0,l.useState)(360),[S,C]=(0,l.useState)(88),A=(e,t)=>Math.min(e,(t?window.innerWidth/2:window.innerHeight/2)-10-12);(0,l.useEffect)(()=>{let e=e=>{var a,l;let{view:r}=e.detail;r.addEventListener("link",e=>{var a;e.preventDefault();let{detail:l}=e;l.follow=!0,null==(a=x.handle(n,e))||a.catch(e=>{var n;console.warn(e),null==(n=f(t))||n.goTo(l.href)})}),r.addEventListener("load",e=>{var n;let{doc:a}=e.detail,l=m(t);(0,I.D)(a,(0,ep.zp)(null==(n=l.book)?void 0:n.primaryLanguage))}),i.current=r,null==(a=s.current)||a.replaceChildren(r);let{renderer:o}=r;o.setAttribute("flow","scrolled"),o.setAttribute("margin","0px"),o.setAttribute("gap","0%");let c=p(t),d={...(0,Y.rj)()},u=document.getElementById("popup-container");u&&(d.bg=getComputedStyle(u).backgroundColor);let h=(0,Y.$f)(c,d),g=(0,Y.D1)();null==(l=o.setStyles)||l.call(o,"".concat(h,"\n").concat(g))},a=e=>{let{view:n}=e.detail;n.addEventListener("relocate",()=>{let{renderer:e}=n;p(t).vertical?k(A(e.viewSize,!0)):C(A(e.viewSize,!1)),h(!0)})};return x.addEventListener("before-render",e),x.addEventListener("render",a),()=>{x.removeEventListener("before-render",e),x.removeEventListener("render",a)}},[g]),(0,l.useEffect)(()=>{b.vertical?(k(88),C(Math.max(360,window.innerHeight/4))):(k(Math.max(360,window.innerWidth/4)),C(88))},[b]),(0,l.useEffect)(()=>{r&&v&&d(no(r,v,j,S,10))},[r,v,j,S]);let T=async e=>{var a;let l=e.detail,s=document.querySelector("#gridcell-".concat(t));if(!s)return;let i=s.getBoundingClientRect(),r=p(t),c=nr(l.a,i,10,r.vertical);y(i),o(c);let{a:d}=l;["duokan-footnote","footnote-link","footnote"].some(e=>d.classList.contains(e))&&(l.follow=!0),null==(a=x.handle(n,e))||a.catch(t=>{console.warn(t);let n=e.detail;null==g||g.goTo(n.href)})},L=()=>{var e;let t=null==(e=s.current)?void 0:e.querySelector("foliate-view");null==t||t.close(),null==t||t.remove()},M=()=>{L(),y(null),d(null),o(null),h(!1)},B=e=>{let{element:n,footnote:a}=e.detail,l=document.querySelector("#gridcell-".concat(t));if(!l)return;let i=l.getBoundingClientRect(),r=p(t),c=nr(n,i,10,r.vertical);if(s.current){let e=document.createElement("p");e.textContent=a,e.setAttribute("style","padding: 1em; hanging-punctuation: allow-end last;"),e.style.visibility="hidden",r.vertical?e.style.height="".concat(S,"px"):e.style.width="".concat(j,"px"),document.body.appendChild(e);let t=e.getBoundingClientRect();r.vertical?k(A(t.width,!0)):C(A(t.height,!1)),document.body.removeChild(e),e.style.visibility="visible",s.current.replaceChildren(e),y(i),o(c),h(!0)}};return eZ(g,{onLinkClick:T}),(0,l.useEffect)(()=>(window.addEventListener("resize",M),E.I.on("footnote-popup",B),()=>{window.removeEventListener("resize",M),E.I.off("footnote-popup",B)}),[]),(0,l.useEffect)(()=>{if(i.current){var e;null==(e=s.current)||e.replaceChildren(i.current)}},[s]),(0,a.jsxs)("div",{children:[u&&(0,a.jsx)("div",{className:"fixed inset-0",onClick:M,onContextMenu:M}),(0,a.jsx)(nu,{width:j,height:S,position:u?c:void 0,trianglePosition:u?r:void 0,className:"select-text overflow-y-auto",children:(0,a.jsx)("div",{className:"",ref:s,style:{width:"".concat(j,"px"),height:"".concat(S,"px")}})})]})},nV=e=>{let{bookKey:t,showDoubleBorder:n,isScrolled:s,isVertical:i,horizontalGap:r,verticalMargin:o}=e,[c,u]=l.useState(null),h=(0,l.useRef)(2e3),m=(0,l.useRef)(null),f=e=>{let{message:n,bookKey:a,timeout:l=2e3}=e.detail;a===t&&(u(n),h.current=l)};return(0,l.useEffect)(()=>(E.I.on("hint",f),()=>{E.I.off("hint",f)}),[]),(0,l.useEffect)(()=>(m.current&&clearTimeout(m.current),m.current=setTimeout(()=>u(""),h.current),()=>{m.current&&clearTimeout(m.current)}),[c]),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:(0,d.A)("absolute left-0 right-0 top-0 z-10 h-[env(safe-area-inset-top)]",c?"bg-base-100":"bg-transparent")}),(0,a.jsx)("div",{className:(0,d.A)("hintinfo absolute flex items-center justify-end overflow-hidden ps-2","mt-[env(safe-area-inset-top)]",c?"bg-base-100":"bg-transparent",i?"writing-vertical-rl":"top-0 h-[44px]",s?i?"h-full":"w-full":i?"max-h-[50%]":"max-w-[50%]"),style:i?{bottom:"".concat(1.5*o,"px"),left:"calc(100% - ".concat(r,"%)"),width:n?"30px":"".concat(r,"%")}:{insetInlineEnd:"".concat(r,"%")},children:(0,a.jsx)("h2",{className:(0,d.A)("text-neutral-content text-center font-sans text-xs font-light"),children:c||""})})]})},nF=e=>{let{borderColor:t,horizontalGap:n,verticalMargin:l,showHeader:s,showFooter:i}=e;return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"borderframe pointer-events-none absolute",style:{border:"4px solid ".concat(t),height:"calc(100% - ".concat(2*l,"px + ").concat(20,"px)"),top:"calc(".concat(l,"px - ").concat(10,"px)"),left:"calc(".concat(n,"% - ").concat(32*!!i,"px - ").concat(10,"px)"),right:"calc(".concat(n,"% - ").concat(32*!!s,"px - ").concat(10,"px)")}}),(0,a.jsx)("div",{className:"borderframe pointer-events-none absolute",style:{border:"1px solid ".concat(t),height:"calc(100% - ".concat(2*l,"px)"),top:"".concat(l,"px"),left:i?"".concat(n,"%"):"calc(".concat(n,"%)"),right:s?"".concat(n,"%"):"calc(".concat(n,"%)")}}),i&&(0,a.jsx)("div",{className:"borderframe pointer-events-none absolute",style:{borderTop:"1px solid ".concat(t),borderBottom:"1px solid ".concat(t),borderLeft:"1px solid ".concat(t),width:"32px",height:"calc(100% - ".concat(2*l,"px)"),top:"".concat(l,"px"),left:"calc(".concat(n,"% - 32px)")}}),s&&(0,a.jsx)("div",{className:"borderframe pointer-events-none absolute",style:{borderTop:"1px solid ".concat(t),borderBottom:"1px solid ".concat(t),borderRight:"1px solid ".concat(t),width:"32px",height:"calc(100% - ".concat(2*l,"px)"),top:"".concat(l,"px"),left:"calc(100% - ".concat(n,"%)")}})]})};var nW=n(96261),nO=n(89657),nH=n(49033);let nK=e=>e.replace(/\r\n/g,"  ").replace(/\r/g," ").replace(/\n/g," ").trimStart(),nU=e=>{var t,n;let a,l=e.match(/<speak[^>]*xml:lang="([^"]+)"[^>]*>/i),s=null!=(t=null==l?void 0:l[1])?t:"en";e=e.replace(/<speak[^>]*>/i,"").replace(/<\/speak>/i,"");let i="",r=[],o=null,c=s,d=[],u=/<(\/?)(\w+)([^>]*)>|([^<]+)/g;for(;null!==(a=u.exec(e));)if(a[4]){let e=a[4],t=nK(e);if(t&&o){let e=i.length;i+=t,r.push({offset:e,name:o,text:t,language:nY(t,c)||c})}else i+=nK(e)}else{let e="/"===a[1],t=a[2],l=a[3];if("mark"!==t||e){if("lang"===t)if(e)c=null!=(n=d.pop())?n:s;else{d.push(c);let e=null==l?void 0:l.match(/xml:lang="([^"]+)"/);e&&(c=e[1])}}else{let e=null==l?void 0:l.match(/name="([^"]+)"/);e&&(o=e[1])}}return{plainText:i,marks:r}},nY=(e,t)=>{if(!t||t.startsWith("en")){if(RegExp("[\\p{Script=Hangul}]","u").test(e))return"ko";else if(RegExp("[\\p{Script=Hiragana}\\p{Script=Katakana}]","u").test(e))return"ja";else if(RegExp("[\\p{Script=Han}]","u").test(e))return"zh"}return t},nG=e=>{let t=null,n=e.match(/xml:lang\s*=\s*"([^"]+)"/);if(n&&n[1]){let e=n[1].split("-");t=e.length>1?"".concat(e[0].toLowerCase(),"-").concat(e[1].toUpperCase()):e[0].toLowerCase()}return nY(e,t)};class nX{static normalizeLanguage(e){return e?e.toLowerCase().slice(0,2):"n/a"}static setPreferredVoice(e,t,n){if(!e||!t||!n)return;let a=this.getPreferences(),l=this.normalizeLanguage(t);a["".concat(e,"-").concat(l)]=n,localStorage.setItem(this.LOCAL_STORAGE_KEY,JSON.stringify(a))}static getPreferredVoice(e,t){let n=this.getPreferences(),a=this.normalizeLanguage(t);return n["".concat(e,"-").concat(a)]||null}static getPreferences(){let e=localStorage.getItem(this.LOCAL_STORAGE_KEY);return e?JSON.parse(e):{}}}(0,nS._)(nX,"LOCAL_STORAGE_KEY","ttsPreferredVoices");let nq=["Albert","Bad News","Bahh","Bells","Boing","Bubbles","Cellos","Eddy","Flo","Fred","Good News","Grandma","Grandpa","Jester","Junior","Kathy","Organ","Ralph","Reed","Rocko","Sandy","Shelley","Superstar","Trinoids","Whisper","Wobble","Zarvox"];async function*nJ(e,t,n,a,l,s,i){let{marks:r}=nU(e),o=window.speechSynthesis,c=new SpeechSynthesisUtterance;for(let e of r){let{language:r}=e,d=r||t;s(d),i(e),c.text=e.text,c.rate=n(),c.pitch=a();let u=await l(d);u&&(c.voice=u),d&&(c.lang=d),yield{type:"boundary",speaking:!0,name:"sentence",mark:e.name};let h=await new Promise(e=>{c.onend=()=>e({type:"end",speaking:!1}),c.onerror=t=>e({type:"error",speaking:!1,error:t.error}),o.speak(c)});if(yield h,"error"===h.type)break}}var nZ=new WeakMap,nQ=new WeakMap,n$=new WeakMap,n0=new WeakMap,n1=new WeakMap,n2=new WeakMap,n8=new WeakMap;class n3{async init(){return(0,nW._)(this,n8)?await new Promise(e=>{let t=()=>{(0,nH._)(this,n2,(0,nW._)(this,n8).getVoices()),(0,nW._)(this,n2).length>0&&e()};(0,nW._)(this,n8).getVoices().length>0?t():void 0!==(0,nW._)(this,n8).onvoiceschanged?(0,nW._)(this,n8).onvoiceschanged=t:(console.warn("Voiceschanged event not supported."),e())}):this.available=!1,this.available}async *speak(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(n)return;let a=nG(e)||"en";for await(let n of("en"===a&&(0,nW._)(this,nZ)&&"en"!==(0,nW._)(this,nZ)&&(a=(0,nW._)(this,nZ)),nJ(e,a,()=>(0,nW._)(this,n$),()=>(0,nW._)(this,n0),this.getVoiceFromLang,e=>(0,nH._)(this,nQ,e),e=>{var t;return null==(t=this.controller)?void 0:t.dispatchSpeakMark(e)}))){var l,s,i,r,o;if(t.aborted){console.log("TTS aborted"),yield{code:"error",message:"Aborted"};return}"boundary"===n.type?yield{code:"boundary",mark:null!=(l=n.mark)?l:"",message:"".concat(null!=(s=n.name)?s:"Unknown"," ").concat(null!=(i=n.charIndex)?i:0,"/").concat(null!=(r=n.charLength)?r:0)}:"error"===n.type?yield{code:"error",message:null!=(o=n.error)?o:"Unknown error"}:"end"===n.type&&(yield{code:"end",message:"Speech finished"})}}async pause(){(0,nW._)(this,n8).pause()}async resume(){(0,nW._)(this,n8).resume()}async stop(){(0,nW._)(this,n8).cancel()}setPrimaryLang(e){(0,nH._)(this,nZ,e)}async setRate(e){(0,nH._)(this,n$,e)}async setPitch(e){(0,nH._)(this,n0,e)}async setVoice(e){let t=(0,nW._)(this,n2).find(t=>t.voiceURI===e);t&&(0,nH._)(this,n1,t)}async getAllVoices(){return(0,nW._)(this,n2).map(e=>({id:e.voiceURI,name:e.name,lang:e.lang,disabled:!this.available}))}async getVoices(e){let t="en"===e&&(0,F.YK)(e)||e,n=e=>!e.includes("com.apple")||e.includes("com.apple.voice.compact"),a=(0,nW._)(this,n2).filter(n=>n.lang.startsWith(t)||"en"===e&&["en-US","en-GB"].includes(n.lang)).filter(e=>n(e.voiceURI||"")).filter(e=>!1===nq.some(t=>e.name.includes(t))),l=new Set,s=a.map(e=>({id:e.voiceURI,name:e.name,lang:e.lang})).filter(e=>!l.has(e.id)&&(l.add(e.id),!0));return s.forEach(e=>{e.disabled=!this.available}),s}getGranularities(){return["sentence"]}getVoiceId(){var e,t;return null!=(t=null==(e=(0,nW._)(this,n1))?void 0:e.voiceURI)?t:""}getSpeakingLang(){return(0,nW._)(this,nQ)}constructor(e){(0,nS._)(this,"controller",void 0),(0,nO._)(this,nZ,{writable:!0,value:"en"}),(0,nO._)(this,nQ,{writable:!0,value:""}),(0,nO._)(this,n$,{writable:!0,value:1}),(0,nO._)(this,n0,{writable:!0,value:1}),(0,nO._)(this,n1,{writable:!0,value:null}),(0,nO._)(this,n2,{writable:!0,value:[]}),(0,nO._)(this,n8,{writable:!0,value:window.speechSynthesis}),(0,nS._)(this,"available",!0),(0,nS._)(this,"getVoiceFromLang",async e=>{let t=nX.getPreferredVoice("web-speech",e),n=(0,nW._)(this,n2).find(e=>e.voiceURI===t);if(n)(0,nH._)(this,n1,n);else{var a,l;let t=null!=(l=null==(a=(await this.getVoices(e))[0])?void 0:a.id)?l:"";(0,nH._)(this,n1,(0,nW._)(this,n2).find(e=>e.voiceURI===t)||null)}return(0,nW._)(this,n1)}),this.controller=e}}var n5=n(36261);class n6{get(e){if(!this.map.has(e))return;let t=this.map.get(e);return this.map.delete(e),this.map.set(e,t),t}set(e,t){if(this.map.has(e))this.map.delete(e);else if(this.map.size===this.capacity){let e=this.map.keys().next().value;e&&this.map.delete(e)}this.map.set(e,t)}has(e){return this.map.has(e)}delete(e){return this.map.delete(e)}clear(){this.map.clear()}size(){return this.map.size}entries(){return Array.from(this.map).reverse()}constructor(e){if((0,nS._)(this,"capacity",void 0),(0,nS._)(this,"map",void 0),e<=0)throw Error("LRUCache capacity must be greater than 0");this.capacity=e,this.map=new Map}}let n4=e=>{let t=JSON.stringify(e);return(0,n5.md5)(t)};var n9=new WeakSet;class n7{async create(e){return(0,nN._)(this,n9,ae).call(this,e)}async createAudio(e){let t=n4(e);if(n7.audioCache.has(t))return new Blob([n7.audioCache.get(t)],{type:"audio/mpeg"});try{let n=await this.create(e),a=await n.arrayBuffer();return n7.audioCache.set(t,a),new Blob([a],{type:"audio/mpeg"})}catch(e){throw e}}constructor(){(0,nk._)(this,n9)}}async function ae(e){let{lang:t,text:n,voice:a,rate:l}=e,s=(0,F.oq)(),i="".concat("wss://speech.platform.bing.com/consumer/speech/synthesize/readaloud/edge/v1","?ConnectionId=").concat(s,"&TrustedClientToken=").concat("6A5AA1D4EAFF4E9FB37E23D68491D6F4"),r=new Date().toString(),o=JSON.stringify({context:{synthesis:{audio:{metadataoptions:{sentenceBoundaryEnabled:!1,wordBoundaryEnabled:!0},outputFormat:"audio-24khz-48kbitrate-mono-mp3"}}}}),c=(e,t)=>{let n="";for(let t of Object.keys(e))n+="".concat(t,": ").concat(e[t],"\r\n");return"".concat(n,"\r\n").concat(t)},d=e=>{let t=e.split("\n"),n={},a="",l=0;for(l=0;l<t.length;l++){let e=t[l].trim();if(!e)break;let a=e.indexOf(":");if(-1===a)continue;let s=e.slice(0,a).trim(),i=e.slice(a+1).trim();n[s]=i}for(l+=1;l<t.length;l++)a+=t[l]+"\n";return{headers:n,body:a}},u=c({"Content-Type":"application/ssml+xml",Path:"ssml","X-RequestId":s,"X-Timestamp":r},((e,t,n,a)=>{let l=t.replace(/^<break\b[^>]*>/i,"");return'\n        <speak version="1.0" xml:lang="'.concat(e,'">\n          <voice name="').concat(n,'">\n            <prosody rate="').concat(a,'">\n              ').concat(l,"\n            </prosody>\n          </voice>\n        </speak>\n      ")})(t,n,a,l)),h=c({"Content-Type":"application/json; charset=utf-8",Path:"speech.config","X-Timestamp":r},o);return new Promise((e,t)=>{let n=new WebSocket(i);n.binaryType="arraybuffer";let a=new ArrayBuffer(0);n.addEventListener("open",()=>{n.send(h),n.send(u)}),n.addEventListener("message",l=>{if("string"==typeof l.data){let{headers:s}=d(l.data);if("turn.end"===s.Path){if(n.close(),!a.byteLength)return t(Error("No audio data received."));e(new Response(a))}}else if(l.data instanceof ArrayBuffer){let e=new DataView(l.data).getInt16(0);if(l.data.byteLength>e+2){let t=l.data.slice(2+e),n=new Uint8Array(a.byteLength+t.byteLength);n.set(new Uint8Array(a),0),n.set(new Uint8Array(t),a.byteLength),a=n.buffer}}}),n.addEventListener("close",()=>{a.byteLength||t(Error("No audio data received."))}),n.addEventListener("error",()=>{n.close(),t(Error("WebSocket error occurred."))})})}(0,nS._)(n7,"voices",Object.entries({"af-ZA":["af-ZA-AdriNeural","af-ZA-WillemNeural"],"am-ET":["am-ET-AmehaNeural","am-ET-MekdesNeural"],"ar-AE":["ar-AE-FatimaNeural","ar-AE-HamdanNeural"],"ar-BH":["ar-BH-AliNeural","ar-BH-LailaNeural"],"ar-DZ":["ar-DZ-AminaNeural","ar-DZ-IsmaelNeural"],"ar-EG":["ar-EG-SalmaNeural","ar-EG-ShakirNeural"],"ar-IQ":["ar-IQ-BasselNeural","ar-IQ-RanaNeural"],"ar-JO":["ar-JO-SanaNeural","ar-JO-TaimNeural"],"ar-KW":["ar-KW-FahedNeural","ar-KW-NouraNeural"],"ar-LB":["ar-LB-LaylaNeural","ar-LB-RamiNeural"],"ar-LY":["ar-LY-ImanNeural","ar-LY-OmarNeural"],"ar-MA":["ar-MA-JamalNeural","ar-MA-MounaNeural"],"ar-OM":["ar-OM-AbdullahNeural","ar-OM-AyshaNeural"],"ar-QA":["ar-QA-AmalNeural","ar-QA-MoazNeural"],"ar-SA":["ar-SA-HamedNeural","ar-SA-ZariyahNeural"],"ar-SY":["ar-SY-AmanyNeural","ar-SY-LaithNeural"],"ar-TN":["ar-TN-HediNeural","ar-TN-ReemNeural"],"ar-YE":["ar-YE-MaryamNeural","ar-YE-SalehNeural"],"az-AZ":["az-AZ-BabekNeural","az-AZ-BanuNeural"],"bg-BG":["bg-BG-BorislavNeural","bg-BG-KalinaNeural"],"bn-BD":["bn-BD-NabanitaNeural","bn-BD-PradeepNeural"],"bn-IN":["bn-IN-BashkarNeural","bn-IN-TanishaaNeural"],"bs-BA":["bs-BA-GoranNeural","bs-BA-VesnaNeural"],"ca-ES":["ca-ES-EnricNeural","ca-ES-JoanaNeural"],"cs-CZ":["cs-CZ-AntoninNeural","cs-CZ-VlastaNeural"],"cy-GB":["cy-GB-AledNeural","cy-GB-NiaNeural"],"da-DK":["da-DK-ChristelNeural","da-DK-JeppeNeural"],"de-AT":["de-AT-IngridNeural","de-AT-JonasNeural"],"de-CH":["de-CH-JanNeural","de-CH-LeniNeural"],"de-DE":["de-DE-AmalaNeural","de-DE-ConradNeural","de-DE-FlorianMultilingualNeural","de-DE-KatjaNeural","de-DE-KillianNeural","de-DE-SeraphinaMultilingualNeural"],"el-GR":["el-GR-AthinaNeural","el-GR-NestorasNeural"],"en-AU":["en-AU-NatashaNeural","en-AU-WilliamNeural"],"en-CA":["en-CA-ClaraNeural","en-CA-LiamNeural"],"en-GB":["en-GB-LibbyNeural","en-GB-MaisieNeural","en-GB-RyanNeural","en-GB-SoniaNeural","en-GB-ThomasNeural"],"en-HK":["en-HK-SamNeural","en-HK-YanNeural"],"en-IE":["en-IE-ConnorNeural","en-IE-EmilyNeural"],"en-IN":["en-IN-NeerjaExpressiveNeural","en-IN-NeerjaNeural","en-IN-PrabhatNeural"],"en-KE":["en-KE-AsiliaNeural","en-KE-ChilembaNeural"],"en-NG":["en-NG-AbeoNeural","en-NG-EzinneNeural"],"en-NZ":["en-NZ-MitchellNeural","en-NZ-MollyNeural"],"en-PH":["en-PH-JamesNeural","en-PH-RosaNeural"],"en-SG":["en-SG-LunaNeural","en-SG-WayneNeural"],"en-TZ":["en-TZ-ElimuNeural","en-TZ-ImaniNeural"],"en-US":["en-US-AnaNeural","en-US-AndrewMultilingualNeural","en-US-AndrewNeural","en-US-AriaNeural","en-US-AvaMultilingualNeural","en-US-AvaNeural","en-US-BrianMultilingualNeural","en-US-BrianNeural","en-US-ChristopherNeural","en-US-EmmaMultilingualNeural","en-US-EmmaNeural","en-US-EricNeural","en-US-GuyNeural","en-US-JennyNeural","en-US-MichelleNeural","en-US-RogerNeural","en-US-SteffanNeural"],"es-AR":["es-AR-ElenaNeural","es-AR-TomasNeural"],"es-BO":["es-BO-MarceloNeural","es-BO-SofiaNeural"],"es-CL":["es-CL-CatalinaNeural","es-CL-LorenzoNeural"],"es-CO":["es-CO-GonzaloNeural","es-CO-SalomeNeural"],"es-CR":["es-CR-JuanNeural","es-CR-MariaNeural"],"es-CU":["es-CU-BelkysNeural","es-CU-ManuelNeural"],"es-DO":["es-DO-EmilioNeural","es-DO-RamonaNeural"],"es-EC":["es-EC-AndreaNeural","es-EC-LuisNeural"],"es-ES":["es-ES-AlvaroNeural","es-ES-ElviraNeural","es-ES-XimenaNeural"],"es-US":["es-US-AlonsoNeural","es-US-PalomaNeural"],"fr-BE":["fr-BE-CharlineNeural","fr-BE-GerardNeural"],"fr-CA":["fr-CA-AntoineNeural","fr-CA-JeanNeural","fr-CA-SylvieNeural","fr-CA-ThierryNeural"],"fr-CH":["fr-CH-ArianeNeural","fr-CH-FabriceNeural"],"fr-FR":["fr-FR-DeniseNeural","fr-FR-EloiseNeural","fr-FR-HenriNeural","fr-FR-RemyMultilingualNeural","fr-FR-VivienneMultilingualNeural"],"ja-JP":["ja-JP-KeitaNeural","ja-JP-NanamiNeural"],"ko-KR":["ko-KR-HyunsuMultilingualNeural","ko-KR-InJoonNeural","ko-KR-SunHiNeural"],"pt-BR":["pt-BR-AntonioNeural","pt-BR-FranciscaNeural","pt-BR-ThalitaMultilingualNeural"],"pt-PT":["pt-PT-DuarteNeural","pt-PT-RaquelNeural"],"zh-CN":["zh-CN-XiaoxiaoNeural","zh-CN-XiaoyiNeural","zh-CN-YunjianNeural","zh-CN-YunxiNeural","zh-CN-YunxiaNeural","zh-CN-YunyangNeural","zh-CN-liaoning-XiaobeiNeural","zh-CN-shaanxi-XiaoniNeural"],"zh-HK":["zh-HK-HiuGaaiNeural","zh-HK-HiuMaanNeural","zh-HK-WanLungNeural"],"zh-TW":["zh-TW-HsiaoChenNeural","zh-TW-HsiaoYuNeural","zh-TW-YunJheNeural"]}).flatMap(e=>{let[t,n]=e;return n.map(e=>({name:e.replace("".concat(t,"-"),"").replace("Neural",""),id:e,lang:t}))})),(0,nS._)(n7,"audioCache",new n6(200));var at=new WeakMap,an=new WeakMap,aa=new WeakMap,al=new WeakMap,as=new WeakMap,ai=new WeakMap,ar=new WeakMap,ao=new WeakMap,ac=new WeakMap,ad=new WeakMap,au=new WeakMap;class ah{async init(){(0,nH._)(this,ai,n7.voices);try{await (0,nW._)(this,ar).create({lang:"en",text:"test",voice:"en-US-AriaNeural",rate:1,pitch:1}),this.available=!0}catch(e){this.available=!1}return this.available}async *speak(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],{marks:a}=nU(e),l=nG(e)||"en";if("en"===l&&(0,nW._)(this,at)&&"en"!==(0,nW._)(this,at)&&(l=(0,nW._)(this,at)),n){for(let e=0;e<Math.min(2,a.length);e++){let t=a[e],{language:n}=t,s=n||l,i=await this.getVoiceIdFromLang(s);await (0,nW._)(this,ar).createAudio(this.getPayload(s,t.text,i)).catch(t=>{console.warn("Error preloading mark",e,t)})}a.length>2&&(async()=>{for(let e=2;e<a.length;e++){let t=a[e];try{let{language:e}=t,n=e||l,a=await this.getVoiceIdFromLang(n);await (0,nW._)(this,ar).createAudio(this.getPayload(n,t.text,a))}catch(t){console.warn("Error preloading mark (bg)",e,t)}}})(),yield{code:"end",message:"Preload finished"};return}for(let e of(await this.stopInternal(),a)){if(t.aborted){yield{code:"error",message:"Aborted"};break}try{var s;let{language:n}=e,a=n||l,i=await this.getVoiceIdFromLang(a);(0,nH._)(this,an,a);let r=await (0,nW._)(this,ar).createAudio(this.getPayload(a,e.text,i)),o=URL.createObjectURL(r);(0,nH._)(this,ao,new Audio(o));let c=(0,nW._)(this,ao);c.setAttribute("x-webkit-airplay","deny"),c.preload="auto",null==(s=this.controller)||s.dispatchSpeakMark(e),yield{code:"boundary",message:"Start chunk: ".concat(e.name),mark:e.name};let d=await new Promise(n=>{let a=()=>{c.onended=null,c.onerror=null,c.pause(),c.src="",URL.revokeObjectURL(o)};if(c.onended=()=>{a(),t.aborted?n({code:"error",message:"Aborted"}):n({code:"end",message:"Chunk finished: ".concat(e.name)})},c.onerror=e=>{a(),console.warn("Audio playback error:",e),n({code:"error",message:"Audio playback error"})},t.aborted){a(),n({code:"error",message:"Aborted"});return}(0,nH._)(this,ac,!0),c.play().catch(e=>{a(),console.error("Failed to play audio:",e),n({code:"error",message:"Playback failed: "+e.message})})});yield d}catch(t){if(t instanceof Error&&"No audio data received."===t.message){console.warn("No audio data received for:",e.text),yield{code:"end",message:"Chunk finished: ".concat(e.name)};continue}console.log("Error:",t),yield{code:"error",message:t instanceof Error?t.message:String(t)};break}await this.stopInternal()}}async pause(){(0,nW._)(this,ac)&&(0,nW._)(this,ao)&&((0,nH._)(this,ad,(0,nW._)(this,ao).currentTime-(0,nW._)(this,au)),await (0,nW._)(this,ao).pause(),(0,nH._)(this,ac,!1))}async resume(){!(0,nW._)(this,ac)&&(0,nW._)(this,ao)&&(await (0,nW._)(this,ao).play(),(0,nH._)(this,ac,!0),(0,nH._)(this,au,(0,nW._)(this,ao).currentTime-(0,nW._)(this,ad)))}async stop(){await this.stopInternal()}async stopInternal(){if((0,nH._)(this,ac,!1),(0,nH._)(this,ad,0),(0,nH._)(this,au,0),(0,nW._)(this,ao)){var e,t;(0,nW._)(this,ao).pause(),(0,nW._)(this,ao).currentTime=0,(null==(e=(0,nW._)(this,ao))?void 0:e.onended)&&(0,nW._)(this,ao).onended(new Event("stopped")),(null==(t=(0,nW._)(this,ao).src)?void 0:t.startsWith("blob:"))&&URL.revokeObjectURL((0,nW._)(this,ao).src),(0,nW._)(this,ao).src="",(0,nH._)(this,ao,null)}}setPrimaryLang(e){(0,nH._)(this,at,e)}async setRate(e){(0,nH._)(this,aa,e)}async setPitch(e){(0,nH._)(this,al,e)}async setVoice(e){let t=(0,nW._)(this,ai).find(t=>t.id===e);t&&(0,nH._)(this,as,t)}async getAllVoices(){return(0,nW._)(this,ai).forEach(e=>{e.disabled=!this.available}),(0,nW._)(this,ai)}async getVoices(e){let t="en"===e&&(0,F.YK)(e)||e;return(await this.getAllVoices()).filter(n=>n.lang.startsWith(t)||"en"===e&&["en-US","en-GB"].includes(n.lang)).sort((e,t)=>{let n=e.lang.split("-")[1]||"",a=t.lang.split("-")[1]||"";return n===a?e.name<t.name?-1:+(e.name>t.name):"CN"===n?-1:"CN"===a?1:"TW"===n?-1:"TW"===a?1:"HK"===n?-1:"HK"===a?1:"US"===n?-1:"US"===a?1:"GB"===n?-1:"GB"===a?1:e.name<t.name?-1:+(e.name>t.name)})}getGranularities(){return["sentence"]}getVoiceId(){var e;return(null==(e=(0,nW._)(this,as))?void 0:e.id)||""}getSpeakingLang(){return(0,nW._)(this,an)}constructor(e){(0,nS._)(this,"controller",void 0),(0,nO._)(this,at,{writable:!0,value:"en"}),(0,nO._)(this,an,{writable:!0,value:""}),(0,nO._)(this,aa,{writable:!0,value:1}),(0,nO._)(this,al,{writable:!0,value:1}),(0,nO._)(this,as,{writable:!0,value:null}),(0,nO._)(this,ai,{writable:!0,value:[]}),(0,nO._)(this,ar,{writable:!0,value:void 0}),(0,nO._)(this,ao,{writable:!0,value:null}),(0,nO._)(this,ac,{writable:!0,value:!1}),(0,nO._)(this,ad,{writable:!0,value:0}),(0,nO._)(this,au,{writable:!0,value:0}),(0,nS._)(this,"available",!0),(0,nS._)(this,"getPayload",(e,t,n)=>({lang:e,text:t,voice:n,rate:(0,nW._)(this,aa),pitch:(0,nW._)(this,al)})),(0,nS._)(this,"getVoiceIdFromLang",async e=>{let t="en-US-AriaNeural",n=nX.getPreferredVoice("edge-tts",e),a=(0,nW._)(this,ai).find(e=>e.id===n);return(0,nH._)(this,as,a||(await this.getVoices(e))[0]||null),(0,nW._)(this,as)&&(t=(0,nW._)(this,as).id),t}),this.controller=e,(0,nH._)(this,ar,new n7)}}var am=n(80570),af=new WeakMap,ap=new WeakMap,ag=new WeakMap,ab=new WeakSet,ax=new WeakSet;class av extends EventTarget{async init(){await this.ttsWebClient.init(),await this.ttsEdgeClient.init()?this.ttsClient=this.ttsEdgeClient:this.ttsClient=this.ttsWebClient,this.ttsWebVoices=await this.ttsWebClient.getAllVoices(),this.ttsEdgeVoices=await this.ttsEdgeClient.getAllVoices()}async initViewTTS(){let e=this.view.language.isCJK?"sentence":"word",t=this.ttsClient.getGranularities();t.includes(e)||(e=t[0]),await this.view.initTTS(e)}async preloadSSML(e){if(e)for await(let t of(await this.ttsClient.speak(e,new AbortController().signal,!0)));}async preloadNextSSML(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2,t=this.view.tts;if(!t)return;let n=0;for(let a=0;a<e;a++){let e=(0,nN._)(this,ab,aw).call(this,t.next());this.preloadSSML(e),e&&n++}for(let e=0;e<n;e++)t.prev()}async speak(e){await this.initViewTTS(),(0,nN._)(this,ax,ay).call(this,e).catch(e=>this.error(e)),this.preloadNextSSML()}play(){"playing"!==this.state?this.start():this.pause()}async start(){var e,t;await this.initViewTTS();let n=this.state.includes("paused")?null==(e=this.view.tts)?void 0:e.resume():null==(t=this.view.tts)?void 0:t.start();this.state.includes("paused")&&this.resume(),(0,nN._)(this,ax,ay).call(this,n),this.preloadNextSSML()}async pause(){this.state="paused",await this.ttsClient.pause().catch(e=>this.error(e))}async resume(){this.state="playing",await this.ttsClient.resume().catch(e=>this.error(e))}async stop(){(0,nW._)(this,ap)&&(0,nW._)(this,ap).abort(),await this.ttsClient.stop().catch(e=>this.error(e)),(0,nW._)(this,ag)&&await (0,nW._)(this,ag).catch(e=>this.error(e)),this.state="stopped"}async backward(){var e,t;await this.initViewTTS(),"playing"===this.state?(await this.stop(),(0,nN._)(this,ax,ay).call(this,null==(e=this.view.tts)?void 0:e.prev())):(await this.stop(),this.state="backward-paused",null==(t=this.view.tts)||t.prev(!0))}async forward(){var e,t;await this.initViewTTS(),"playing"===this.state?(await this.stop(),(0,nN._)(this,ax,ay).call(this,null==(e=this.view.tts)?void 0:e.next()),this.preloadNextSSML()):(await this.stop(),this.state="forward-paused",null==(t=this.view.tts)||t.next(!0))}async setLang(e){this.ttsLang=e,this.setPrimaryLang(e)}async setPrimaryLang(e){this.ttsEdgeClient.setPrimaryLang(e),this.ttsWebClient.setPrimaryLang(e)}async setRate(e){this.state="setrate-paused",this.ttsRate=e,await this.ttsClient.setRate(this.ttsRate)}async getVoices(e){let t=await this.ttsWebClient.getVoices(e);return[...await this.ttsEdgeClient.getVoices(e),...t]}async setVoice(e,t){this.state="setvoice-paused",this.ttsEdgeVoices.find(t=>(""===e||t.id===e)&&!t.disabled)?(this.ttsClient=this.ttsEdgeClient,await this.ttsClient.setRate(this.ttsRate),nX.setPreferredVoice("edge-tts",t,e)):(this.ttsClient=this.ttsWebClient,await this.ttsClient.setRate(this.ttsRate),nX.setPreferredVoice("web-speech",t,e)),await this.ttsClient.setVoice(e)}getVoiceId(){return this.ttsClient.getVoiceId()}getSpeakingLang(){return this.ttsClient.getSpeakingLang()}dispatchSpeakMark(e){this.dispatchEvent(new CustomEvent("tts-speak-mark",{detail:e}))}error(e){console.error(e),this.state="stopped"}async kill(){await this.stop()}constructor(e){super(),(0,nk._)(this,ab),(0,nk._)(this,ax),(0,nS._)(this,"state","stopped"),(0,nS._)(this,"view",void 0),(0,nO._)(this,af,{writable:!0,value:0}),(0,nO._)(this,ap,{writable:!0,value:null}),(0,nO._)(this,ag,{writable:!0,value:null}),(0,nS._)(this,"ttsLang",""),(0,nS._)(this,"ttsRate",1),(0,nS._)(this,"ttsClient",void 0),(0,nS._)(this,"ttsWebClient",void 0),(0,nS._)(this,"ttsEdgeClient",void 0),(0,nS._)(this,"ttsWebVoices",[]),(0,nS._)(this,"ttsEdgeVoices",[]),this.ttsWebClient=new n3(this),this.ttsEdgeClient=new ah(this),this.ttsClient=this.ttsWebClient,this.view=e}}function aw(e){if(e)return e=e.replace(/<emphasis[^>]*>([^<]+)<\/emphasis>/g,"$1").replace(/[–—]/g,",").replace("<break/>"," ").replace(/\.{3,}/g,"   ").replace(/……/g,"  ").replace(/·/g," ")}async function ay(e){await this.stop(),(0,nH._)(this,ap,new AbortController);let{signal:t}=(0,nW._)(this,ap);(0,nH._)(this,ag,new Promise(async(n,a)=>{try{if(console.log("TTS speak"),this.state="playing",e=(0,nN._)(this,ab,aw).call(this,await e),await this.preloadSSML(e),e)(0,nH._)(this,af,0);else{(0,am._)(this,af).value++,10>(0,nW._)(this,af)&&"playing"===this.state&&(n(),await this.view.next(),await this.forward()),console.log("no SSML, skipping for",(0,nW._)(this,af));return}let{plainText:a,marks:s}=nU(e);if(!a||0===s.length)return n(),await this.forward();let i=await this.ttsClient.speak(e,t),r="boundary";for await(let{code:e,mark:a}of i){if(t.aborted)return void n();if(a&&"playing"===this.state){var l;let e=null==(l=this.view.tts)?void 0:l.setMark(a);this.dispatchEvent(new CustomEvent("tts-highlight-mark",{detail:e}))}r=e}"end"===r&&"playing"===this.state&&(n(),await this.forward()),n()}catch(e){t.aborted?n():a(e)}finally{(0,nH._)(this,ap,null),(0,nH._)(this,ag,null)}})),await (0,nW._)(this,ag).catch(e=>this.error(e))}let aj=e=>[{label:e("No Timeout"),value:0},{label:e("{{value}} minute",{value:1}),value:60},{label:e("{{value}} minutes",{value:3}),value:180},{label:e("{{value}} minutes",{value:5}),value:300},{label:e("{{value}} minutes",{value:10}),value:600},{label:e("{{value}} minutes",{value:20}),value:1200},{label:e("{{value}} minutes",{value:30}),value:1800},{label:e("{{value}} minutes",{value:45}),value:2700},{label:e("{{value}} hour",{value:1}),value:3600},{label:e("{{value}} hours",{value:2}),value:7200},{label:e("{{value}} hours",{value:3}),value:10800},{label:e("{{value}} hours",{value:4}),value:14400},{label:e("{{value}} hours",{value:6}),value:21600},{label:e("{{value}} hours",{value:8}),value:28800}],aN=e=>{let t=Date.now();if(e>t){let n=Math.floor((e-t)/1e3),a=60*Math.floor(n/3600)+Math.floor(n%3600/60),l=n%60;return"".concat(a,":").concat(l<10?"0":"").concat(l)}return""},ak=e=>{var t,n;let{bookKey:r,ttsLang:c,isPlaying:u,timeoutOption:h,timeoutTimestamp:m,onTogglePlay:f,onBackward:p,onForward:g,onSetRate:b,onGetVoices:x,onSetVoice:v,onGetVoiceId:w,onSelectTimeout:y}=e,j=(0,i.B)(),{envConfig:k}=(0,s.D)(),{getViewSettings:S,setViewSettings:C}=N(),{settings:A,setSettings:E,saveSettings:T}=(0,o.C)(),L=S(r),[M,I]=(0,l.useState)([]),[B,R]=(0,l.useState)(null!=(t=null==L?void 0:L.ttsRate)?t:1),[P,_]=(0,l.useState)(null!=(n=null==L?void 0:L.ttsVoice)?n:""),[D,z]=(0,l.useState)(()=>aN(m)),V=(0,es.n)(),F=(0,es.D)(32),W=(0,es.D)(48),O=(e,t)=>{v(e,t),_(e);let n=S(r);n.ttsVoice=e,C(r,n)},H=e=>{let t=Date.now();e>0&&e<t?(y(r,0),z("")):e>0&&z(aN(e))};(0,l.useEffect)(()=>{setTimeout(()=>{H(m)},1e3)},[m,D]),(0,l.useEffect)(()=>{_(w())},[]),(0,l.useEffect)(()=>{(async()=>{I(await x(c))})()},[c]);let K=aj(j);return(0,a.jsxs)("div",{className:"flex w-full flex-col items-center justify-center gap-2 rounded-2xl p-4",children:[(0,a.jsxs)("div",{className:"flex w-full flex-col items-center gap-0.5",children:[(0,a.jsx)("input",{className:"range",type:"range",min:0,max:3,step:"0.1",value:B,onChange:e=>{let t=parseFloat(e.target.value);R(t=Math.max(.2,Math.min(3,t))),b(t);let n=S(r);n.ttsRate=t,A.globalViewSettings.ttsRate=t,C(r,n),E(A),T(k,A)}}),(0,a.jsxs)("div",{className:"grid w-full grid-cols-7 text-xs",children:[(0,a.jsx)("span",{className:"text-center",children:"|"}),(0,a.jsx)("span",{className:"text-center",children:"|"}),(0,a.jsx)("span",{className:"text-center",children:"|"}),(0,a.jsx)("span",{className:"text-center",children:"|"}),(0,a.jsx)("span",{className:"text-center",children:"|"}),(0,a.jsx)("span",{className:"text-center",children:"|"}),(0,a.jsx)("span",{className:"text-center",children:"|"})]}),(0,a.jsxs)("div",{className:"grid w-full grid-cols-7 text-xs",children:[(0,a.jsx)("span",{className:"text-center",children:j("Slow")}),(0,a.jsx)("span",{className:"text-center"}),(0,a.jsx)("span",{className:"text-center",children:"1.0"}),(0,a.jsx)("span",{className:"text-center",children:"1.5"}),(0,a.jsx)("span",{className:"text-center",children:"2.0"}),(0,a.jsx)("span",{className:"text-center"}),(0,a.jsx)("span",{className:"text-center",children:j("Fast")})]})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between space-x-2",children:[(0,a.jsx)("button",{onClick:p,className:"rounded-full p-1",children:(0,a.jsx)(el.N_V,{size:F})}),(0,a.jsx)("button",{onClick:f,className:"rounded-full p-1",children:u?(0,a.jsx)(el.mbB,{size:W,className:"fill-primary"}):(0,a.jsx)(el.Egk,{size:W,className:"fill-primary"})}),(0,a.jsx)("button",{onClick:g,className:"rounded-full p-1",children:(0,a.jsx)(el.xbA,{size:F})}),(0,a.jsxs)("div",{className:"dropdown dropdown-top",children:[(0,a.jsxs)("button",{tabIndex:0,className:"flex flex-col items-center justify-center rounded-full p-1",children:[(0,a.jsx)(el.vH2,{size:F}),D&&(0,a.jsx)("span",{className:(0,d.A)("absolute bottom-0 left-1/2 w-12 translate-x-[-50%] translate-y-[80%] px-1","bg-primary/80 text-base-100 rounded-full text-center text-xs"),children:D})]}),(0,a.jsx)("ul",{tabIndex:0,className:(0,d.A)("dropdown-content bgcolor-base-200 no-triangle menu menu-vertical rounded-box absolute right-0 z-[1] shadow","mt-4 inline max-h-96 w-[200px] overflow-y-scroll"),children:K.map((e,t)=>(0,a.jsx)("li",{onClick:()=>y(r,e.value),children:(0,a.jsxs)("div",{className:"flex items-center px-2",children:[(0,a.jsx)("span",{style:{minWidth:"".concat(V,"px")},children:h===e.value&&(0,a.jsx)(el.g9_,{className:"text-base-content"})}),(0,a.jsx)("span",{className:(0,d.A)("text-base sm:text-sm"),children:e.label})]})},"".concat(t,"-").concat(e.value)))})]}),(0,a.jsxs)("div",{className:"dropdown dropdown-top",children:[(0,a.jsx)("button",{tabIndex:0,className:"rounded-full p-1",children:(0,a.jsx)(ty.DBM,{size:F})}),(0,a.jsx)("ul",{tabIndex:0,className:(0,d.A)("dropdown-content bgcolor-base-200 no-triangle menu menu-vertical rounded-box absolute right-0 z-[1] shadow","mt-4 inline max-h-96 w-[250px] overflow-y-scroll"),children:M.map((e,t)=>(0,a.jsx)("li",{onClick:()=>!e.disabled&&O(e.id,e.lang),children:(0,a.jsxs)("div",{className:"flex items-center px-2",children:[(0,a.jsx)("span",{style:{minWidth:"".concat(V,"px")},children:P===e.id&&(0,a.jsx)(el.g9_,{className:"text-base-content"})}),(0,a.jsx)("span",{className:(0,d.A)("text-base sm:text-sm",e.disabled&&"text-gray-400"),children:e.name})]})},"".concat(t,"-").concat(e.id)))})]})]})]})},aS=e=>{let{isPlaying:t,ttsInited:n,onClick:l}=e;return(0,a.jsxs)("div",{className:(0,d.A)("relative h-full w-full",n?"cursor-pointer":"cursor-not-allowed"),onClick:l,children:[(0,a.jsx)("div",{className:"absolute inset-0 overflow-hidden rounded-full bg-gradient-to-r from-blue-500 via-emerald-500 to-violet-500",children:(0,a.jsx)("div",{className:"absolute -inset-full bg-gradient-to-r from-blue-500 via-emerald-500 to-violet-500",style:{animation:t&&n?"moveGradient 2s alternate infinite":"none"}})}),(0,a.jsxs)("div",{className:"absolute inset-0 flex items-center justify-center",children:[(0,a.jsx)("style",{children:"\n          @keyframes moveGradient {\n            0% { transform: translate(0, 0); }\n            100% { transform: translate(25%, 25%); }\n          }\n          @keyframes bounce {\n            0%, 100% { transform: scaleY(1); }\n            50% { transform: scaleY(0.6); }\n          }\n        "}),(0,a.jsx)("div",{className:"flex items-end space-x-1",children:[1,2,3,4].map(e=>(0,a.jsx)("div",{className:"w-1 rounded-t bg-white",style:{height:"16px",animationName:t?"bounce":"none",animationDuration:t?"".concat(1+.1*e,"s"):"0s",animationTimingFunction:"ease-in-out",animationIterationCount:"infinite",animationDelay:"".concat(.1*e,"s")}},e))})]})]})},aC=()=>{let e=(0,i.B)(),{appService:t}=(0,s.D)(),{getBookData:n}=(0,w.I)(),{getView:r,getProgress:o,getViewSettings:c}=N(),{setViewSettings:u,setTTSEnabled:h}=N(),[m,p]=(0,l.useState)(""),[g,b]=(0,l.useState)("en"),[x,v]=(0,l.useState)(!1),[y,j]=(0,l.useState)(!1),[k,S]=(0,l.useState)(!1),[C,A]=(0,l.useState)(!1),[T,L]=(0,l.useState)(),[M,I]=(0,l.useState)(),[R,P]=(0,l.useState)(0),[_,D]=(0,l.useState)(0),[z,V]=(0,l.useState)(null),F=c(m),W=(0,es.D)(10),O=Math.min(window.innerWidth-2*W,(0,es.D)(282)),H=(0,es.D)(160),K=(0,l.useRef)(null),U=(0,l.useRef)(null),Y=(0,l.useRef)(null),[G,X]=(0,l.useState)(null),[q,J]=(0,l.useState)(!1),Z=()=>{U.current||(U.current=document.createElement("audio"),U.current.setAttribute("x-webkit-airplay","deny"),U.current.addEventListener("play",()=>{"mediaSession"in navigator&&(navigator.mediaSession.metadata=null,navigator.mediaSession.setActionHandler("play",null),navigator.mediaSession.setActionHandler("pause",null),navigator.mediaSession.setActionHandler("stop",null),navigator.mediaSession.setActionHandler("seekbackward",null),navigator.mediaSession.setActionHandler("seekforward",null))}),U.current.preload="auto",U.current.loop=!0,U.current.src="data:audio/mp3;base64,//MkxAAHiAICWABElBeKPL/RANb2w+yiT1g/gTok//lP/W/l3h8QO/OCdCqCW2Cw//MkxAQHkAIWUAhEmAQXWUOFW2dxPu//9mr60ElY5sseQ+xxesmHKtZr7bsqqX2L//MkxAgFwAYiQAhEAC2hq22d3///9FTV6tA36JdgBJoOGgc+7qvqej5Zu7/7uI9l//MkxBQHAAYi8AhEAO193vt9KGOq+6qcT7hhfN5FTInmwk8RkqKImTM55pRQHQSq//MkxBsGkgoIAABHhTACIJLf99nVI///yuW1uBqWfEu7CgNPWGpUadBmZ////4sL//MkxCMHMAH9iABEmAsKioqKigsLCwtVTEFNRTMuOTkuNVVVVVVVVVVVVVVVVVVV//MkxCkECAUYCAAAAFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV",U.current.play())},Q=()=>{if(U.current)try{U.current.pause(),U.current.currentTime=0,U.current.removeAttribute("src"),U.current.src="",U.current.load(),U.current=null,console.log("Unblock audio released")}catch(e){console.warn("Error releasing unblock audio:",e)}};(0,l.useEffect)(()=>()=>{Y.current&&(Y.current.kill(),Y.current=null)},[]),(0,l.useEffect)(()=>(E.I.on("tts-speak",$),E.I.on("tts-stop",ee),E.I.onSync("tts-is-speaking",et),()=>{E.I.off("tts-speak",$),E.I.off("tts-stop",ee),E.I.offSync("tts-is-speaking",et)}),[]),(0,l.useEffect)(()=>{if(!G||!m)return;let e=n(m);if(!e||!e.book)return;let{title:a,author:l,coverImageUrl:s}=e.book,i=e=>{let{sectionLabel:n}=o(m)||{},i=e.detail;(null==t?void 0:t.isMobileApp)&&"mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:i.text,artist:n||a,album:l,artwork:[{src:s||"/icon.png",sizes:"512x512",type:"image/png"}]}))},d=e=>{let t=e.detail,n=r(m),a=o(m),l=c(m);if(!t||!n||!a||!l)return;let{location:s}=a,{index:i}=n.resolveCFI(s),d=null==n?void 0:n.getCFI(i,t);d&&(l.ttsLocation=d||"",u(m,l))};return G.addEventListener("tts-speak-mark",i),G.addEventListener("tts-highlight-mark",d),()=>{G.removeEventListener("tts-speak-mark",i),G.removeEventListener("tts-highlight-mark",d)}},[G,m]);let $=async a=>{var l,s;let{bookKey:i,range:d}=a.detail,u=r(i),m=o(i),g=c(i),x=n(i);if(!u||!m||!g||!x||!x.book)return;if((null==(l=x.book)?void 0:l.format)==="PDF")return void E.I.dispatch("toast",{message:e("TTS not supported for PDF"),type:"warning"});let w=d||m.range;if(g.ttsLocation){let{location:e}=m,t=g.ttsLocation,n=f.HY.collapse(e),a=f.HY.collapse(e,!0);if(f.HY.compare(n,t)*f.HY.compare(a,t)<=0){let{index:e,anchor:n}=u.resolveCFI(t),{doc:a}=u.renderer.getContents().find(t=>t.index=e)||{};a&&(w=n(a)||w)}}let y=x.book.primaryLanguage;p(i),Y.current&&(Y.current.stop(),Y.current=null),h(i,!0),S(!0);try{(null==t?void 0:t.isIOSApp)&&await (0,B.i1)({enabled:!0}),(null==t?void 0:t.isMobile)&&Z(),J(!1);let e=new av(u);await e.init(),await e.initViewTTS();let n=null==(s=u.tts)?void 0:s.from(w);if(n){let t=nG(n)||"en";"en"===t&&y&&"en"!==y&&(t=y.split("-")[0]),v(!0),b(t),e.setLang(t),e.setRate(g.ttsRate),e.speak(n),Y.current=e,X(e)}J(!0)}catch(t){E.I.dispatch("toast",{message:e("TTS not supported in this device"),type:"error"}),console.error(t)}},ee=async e=>{let{bookKey:t}=e.detail;Y.current&&ei(t)},et=()=>!!Y.current,en=async()=>{let e=Y.current;e&&(x?(v(!1),j(!0),await e.pause()):y&&(v(!0),j(!1),"paused"===e.state?await e.resume():await e.start()))},ea=async()=>{let e=Y.current;e&&await e.backward()},el=async()=>{let e=Y.current;e&&await e.forward()},ei=async e=>{let n=Y.current;if(n){var a;await n.stop(),Y.current=null,X(null),null==(a=r(e))||a.deselect(),v(!1),A(!1),S(!1)}(null==t?void 0:t.isIOSApp)&&await (0,B.i1)({enabled:!1}),(null==t?void 0:t.isMobile)&&Q(),h(e,!1)},er=(0,l.useCallback)((0,e2.n)(async e=>{let t=Y.current;t&&("playing"===t.state?(await t.stop(),await t.setRate(e),await t.start()):await t.setRate(e))},3e3),[]),eo=(0,l.useCallback)((0,e2.n)(async(e,t)=>{let n=Y.current;n&&("playing"===n.state?(await n.stop(),await n.setVoice(e,t),await n.start()):await n.setVoice(e,t))},3e3),[]),ec=async e=>{let t=Y.current;return t?t.getVoices(e):[]},ed=()=>{if(K.current){var e;let t=K.current.getBoundingClientRect(),n=(null==(e=K.current.parentElement)?void 0:e.getBoundingClientRect())||document.documentElement.getBoundingClientRect(),a={dir:"up",point:{x:t.left+t.width/2-n.left,y:t.top-12}};L(no(a,n,O,H,W)),I(a)}},eu=()=>{A(!1)};return(0,l.useEffect)(()=>{if(!K.current||!C)return;let e=K.current.parentElement;if(!e)return;let t=new ResizeObserver(()=>{ed()});return t.observe(e),()=>{t.disconnect()}},[C]),(0,a.jsxs)(a.Fragment,{children:[C&&(0,a.jsx)("div",{className:"fixed inset-0",onClick:eu,onContextMenu:eu}),k&&(0,a.jsx)("div",{ref:K,className:(0,d.A)("absolute h-12 w-12",(null==F?void 0:F.rtl)?"left-6":"right-6",(null==t?void 0:t.hasSafeAreaInset)?"bottom-[calc(env(safe-area-inset-bottom)+70px)]":"bottom-[70px] sm:bottom-14"),children:(0,a.jsx)(aS,{isPlaying:x,ttsInited:q,onClick:()=>{ed(),!C&&Y.current&&b(Y.current.getSpeakingLang()||g),A(e=>!e)}})}),C&&T&&M&&q&&(0,a.jsx)(nu,{width:O,height:H,position:T,trianglePosition:M,className:"bg-base-200 flex shadow-lg",children:(0,a.jsx)(ak,{bookKey:m,ttsLang:g,isPlaying:x,timeoutOption:R,timeoutTimestamp:_,onTogglePlay:en,onBackward:ea,onForward:el,onSetRate:er,onGetVoices:ec,onSetVoice:eo,onGetVoiceId:()=>{let e=Y.current;return e?e.getVoiceId():""},onSelectTimeout:(e,t)=>{P(t),z&&clearTimeout(z),t>0?(V(setTimeout(()=>{ei(e)},1e3*t)),D(Date.now()+1e3*t)):D(0)}})})]})},aA=e=>{let{bookKeys:t,onCloseBook:n}=e,{appService:i}=(0,s.D)(),{getConfig:r,getBookData:c}=(0,w.I)(),{getProgress:u,getViewState:h,getViewSettings:m,hoveredBookKey:f}=N(),{isSideBarVisible:p,sideBarBookKey:g}=k(),{isFontLayoutSettingsDialogOpen:b,setFontLayoutSettingsDialogOpen:x}=(0,o.C)(),v=tm(t.length,window.innerWidth/window.innerHeight);return(0,l.useEffect)(()=>{if(!g)return;let e=c(g);e&&e.book&&(document.title=e.book.title)},[g]),(0,a.jsxs)("div",{className:(0,d.A)("relative grid h-full flex-grow"),style:{gridTemplateColumns:v.columns,gridTemplateRows:v.rows},children:[t.map((e,l)=>{var s;let o=c(e),g=r(e),v=u(e),w=m(e),{book:y,bookDoc:j}=o||{};if(!y||!g||!j||!w)return null;let{section:N,pageinfo:k,timeinfo:S,sectionLabel:C}=v||{},A=null==(s=h(e))?void 0:s.ribbonVisible,E=w.gapPercent,T=w.marginPx,L=w.scrolled,M=w.showBarsOnScroll,I=w.showHeader&&(!L||M),B=w.showFooter&&(!L||M);return(0,a.jsxs)("div",{id:"gridcell-".concat(e),className:(0,d.A)("relative h-full w-full overflow-hidden",0===l&&!(null==w?void 0:w.scrolled)&&(null==i?void 0:i.hasSafeAreaInset)&&"pt-[env(safe-area-inset-top)]",!p&&(null==i?void 0:i.hasRoundedWindow)&&"rounded-window"),children:[A&&!f&&(0,a.jsx)(tB,{width:"".concat(E,"%")}),(0,a.jsx)(tA,{bookKey:e,bookTitle:y.title,isTopLeft:0===l,isHoveredAnim:t.length>2,onCloseBook:n,onSetSettingsDialogOpen:x}),(0,a.jsx)(th,{bookKey:e,bookDoc:j,config:g}),w.vertical&&w.scrolled&&(0,a.jsxs)(a.Fragment,{children:[(B||w.doubleBorder)&&(0,a.jsx)("div",{className:"bg-base-100 absolute left-0 top-0 h-full",style:{width:"calc(".concat(E,"%)"),height:"calc(100% - ".concat(T,"px)")}}),(I||w.doubleBorder)&&(0,a.jsx)("div",{className:"bg-base-100 absolute right-0 top-0 h-full",style:{width:"calc(".concat(E,"%)"),height:"calc(100% - ".concat(T,"px)")}})]}),w.vertical&&w.doubleBorder&&(0,a.jsx)(nF,{showHeader:I,showFooter:B,borderColor:w.borderColor,horizontalGap:E,verticalMargin:T}),I&&(0,a.jsx)(tf,{section:C,showDoubleBorder:w.vertical&&w.doubleBorder,isScrolled:w.scrolled,isVertical:w.vertical,horizontalGap:E,verticalMargin:T}),(0,a.jsx)(nV,{bookKey:e,showDoubleBorder:w.vertical&&w.doubleBorder,isScrolled:w.scrolled,isVertical:w.vertical,horizontalGap:E,verticalMargin:T}),B&&(0,a.jsx)(tI,{bookKey:e,bookFormat:y.format,section:N,pageinfo:k,timeinfo:S,horizontalGap:E,verticalMargin:T}),(0,a.jsx)(nj,{bookKey:e}),(0,a.jsx)(nz,{bookKey:e,bookDoc:j}),(0,a.jsx)(tM,{bookKey:e,bookFormat:y.format,section:N,pageinfo:k,isHoveredAnim:!1}),b&&(0,a.jsx)(t7,{bookKey:e,config:g})]},e)}),(0,a.jsx)(aC,{})]})},aE=e=>{let{ids:t,settings:n}=e,i=(0,D.useRouter)(),r=(0,D.useSearchParams)(),{envConfig:c,appService:u}=(0,s.D)(),{bookKeys:h,dismissBook:m,getNextBookKey:f}=K(),{sideBarBookKey:p,setSideBarBookKey:g}=k(),{saveSettings:b}=(0,o.C)(),{getConfig:x,getBookData:v,saveConfig:y}=(0,w.I)(),{getView:j,setBookKeys:S}=N(),{initViewState:C,getViewState:A,clearViewState:T}=N(),[M,I]=(0,l.useState)(null),B=(0,l.useRef)(!1),[R,P]=(0,l.useState)(!1);q({sideBarBookKey:p,bookKeys:h}),(0,l.useEffect)(()=>{if(B.current)return;B.current=!0;let e=(t||(null==r?void 0:r.get("ids"))||"").split(O.Zk).filter(Boolean).map(e=>"".concat(e,"-").concat((0,F.NF)()));S(e);let n=new Set;console.log("Initialize books",e),e.forEach((e,t)=>{let a=e.split("-")[0],l=!n.has(a);n.add(a),A(e)||(C(c,a,e,l).catch(t=>{console.log("Error initializing book",e,t)}),0===t&&g(e))}),E.I.onSync("show-book-details",e=>(I(e.detail),!0))},[]),(0,l.useEffect)(()=>{if(h&&h.length>0){let e=o.C.getState().settings;e.lastOpenBooks=h.map(e=>e.split("-")[0]),b(c,e)}return(0,L.uO)()&&(0,V.tQ)(Y),window.addEventListener("beforeunload",Y),E.I.on("quit-app",Y),()=>{window.removeEventListener("beforeunload",Y),E.I.off("quit-app",Y)}},[h]);let _=async e=>{let t=x(e),{book:n}=v(e)||{},{isPrimary:a}=A(e)||{};if(a&&n&&t){E.I.dispatch("sync-book-progress",{bookKey:e});let n=o.C.getState().settings;await y(c,e,t,n)}},H=async e=>{console.log("Closing book",e);try{var t,n;null==(t=j(e))||t.close(),null==(n=j(e))||n.remove()}catch(t){console.info("Error closing book",e)}E.I.dispatch("tts-stop",{bookKey:e}),await _(e),T(e)},U=()=>{b(c,n),(0,W.i7)(i)},Y=async()=>{let e=o.C.getState().settings;await Promise.all(h.map(e=>H(e))),await b(c,e)},G=async e=>{H(e),p===e&&g(f(p)),m(e),0==h.filter(t=>t!==e).length&&(!((await (0,z.L)()||[]).length>0)||(null==u?void 0:u.isMobile)?U():(0,V.wm)())};if(!h||0===h.length)return null;let X=v(h[0]);return X&&X.book&&X.bookDoc?(0,a.jsxs)("div",{className:(0,d.A)("flex",(null==u?void 0:u.isIOSApp)?"h-[100vh]":"h-dvh"),children:[(0,a.jsx)(eF,{onGoToLibrary:()=>{Y(),(0,W.i7)(i)}}),(0,a.jsx)(aA,{bookKeys:h,onCloseBook:G}),(0,a.jsx)(eY,{}),M&&(0,a.jsx)(J.A,{isOpen:!!M,book:M,onClose:()=>I(null)})]}):(setTimeout(()=>P(!0),300),R&&(0,a.jsx)("div",{className:(0,d.A)("hero hero-content",(null==u?void 0:u.isIOSApp)?"h-[100vh]":"h-dvh"),children:(0,a.jsx)(Z.A,{loading:!0})}))},aT=e=>{let{ids:t}=e,{envConfig:n,appService:i}=(0,s.D)(),{setLibrary:r}=(0,y.C)(),{hoveredBookKey:c}=N(),{settings:m,setSettings:f}=(0,o.C)(),{isSideBarVisible:p,setSideBarVisible:g}=k(),{isNotebookVisible:b,setNotebookVisible:x}=S(),{isDarkMode:v,showSystemUI:w,dismissSystemUI:j}=(0,h.C)(),{acquireBackKeyInterception:T,releaseBackKeyInterception:L}=(0,C.A)(),[D,z]=(0,l.useState)(!1),V=(0,l.useRef)(!1);(0,u.D)({systemUIVisible:!1,appThemeColor:"base-100"}),(0,A.N)(m.screenWakeLock),(0,l.useEffect)(()=>{(0,I.D)(document),M()},[]),(0,l.useEffect)(()=>{let e=()=>{(null==i?void 0:i.isMobileApp)&&!document.hidden&&(j(),(0,B.Mp)({visible:!1,darkMode:v}))};return document.addEventListener("visibilitychange",e),()=>{document.removeEventListener("visibilitychange",e)}},[i,v]);let F=e=>"Back"===e.detail.keyName&&(g(!1),x(!1),!0);return(0,l.useEffect)(()=>{if(null==i?void 0:i.isAndroidApp)return(p||b)&&(T(),E.I.onSync("native-key-down",F)),p||b||(L(),E.I.offSync("native-key-down",F)),()=>{(null==i?void 0:i.isAndroidApp)&&(L(),E.I.offSync("native-key-down",F))}},[p,b]),(0,l.useEffect)(()=>{V.current||(V.current=!0,(async()=>{let e=await n.getAppService();f(await e.loadSettings()),r(await e.loadLibraryBooks()),z(!0)})())},[]),(0,l.useEffect)(()=>{if(!(null==i?void 0:i.isMobileApp))return;let e=!!c;(0,B.Mp)({visible:e,darkMode:v}),e?w():j()},[c]),D&&m.globalReadSettings&&(0,a.jsx)("div",{className:(0,d.A)("reader-page bg-base-100 text-base-content select-none",!p&&(null==i?void 0:i.hasRoundedWindow)&&"rounded-window"),children:(0,a.jsxs)(l.Suspense,{children:[(0,a.jsx)(aE,{ids:t,settings:m}),(0,a.jsx)(R.i,{}),(null==i?void 0:i.isAndroidApp)&&(0,a.jsx)(P.Y0,{}),(0,a.jsx)(_.y,{})]})})};function aL(){let e=(0,i.B)(),{appService:t}=(0,s.D)(),{settings:n}=(0,o.C)();return(0,r._)(),(0,l.useEffect)(()=>{(async()=>{(null==t?void 0:t.hasUpdater)&&n.autoCheckUpdates&&await (0,c.J)(e)})()},[n]),(0,a.jsx)(aT,{})}}},e=>{var t=t=>e(e.s=t);e.O(0,[7412,1868,2848,7324,951,8375,3564,1336,6258,868,3064,589,9297,690,4607,9211,7226,1470,2778,1029,6261,743,8769,348,935,1503,2722,2991,1985,1426,6821,426,3125,7358],()=>t(36995)),_N_E=e.O()}]);