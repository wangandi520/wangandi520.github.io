"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9867],{59867:(e,t,i)=>{i.r(t),i.d(t,{MOBI:()=>ei,isMOBI:()=>G});var r=i(96261),a=i(89657),n=i(49033),l=i(80570),s=i(19780),o=i(25842),u=i(84648);let h=e=>{if(!e)return"";let t=document.createElement("textarea");return t.innerHTML=e,t.value},c={XML:"application/xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml"},d={name:[0,32,"string"],type:[60,4,"string"],creator:[64,4,"string"],numRecords:[76,2,"uint"]},f={compression:[0,2,"uint"],numTextRecords:[8,2,"uint"],recordSize:[10,2,"uint"],encryption:[12,2,"uint"]},g={magic:[16,4,"string"],length:[20,4,"uint"],type:[24,4,"uint"],encoding:[28,4,"uint"],uid:[32,4,"uint"],version:[36,4,"uint"],titleOffset:[84,4,"uint"],titleLength:[88,4,"uint"],localeRegion:[94,1,"uint"],localeLanguage:[95,1,"uint"],resourceStart:[108,4,"uint"],huffcdic:[112,4,"uint"],numHuffcdic:[116,4,"uint"],exthFlag:[128,4,"uint"],trailingFlags:[240,4,"uint"],indx:[244,4,"uint"]},p={resourceStart:[108,4,"uint"],fdst:[192,4,"uint"],numFdst:[196,4,"uint"],frag:[248,4,"uint"],skel:[252,4,"uint"],guide:[260,4,"uint"]},m={magic:[0,4,"string"],length:[4,4,"uint"],count:[8,4,"uint"]},w={magic:[0,4,"string"],length:[4,4,"uint"],type:[8,4,"uint"],idxt:[20,4,"uint"],numRecords:[24,4,"uint"],encoding:[28,4,"uint"],language:[32,4,"uint"],total:[36,4,"uint"],ordt:[40,4,"uint"],ligt:[44,4,"uint"],numLigt:[48,4,"uint"],numCncx:[52,4,"uint"]},b={magic:[0,4,"string"],length:[4,4,"uint"],numControlBytes:[8,4,"uint"]},v={magic:[0,4,"string"],offset1:[8,4,"uint"],offset2:[12,4,"uint"]},_={magic:[0,4,"string"],length:[4,4,"uint"],numEntries:[8,4,"uint"],codeLength:[12,4,"uint"]},y={magic:[0,4,"string"],numEntries:[8,4,"uint"]},R={flags:[8,4,"uint"],dataStart:[12,4,"uint"],keyLength:[16,4,"uint"],keyStart:[20,4,"uint"]},M={1252:"windows-1252",65001:"utf-8"},k={100:["creator","string",!0],101:["publisher"],103:["description"],104:["isbn"],105:["subject","string",!0],106:["date"],108:["contributor","string",!0],109:["rights"],110:["subjectCode","string",!0],112:["source","string",!0],113:["asin"],121:["boundary","uint"],122:["fixedLayout"],125:["numResources","uint"],126:["originalResolution"],127:["zeroGutter"],128:["zeroMargin"],129:["coverURI"],132:["regionMagnification"],201:["coverOffset","uint"],202:["thumbnailOffset","uint"],503:["title"],524:["language","string",!0],527:["pageProgressionDirection"]},x={1:["ar","ar-SA","ar-IQ","ar-EG","ar-LY","ar-DZ","ar-MA","ar-TN","ar-OM","ar-YE","ar-SY","ar-JO","ar-LB","ar-KW","ar-AE","ar-BH","ar-QA"],2:["bg"],3:["ca"],4:["zh","zh-TW","zh-CN","zh-HK","zh-SG"],5:["cs"],6:["da"],7:["de","de-DE","de-CH","de-AT","de-LU","de-LI"],8:["el"],9:["en","en-US","en-GB","en-AU","en-CA","en-NZ","en-IE","en-ZA","en-JM",null,"en-BZ","en-TT","en-ZW","en-PH"],10:["es","es-ES","es-MX",null,"es-GT","es-CR","es-PA","es-DO","es-VE","es-CO","es-PE","es-AR","es-EC","es-CL","es-UY","es-PY","es-BO","es-SV","es-HN","es-NI","es-PR"],11:["fi"],12:["fr","fr-FR","fr-BE","fr-CA","fr-CH","fr-LU","fr-MC"],13:["he"],14:["hu"],15:["is"],16:["it","it-IT","it-CH"],17:["ja"],18:["ko"],19:["nl","nl-NL","nl-BE"],20:["no","nb","nn"],21:["pl"],22:["pt","pt-BR","pt-PT"],23:["rm"],24:["ro"],25:["ru"],26:["hr",null,"sr"],27:["sk"],28:["sq"],29:["sv","sv-SE","sv-FI"],30:["th"],31:["tr"],32:["ur"],33:["id"],34:["uk"],35:["be"],36:["sl"],37:["et"],38:["lv"],39:["lt"],41:["fa"],42:["vi"],43:["hy"],44:["az"],45:["eu"],46:["hsb"],47:["mk"],48:["st"],49:["ts"],50:["tn"],52:["xh"],53:["zu"],54:["af"],55:["ka"],56:["fo"],57:["hi"],58:["mt"],59:["se"],62:["ms"],63:["kk"],65:["sw"],67:["uz",null,"uz-UZ"],68:["tt"],69:["bn"],70:["pa"],71:["gu"],72:["or"],73:["ta"],74:["te"],75:["kn"],76:["ml"],77:["as"],78:["mr"],79:["sa"],82:["cy","cy-GB"],83:["gl","gl-ES"],87:["kok"],97:["ne"],98:["fy"]},S=(e,t)=>{let i=new e.constructor(e.length+t.length);return i.set(e),i.set(t,e.length),i},A=(e,t,i)=>{let r=new e.constructor(e.length+t.length+i.length);return r.set(e),r.set(t,e.length),r.set(i,e.length+t.length),r},E=new TextDecoder,T=e=>E.decode(e),C=e=>{if(!e)return;let t=e.byteLength;return new DataView(e)[4===t?"getUint32":2===t?"getUint16":"getUint8"](0)},L=(e,t)=>Object.fromEntries(Array.from(Object.entries(e)).map(e=>{let[i,[r,a,n]]=e;return[i,("string"===n?T:C)(t.slice(r,r+a))]})),I=e=>new TextDecoder(M[e]),U=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0,r=0;for(let a of e.subarray(t,t+4))if(i=i<<7|(127&a)>>>0,r++,128&a)break;return{value:i,length:r}},B=e=>{let t=0;for(let i of e.subarray(-4))128&i&&(t=0),t=t<<7|127&i;return t},O=e=>{let t=0;for(;e>0;e>>=1)(1&e)==1&&t++;return t},F=e=>{let t=0;for(;(1&e)==0;)e>>=1,t++;return t},W=e=>{let t=[];for(let i=0;i<e.length;i++){let r=e[i];if(0===r)t.push(0);else if(r<=8)for(let a of e.subarray(i+1,(i+=r)+1))t.push(a);else if(r<=127)t.push(r);else if(r<=191){let a=r<<8|e[i+++1],n=(16383&a)>>>3,l=(7&a)+3;for(let e=0;e<l;e++)t.push(t[t.length-n])}else t.push(32,128^r)}return Uint8Array.from(t)},D=(e,t)=>{var i;let r=t>>3,a=t+32,n=a>>3,l=0n;for(let t=r;t<=n;t++)l=l<<8n|BigInt(null!=(i=e[t])?i:0);return l>>8n-BigInt(7&a)&4294967295n},H=async(e,t)=>{let i=await t(e.huffcdic),{magic:r,offset1:a,offset2:n}=L(v,i);if("HUFF"!==r)throw Error("Invalid HUFF record");let l=Array.from({length:256},(e,t)=>a+4*t).map(e=>C(i.slice(e,e+4))).map(e=>[128&e,31&e,e>>>8]),s=[null].concat(Array.from({length:32},(e,t)=>n+8*t).map(e=>[C(i.slice(e,e+4)),C(i.slice(e+4,e+8))])),o=[];for(let i=1;i<e.numHuffcdic;i++){let r=await t(e.huffcdic+i),a=L(_,r);if("CDIC"!==a.magic)throw Error("Invalid CDIC record");let n=Math.min(1<<a.codeLength,a.numEntries-o.length),l=r.slice(a.length);for(let e=0;e<n;e++){let t=C(l.slice(2*e,2*e+2)),i=C(l.slice(t,t+2)),r=32767&i,a=32768&i,n=new Uint8Array(l.slice(t+2,t+2+r));o.push([n,a])}}let u=e=>{let t=new Uint8Array,i=8*e.byteLength;for(let r=0;r<i;){let a=Number(D(e,r)),[n,h,c]=l[a>>>24];if(!n){for(;a>>>32-h<s[h][0];)h+=1;c=s[h][1]}if((r+=h)>i)break;let d=c-(a>>>32-h),[f,g]=o[d];g||(f=u(f),o[d]=[f,!0]),t=S(t,f)}return t};return u},z=async(e,t)=>{let i=await t(e),r=L(w,i);if("INDX"!==r.magic)throw Error("Invalid INDX record");let a=I(r.encoding),n=i.slice(r.length),l=L(b,n);if("TAGX"!==l.magic)throw Error("Invalid TAGX section");let s=Array.from({length:(l.length-12)/4},(e,t)=>new Uint8Array(n.slice(12+4*t,12+4*t+4))),o={},u=0;for(let i=0;i<r.numCncx;i++){let n=await t(e+r.numRecords+i+1),l=new Uint8Array(n);for(let e=0;e<l.byteLength;){let t=e,{value:i,length:r}=U(l,e);e+=r;let s=n.slice(e,e+i);e+=i,o[u+t]=a.decode(s)}u+=65536}let h=[];for(let i=0;i<r.numRecords;i++){let r=await t(e+1+i),a=new Uint8Array(r),n=L(w,r);if("INDX"!==n.magic)throw Error("Invalid INDX record");for(let e=0;e<n.numRecords;e++){let t=n.idxt+4+2*e,i=C(r.slice(t,t+2)),o=C(r.slice(i,i+1)),u=T(r.slice(i+1,i+1+o)),c=[],d=i+1+o,f=0,g=d+l.numControlBytes;for(let[e,t,i,n]of s){if(1&n){f++;continue}let l=d+f,s=C(r.slice(l,l+1))&i;if(s===i)if(O(i)>1){let{value:i,length:r}=U(a,g);c.push([e,null,i,t]),g+=r}else c.push([e,1,null,t]);else c.push([e,s>>F(i),null,t])}let p={};for(let[e,t,i,r]of c){let n=[];if(null!=t)for(let e=0;e<t*r;e++){let{value:e,length:t}=U(a,g);n.push(e),g+=t}else{let e=0;for(;e<i;){let{value:t,length:i}=U(a,g);n.push(t),g+=i,e+=i}}p[e]=n}h.push({name:u,tagMap:p})}}return{table:h,cncx:o}},N=async(e,t)=>{let{table:i,cncx:r}=await z(e,t),a=i.map((e,t)=>{var i,a,n,l,s,o,u;let{tagMap:h}=e;return{index:t,offset:null==(i=h[1])?void 0:i[0],size:null==(a=h[2])?void 0:a[0],label:null!=(u=r[h[3]])?u:"",headingLevel:null==(n=h[4])?void 0:n[0],pos:h[6],parent:null==(l=h[21])?void 0:l[0],firstChild:null==(s=h[22])?void 0:s[0],lastChild:null==(o=h[23])?void 0:o[0]}}),n=e=>(null==e.firstChild||(e.children=a.filter(t=>t.parent===e.index).map(n)),e);return a.filter(e=>0===e.headingLevel).map(n)},X=(e,t)=>{let{magic:i,count:r}=L(m,e);if("EXTH"!==i)throw Error("Invalid EXTH header");let a=I(t),n={},l=12;for(let t=0;t<r;t++){let t=C(e.slice(l,l+4)),i=C(e.slice(l+4,l+8));if(t in k){let[r,o,u]=k[t],h=e.slice(l+8,l+i),c="uint"===o?C(h):a.decode(h);if(u){var s;null!=n[r]||(n[r]=[]),n[r].push(c)}else n[r]=c}l+=i}return n},j=async(e,t)=>{let{flags:i,dataStart:r,keyLength:a,keyStart:n}=L(R,e),l=new Uint8Array(e.slice(r));if(2&i){let t=new Uint8Array(e.slice(n,n+a)),i=Math.min(16===a?1024:1040,l.length);for(var s=0;s<i;s++)l[s]=l[s]^t[s%t.length]}if(1&i)try{return await t(l)}catch(e){console.warn(e),console.warn("Failed to decompress font")}return l},G=async e=>"BOOKMOBI"===T(await e.slice(60,68).arrayBuffer());var q=new WeakMap,P=new WeakMap;class V{async open(e){(0,n._)(this,q,e);let t=L(d,await e.slice(0,78).arrayBuffer());this.pdb=t;let i=await e.slice(78,78+8*t.numRecords).arrayBuffer();(0,n._)(this,P,Array.from({length:t.numRecords},(e,t)=>C(i.slice(8*t,8*t+4))).map((e,t,i)=>[e,i[t+1]]))}loadRecord(e){let t=(0,r._)(this,P)[e];if(!t)throw RangeError("Record index out of bounds");return(0,r._)(this,q).slice(...t).arrayBuffer()}async loadMagic(e){let t=(0,r._)(this,P)[e][0];return T(await (0,r._)(this,q).slice(t,t+4).arrayBuffer())}constructor(){(0,a._)(this,q,{writable:!0,value:void 0}),(0,a._)(this,P,{writable:!0,value:void 0}),(0,u._)(this,"pdb",void 0)}}var Z=new WeakMap,Y=new WeakMap,K=new WeakMap,J=new WeakMap,Q=new WeakMap,$=new WeakMap,ee=new WeakSet,et=new WeakSet;class ei extends V{async open(e){await super.open(e),this.headers=(0,s._)(this,ee,er).call(this,await super.loadRecord(0)),(0,n._)(this,Y,this.headers.mobi.resourceStart);let t=this.headers.mobi.version>=8;if(!t){var i;let e=null==(i=this.headers.exth)?void 0:i.boundary;if(e<0xffffffff)try{this.headers=(0,s._)(this,ee,er).call(this,await super.loadRecord(e)),(0,n._)(this,Z,e),t=!0}catch(e){console.warn(e),console.warn("Failed to open KF8; falling back to MOBI")}}return await (0,s._)(this,et,ea).call(this),t?new eF(this).init():new eg(this).init()}decode(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return(0,r._)(this,K).decode(...t)}encode(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return(0,r._)(this,J).encode(...t)}loadRecord(e){return super.loadRecord((0,r._)(this,Z)+e)}loadMagic(e){return super.loadMagic((0,r._)(this,Z)+e)}loadText(e){return this.loadRecord(e+1).then(e=>new Uint8Array(e)).then((0,r._)(this,$)).then((0,r._)(this,Q))}async loadResource(e){let t=await super.loadRecord((0,r._)(this,Y)+e),i=T(t.slice(0,4));return"FONT"===i?j(t,this.unzlib):"VIDE"===i||"AUDI"===i?t.slice(12):t}getNCX(){let e=this.headers.mobi.indx;if(e<0xffffffff)return N(e,this.loadRecord.bind(this))}getMetadata(){var e,t,i;let{mobi:r,exth:a}=this.headers;return{identifier:r.uid.toString(),title:h((null==a?void 0:a.title)||this.decode(r.title)),author:null==a||null==(e=a.creator)?void 0:e.map(h),publisher:h(null==a?void 0:a.publisher),language:null!=(i=null==a?void 0:a.language)?i:r.language,published:null==a?void 0:a.date,description:h(null==a?void 0:a.description),subject:null==a||null==(t=a.subject)?void 0:t.map(h),rights:h(null==a?void 0:a.rights),contributor:null==a?void 0:a.contributor}}async getCover(){let{exth:e}=this.headers,t=(null==e?void 0:e.coverOffset)<0xffffffff?null==e?void 0:e.coverOffset:(null==e?void 0:e.thumbnailOffset)<0xffffffff?null==e?void 0:e.thumbnailOffset:null;if(null!=t)return new Blob([await this.loadResource(t)])}constructor({unzlib:e}){super(),(0,o._)(this,ee),(0,o._)(this,et),(0,a._)(this,Z,{writable:!0,value:0}),(0,a._)(this,Y,{writable:!0,value:void 0}),(0,a._)(this,K,{writable:!0,value:void 0}),(0,a._)(this,J,{writable:!0,value:void 0}),(0,a._)(this,Q,{writable:!0,value:void 0}),(0,a._)(this,$,{writable:!0,value:void 0}),this.unzlib=e}}function er(e){var t;let i=L(f,e),r=L(g,e);if("MOBI"!==r.magic)throw Error("Missing MOBI header");let{titleOffset:a,titleLength:n,localeLanguage:l,localeRegion:s}=r;r.title=e.slice(a,a+n);let o=x[l];r.language=null!=(t=null==o?void 0:o[s>>2])?t:null==o?void 0:o[0];let u=64&r.exthFlag?X(e.slice(r.length+16),r.encoding):null,h=r.version>=8?L(p,e):null;return{palmdoc:i,mobi:r,exth:u,kf8:h}}async function ea(){let{palmdoc:e,mobi:t}=this.headers;(0,n._)(this,K,I(t.encoding)),(0,n._)(this,J,new TextEncoder);let{compression:i}=e;if((0,n._)(this,Q,1===i?e=>e:2===i?W:17480===i?await H(t,this.loadRecord.bind(this)):null),!(0,r._)(this,Q))throw Error("Unknown compression type");let{trailingFlags:a}=t,l=1&a,s=O(a>>>1);(0,n._)(this,$,e=>{for(let t=0;t<s;t++){let t=B(e);e=e.subarray(0,-t)}if(l){let t=(3&e[e.length-1])+1;e=e.subarray(0,-t)}return e})}let en=/<\s*(?:mbp:)?pagebreak[^>]*>/gi,el=/<[^<>]+filepos=['"]{0,1}(\d+)[^<>]*>/gi,es=e=>{let t=0;for(;e;){let i=e.parentElement;if(i){let e=i.tagName.toLowerCase();"p"===e?t+=1.5:"blockquote"===e&&(t+=2)}e=i}return t};var eo=new WeakMap,eu=new WeakMap,eh=new WeakMap,ec=new WeakMap,ed=new WeakMap,ef=new WeakMap;class eg{async init(){let e=new Uint8Array;for(let t=0;t<this.mobi.headers.palmdoc.numTextRecords;t++)e=S(e,await this.mobi.loadText(t));let t=Array.from(new Uint8Array(e),e=>String.fromCharCode(e)).join("");(0,n._)(this,ec,[0].concat(Array.from(t.matchAll(en),e=>e.index)).map((e,i,r)=>t.slice(e,r[i+1])).map(e=>Uint8Array.from(e,e=>e.charCodeAt(0))).map(e=>({book:this,raw:e})).reduce((e,t)=>{var i;let r=e[e.length-1];return t.start=null!=(i=null==r?void 0:r.end)?i:0,t.end=t.start+t.raw.byteLength,e.concat(t)},[])),this.sections=(0,r._)(this,ec).map((e,t)=>({id:t,load:()=>this.loadSection(e),createDocument:()=>this.createDocument(e),size:e.end-e.start}));try{var i;this.landmarks=await this.getGuide();let e=null==(i=this.landmarks.find(e=>{let{type:t}=e;return null==t?void 0:t.includes("toc")}))?void 0:i.href;if(e){let t,{index:i}=this.resolveHref(e),r=await this.sections[i].createDocument(),a=0,n=0,l=new Map,s=new Map;this.toc=Array.from(r.querySelectorAll("a[filepos]")).reduce((e,i)=>{var r,o,u,h,c;let d=es(i),f={label:null!=(o=null==(r=i.innerText)?void 0:r.trim())?o:"",href:"filepos:".concat(i.getAttribute("filepos"))},g=d>n?a+1:d===n?a:null!=(u=l.get(d))?u:Math.max(0,a-1);if(g>a)t?(null!=(h=t).subitems||(h.subitems=[]),t.subitems.push(f),s.set(g,t)):e.push(f);else{let t=s.get(g);t?t.subitems.push(f):e.push(f)}return t=f,a=g,n=d,l.set(d,g),e},[])}}catch(e){console.warn(e)}return(0,n._)(this,ed,[...new Set(Array.from(t.matchAll(el),e=>e[1]))].map(e=>({filepos:e,number:Number(e)})).sort((e,t)=>e.number-t.number)),this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getGuide(){return Array.from((await this.createDocument((0,r._)(this,ec)[0])).getElementsByTagName("reference"),e=>{var t;return{label:e.getAttribute("title"),type:null==(t=e.getAttribute("type"))?void 0:t.split(/\s/),href:"filepos:".concat(e.getAttribute("filepos"))}})}async loadResource(e){if((0,r._)(this,eo).has(e))return(0,r._)(this,eo).get(e);let t=await this.mobi.loadResource(e),i=URL.createObjectURL(new Blob([t]));return(0,r._)(this,eo).set(e,i),i}async loadRecindex(e){return this.loadResource(Number(e)-1)}async replaceResources(e){for(let t of e.querySelectorAll("img[recindex]")){let e=t.getAttribute("recindex");try{t.src=await this.loadRecindex(e)}catch(t){console.warn("Failed to load image ".concat(e))}}for(let t of e.querySelectorAll("[mediarecindex]")){let e=t.getAttribute("mediarecindex"),i=t.getAttribute("recindex");try{t.src=await this.loadRecindex(e),i&&(t.poster=await this.loadRecindex(i))}catch(t){console.warn("Failed to load media ".concat(e))}}for(let t of e.querySelectorAll("[filepos]")){let e=t.getAttribute("filepos");t.href="filepos:".concat(e)}}async loadText(e){if((0,r._)(this,eu).has(e))return(0,r._)(this,eu).get(e);let{raw:t}=e,i=(0,r._)(this,ed).filter(t=>{let{number:i}=t;return i>=e.start&&i<e.end}).map(t=>({...t,offset:t.number-e.start})),a=t;i.length&&(a=t.subarray(0,i[0].offset),i.forEach((e,r)=>{let{filepos:n,offset:l}=e,s=i[r+1],o=this.mobi.encode('<a id="filepos'.concat(n,'"></a>'));a=A(a,o,t.subarray(l,null==s?void 0:s.offset))}));let n=this.mobi.decode(a).replaceAll(en,"");return(0,r._)(this,eu).set(e,n),n}async createDocument(e){let t=await this.loadText(e);return this.parser.parseFromString(t,(0,r._)(this,ef))}async loadSection(e){if((0,r._)(this,eh).has(e))return(0,r._)(this,eh).get(e);let t=await this.createDocument(e),i=t.createElement("style");t.head.append(i),i.append(t.createTextNode("blockquote {\n            margin-block-start: 0;\n            margin-block-end: 0;\n            margin-inline-start: 1em;\n            margin-inline-end: 0;\n        }")),await this.replaceResources(t);let a=this.serializer.serializeToString(t),n=URL.createObjectURL(new Blob([a],{type:(0,r._)(this,ef)}));return(0,r._)(this,eh).set(e,n),n}resolveHref(e){let t=e.match(/filepos:(.*)/)[1],i=Number(t);return{index:(0,r._)(this,ec).findIndex(e=>e.end>i),anchor:e=>e.getElementById("filepos".concat(t))}}splitTOCHref(e){let t=e.match(/filepos:(.*)/)[1],i=Number(t);return[(0,r._)(this,ec).findIndex(e=>e.end>i),"filepos".concat(t)]}getTOCFragment(e,t){return e.getElementById(t)}isExternal(e){return/^(?!blob|filepos)\w+:/i.test(e)}destroy(){for(let e of(0,r._)(this,eo).values())URL.revokeObjectURL(e);for(let e of(0,r._)(this,eh).values())URL.revokeObjectURL(e)}constructor(e){(0,u._)(this,"parser",new DOMParser),(0,u._)(this,"serializer",new XMLSerializer),(0,a._)(this,eo,{writable:!0,value:new Map}),(0,a._)(this,eu,{writable:!0,value:new Map}),(0,a._)(this,eh,{writable:!0,value:new Map}),(0,a._)(this,ec,{writable:!0,value:void 0}),(0,a._)(this,ed,{writable:!0,value:[]}),(0,a._)(this,ef,{writable:!0,value:c.HTML}),this.mobi=e}}let ep=/kindle:(flow|embed):(\w+)(?:\?mime=(\w+\/[-+.\w]+))?/,em=/kindle:pos:fid:(\w+):off:(\w+)/,ew=e=>{let[t,i,r]=e.match(ep).slice(1);return{resourceType:t,id:parseInt(i,32),type:r}},eb=e=>{let[t,i]=e.match(em).slice(1);return{fid:parseInt(t,32),off:parseInt(i,32)}},ev=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return"kindle:pos:fid:".concat(e.toString(32).toUpperCase().padStart(4,"0"),":off:").concat(t.toString(32).toUpperCase().padStart(10,"0"))},e_=e=>{let t=e.match(/\s(id|name|aid)\s*=\s*['"]([^'"]*)['"]/i);if(!t)return;let[,i,r]=t;return"[".concat(i,'="').concat(CSS.escape(r),'"]')},ey=async(e,t,i)=>{let r=[];e.replace(t,function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return r.push(t),null});let a=[];for(let e of r)a.push(await i(...e));return e.replace(t,()=>a.shift())},eR=e=>{for(let t of e){if("page-spread-left"===t||"rendition:page-spread-left"===t)return"left";if("page-spread-right"===t||"rendition:page-spread-right"===t)return"right";if("rendition:page-spread-center"===t)return"center"}};var eM=new WeakMap,ek=new WeakMap,ex=new WeakMap,eS=new WeakMap,eA=new WeakMap,eE=new WeakMap,eT=new WeakMap,eC=new WeakMap,eL=new WeakMap,eI=new WeakMap,eU=new WeakMap,eB=new WeakMap,eO=new WeakSet;class eF{async init(){var e,t,i,a,l,s;let o=this.mobi.loadRecord.bind(this.mobi),{kf8:u}=this.mobi.headers;try{let e=await o(u.fdst),t=L(y,e);if("FDST"!==t.magic)throw Error("Missing FDST record");let i=Array.from({length:t.numEntries},(e,t)=>12+8*t).map(t=>[C(e.slice(t,t+4)),C(e.slice(t+4,t+8))]);(0,r._)(this,eS).fdstTable=i,(0,n._)(this,eE,i[i.length-1][1])}catch(e){}let d=(await z(u.skel,o)).table.map((e,t)=>{let{name:i,tagMap:r}=e;return{index:t,name:i,numFrag:r[1][0],offset:r[6][0],length:r[6][1]}}),f=await z(u.frag,o),g=f.table.map(e=>{let{name:t,tagMap:i}=e;return{insertOffset:parseInt(t),selector:f.cncx[i[2][0]],index:i[4][0],offset:i[6][0],length:i[6][1]}});(0,r._)(this,eS).skelTable=d,(0,r._)(this,eS).fragTable=g,(0,n._)(this,eA,d.reduce((e,t)=>{var i,r;let a=e[e.length-1],n=null!=(i=null==a?void 0:a.fragEnd)?i:0,l=n+t.numFrag,s=g.slice(n,l),o=t.length+s.map(e=>e.length).reduce((e,t)=>e+t),u=(null!=(r=null==a?void 0:a.totalLength)?r:0)+o;return e.concat({skel:t,frags:s,fragEnd:l,length:o,totalLength:u})},[]));let p=await this.getResourcesByMagic(["RESC","PAGE"]),m=new Map;if(p.RESC){let e=await this.mobi.loadRecord(p.RESC),t=this.mobi.decode(e.slice(16)).replace(/\0/g,""),i=t.search(/\?>/),r="<package>".concat(t.slice(i),"</package>");for(let e of this.parser.parseFromString(r,c.XML).querySelectorAll("spine > itemref")){let t=parseInt(e.getAttribute("skelid"));m.set(t,eR(null!=(l=null==(a=e.getAttribute("properties"))?void 0:a.split(" "))?l:[]))}}this.sections=(0,r._)(this,eA).map((e,t)=>e.frags.length?{id:t,load:()=>this.loadSection(e),createDocument:()=>this.createDocument(e),size:e.length,pageSpread:m.get(t)}:{linear:"no"});try{let e=await this.mobi.getNCX(),t=e=>{let{label:i,pos:a,children:n}=e,[l,s]=a,o=ev(l,s),u=(0,r._)(this,ek).get(l);return u?u.push(s):(0,r._)(this,ek).set(l,[s]),{label:h(i),href:o,subitems:null==n?void 0:n.map(t)}};this.toc=null==e?void 0:e.map(t),this.landmarks=await this.getGuide()}catch(e){console.warn(e)}let{exth:w}=this.mobi.headers;return this.dir=w.pageProgressionDirection,this.rendition={layout:"true"===w.fixedLayout?"pre-paginated":"reflowable",viewport:Object.fromEntries(null!=(s=null==(i=w.originalResolution)||null==(t=i.split("x"))||null==(e=t.slice(0,2))?void 0:e.map((e,t)=>[t?"height":"width",e]))?s:[])},this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getResourcesByMagic(e){let t={},i=this.mobi.headers.kf8.resourceStart,r=this.mobi.pdb.numRecords;for(let a=i;a<r;a++)try{let i=await this.mobi.loadMagic(a),r=e.find(e=>e===i);r&&(t[r]=a)}catch(e){}return t}async getGuide(){let e=this.mobi.headers.kf8.guide;if(e<0xffffffff){let t=this.mobi.loadRecord.bind(this.mobi),{table:i,cncx:r}=await z(e,t);return i.map(e=>{var t,i,a,n;let{name:l,tagMap:s}=e;return{label:null!=(a=r[s[1][0]])?a:"",type:null==l?void 0:l.split(/\s/),href:ev(null!=(n=null==(t=s[6])?void 0:t[0])?n:null==(i=s[3])?void 0:i[0])}})}}async loadResourceBlob(e){var t;let{resourceType:i,id:r,type:a}=ew(e),n="flow"===i?await this.loadFlow(r):await this.mobi.loadResource(r-1),l=new CustomEvent("data",{detail:{data:[c.XHTML,c.HTML,c.CSS,c.SVG].includes(a)?await this.replaceResources(this.mobi.decode(n)):n,type:a}});this.transformTarget.dispatchEvent(l);let s=await l.detail.data,o=await l.detail.type,u=o===c.SVG?this.parser.parseFromString(s,o):null;return[new Blob([s],{newType:o}),(null==u||null==(t=u.getElementsByTagNameNS("http://www.w3.org/2000/svg","image"))?void 0:t.length)?u.documentElement:null]}async loadResource(e){if((0,r._)(this,eM).has(e))return(0,r._)(this,eM).get(e);let[t,i]=await this.loadResourceBlob(e),a=i?e:URL.createObjectURL(t);return i&&(0,r._)(this,eB).set(a,i),(0,r._)(this,eM).set(e,a),a}replaceResources(e){return ey(e,RegExp(ep,"g"),this.loadResource.bind(this))}async loadRaw(e,t){let i=t-(0,r._)(this,eT).length,a=null==(0,r._)(this,eE)?1/0:(0,r._)(this,eE)-(0,r._)(this,eC).length-e;if(i<0||i<a){for(;(0,r._)(this,eT).length<t;){let e=++(0,l._)(this,eL).value,t=await this.mobi.loadText(e);(0,n._)(this,eT,S((0,r._)(this,eT),t))}return(0,r._)(this,eT).slice(e,t)}for(;(0,r._)(this,eE)-(0,r._)(this,eC).length>e;){let e=this.mobi.headers.palmdoc.numTextRecords-1-++(0,l._)(this,eI).value,t=await this.mobi.loadText(e);(0,n._)(this,eC,S(t,(0,r._)(this,eC)))}let s=(0,r._)(this,eE)-(0,r._)(this,eC).length;return(0,r._)(this,eC).slice(e-s,t-s)}loadFlow(e){if(e<0xffffffff)return this.loadRaw(...(0,r._)(this,eS).fdstTable[e])}async loadText(e){let{skel:t,frags:i,length:a}=e,n=await this.loadRaw(t.offset,t.offset+a),l=n.slice(0,t.length);for(let e of i){let i=e.insertOffset-t.offset,a=t.length+e.offset,o=n.slice(a,a+e.length);l=A(l.slice(0,i),o,l.slice(i));let u=(0,r._)(this,ek).get(e.index);if(u)for(let t of u){let i=e_(this.mobi.decode(o).slice(t));(0,s._)(this,eO,eW).call(this,e.index,t,i)}}return this.mobi.decode(l)}async createDocument(e){let t=await this.loadText(e);return this.parser.parseFromString(t,(0,r._)(this,eU))}async loadSection(e){var t;if((0,r._)(this,eM).has(e))return(0,r._)(this,eM).get(e);let i=await this.loadText(e),a=await this.replaceResources(i),l=this.parser.parseFromString(a,(0,r._)(this,eU));for(let[e,i]of(!l.querySelector("parsererror")&&(null==(t=l.documentElement)?void 0:t.namespaceURI)||((0,n._)(this,eU,c.HTML),l=this.parser.parseFromString(a,(0,r._)(this,eU))),(0,r._)(this,eB)))for(let t of l.querySelectorAll('img[src="'.concat(e,'"]')))t.replaceWith(i);let s=URL.createObjectURL(new Blob([this.serializer.serializeToString(l)],{type:(0,r._)(this,eU)}));return(0,r._)(this,eM).set(e,s),s}getIndexByFID(e){return(0,r._)(this,eA).findIndex(t=>t.frags.some(t=>t.index===e))}async resolveHref(e){var t;let{fid:i,off:a}=eb(e),n=this.getIndexByFID(i);if(n<0)return;let l=null==(t=(0,r._)(this,ex).get(i))?void 0:t.get(a);if(l)return{index:n,anchor:e=>e.querySelector(l)};let{skel:o,frags:u}=(0,r._)(this,eA)[n],h=u.find(e=>e.index===i),c=o.offset+o.length+h.offset,d=await this.loadRaw(c,c+h.length),f=e_(this.mobi.decode(d).slice(a));return(0,s._)(this,eO,eW).call(this,i,a,f),{index:n,anchor:e=>e.querySelector(f)}}splitTOCHref(e){let t=eb(e);return[this.getIndexByFID(t.fid),t]}getTOCFragment(e,t){var i;let{fid:a,off:n}=t,l=null==(i=(0,r._)(this,ex).get(a))?void 0:i.get(n);return e.querySelector(l)}isExternal(e){return/^(?!blob|kindle)\w+:/i.test(e)}destroy(){for(let e of(0,r._)(this,eM).values())URL.revokeObjectURL(e)}constructor(e){(0,o._)(this,eO),(0,u._)(this,"parser",new DOMParser),(0,u._)(this,"serializer",new XMLSerializer),(0,u._)(this,"transformTarget",new EventTarget),(0,a._)(this,eM,{writable:!0,value:new Map}),(0,a._)(this,ek,{writable:!0,value:new Map}),(0,a._)(this,ex,{writable:!0,value:new Map}),(0,a._)(this,eS,{writable:!0,value:{}}),(0,a._)(this,eA,{writable:!0,value:void 0}),(0,a._)(this,eE,{writable:!0,value:void 0}),(0,a._)(this,eT,{writable:!0,value:new Uint8Array}),(0,a._)(this,eC,{writable:!0,value:new Uint8Array}),(0,a._)(this,eL,{writable:!0,value:-1}),(0,a._)(this,eI,{writable:!0,value:-1}),(0,a._)(this,eU,{writable:!0,value:c.XHTML}),(0,a._)(this,eB,{writable:!0,value:new Map}),this.mobi=e}}function eW(e,t,i){let a=(0,r._)(this,ex).get(e);if(a)a.set(t,i);else{let a=new Map;(0,r._)(this,ex).set(e,a),a.set(t,i)}}}}]);